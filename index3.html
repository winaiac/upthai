<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Winai Innovation Portal - Super App ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡πÑ‡∏ó‡∏¢</title>

    <link rel="icon" type="image/svg+xml"
        href="https://upload.wikimedia.org/wikipedia/commons/a/a9/Flag_of_Thailand.svg">

    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;700&display=swap');

        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #0f172a;
            color: #f1f5f9;
            overflow: hidden;
            height: 100dvh;
        }

        .leaflet-container {
            cursor: grab !important;
        }

        .leaflet-container:active {
            cursor: grabbing !important;
        }

        .leaflet-interactive {
            cursor: pointer !important;
        }

        .animate-fade-in-up {
            animation: fadeInUp 0.5s ease-out forwards;
        }

        /* Animation for panel transition */
        .animate-slide-in-right {
            animation: slideInRight 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(20px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse-glow {

            0%,
            100% {
                box-shadow: 0 0 15px rgba(236, 72, 153, 0.6);
                transform: scale(1);
            }

            50% {
                box-shadow: 0 0 30px rgba(236, 72, 153, 1);
                transform: scale(1.05);
            }
        }

        .btn-super-pulse {
            animation: pulse-glow 2s infinite;
        }

        @keyframes flag-wave-left {
            0% {
                transform: perspective(400px) rotateY(-5deg) skewY(0deg) translateY(0);
            }

            25% {
                transform: perspective(400px) rotateY(-15deg) skewY(2deg) translateY(-2px);
            }

            50% {
                transform: perspective(400px) rotateY(-5deg) skewY(0deg) translateY(0);
            }

            75% {
                transform: perspective(400px) rotateY(5deg) skewY(-2deg) translateY(2px);
            }

            100% {
                transform: perspective(400px) rotateY(-5deg) skewY(0deg) translateY(0);
            }
        }

        .animate-flag-wave {
            animation: flag-wave-left 3s infinite cubic-bezier(0.45, 0.05, 0.55, 0.95);
            transform-origin: bottom right;
            filter: drop-shadow(0 10px 10px rgba(0, 0, 0, 0.5));
        }

        .scrollbar-prominent {
            scrollbar-width: thin;
            scrollbar-color: rgba(251, 191, 36, 0.5) transparent;
        }

        .scrollbar-prominent::-webkit-scrollbar {
            width: 6px;
            height: 6px;
            display: block;
            -webkit-appearance: none;
        }

        .scrollbar-prominent::-webkit-scrollbar-track {
            background: transparent;
        }

        .scrollbar-prominent::-webkit-scrollbar-thumb {
            background: rgba(251, 191, 36, 0.5);
            border-radius: 10px;
        }

        .scrollbar-prominent::-webkit-scrollbar-thumb:hover {
            background: rgba(251, 191, 36, 0.8);
        }

        .bottom-sheet {
            transition: all 0.5s cubic-bezier(0.32, 0.72, 0, 1);
        }

        #global-map {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
        }

        .ui-layer {
            position: relative;
            z-index: 10;
        }

        .cloud-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 50;
            opacity: 0;
            transition: opacity 1.5s ease-in-out;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .cloud-container.active {
            opacity: 1;
            pointer-events: auto;
        }

        .cloud-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 200%;
            height: 100%;
            background:
                radial-gradient(circle at 10% 20%, rgba(255, 255, 255, 0.5) 0%, transparent 20%),
                radial-gradient(circle at 30% 80%, rgba(255, 255, 255, 0.4) 0%, transparent 25%),
                radial-gradient(circle at 50% 30%, rgba(255, 255, 255, 0.5) 0%, transparent 15%),
                radial-gradient(circle at 70% 60%, rgba(255, 255, 255, 0.4) 0%, transparent 20%),
                radial-gradient(circle at 90% 10%, rgba(255, 255, 255, 0.5) 0%, transparent 25%);

            background-size: 100% 100%;
            filter: blur(40px);
            opacity: 0.6;
            animation: cloudFly 20s linear infinite;
        }

        .cloud-layer:nth-child(2) {
            top: 10%;
            width: 250%;
            background:
                radial-gradient(circle at 15% 50%, rgba(255, 255, 255, 0.3) 0%, transparent 25%),
                radial-gradient(circle at 45% 10%, rgba(255, 255, 255, 0.4) 0%, transparent 20%),
                radial-gradient(circle at 75% 80%, rgba(255, 255, 255, 0.3) 0%, transparent 25%);
            animation: cloudFly 25s linear infinite reverse;
            opacity: 0.4;
            filter: blur(50px);
        }

        .cloud-layer:nth-child(3) {
            top: -10%;
            width: 300%;
            background:
                radial-gradient(circle at 50% 50%, rgba(255, 255, 255, 0.2) 0%, transparent 40%);
            animation: cloudFly 35s linear infinite;
            opacity: 0.3;
            filter: blur(60px);
        }

        @keyframes cloudFly {
            from {
                transform: translateX(-20%);
            }

            to {
                transform: translateX(-60%);
            }
        }

        .travel-message {
            position: relative;
            z-index: 60;
            text-align: center;
            color: #0f172a;
            text-shadow: 0 2px 10px rgba(255, 255, 255, 0.9), 0 0 20px rgba(255, 255, 255, 0.5);
            transform: scale(0.9);
            transition: transform 0.5s;
        }

        .cloud-container.active .travel-message {
            transform: scale(1);
        }
    </style>
</head>

<body class="bg-slate-900 text-slate-100">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- SUPABASE SETUP (‡πÉ‡∏™‡πà Key ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà) ---
        const SUPABASE_URL = 'https://ldsysxczitmkxmukmwri.supabase.co'; // ‡πÉ‡∏™‡πà URL ‡∏à‡∏≤‡∏Å Supabase Settings > API
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imxkc3lzeGN6aXRta3htdWttd3JpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYxNzI4NDAsImV4cCI6MjA4MTc0ODg0MH0.1rHQug1PlhgNE6lsy3RllAQC36k0BoY6KqjeeQvAVhc'; // ‡πÉ‡∏™‡πà Key ‡∏à‡∏≤‡∏Å Supabase Settings > API

        let supabase = null;
        // FIX: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö URL ‡∏Å‡πà‡∏≠‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á Client ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô Error ‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡∏≤‡∏ß‡∏ñ‡πâ‡∏≤ URL ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
        if (SUPABASE_URL && SUPABASE_URL.startsWith('http') && SUPABASE_URL !== 'YOUR_SUPABASE_URL') {
            try {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            } catch (err) {
                console.warn("Supabase init error (using mock data):", err);
            }
        }

        // --- GLOBAL CONSTANTS & DATA ---
        Chart.defaults.color = '#cbd5e1';
        Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.1)';
        Chart.defaults.font.family = 'Sarabun';

        const DON_MUEANG_COORDS = [13.9133, 100.6042];

        // --- MOCK DATA (‡πÉ‡∏ä‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ï‡πà‡∏≠ Supabase ‡πÑ‡∏°‡πà‡∏ï‡∏¥‡∏î) ---
        // ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏•‡∏∞ 1 ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ç‡∏≠
        const MOCK_PROVINCE_DATA = {
            "‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£": { lat: 13.9133, lng: 100.6042, ph: 7.0, moisture: 70, soil: "‡∏î‡∏¥‡∏ô‡πÄ‡∏´‡∏ô‡∏µ‡∏¢‡∏ß (‡∏ä‡∏∏‡∏î‡∏î‡∏¥‡∏ô‡∏£‡∏≤‡∏ä‡∏ö‡∏∏‡∏£‡∏µ)", region: "‡∏Å‡∏•‡∏≤‡∏á" }
        };

        const MOCK_REGIONS = {
            "‡∏Å‡∏•‡∏≤‡∏á": ["‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£"]
        };

        const MOCK_CROPS = [
            {
                name: "‡∏Ç‡πâ‡∏≤‡∏ß‡∏´‡∏≠‡∏°‡∏°‡∏∞‡∏•‡∏¥ 105 (Mock)", category: "‡∏û‡∏∑‡∏ä‡πÑ‡∏£‡πà", price: 16500, yield: 780, cost: 5200, risk: "Low", primarySource: "RICE", market: "‡πÇ‡∏£‡∏á‡∏™‡∏µ‡∏Ç‡πâ‡∏≤‡∏ß‡∏ó‡πâ‡∏≠‡∏á‡∏ñ‡∏¥‡πà‡∏ô / ‡∏™‡∏Å‡∏ï.", marketLocation: "‡∏ó‡∏±‡πà‡∏ß‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®",
                density: "‡πÉ‡∏ä‡πÄ‡∏°‡∏•‡πá‡∏î‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå 15-20 ‡∏Å‡∏Å.", yieldUnit: "‡∏Ç‡πâ‡∏≤‡∏ß‡πÄ‡∏õ‡∏•‡∏∑‡∏≠‡∏Å (‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô 15%)",
                costStructure: { fertilizer: 25, labor: 35, seeds: 15, water: 15, misc: 10 },
                farmingSteps: [
                    { title: '‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏î‡∏¥‡∏ô', desc: '‡πÑ‡∏ñ‡∏î‡∏∞‡∏ï‡∏≤‡∏Å‡∏î‡∏¥‡∏ô 7-14 ‡∏ß‡∏±‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏ñ‡πÅ‡∏õ‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≥‡∏à‡∏±‡∏î‡∏ß‡∏±‡∏ä‡∏û‡∏∑‡∏ä' },
                    { title: '‡πÄ‡∏û‡∏≤‡∏∞‡∏õ‡∏•‡∏π‡∏Å', desc: '‡∏´‡∏ß‡πà‡∏≤‡∏ô‡πÄ‡∏°‡∏•‡πá‡∏î‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå (15-20 ‡∏Å‡∏Å./‡πÑ‡∏£‡πà) ‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏±‡∏Å‡∏î‡∏≥' },
                    { title: '‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏±‡∏Å‡∏©‡∏≤', desc: '‡πÉ‡∏™‡πà‡∏õ‡∏∏‡πã‡∏¢‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡∏´‡∏•‡∏±‡∏á‡∏õ‡∏•‡∏π‡∏Å 20 ‡∏ß‡∏±‡∏ô ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 2 ‡∏£‡∏∞‡∏¢‡∏∞‡∏Å‡∏≥‡πÄ‡∏ô‡∏¥‡∏î‡∏ä‡πà‡∏≠‡∏î‡∏≠‡∏Å' },
                    { title: '‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß', desc: '‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏£‡∏ß‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á 80-90% (‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì 100-120 ‡∏ß‡∏±‡∏ô)' }
                ],
                lifecycle: { type: 'annual', lifespan: 1, advice: '‚ÑπÔ∏è (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≥‡∏•‡∏≠‡∏á) ‡∏Ñ‡∏ß‡∏£‡∏õ‡∏•‡∏π‡∏Å‡∏û‡∏∑‡∏ä‡∏ï‡∏£‡∏∞‡∏Å‡∏π‡∏•‡∏ñ‡∏±‡πà‡∏ß‡∏™‡∏•‡∏±‡∏ö' }
            }
        ];

        // ‡∏Ñ‡πà‡∏≤ Default ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏ì‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô DB ‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö
        const DEFAULT_COST_STRUCTURE = { fertilizer: 30, labor: 30, seeds: 20, water: 10, misc: 10 };
        const DEFAULT_STEPS = [
            { title: '‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà', desc: '‡πÑ‡∏ñ‡∏û‡∏£‡∏ß‡∏ô‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏†‡∏≤‡∏û‡∏î‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏≥‡∏à‡∏±‡∏î‡∏ß‡∏±‡∏ä‡∏û‡∏∑‡∏ä' },
            { title: '‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏î‡∏¥‡∏ô', desc: '‡∏ï‡∏£‡∏ß‡∏à pH ‡πÅ‡∏•‡∏∞‡πÉ‡∏™‡πà‡∏õ‡∏π‡∏ô‡∏Ç‡∏≤‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏∏‡πã‡∏¢‡∏Ñ‡∏≠‡∏Å‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô' },
            { title: '‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏±‡∏Å‡∏©‡∏≤', desc: '‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥‡∏™‡∏°‡πà‡∏≥‡πÄ‡∏™‡∏°‡∏≠‡πÅ‡∏•‡∏∞‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÅ‡∏°‡∏•‡∏á‡∏®‡∏±‡∏ï‡∏£‡∏π‡∏û‡∏∑‡∏ä' },
            { title: '‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß', desc: '‡πÄ‡∏Å‡πá‡∏ö‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î' }
        ];
        const DEFAULT_LIFECYCLE = { type: 'annual', lifespan: 1, advice: '‚ÑπÔ∏è ‡∏Ñ‡∏ß‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏à‡∏≤‡∏Å‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏≠‡∏≥‡πÄ‡∏†‡∏≠' };

        const GOV_SOURCES = {
            OAE: { id: 'oae', name: '‡∏™‡∏®‡∏Å.', icon: 'fa-chart-line', color: 'text-blue-400', borderColor: 'border-blue-500/30', bg: 'bg-blue-500/10' },
            LDD: { id: 'ldd', name: '‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô', icon: 'fa-layer-group', color: 'text-amber-400', borderColor: 'border-amber-500/30', bg: 'bg-amber-500/10' },
            TMD: { id: 'tmd', name: '‡∏≠‡∏∏‡∏ï‡∏∏‡∏Ø', icon: 'fa-cloud-bolt', color: 'text-cyan-400', borderColor: 'border-cyan-500/30', bg: 'bg-cyan-500/10' },
            GISTDA: { id: 'gistda', name: 'GISTDA', icon: 'fa-satellite', color: 'text-purple-400', borderColor: 'border-purple-500/30', bg: 'bg-purple-500/10' },
            MARKET: { id: 'market', name: '‡∏ï‡∏•‡∏≤‡∏î‡πÑ‡∏ó', icon: 'fa-shop', color: 'text-green-400', borderColor: 'border-green-500/30', bg: 'bg-green-500/10' },
            DOA: { id: 'doa', name: '‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏©‡∏ï‡∏£', icon: 'fa-seedling', color: 'text-pink-400', borderColor: 'border-pink-500/30', bg: 'bg-pink-500/10' },
            RICE: { id: 'rice', name: '‡∏Å‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≤‡∏ß', icon: 'fa-bowl-rice', color: 'text-yellow-200', borderColor: 'border-yellow-200/30', bg: 'bg-yellow-200/10' }
        };

        // --- HELPER FUNCTIONS ---
        const long2tile = (lon, zoom) => (Math.floor((lon + 180) / 360 * Math.pow(2, zoom)));
        const lat2tile = (lat, zoom) => (Math.floor((1 - Math.log(Math.tan(lat * Math.PI / 180) + 1 / Math.cos(lat * Math.PI / 180)) / Math.PI) / 2 * Math.pow(2, zoom)));

        const toRad = (deg) => deg * (Math.PI / 180);
        const toDeg = (rad) => rad * (180 / Math.PI);

        const getBearing = (startLat, startLng, destLat, destLng) => {
            const startLatRad = toRad(startLat);
            const startLngRad = toRad(startLng);
            const destLatRad = toRad(destLat);
            const destLngRad = toRad(destLng);

            const y = Math.sin(destLngRad - startLngRad) * Math.cos(destLatRad);
            const x = Math.cos(startLatRad) * Math.sin(destLatRad) -
                Math.sin(startLatRad) * Math.cos(destLatRad) * Math.cos(destLngRad - startLngRad);

            let brng = Math.atan2(y, x);
            brng = toDeg(brng);
            return (brng + 360) % 360;
        };

        const checkAndPreloadTiles = (lat, lng, zoom = 9) => {
            const promises = [];
            const x = long2tile(lng, zoom);
            const y = lat2tile(lat, zoom);
            for (let i = -1; i <= 1; i++) {
                for (let j = -1; j <= 1; j++) {
                    const tx = x + i;
                    const ty = y + j;
                    const urls = [
                        `https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/${zoom}/${ty}/${tx}`,
                        `https://mt1.google.com/vt/lyrs=h&x=${tx}&y=${ty}&z=${zoom}`
                    ];
                    urls.forEach(url => {
                        const p = new Promise((resolve) => {
                            const img = new Image();
                            img.onload = () => resolve(true);
                            img.onerror = () => resolve(false);
                            img.src = url;
                        });
                        promises.push(p);
                    });
                }
            }
            return Promise.all(promises);
        };

        // --- SUB COMPONENTS ---
        const CloudOverlay = ({ isActive, message, rotation }) => {
            return (
                <div className={`cloud-container ${isActive ? 'active' : ''}`}>
                    <div className="cloud-layer"></div>
                    <div className="cloud-layer"></div>
                    <div className="cloud-layer"></div>
                    {isActive && (
                        <div className="travel-message">
                            <div className="text-4xl md:text-6xl text-emerald-600 mb-4 drop-shadow-2xl transition-all duration-1000">
                                <i
                                    className="fa-solid fa-plane-up"
                                    style={{
                                        transform: `rotate(${rotation || 0}deg)`,
                                        display: 'inline-block',
                                        transition: 'transform 1s cubic-bezier(0.4, 0, 0.2, 1)'
                                    }}
                                ></i>
                            </div>
                            <h2 className="text-2xl md:text-4xl font-bold bg-white/60 backdrop-blur-md px-6 py-3 rounded-full shadow-lg border-white/50 text-emerald-900">
                                {message}
                            </h2>
                        </div>
                    )}
                </div>
            );
        };

        // --- SimulationPanel (‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Dynamic ‡πÑ‡∏î‡πâ) ---
        const SimulationPanel = ({ item, onClose, initialArea, floodData, soilInfo }) => {
            const [localArea, setLocalArea] = useState(initialArea);
            const [yearCount, setYearCount] = useState(10);
            const [panelTab, setPanelTab] = useState('overview'); // overview, financial, guide
            const [customCosts, setCustomCosts] = useState(null);

            // ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Item (‡∏ó‡∏µ‡πà‡∏î‡∏∂‡∏á‡∏°‡∏≤‡∏à‡∏≤‡∏Å DB) ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤ Default
            const lifeInfo = item.lifecycle || DEFAULT_LIFECYCLE;
            const isTree = lifeInfo.type === 'tree';
            const plantingSteps = item.farmingSteps || item.farming_steps || DEFAULT_STEPS;

            const donutCanvasRef = useRef(null);
            const donutChartRef = useRef(null);
            const lineCanvasRef = useRef(null);
            const lineChartRef = useRef(null);

            const calculateTotalPlants = () => {
                if (!item.density) return "-";
                const densityNum = parseInt(item.density.replace(/,/g, ''));
                if (isNaN(densityNum)) return item.density;
                return Math.floor(densityNum * localArea).toLocaleString() + " ‡∏ï‡πâ‡∏ô";
            };

            useEffect(() => {
                // ‡πÉ‡∏ä‡πâ Cost Structure ‡∏à‡∏≤‡∏Å DB ‡∏´‡∏£‡∏∑‡∏≠ Default
                const costStructure = item.costStructure || item.cost_structure || DEFAULT_COST_STRUCTURE;
                const defaultTotalCost = (item.costTotal / initialArea) * localArea;

                setCustomCosts({
                    fertilizer: defaultTotalCost * (costStructure.fertilizer / 100),
                    labor: defaultTotalCost * (costStructure.labor / 100),
                    seeds: defaultTotalCost * (costStructure.seeds / 100),
                    water: defaultTotalCost * (costStructure.water / 100),
                    misc: defaultTotalCost * (costStructure.misc / 100)
                });
            }, [item, localArea]);

            const handleCostChange = (key, value) => {
                const numVal = parseFloat(value) || 0;
                setCustomCosts(prev => ({ ...prev, [key]: numVal }));
            };

            const simulationData = [];
            let totalProfit = 0;
            const currentTotalCostPerYear = customCosts ? Object.values(customCosts).reduce((a, b) => a + b, 0) : 0;
            let grandTotalCost = 0;

            const currentYearBE = new Date().getFullYear() + 543;
            const startYearBE = currentYearBE;

            if (customCosts) {
                const unitRev = (item.profitTotal + item.costTotal) / initialArea;
                const baseYearlyRev = unitRev * localArea;

                for (let i = 0; i < yearCount; i++) {
                    const yearBE = startYearBE + i;
                    const age = i + 1;
                    let yearlyCost = currentTotalCostPerYear;
                    let yearlyRev = baseYearlyRev;

                    if (isTree) {
                        if (age <= (lifeInfo.wait_years || 0)) {
                            yearlyRev = 0;
                            yearlyCost = yearlyCost * 0.5;
                        } else if (age < (lifeInfo.peak_start || 5)) {
                            yearlyRev = yearlyRev * 0.6;
                        }
                    }

                    let eventNote = "-";
                    let statusColor = "text-slate-400";
                    const floodMatch = floodData.history.find(h => h.includes(yearBE.toString()));
                    if (floodMatch) {
                        eventNote = `üåä ‡∏ô‡πâ‡∏≥‡∏ó‡πà‡∏ß‡∏° (${floodMatch})`;
                        statusColor = "text-red-400 font-bold";
                        yearlyCost *= 1.5;
                        yearlyRev *= 0.2;
                    }

                    const yearlyProfit = yearlyRev - yearlyCost;
                    totalProfit += yearlyProfit;
                    grandTotalCost += yearlyCost;

                    simulationData.push({
                        year: yearBE, age: age, cost: yearlyCost, revenue: yearlyRev,
                        profit: yearlyProfit, accumulatedProfit: totalProfit,
                        note: eventNote, statusColor: statusColor
                    });
                }
            }

            useEffect(() => {
                if (!customCosts) return;

                if (panelTab === 'overview' && donutCanvasRef.current) {
                    if (donutChartRef.current) donutChartRef.current.destroy();
                    const ctx = donutCanvasRef.current.getContext('2d');
                    donutChartRef.current = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: ['‡∏õ‡∏∏‡πã‡∏¢/‡∏¢‡∏≤', '‡πÅ‡∏£‡∏á‡∏á‡∏≤‡∏ô', '‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå', '‡∏ô‡πâ‡∏≥/‡πÑ‡∏ü', '‡πÄ‡∏ö‡πá‡∏î‡πÄ‡∏ï‡∏•‡πá‡∏î'],
                            datasets: [{ data: [customCosts.fertilizer, customCosts.labor, customCosts.seeds, customCosts.water, customCosts.misc], backgroundColor: ['#34d399', '#facc15', '#f87171', '#60a5fa', '#94a3b8'], borderWidth: 0 }]
                        },
                        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { color: '#cbd5e1', font: { size: 10 } } }, title: { display: false } } }
                    });
                }

                if (panelTab === 'financial' && lineCanvasRef.current) {
                    if (lineChartRef.current) lineChartRef.current.destroy();
                    const ctx = lineCanvasRef.current.getContext('2d');
                    lineChartRef.current = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: simulationData.map(d => d.year),
                            datasets: [
                                { label: '‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∞‡∏™‡∏°', data: simulationData.map(d => d.accumulatedProfit), borderColor: '#34d399', backgroundColor: 'rgba(52, 211, 153, 0.1)', fill: true, tension: 0.4 },
                                { label: '‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö', data: simulationData.map(d => d.revenue), borderColor: '#60a5fa', borderDash: [5, 5], fill: false, tension: 0.1 },
                            ]
                        },
                        options: { responsive: true, maintainAspectRatio: false, scales: { x: { ticks: { color: '#94a3b8' }, grid: { display: false } }, y: { ticks: { color: '#94a3b8' }, grid: { color: 'rgba(255,255,255,0.05)' } } }, plugins: { legend: { labels: { color: '#cbd5e1' } } } }
                    });
                }

                return () => {
                    if (donutChartRef.current) donutChartRef.current.destroy();
                    if (lineChartRef.current) lineChartRef.current.destroy();
                };
            }, [customCosts, yearCount, simulationData, panelTab]);

            if (!customCosts) return <div className="p-10 text-center text-slate-400">Loading Simulation...</div>;

            return (
                <div className="flex flex-col h-full w-full animate-slide-in-right px-2 pb-6">
                    {/* Header Bar */}
                    <div className="flex items-center justify-between mb-2 pb-2 border-b border-white/5">
                        <div className="flex items-center gap-3">
                            <button onClick={onClose} className="w-8 h-8 rounded-full bg-white/10 hover:bg-white/20 flex items-center justify-center text-white transition">
                                <i className="fa-solid fa-arrow-left"></i>
                            </button>
                            <div>
                                <h3 className="text-xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-emerald-300 to-teal-200">
                                    {item.name}
                                </h3>
                                <div className="flex items-center gap-2 text-[10px] text-slate-400">
                                    <span>‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á: {item.risk}</span>
                                    <span>‚Ä¢</span>
                                    <span>ROI: {grandTotalCost > 0 ? ((totalProfit / grandTotalCost) * 100).toFixed(0) : 0}%</span>
                                </div>
                            </div>
                        </div>

                        <div className="flex gap-2">
                            <div className="flex items-center gap-2 bg-black/20 rounded-lg px-3 py-1">
                                <span className="text-xs text-slate-400">‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</span>
                                <input type="number" step="0.1" min="0" value={localArea} onChange={(e) => { const val = parseFloat(e.target.value); setLocalArea(isNaN(val) ? 0 : Math.max(0, val)); }} className="w-10 bg-transparent text-center font-bold text-emerald-400 focus:outline-none" />
                                <span className="text-xs text-slate-400">‡πÑ‡∏£‡πà</span>
                            </div>
                            <div className="flex items-center gap-2 bg-black/20 rounded-lg px-3 py-1">
                                <span className="text-xs text-slate-400">‡πÄ‡∏ß‡∏•‡∏≤</span>
                                <input type="number" value={yearCount} onChange={(e) => setYearCount(Math.max(1, Math.min(50, parseInt(e.target.value) || 1)))} className="w-8 bg-transparent text-center font-bold text-yellow-400 focus:outline-none" />
                                <span className="text-xs text-slate-400">‡∏õ‡∏µ</span>
                            </div>
                        </div>
                    </div>

                    {/* ‡πÄ‡∏°‡∏ô‡∏π‡∏¢‡πà‡∏≠‡∏¢ (Tabs) */}
                    <div className="flex p-1 bg-black/20 rounded-lg mb-3 gap-1">
                        <button
                            onClick={() => setPanelTab('overview')}
                            className={`flex-1 py-1.5 text-xs rounded-md transition flex items-center justify-center gap-2 ${panelTab === 'overview' ? 'bg-emerald-600 text-white shadow' : 'text-slate-400 hover:bg-white/5'}`}
                        >
                            <i className="fa-solid fa-chart-pie"></i> ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°
                        </button>
                        <button
                            onClick={() => setPanelTab('financial')}
                            className={`flex-1 py-1.5 text-xs rounded-md transition flex items-center justify-center gap-2 ${panelTab === 'financial' ? 'bg-emerald-600 text-white shadow' : 'text-slate-400 hover:bg-white/5'}`}
                        >
                            <i className="fa-solid fa-table-list"></i> ‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô
                        </button>
                        <button
                            onClick={() => setPanelTab('guide')}
                            className={`flex-1 py-1.5 text-xs rounded-md transition flex items-center justify-center gap-2 ${panelTab === 'guide' ? 'bg-emerald-600 text-white shadow' : 'text-slate-400 hover:bg-white/5'}`}
                        >
                            <i className="fa-solid fa-book-open"></i> ‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠
                        </button>
                    </div>

                    <div className="flex-1 overflow-y-auto overflow-x-hidden scrollbar-prominent pr-1">

                        {/* Tab 1: Overview - ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏° */}
                        {panelTab === 'overview' && (
                            <div className="flex flex-col gap-3 animate-fade-in-up">
                                <div className="bg-emerald-900/10 backdrop-blur-none p-4 rounded-xl border border-emerald-500/10 relative overflow-hidden">
                                    <div className="absolute top-0 right-0 w-20 h-20 bg-emerald-500/5 rounded-full blur-2xl"></div>
                                    <div className="flex justify-between items-end mb-2">
                                        <span className="text-sm text-slate-300">‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ ({yearCount} ‡∏õ‡∏µ)</span>
                                        <span className={`text-3xl font-bold ${totalProfit > 0 ? 'text-emerald-400' : 'text-red-400'}`}>{totalProfit.toLocaleString(undefined, { maximumFractionDigits: 0 })} ‡∏ø</span>
                                    </div>
                                    <div className="flex justify-between items-end border-t border-white/5 pt-2 mt-2">
                                        <span className="text-xs text-slate-400">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡πâ‡∏ô ({localArea} ‡πÑ‡∏£‡πà)</span>
                                        <span className="text-sm font-bold text-slate-200">{calculateTotalPlants()}</span>
                                    </div>
                                </div>

                                <div className="bg-black/10 p-4 rounded-xl backdrop-blur-none border border-white/5 flex flex-col gap-2">
                                    <h4 className="text-xs font-bold text-slate-400 mb-1 flex justify-between">
                                        <span>‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô (‡∏ï‡πà‡∏≠‡∏õ‡∏µ)</span>
                                        <span className="text-red-300">{currentTotalCostPerYear.toLocaleString()} ‡∏ø</span>
                                    </h4>
                                    <div className="flex gap-4 h-[140px] items-center">
                                        <div className="w-1/2 h-full relative">
                                            <canvas ref={donutCanvasRef}></canvas>
                                        </div>
                                        <div className="flex-1 overflow-y-auto pr-1 h-full">
                                            <table className="w-full text-[10px] text-slate-300">
                                                <tbody>
                                                    {[{ key: 'fertilizer', label: '‡∏õ‡∏∏‡πã‡∏¢/‡∏¢‡∏≤' }, { key: 'labor', label: '‡πÅ‡∏£‡∏á‡∏á‡∏≤‡∏ô' }, { key: 'seeds', label: '‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå' }, { key: 'water', label: '‡∏ô‡πâ‡∏≥' }, { key: 'misc', label: '‡∏≠‡∏∑‡πà‡∏ô‡πÜ' }].map((c) => (
                                                        <tr key={c.key} className="border-b border-white/5 last:border-0">
                                                            <td className="py-1.5">{c.label}</td>
                                                            <td className="py-1.5 text-right">
                                                                <input type="number" value={Math.round(customCosts[c.key])} onChange={(e) => handleCostChange(c.key, e.target.value)} className="bg-white/5 rounded px-1 text-right text-emerald-300 w-16 focus:outline-none focus:bg-white/10" />
                                                            </td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Tab 2: Financial - ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô */}
                        {panelTab === 'financial' && (
                            <div className="flex flex-col gap-3 animate-fade-in-up">
                                <div className="bg-black/10 p-3 rounded-xl border border-white/5 h-[200px] flex flex-col">
                                    <h4 className="text-xs text-slate-400 mb-1">‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∞‡∏™‡∏°</h4>
                                    <div className="flex-1 relative"><canvas ref={lineCanvasRef}></canvas></div>
                                </div>

                                <div className="bg-black/10 p-0 rounded-xl border border-white/5 overflow-hidden flex flex-col h-full min-h-[300px]">
                                    <div className="bg-white/5 px-3 py-2 text-xs font-bold text-slate-300 flex justify-between">
                                        <span>‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏£‡∏∞‡πÅ‡∏™‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</span>
                                        <span className="text-[10px] font-normal text-slate-500">‡∏´‡∏ô‡πà‡∏ß‡∏¢: ‡∏ö‡∏≤‡∏ó</span>
                                    </div>
                                    <div className="overflow-y-auto flex-1 scrollbar-prominent">
                                        <table className="w-full text-xs text-left text-slate-300">
                                            <thead className="text-[10px] text-slate-500 bg-black/20 sticky top-0 backdrop-blur-none">
                                                <tr><th className="px-3 py-2">‡∏õ‡∏µ</th><th className="px-3 py-2 text-right">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</th><th className="px-3 py-2 text-right">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</th><th className="px-3 py-2 text-right">‡∏Å‡∏≥‡πÑ‡∏£</th></tr>
                                            </thead>
                                            <tbody>
                                                {simulationData.map(d => (
                                                    <tr key={d.year} className="border-b border-white/5 hover:bg-white/5 transition-colors">
                                                        <td className="px-3 py-2">
                                                            <div className="text-yellow-500 font-bold">{d.year}</div>
                                                            {d.note !== '-' && <div className="text-[9px] text-red-400">{d.note}</div>}
                                                        </td>
                                                        <td className="px-3 py-2 text-right text-emerald-300/80">{d.revenue.toLocaleString()}</td>
                                                        <td className="px-3 py-2 text-right text-red-300/80">{d.cost.toLocaleString()}</td>
                                                        <td className={`px-3 py-2 text-right font-bold ${d.profit > 0 ? 'text-emerald-400' : 'text-red-500'}`}>{d.profit.toLocaleString()}</td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Tab 3: Guide - ‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠ */}
                        {panelTab === 'guide' && (
                            <div className="flex flex-col gap-3 animate-fade-in-up">
                                <div className="p-4 bg-yellow-500/10 border border-yellow-500/20 rounded-xl flex items-start gap-3">
                                    <i className="fa-solid fa-lightbulb text-yellow-500 mt-1"></i>
                                    <div>
                                        <h4 className="font-bold text-yellow-500 text-sm">‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</h4>
                                        <p className="text-xs text-yellow-100/80 mt-1">{lifeInfo.advice}</p>
                                        <p className="text-xs text-slate-400 mt-1">‡∏™‡∏†‡∏≤‡∏û‡∏î‡∏¥‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: {soilInfo.soil || soilInfo.soil_type} (‡∏Ñ‡∏ß‡∏£‡∏ï‡∏£‡∏ß‡∏à pH ‡∏Å‡πà‡∏≠‡∏ô‡∏õ‡∏•‡∏π‡∏Å)</p>
                                    </div>
                                </div>

                                <div className="space-y-3">
                                    {plantingSteps.map((step, idx) => (
                                        <div key={idx} className="bg-black/20 p-4 rounded-xl border border-white/5 flex gap-4">
                                            <div className="w-8 h-8 rounded-full bg-emerald-500/20 text-emerald-400 flex items-center justify-center font-bold text-sm shrink-0 border border-emerald-500/30">
                                                {idx + 1}
                                            </div>
                                            <div>
                                                <div className="text-emerald-400 font-bold text-sm mb-1">{step.title}</div>
                                                <div className="text-xs text-slate-300 leading-relaxed">{step.desc}</div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                    </div>
                </div>
            );
        };

        const KasetCloudApp = ({ mapInstance, onTravelStart, onTravelEnd }) => {
            const [selectedRegion, setSelectedRegion] = useState(null);
            const [selectedProvince, setSelectedProvince] = useState(null);
            const [province, setProvince] = useState("‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£");
            const [area, setArea] = useState(1);
            const [analyzing, setAnalyzing] = useState(false);
            const [results, setResults] = useState(null);

            // --- STATE ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å ---
            // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢ Mock Data ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏™‡∏°‡∏≠ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢
            const [appData, setAppData] = useState({
                regions: MOCK_REGIONS,
                provinceData: MOCK_PROVINCE_DATA,
                crops: MOCK_CROPS,
                isLoading: true,
                isOnline: false
            });

            const [soilInfo, setSoilInfo] = useState(MOCK_PROVINCE_DATA["‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£"]);
            const [isFullSheet, setIsFullSheet] = useState(false);
            const [hasArrived, setHasArrived] = useState(false);

            const [itemsPerPage, setItemsPerPage] = useState(5);
            const [currentPage, setCurrentPage] = useState(1);
            const listContainerRef = useRef(null);

            const [weatherData, setWeatherData] = useState(null);
            const [address, setAddress] = useState({
                village: '-', subDistrict: '-', district: '-', province: '‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£', postcode: '-'
            });
            const [floodData, setFloodData] = useState({ risk: 'Low', history: [], desc: '‡∏õ‡∏Å‡∏ï‡∏¥' });

            const [userHasInteracted, setUserHasInteracted] = useState(false);
            const [simulatingItem, setSimulatingItem] = useState(null);
            const [isFullscreen, setIsFullscreen] = useState(false);

            const kasetMarkerRef = useRef(null);
            const debounceRef = useRef(null);

            // --- FETCH DATA LOGIC (‡∏´‡∏±‡∏ß‡πÉ‡∏à‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç) ---
            useEffect(() => {
                const fetchMasterData = async () => {
                    // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏™‡πà Key ‡∏´‡∏£‡∏∑‡∏≠ init ‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏õ‡πÉ‡∏ä‡πâ Mock ‡πÄ‡∏•‡∏¢
                    if (!supabase) {
                        console.warn("‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Supabase ‡∏´‡∏£‡∏∑‡∏≠ URL ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á - ‡πÉ‡∏ä‡πâ Mock Data");
                        setAppData(prev => ({ ...prev, isLoading: false, isOnline: false }));
                        return;
                    }

                    try {
                        // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• 2 ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô
                        const [provRes, cropRes] = await Promise.all([
                            supabase.from('provinces').select('*'),
                            supabase.from('crops').select('*')
                        ]);

                        if (provRes.error) throw provRes.error;
                        if (cropRes.error) throw cropRes.error;

                        if (provRes.data && provRes.data.length > 0) {
                            // 1. ‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î
                            const newRegions = {};
                            const newProvinceData = {};

                            provRes.data.forEach(p => {
                                if (!newRegions[p.region]) newRegions[p.region] = [];
                                newRegions[p.region].push(p.name);

                                newProvinceData[p.name] = {
                                    lat: p.lat,
                                    lng: p.lng,
                                    ph: p.ph,
                                    moisture: p.moisture,
                                    soil: p.soil_type,
                                    region: p.region
                                };
                            });

                            // 2. ‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡∏ä
                            const newCrops = cropRes.data.map(c => ({
                                ...c,
                                primarySource: c.primary_source,
                                marketLocation: c.market_location,
                                yieldUnit: c.yield_unit,
                                costStructure: c.cost_structure, // ‡πÅ‡∏õ‡∏•‡∏á field ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö React
                                farmingSteps: c.farming_steps,
                                lifecycle: c.lifecycle,
                                profitTotal: 0,
                                costTotal: 0
                            }));

                            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï State ‡∏î‡πâ‡∏ß‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á
                            setAppData({
                                regions: newRegions,
                                provinceData: newProvinceData,
                                crops: newCrops,
                                isLoading: false,
                                isOnline: true
                            });

                            // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                            if (newProvinceData["‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£"]) {
                                setSoilInfo(newProvinceData["‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£"]);
                            }
                        }
                    } catch (error) {
                        console.error("‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Database ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ, ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ Mock Data:", error);
                        // ‡∏ñ‡πâ‡∏≤‡∏û‡∏±‡∏á ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ Mock Data ‡πÄ‡∏î‡∏¥‡∏° (‡πÑ‡∏°‡πà‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏£‡∏≤‡∏∞ init ‡∏î‡πâ‡∏ß‡∏¢ Mock ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß)
                        setAppData(prev => ({ ...prev, isLoading: false, isOnline: false }));
                    }
                };

                fetchMasterData();
            }, []);

            const toggleFullScreen = () => {
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen().then(() => setIsFullscreen(true));
                } else {
                    if (document.exitFullscreen) {
                        document.exitFullscreen().then(() => setIsFullscreen(false));
                    }
                }
            };

            // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏≥‡∏•‡∏≠‡∏á ‡πÉ‡∏´‡πâ‡∏Ç‡∏¢‡∏≤‡∏¢ BottomSheet ‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ä‡∏±‡∏î
            useEffect(() => {
                if (simulatingItem) {
                    setIsFullSheet(true);
                }
            }, [simulatingItem]);

            const analyzeData = () => {
                const baseData = appData.crops; // ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å State (DB ‡∏´‡∏£‡∏∑‡∏≠ Mock)

                const calculated = baseData.map(item => {
                    let y = item.yield, c = item.cost;
                    // Logic ‡∏õ‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
                    if (item.name.includes("‡∏ó‡∏∏‡πÄ‡∏£‡∏µ‡∏¢‡∏ô")) {
                        const priceFactor = 0.85;
                        item.price = item.price * priceFactor;
                    }
                    if (item.name.includes("‡∏°‡∏±‡∏ô‡∏™‡∏≥‡∏õ‡∏∞‡∏´‡∏•‡∏±‡∏á")) {
                        y *= 0.85;
                        item.price *= 1.1;
                    }

                    if (floodData.risk === 'High') {
                        c *= 1.3;
                        if (!item.name.includes("‡∏Ç‡πâ‡∏≤‡∏ß")) y *= 0.5;
                    }

                    const soilType = soilInfo.soil || soilInfo.soil_type || "";
                    if (soilType.includes("‡∏ó‡∏£‡∏≤‡∏¢") && item.name.includes("‡∏Ç‡πâ‡∏≤‡∏ß")) {
                        y *= 0.8;
                    }
                    if (weatherData && weatherData.dailyRain < 2 && item.name.includes("‡∏Ç‡πâ‡∏≤‡∏ß")) {
                        y *= 0.9;
                    }

                    const rev = item.price * (y / 1000) * area;
                    const cost = c * area;

                    const usedSources = [];
                    if (GOV_SOURCES[item.primarySource]) usedSources.push(GOV_SOURCES[item.primarySource]);
                    if (floodData.risk !== 'Low') usedSources.push(GOV_SOURCES.GISTDA);
                    if (soilType !== '‡∏î‡∏¥‡∏ô‡∏£‡πà‡∏ß‡∏ô') usedSources.push(GOV_SOURCES.LDD);

                    return {
                        ...item,
                        profitTotal: rev - cost,
                        costTotal: cost,
                        risk_level: item.risk,
                        history: [],
                        refSources: usedSources
                    };
                });

                setResults(calculated.sort((a, b) => b.profitTotal - a.profitTotal));
                setAnalyzing(false);
                setCurrentPage(1);
            };

            useEffect(() => {
                const handleResize = () => {
                    if (listContainerRef.current) {
                        const containerHeight = listContainerRef.current.clientHeight;
                        const itemElement = listContainerRef.current.querySelector('.group');
                        const itemHeight = itemElement ? itemElement.offsetHeight : 100;
                        const calculatedItems = Math.floor(containerHeight / itemHeight);
                        setItemsPerPage(Math.max(3, calculatedItems));
                    }
                };
                handleResize();
                const timer = setTimeout(handleResize, 600);
                window.addEventListener('resize', handleResize);
                return () => {
                    window.removeEventListener('resize', handleResize);
                    clearTimeout(timer);
                };
            }, [isFullSheet, results, province]);

            useEffect(() => {
                if (mapInstance && appData.provinceData[province]) {
                    const targetInfo = appData.provinceData[province];
                    mapInstance.dragging.enable();
                    mapInstance.touchZoom.enable();
                    mapInstance.doubleClickZoom.enable();
                    mapInstance.scrollWheelZoom.enable();
                    mapInstance.boxZoom.enable();
                    mapInstance.keyboard.enable();
                    if (mapInstance.tap) mapInstance.tap.enable();
                    mapInstance.getContainer().style.cursor = 'grab';

                    if (!kasetMarkerRef.current) {
                        const marker = L.marker([targetInfo.lat, targetInfo.lng], { draggable: true }).addTo(mapInstance);
                        marker.bindPopup(`<b>${province}</b><br>‡∏•‡∏≤‡∏Å‡∏´‡∏°‡∏∏‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÅ‡∏õ‡∏•‡∏á`).openPopup();
                        marker.on('dragend', async function (event) {
                            const m = event.target;
                            const position = m.getLatLng();
                            setSoilInfo(prev => ({ ...prev, lat: position.lat, lng: position.lng }));
                            await fetchDetailedAddress(position.lat, position.lng);
                            setFloodData(calculateFloodRisk(position.lat, position.lng));
                            fetchDetailedWeather(position.lat, position.lng);
                            setUserHasInteracted(true);
                            m.setPopupContent(`<b>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà...</b>`).openPopup();
                        });
                        marker.on('mouseover', () => { mapInstance.getContainer().style.cursor = 'pointer'; });
                        marker.on('mouseout', () => { mapInstance.getContainer().style.cursor = 'grab'; });
                        kasetMarkerRef.current = marker;
                    } else {
                        if (!userHasInteracted || selectedRegion) {
                            kasetMarkerRef.current.setLatLng([targetInfo.lat, targetInfo.lng]);
                        }
                    }
                }
                return () => {
                    if (kasetMarkerRef.current) {
                        kasetMarkerRef.current.remove();
                        kasetMarkerRef.current = null;
                    }
                };
            }, [mapInstance, province, appData.provinceData]);

            const fetchDetailedAddress = async (lat, lng) => {
                try {
                    const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`, { headers: { 'User-Agent': 'WinaiPortal/1.0' } });
                    const data = await res.json();
                    if (data && data.address) {
                        setAddress({
                            village: data.address.village || data.address.hamlet || '-',
                            subDistrict: data.address.suburb || data.address.quarter || data.address.neighbourhood || '-',
                            district: data.address.city_district || data.address.district || data.address.county || '-',
                            province: data.address.province || data.address.state || province,
                            postcode: data.address.postcode || '-'
                        });
                        if (kasetMarkerRef.current) {
                            kasetMarkerRef.current.setPopupContent(
                                `<b>üìç ‡∏û‡∏¥‡∏Å‡∏±‡∏î:</b> ${data.address.suburb || '-'}<br>‡∏≠.${data.address.district || '-'}`
                            ).openPopup();
                        }
                    }
                } catch (e) { console.error("Address fetch failed", e); }
            };

            const calculateFloodRisk = (lat, lng) => {
                const hash = Math.abs(Math.sin(lat * 1000 + lng) * 10000);
                const riskLevel = hash % 100;
                if (riskLevel > 80) return { risk: 'High', desc: '‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏™‡∏π‡∏á‡∏°‡∏≤‡∏Å', history: ['2554', '2564', '2565'] };
                if (riskLevel > 50) return { risk: 'Medium', desc: '‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á', history: ['2565'] };
                return { risk: 'Low', desc: '‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ï‡πà‡∏≥', history: [] };
            };

            const fetchDetailedWeather = async (lat, lng) => {
                try {
                    const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&current=temperature_2m,rain,surface_pressure&daily=temperature_2m_max,temperature_2m_min,precipitation_sum&timezone=Asia%2FBangkok&forecast_days=1`);
                    const data = await res.json();
                    if (data && data.current && data.daily) {
                        setWeatherData({
                            temp: data.current.temperature_2m,
                            rain: data.current.rain,
                            tempMax: data.daily.temperature_2m_max[0],
                            tempMin: data.daily.temperature_2m_min[0],
                            dailyRain: data.daily.precipitation_sum[0],
                            seasonalAvgTemp: data.daily.temperature_2m_max[0] - 2,
                            seasonalAvgRain: 1200
                        });
                    }
                } catch (e) { setWeatherData(null); }
            };

            useEffect(() => {
                if (soilInfo.lat) {
                    fetchDetailedWeather(soilInfo.lat, soilInfo.lng);
                    fetchDetailedAddress(soilInfo.lat, soilInfo.lng);
                    setFloodData(calculateFloodRisk(soilInfo.lat, soilInfo.lng));
                }
            }, [soilInfo.lat, soilInfo.lng]);

            useEffect(() => {
                if (debounceRef.current) clearTimeout(debounceRef.current);
                setAnalyzing(true);
                debounceRef.current = setTimeout(analyzeData, 800);
                return () => clearTimeout(debounceRef.current);
            }, [province, area, weatherData, floodData, appData.crops]);

            const handleRegionSelect = (regionName) => {
                setSelectedRegion(regionName);
            };

            const handleProvinceSelect = async (provName) => {
                setSelectedProvince(provName);
                setProvince(provName);
                setHasArrived(false);

                const info = appData.provinceData[provName];
                setSoilInfo(info);
                setUserHasInteracted(true);
                if (mapInstance) {
                    const startLat = DON_MUEANG_COORDS[0];
                    const startLng = DON_MUEANG_COORDS[1];
                    const endLat = info.lat;
                    const endLng = info.lng;
                    const bearing = getBearing(startLat, startLng, endLat, endLng);

                    onTravelStart(`‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Å‡∏≤‡∏£‡∏ö‡∏¥‡∏ô...`, bearing);

                    const midLat = (startLat + endLat) / 2;
                    const midLng = (startLng + endLng) / 2;
                    const slowNetTimer = setTimeout(() => {
                        onTravelStart(`‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏≠‡∏¥‡∏ô‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï‡πÄ‡∏¢‡∏≠‡∏∞‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...`, bearing);
                    }, 2000);

                    const cacheTasks = [
                        checkAndPreloadTiles(startLat, startLng, 9),
                        checkAndPreloadTiles(midLat, midLng, 9),
                        checkAndPreloadTiles(endLat, endLng, 9)
                    ];

                    await Promise.all(cacheTasks);
                    clearTimeout(slowNetTimer);

                    onTravelStart(`‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏≠‡∏≠‡∏Å‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡πÑ‡∏õ ${provName}!`, bearing);

                    setTimeout(() => {
                        const offsetLat = info.lat - 0.15;
                        mapInstance.flyTo([offsetLat, info.lng], 9, { duration: 8, easeLinearity: 0.25 });
                        setTimeout(() => {
                            onTravelEnd();
                            setHasArrived(true);
                            if (kasetMarkerRef.current) {
                                kasetMarkerRef.current.setLatLng([info.lat, info.lng]);
                            }
                        }, 8000);
                    }, 500);
                }
            };

            const resetRegion = () => {
                setSelectedRegion(null);
                setSelectedProvince(null);
                if (mapInstance) mapInstance.flyTo(DON_MUEANG_COORDS, 10, { duration: 4 });
            };

            const handleProvinceChange = (e) => {
                const p = e.target.value;
                setProvince(p);
                setHasArrived(true);

                const info = appData.provinceData[p];
                setSoilInfo(info);
                setUserHasInteracted(true);
                if (mapInstance && kasetMarkerRef.current) {
                    const offsetLat = info.lat - 0.15;
                    mapInstance.flyTo([offsetLat, info.lng], 10, { duration: 3 });
                    kasetMarkerRef.current.setLatLng([info.lat, info.lng]);
                }
            };

            const inputContainerClass = !userHasInteracted
                ? "bg-slate-900/40 backdrop-blur-xl p-2 rounded-full border border-yellow-400/50 shadow-[0_0_20px_rgba(250,204,21,0.5)] animate-attention transition-all duration-300 transform scale-105"
                : "bg-slate-900/30 backdrop-blur-xl px-4 py-1.5 rounded-full border border-white/10 shadow-lg transition-all duration-300";

            // ‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏™‡πÉ‡∏´‡πâ‡πÉ‡∏™‡∏õ‡∏¥‡πä‡∏á (‡πÄ‡∏≠‡∏≤ backdrop-blur ‡∏≠‡∏≠‡∏Å) ‡πÅ‡∏•‡∏∞‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏°‡∏Ç‡∏≠‡∏á‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á
            const resultHeaderClass = "w-full min-h-14 flex flex-col justify-center px-4 py-2 bg-slate-900/60 backdrop-blur-none text-white cursor-pointer pointer-events-auto rounded-t-2xl border-t border-white/10 shadow-[0_-5px_20px_rgba(0,0,0,0.3)]";

            const totalPages = results ? Math.ceil(results.length / itemsPerPage) : 0;
            const paginatedResults = results ? results.slice((currentPage - 1) * itemsPerPage, currentPage * itemsPerPage) : [];
            const bottomSheetClass = `absolute bottom-0 left-0 right-0 mx-auto w-full md:max-w-4xl lg:max-w-5xl bg-transparent z-[1000] bottom-sheet flex flex-col pointer-events-none transition-all duration-500 ${isFullSheet || !selectedProvince ? 'h-[90%] max-h-[95dvh]' : 'h-[60%] max-h-[70dvh] landscape:h-[80%]'}`;

            if (appData.isLoading) {
                return (
                    <div className="absolute inset-0 flex items-center justify-center bg-black/50 z-[2000] text-white backdrop-blur-sm">
                        <div className="text-center">
                            <i className="fa-solid fa-cloud-arrow-down fa-spin text-4xl mb-4 text-emerald-400"></i>
                            <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="relative w-full h-[100dvh] overflow-hidden ui-layer pointer-events-none">
                    <button onClick={toggleFullScreen} className="absolute top-6 right-6 z-[1050] bg-slate-900/10 backdrop-blur-xl border border-white/20 text-white w-10 h-10 rounded-full flex items-center justify-center hover:bg-slate-800/40 hover:scale-110 transition-all shadow-lg pointer-events-auto">
                        <i className={`fa-solid ${isFullscreen ? 'fa-compress' : 'fa-expand'} text-sm`}></i>
                    </button>

                    {/* Offline Indicator */}
                    {!appData.isOnline && (
                        <div className="absolute top-20 right-6 z-[1050] bg-red-500/80 backdrop-blur-md px-3 py-1 rounded-full text-[10px] text-white shadow-lg pointer-events-auto flex items-center gap-2">
                            <i className="fa-solid fa-wifi-slash"></i> Offline Mode (Mock Data)
                        </div>
                    )}

                    {selectedProvince && (
                        <div className="absolute top-4 left-1/2 -translate-x-1/2 z-[990] w-full pointer-events-auto">
                            <div className={inputContainerClass + " flex flex-row items-center gap-2 justify-center w-fit mx-auto"}>
                                <button onClick={resetRegion} className="w-8 h-8 rounded-full bg-white/10 hover:bg-white/20 text-white flex items-center justify-center transition mr-1" title="‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏†‡∏π‡∏°‡∏¥‡∏†‡∏≤‡∏Ñ">
                                    <i className="fa-solid fa-arrow-left"></i>
                                </button>
                                <div className="relative group">
                                    <i className={`fa-solid fa-location-dot absolute left-2 top-2 text-xs z-10 ${!userHasInteracted ? 'text-yellow-400 animate-bounce' : 'text-emerald-300'}`}></i>
                                    <select className={`w-[140px] py-1.5 pl-7 pr-4 text-xs rounded-full text-white focus:outline-none appearance-none cursor-pointer font-bold ${!userHasInteracted ? 'bg-yellow-500/20 border-yellow-500' : 'bg-transparent border border-white/30'}`}
                                        value={province} onChange={handleProvinceChange}>
                                        {(appData.regions[selectedRegion] || []).sort().map(p => (
                                            <option key={p} value={p} className="text-white bg-slate-800">{p}</option>
                                        ))}
                                    </select>
                                </div>
                                <div className="flex items-center gap-2">
                                    <input
                                        type="number" step="0.1" min="0" value={area}
                                        onChange={(e) => { const val = parseFloat(e.target.value); setArea(isNaN(val) ? 0 : Math.max(0, val)); setUserHasInteracted(true); }}
                                        className={`w-[50px] py-1.5 text-xs text-center rounded-full text-white focus:outline-none font-bold ${!userHasInteracted ? 'bg-yellow-500/20 border border-yellow-500 placeholder-yellow-200' : 'bg-transparent border border-white/30'}`}
                                        placeholder="‡πÑ‡∏£‡πà"
                                    />
                                    <span className={`text-[10px] font-bold ${!userHasInteracted ? 'text-yellow-300' : 'text-white/80'}`}>‡πÑ‡∏£‡πà</span>
                                </div>
                            </div>
                        </div>
                    )}

                    {selectedProvince && (
                        <>
                            <div className="absolute top-[80px] left-4 z-[950] pointer-events-none flex flex-col gap-2 text-[10px] md:text-xs text-white drop-shadow-[0_1px_2px_rgba(0,0,0,0.8)] max-w-[45%]">
                                <div>
                                    <div className="font-bold text-emerald-300"><i className="fa-solid fa-map-pin"></i> ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</div>
                                    <div className="text-white/80">{address.village}</div>
                                    <div className="text-white/80">{address.subDistrict} {'>'} {address.district}</div>
                                </div>
                            </div>

                            <div className="absolute top-[80px] right-4 z-[950] pointer-events-none flex flex-col gap-2 text-[10px] md:text-xs text-white drop-shadow-[0_1px_2px_rgba(0,0,0,0.8)] text-right items-end max-w-[45%]">
                                <div>
                                    <div className="font-bold text-blue-300"><i className="fa-solid fa-temperature-half"></i> ‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥</div>
                                    <div className="text-xl font-bold">{weatherData ? weatherData.temp : '-'}¬∞C</div>
                                </div>
                            </div>
                        </>
                    )}

                    <div className={bottomSheetClass}>
                        {!selectedRegion ? (
                            <div className="flex-1 flex items-center justify-center p-6 pointer-events-auto">
                                <div className="w-full max-w-2xl grid grid-cols-2 gap-4 animate-fade-in-up">
                                    {Object.keys(appData.regions).map((region) => (
                                        <button
                                            key={region}
                                            onClick={() => handleRegionSelect(region)}
                                            className="bg-slate-900/60 hover:bg-emerald-900/60 backdrop-blur-md border border-white/10 rounded-xl p-6 flex flex-col items-center justify-center gap-2 transition-all hover:scale-105 shadow-lg group h-32"
                                        >
                                            <span className="text-3xl group-hover:animate-bounce">
                                                {region === '‡πÄ‡∏´‡∏ô‡∏∑‡∏≠' && 'üå≤'}
                                                {region === '‡∏≠‡∏µ‡∏™‡∏≤‡∏ô' && 'üçÇ'}
                                                {region === '‡∏Å‡∏•‡∏≤‡∏á' && 'üèôÔ∏è'}
                                                {region === '‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å' && 'üè≠'}
                                                {region === '‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏ï‡∏Å' && '‚õ∞Ô∏è'}
                                                {region === '‡πÉ‡∏ï‡πâ' && 'üåä'}
                                            </span>
                                            <span className="text-xl font-bold text-white">‡∏†‡∏≤‡∏Ñ{region}</span>
                                        </button>
                                    ))}
                                </div>
                            </div>
                        ) : !selectedProvince ? (
                            <div className="flex-1 flex flex-col items-center p-4 pointer-events-auto bg-slate-900/80 rounded-t-3xl backdrop-blur-md max-w-2xl mx-auto w-full border-t border-white/10">
                                <div className="flex items-center gap-4 mb-4 w-full px-4">
                                    <button onClick={() => setSelectedRegion(null)} className="text-white/70 hover:text-white"><i className="fa-solid fa-arrow-left"></i></button>
                                    <h2 className="text-xl font-bold text-white">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡πÉ‡∏ô‡∏†‡∏≤‡∏Ñ{selectedRegion}</h2>
                                </div>
                                <div className="w-full grid grid-cols-3 gap-2 overflow-y-auto pb-10 scrollbar-prominent px-2">
                                    {(appData.regions[selectedRegion] || []).sort().map(p => (
                                        <button
                                            key={p}
                                            onClick={() => handleProvinceSelect(p)}
                                            className="bg-white/5 hover:bg-white/10 border border-white/5 rounded-lg p-3 text-xs md:text-sm font-bold text-white transition-all"
                                        >
                                            {p}
                                        </button>
                                    ))}
                                </div>
                            </div>
                        ) : (
                            hasArrived && (
                                <>
                                    {isFullSheet && !simulatingItem && <button onClick={() => setIsFullSheet(false)} className="absolute top-4 right-4 z-[1010] text-white/50 hover:text-white pointer-events-auto"><i className="fa-solid fa-chevron-down text-xl"></i></button>}

                                    <div className={resultHeaderClass} onClick={() => !simulatingItem && setIsFullSheet(!isFullSheet)}>
                                        {!simulatingItem ? (
                                            <div className="flex flex-wrap justify-between items-center w-full gap-2">
                                                <div className="flex flex-col items-start gap-1">
                                                    <div className={`font-bold text-base md:text-lg flex items-center gap-2 ${userHasInteracted ? 'text-emerald-200' : 'text-emerald-400'}`}>
                                                        <i className="fa-solid fa-ranking-star"></i>
                                                        <span className="truncate max-w-[200px] sm:max-w-none">‡∏û‡∏∑‡∏ä‡πÄ‡∏®‡∏£‡∏©‡∏ê‡∏Å‡∏¥‡∏à ({selectedProvince})</span>
                                                    </div>
                                                    <div className="text-[10px] text-slate-400 font-light leading-tight">
                                                        ‡∏ú‡∏•‡∏¥‡∏ï‡πÇ‡∏î‡∏¢: Mr.Winai Phanarkat | ‡πÑ‡∏•‡∏ô‡πå: 0926533228
                                                    </div>
                                                </div>

                                                <div className="flex items-center gap-3" onClick={(e) => e.stopPropagation()}>
                                                    {results && results.length > itemsPerPage && (
                                                        <div className="flex items-center gap-2 text-xs bg-white/5 rounded-full px-2 py-1 border border-white/5">
                                                            <button onClick={() => setCurrentPage(p => Math.max(1, p - 1))} disabled={currentPage === 1} className={`w-6 h-6 flex items-center justify-center rounded-full transition ${currentPage === 1 ? 'text-slate-500' : 'text-white hover:bg-white/20'}`}><i className="fa-solid fa-chevron-left"></i></button>
                                                            <span className="font-mono text-yellow-400">{currentPage}/{totalPages}</span>
                                                            <button onClick={() => setCurrentPage(p => Math.min(totalPages, p + 1))} disabled={currentPage === totalPages} className={`w-6 h-6 flex items-center justify-center rounded-full transition ${currentPage === totalPages ? 'text-slate-500' : 'text-white hover:bg-white/20'}`}><i className="fa-solid fa-chevron-right"></i></button>
                                                        </div>
                                                    )}
                                                    <div className="text-slate-400 text-sm ml-2" onClick={() => setIsFullSheet(!isFullSheet)}>
                                                        <i className={`fa-solid fa-chevron-up transition-transform ${isFullSheet ? 'rotate-180' : ''}`}></i>
                                                    </div>
                                                </div>
                                            </div>
                                        ) : (
                                            <div className="w-full h-1"></div> /* Spacer when simulating */
                                        )}
                                    </div>

                                    {/* Content Container - Glass Effect ‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÉ‡∏™‡∏õ‡∏¥‡πä‡∏á */}
                                    <div className="flex-1 flex flex-col pointer-events-auto bg-slate-900/60 border-t-0 border-white/10 backdrop-blur-none">
                                        <div
                                            ref={listContainerRef}
                                            className="flex-1 overflow-y-scroll scrollbar-prominent pb-10 pointer-events-auto overscroll-contain relative"
                                            style={{ WebkitOverflowScrolling: 'touch', touchAction: 'pan-y', isolation: 'isolate' }}
                                            onWheel={(e) => { e.stopPropagation(); }}
                                            onMouseDown={(e) => { e.stopPropagation(); }}
                                            onTouchStart={(e) => { e.stopPropagation(); }}
                                        >
                                            {/* Logic: Show List OR Show Simulation Panel embedded */}
                                            {simulatingItem ? (
                                                <SimulationPanel
                                                    item={simulatingItem}
                                                    initialArea={area}
                                                    floodData={floodData}
                                                    soilInfo={soilInfo}
                                                    onClose={() => setSimulatingItem(null)}
                                                />
                                            ) : (
                                                results ? paginatedResults.map((item, i) => {
                                                    const realIndex = (currentPage - 1) * itemsPerPage + i;
                                                    return (
                                                        <div key={realIndex} onClick={() => setSimulatingItem(item)}
                                                            className="group flex flex-col sm:flex-row items-start sm:items-center justify-between border-b border-white/5 p-4 cursor-pointer transition hover:bg-white/5 px-4 md:px-6 w-full gap-3">
                                                            <div className="flex items-start gap-3 w-full sm:w-auto">
                                                                <div className="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center text-sm font-bold text-emerald-400 border border-emerald-500/20 shrink-0 shadow-lg mt-1 sm:mt-0">
                                                                    {realIndex + 1}
                                                                </div>
                                                                <div className="flex flex-col gap-1 w-full">
                                                                    <span className="text-base md:text-lg font-bold text-slate-100 leading-snug group-hover:text-yellow-400 transition break-words">{item.name}</span>
                                                                    <div className="flex flex-wrap items-center gap-2 opacity-80">
                                                                        {item.refSources && item.refSources.map((src, idx) => (
                                                                            <span key={idx} className={`text-[9px] px-1.5 py-0.5 rounded ${src.color} bg-white/5 border border-white/5 flex items-center gap-1 whitespace-nowrap`}>
                                                                                <i className={`fa-solid ${src.icon} text-[8px]`}></i>
                                                                                {src.name}
                                                                            </span>
                                                                        ))}
                                                                    </div>
                                                                    <div className="flex flex-col text-[10px] text-slate-400 mt-1">
                                                                        <span>‡∏£‡∏≤‡∏Ñ‡∏≤: {item.price.toLocaleString()} ‡∏ø</span>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div className="flex items-center justify-between sm:justify-end w-full sm:w-auto gap-4 pl-11 sm:pl-0 mt-2 sm:mt-0">
                                                                <div className="flex flex-col text-left sm:text-right">
                                                                    <span className="text-[10px] text-slate-500 leading-tight">‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</span>
                                                                    <span className={`text-base md:text-xl font-bold ${item.profitTotal > 0 ? 'text-emerald-400' : 'text-red-400'}`}>
                                                                        {item.profitTotal > 0 ? '+' : ''}{item.profitTotal.toLocaleString()}
                                                                    </span>
                                                                </div>
                                                                <button
                                                                    className="w-8 h-8 rounded-full bg-emerald-500/20 text-emerald-400 hover:bg-emerald-500 hover:text-white flex items-center justify-center transition shrink-0 border border-emerald-500/30"
                                                                >
                                                                    <i className="fa-solid fa-chevron-right text-xs"></i>
                                                                </button>
                                                            </div>
                                                        </div>
                                                    );
                                                }) : <div className="text-center p-10 text-slate-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå...</div>
                                            )}
                                        </div>
                                    </div>
                                </>
                            )
                        )}
                    </div>
                </div>
            );
        };

        const HomePage = ({ setPage, onStartTransition }) => {
            const [isFullscreen, setIsFullscreen] = useState(false);
            const toggleFullScreen = () => {
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen().then(() => setIsFullscreen(true));
                } else {
                    if (document.exitFullscreen) {
                        document.exitFullscreen().then(() => setIsFullscreen(false));
                    }
                }
            };

            useEffect(() => {
                checkAndPreloadTiles(13.9133, 100.6042, 10);
            }, []);

            return (
                <div className="min-h-screen relative flex flex-col items-center justify-center text-white p-6 overflow-hidden ui-layer">
                    <div className="absolute inset-0 w-full h-full pointer-events-none z-0 overflow-hidden">
                        <div className="cloud-layer opacity-30 mix-blend-screen"></div>
                        <div className="cloud-layer opacity-20 mix-blend-screen" style={{ animationDirection: 'reverse', animationDuration: '60s' }}></div>
                    </div>

                    <button onClick={toggleFullScreen} className="absolute top-6 right-6 z-50 bg-white/5 backdrop-blur-md border border-white/10 text-white w-10 h-10 rounded-full flex items-center justify-center hover:bg-white/10 transition-all shadow-lg group">
                        <i className={`fa-solid ${isFullscreen ? 'fa-compress' : 'fa-expand'} text-sm group-hover:text-emerald-400`}></i>
                    </button>

                    <div className="z-20 text-center animate-fade-in-up relative flex flex-col items-center">
                        <div className="relative mb-4 pr-2">
                            <div className="absolute top-0 right-[-3px] w-2 h-2 bg-yellow-400 rounded-full shadow-[0_0_5px_rgba(250,204,21,0.8)] z-20"></div>
                            <div className="absolute top-0 right-[-1px] w-1 h-20 bg-slate-400 rounded-b-full shadow-sm z-0"></div>
                            <img src="https://upload.wikimedia.org/wikipedia/commons/a/a9/Flag_of_Thailand.svg" alt="Thai Flag" className="w-24 h-auto animate-flag-wave relative z-10" style={{ transformOrigin: 'center right' }} />
                        </div>

                        <h1 className="text-5xl md:text-7xl font-bold mb-2 text-transparent bg-clip-text bg-gradient-to-r from-yellow-300 via-emerald-400 to-cyan-400 drop-shadow-[0_2px_10px_rgba(0,0,0,0.8)]">
                            Winai Innovation
                        </h1>
                        <p className="text-slate-200 text-lg md:text-xl mb-2 drop-shadow-md font-light bg-black/30 px-4 py-1 rounded-full inline-block backdrop-blur-sm border border-white/10">
                            Super App ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£‡πÑ‡∏ó‡∏¢
                        </p>

                        <div className="flex flex-col gap-6 w-full max-w-sm mx-auto">
                            <button onClick={onStartTransition} className="btn-super-pulse bg-gradient-to-r from-emerald-600 to-teal-600 p-5 rounded-2xl font-bold text-xl text-white hover:scale-105 transition transform shadow-[0_0_20px_rgba(16,185,129,0.4)] border border-emerald-400/30 relative overflow-hidden group">
                                <div className="absolute inset-0 bg-white/20 group-hover:bg-white/30 transition"></div>
                                <div className="relative flex items-center justify-center gap-3">
                                    <i className="fa-solid fa-globe text-2xl animate-spin-slow"></i>
                                    <span>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà Kaset Cloud</span>
                                </div>
                            </button>

                            <div className="bg-white/5 px-6 py-4 rounded-xl backdrop-blur-md border border-white/5 flex flex-col items-center w-full">
                                <div className="flex flex-wrap justify-center gap-3 mb-3">
                                    <a href="https://line.me/ti/p/-M5tBwhz9j" target="_blank" className="inline-flex items-center justify-center gap-2 bg-[#06C755] hover:bg-[#05a546] text-white py-1 px-3 rounded-full text-xs font-bold shadow-sm transition hover:scale-105">
                                        <i className="fa-brands fa-line text-lg"></i>
                                        ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ Admin
                                    </a>
                                </div>
                                <div className="text-[10px] md:text-xs text-slate-400">
                                    <p className="mb-1 font-bold text-slate-300">‡∏ú‡∏•‡∏¥‡∏ï‡πÇ‡∏î‡∏¢: Mr.Winai Phanarkat</p>
                                    <p>‡πÑ‡∏•‡∏ô‡πå: 0926533228 | ‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πå: winayo@gmail.com</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const VinaiInnovationPortal = () => {
            const [page, setPage] = useState('home');
            const [isTransitioning, setIsTransitioning] = useState(false);
            const [travelState, setTravelState] = useState({ active: false, message: '', rotation: 0 });
            const mapRef = useRef(null);
            const rotationInterval = useRef(null);

            const jetSoundRef = useRef(new Audio('https://www.soundjay.com/transportation/sounds/airplane-fly-by-01.mp3'));

            const playJetSound = () => {
                try {
                    jetSoundRef.current.currentTime = 0;
                    jetSoundRef.current.volume = 0.5;
                    jetSoundRef.current.play().catch(e => console.log("Audio play failed"));
                } catch (e) { }
            };

            useEffect(() => {
                if (!document.getElementById('global-map')) return;
                const map = L.map('global-map', { zoomControl: false, attributionControl: false, zoomSnap: 0.1, minZoom: 2 }).setView([13.7563, 100.5018], 2.5);
                L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Tiles &copy; Esri' }).addTo(map);
                L.tileLayer('https://mt1.google.com/vt/lyrs=h&x={x}&y={y}&z={z}', { opacity: 0.5 }).addTo(map);
                L.control.zoom({ position: 'bottomright' }).addTo(map);
                mapRef.current = map;
                startRotation(map);
                return () => { if (map) map.remove(); stopRotation(); };
            }, []);

            const startRotation = (map) => {
                if (rotationInterval.current) clearInterval(rotationInterval.current);
                map.dragging.disable(); map.scrollWheelZoom.disable(); map.touchZoom.disable(); map.doubleClickZoom.disable();
                rotationInterval.current = setInterval(() => { if (map) map.panBy([1, 0], { animate: false }); }, 50);
            };

            const stopRotation = () => {
                if (rotationInterval.current) { clearInterval(rotationInterval.current); rotationInterval.current = null; }
            };

            useEffect(() => {
                if (page === 'kaset') {
                    stopRotation();
                }
            }, [page]);

            const startTravel = (msg, rotation = 0) => {
                playJetSound();
                setTravelState({ active: true, message: msg, rotation: rotation });
            };

            const endTravel = () => setTravelState({ active: false, message: '', rotation: 0 });

            const handleStartKaset = () => {
                if (!mapRef.current) return;
                playJetSound();
                setIsTransitioning(true);
                setTravelState({ active: true, message: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡πÑ‡∏õ‡∏ó‡∏µ‡πà ‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£ (‡∏î‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡∏≠‡∏á)...' });
                stopRotation();
                mapRef.current.flyTo(DON_MUEANG_COORDS, 10, { duration: 8, easeLinearity: 0.25 });
                setTimeout(() => { setPage('kaset'); setIsTransitioning(false); setTravelState({ active: false, message: '' }); }, 8000);
            };

            const handleGoHome = () => {
                playJetSound();
                setPage('home');
                if (mapRef.current) {
                    mapRef.current.flyTo([13.7563, 100.5018], 2.5, { duration: 3 });
                    setTimeout(() => startRotation(mapRef.current), 3000);
                }
            };

            return (
                <div className="font-sans text-slate-200 h-[100dvh] w-screen overflow-hidden">
                    <div id="global-map"></div>
                    <CloudOverlay isActive={travelState.active} message={travelState.message} rotation={travelState.rotation} />

                    <button onClick={handleGoHome} className="absolute top-6 left-6 z-[1050] bg-white/10 hover:bg-white/20 text-white w-10 h-10 rounded-full flex items-center justify-center backdrop-blur-md border border-white/20 shadow-lg transition-all group pointer-events-auto" title="‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å">
                        <i className="fa-solid fa-house text-sm group-hover:text-emerald-400"></i>
                    </button>

                    {page === 'home' && <div className={`absolute inset-0 z-20 transition-opacity duration-1000 ${isTransitioning ? 'opacity-0 pointer-events-none' : 'opacity-100'}`}><HomePage setPage={setPage} onStartTransition={handleStartKaset} /></div>}
                    {page === 'kaset' && !isTransitioning && <KasetCloudApp mapInstance={mapRef.current} onTravelStart={startTravel} onTravelEnd={endTravel} />}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<VinaiInnovationPortal />);
    </script>
</body>

</html>
