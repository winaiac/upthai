<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Winai Innovation Portal - Super App ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡πÑ‡∏ó‡∏¢</title>

    <link rel="icon" type="image/svg+xml"
        href="https://upload.wikimedia.org/wikipedia/commons/a/a9/Flag_of_Thailand.svg">

    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;700&display=swap');

        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #0f172a;
            color: #f1f5f9;
            overflow: hidden;
            height: 100dvh;
        }

        .leaflet-container {
            cursor: grab !important;
        }

        .leaflet-container:active {
            cursor: grabbing !important;
        }

        .leaflet-interactive {
            cursor: pointer !important;
        }

        .animate-fade-in-up {
            animation: fadeInUp 0.8s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse-glow {

            0%,
            100% {
                box-shadow: 0 0 15px rgba(236, 72, 153, 0.6);
                transform: scale(1);
            }

            50% {
                box-shadow: 0 0 30px rgba(236, 72, 153, 1);
                transform: scale(1.05);
            }
        }

        .btn-super-pulse {
            animation: pulse-glow 2s infinite;
        }

        @keyframes flag-wave-left {
            0% {
                transform: perspective(400px) rotateY(-5deg) skewY(0deg) translateY(0);
            }

            25% {
                transform: perspective(400px) rotateY(-15deg) skewY(2deg) translateY(-2px);
            }

            50% {
                transform: perspective(400px) rotateY(-5deg) skewY(0deg) translateY(0);
            }

            75% {
                transform: perspective(400px) rotateY(5deg) skewY(-2deg) translateY(2px);
            }

            100% {
                transform: perspective(400px) rotateY(-5deg) skewY(0deg) translateY(0);
            }
        }

        .animate-flag-wave {
            animation: flag-wave-left 3s infinite cubic-bezier(0.45, 0.05, 0.55, 0.95);
            transform-origin: bottom right;
            filter: drop-shadow(0 10px 10px rgba(0, 0, 0, 0.5));
        }

        .scrollbar-prominent {
            scrollbar-width: thin;
            scrollbar-color: #fbbf24 #0f172a;
        }

        .scrollbar-prominent::-webkit-scrollbar {
            width: 12px;
            height: 12px;
            display: block;
            -webkit-appearance: none;
        }

        .scrollbar-prominent::-webkit-scrollbar-track {
            background: #0f172a;
            border-radius: 0;
            border-left: 1px solid #334155;
            box-shadow: inset 0 0 6px rgba(0, 0, 0, 0.3);
        }

        .scrollbar-prominent::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #fbbf24, #d97706, #b45309);
            border-radius: 6px;
            border: 2px solid #0f172a;
            min-height: 40px;
        }

        .scrollbar-prominent::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, #fcd34d, #fbbf24, #f59e0b);
        }

        .bottom-sheet {
            transition: all 0.5s cubic-bezier(0.32, 0.72, 0, 1);
        }

        #global-map {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
        }

        .ui-layer {
            position: relative;
            z-index: 10;
        }

        .cloud-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 50;
            opacity: 0;
            transition: opacity 1.5s ease-in-out;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .cloud-container.active {
            opacity: 1;
            pointer-events: auto;
        }

        .cloud-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 200%;
            height: 100%;
            background:
                radial-gradient(circle at 10% 20%, rgba(255, 255, 255, 0.5) 0%, transparent 20%),
                radial-gradient(circle at 30% 80%, rgba(255, 255, 255, 0.4) 0%, transparent 25%),
                radial-gradient(circle at 50% 30%, rgba(255, 255, 255, 0.5) 0%, transparent 15%),
                radial-gradient(circle at 70% 60%, rgba(255, 255, 255, 0.4) 0%, transparent 20%),
                radial-gradient(circle at 90% 10%, rgba(255, 255, 255, 0.5) 0%, transparent 25%);

            background-size: 100% 100%;
            filter: blur(40px);
            opacity: 0.6;
            animation: cloudFly 20s linear infinite;
        }

        .cloud-layer:nth-child(2) {
            top: 10%;
            width: 250%;
            background:
                radial-gradient(circle at 15% 50%, rgba(255, 255, 255, 0.3) 0%, transparent 25%),
                radial-gradient(circle at 45% 10%, rgba(255, 255, 255, 0.4) 0%, transparent 20%),
                radial-gradient(circle at 75% 80%, rgba(255, 255, 255, 0.3) 0%, transparent 25%);
            animation: cloudFly 25s linear infinite reverse;
            opacity: 0.4;
            filter: blur(50px);
        }

        .cloud-layer:nth-child(3) {
            top: -10%;
            width: 300%;
            background:
                radial-gradient(circle at 50% 50%, rgba(255, 255, 255, 0.2) 0%, transparent 40%);
            animation: cloudFly 35s linear infinite;
            opacity: 0.3;
            filter: blur(60px);
        }

        @keyframes cloudFly {
            from {
                transform: translateX(-20%);
            }

            to {
                transform: translateX(-60%);
            }
        }

        .travel-message {
            position: relative;
            z-index: 60;
            text-align: center;
            color: #0f172a;
            text-shadow: 0 2px 10px rgba(255, 255, 255, 0.9), 0 0 20px rgba(255, 255, 255, 0.5);
            transform: scale(0.9);
            transition: transform 0.5s;
        }

        .cloud-container.active .travel-message {
            transform: scale(1);
        }
    </style>
</head>

<body class="bg-slate-900 text-slate-100">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- GLOBAL CONSTANTS & DATA ---
        Chart.defaults.color = '#cbd5e1';
        Chart.defaults.borderColor = '#334155';
        Chart.defaults.font.family = 'Sarabun';

        const DON_MUEANG_COORDS = [13.9133, 100.6042];

        const PROVINCE_COORDS = {
            "‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏£‡∏≤‡∏¢": [19.9502, 99.8826], "‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà": [18.7677, 98.9640], "‡∏ô‡πà‡∏≤‡∏ô": [18.8077, 100.7834],
            "‡∏û‡∏∞‡πÄ‡∏¢‡∏≤": [19.1662, 99.9022], "‡πÅ‡∏û‡∏£‡πà": [18.1301, 100.1623], "‡πÅ‡∏°‡πà‡∏Æ‡πà‡∏≠‡∏á‡∏™‡∏≠‡∏ô": [19.3005, 97.9706],
            "‡∏•‡∏≥‡∏õ‡∏≤‡∏á": [18.2764, 99.5028], "‡∏•‡∏≥‡∏û‡∏π‡∏ô": [18.5772, 99.0087], "‡∏≠‡∏∏‡∏ï‡∏£‡∏î‡∏¥‡∏ï‡∏ñ‡πå": [17.6201, 100.0993],
            "‡∏™‡∏∏‡πÇ‡∏Ç‡∏ó‡∏±‡∏¢": [17.2384, 99.8295], "‡∏û‡∏¥‡∏©‡∏ì‡∏∏‡πÇ‡∏•‡∏Å": [16.7797, 100.2741], "‡∏û‡∏¥‡∏à‡∏¥‡∏ï‡∏£": [16.4418, 100.3488],
            "‡πÄ‡∏û‡∏ä‡∏£‡∏ö‡∏π‡∏£‡∏ì‡πå": [16.7628, 101.1894], "‡∏Å‡∏≥‡πÅ‡∏û‡∏á‡πÄ‡∏û‡∏ä‡∏£": [16.4834, 99.5215], "‡∏ï‡∏≤‡∏Å": [16.8974, 99.2541],
            "‡∏ô‡∏Ñ‡∏£‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡πå": [15.6667, 100.1333], "‡∏≠‡∏∏‡∏ó‡∏±‡∏¢‡∏ò‡∏≤‡∏ô‡∏µ": [15.3835, 100.0246], "‡∏Å‡∏≤‡∏¨‡∏™‡∏¥‡∏ô‡∏ò‡∏∏‡πå": [16.4328, 103.5069],
            "‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô": [16.4643, 102.7872], "‡∏ä‡∏±‡∏¢‡∏†‡∏π‡∏°‡∏¥": [15.8105, 102.0288], "‡∏ô‡∏Ñ‡∏£‡∏û‡∏ô‡∏°": [17.3833, 104.6433],
            "‡∏ô‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡∏™‡∏µ‡∏°‡∏≤": [14.9392, 102.1119], "‡∏ö‡∏∂‡∏á‡∏Å‡∏≤‡∏¨": [18.3612, 103.6461], "‡∏ö‡∏∏‡∏£‡∏µ‡∏£‡∏±‡∏°‡∏¢‡πå": [15.2294, 103.2533],
            "‡∏°‡∏´‡∏≤‡∏™‡∏≤‡∏£‡∏Ñ‡∏≤‡∏°": [16.1858, 103.3015], "‡∏°‡∏∏‡∏Å‡∏î‡∏≤‡∏´‡∏≤‡∏£": [16.5436, 104.7046], "‡∏¢‡πÇ‡∏™‡∏ò‡∏£": [15.7924, 104.1451],
            "‡∏£‡πâ‡∏≠‡∏¢‡πÄ‡∏≠‡πá‡∏î": [16.1507, 103.7745], "‡πÄ‡∏•‡∏¢": [17.4411, 101.7225], "‡∏™‡∏Å‡∏•‡∏ô‡∏Ñ‡∏£": [17.1897, 104.1186],
            "‡∏™‡∏∏‡∏£‡∏¥‡∏ô‡∏ó‡∏£‡πå": [14.8829, 103.4937], "‡∏®‡∏£‡∏µ‡∏™‡∏∞‡πÄ‡∏Å‡∏©": [15.1186, 104.3227], "‡∏´‡∏ô‡∏≠‡∏á‡∏Ñ‡∏≤‡∏¢": [17.8785, 102.7413],
            "‡∏´‡∏ô‡∏≠‡∏á‡∏ö‡∏±‡∏ß‡∏•‡∏≥‡∏†‡∏π": [17.2044, 102.4413], "‡∏≠‡∏∏‡∏î‡∏£‡∏ò‡∏≤‡∏ô‡∏µ": [17.3859, 102.7880], "‡∏≠‡∏∏‡∏ö‡∏•‡∏£‡∏≤‡∏ä‡∏ò‡∏≤‡∏ô‡∏µ": [15.2514, 104.8703],
            "‡∏≠‡∏≥‡∏ô‡∏≤‡∏à‡πÄ‡∏à‡∏£‡∏¥‡∏ç": [15.8587, 104.6258], "‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£": [13.9133, 100.6042], "‡∏Å‡∏≤‡∏ç‡∏à‡∏ô‡∏ö‡∏∏‡∏£‡∏µ": [14.0205, 99.5304],
            "‡∏à‡∏±‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ": [12.6114, 102.1039], "‡∏â‡∏∞‡πÄ‡∏ä‡∏¥‡∏á‡πÄ‡∏ó‡∏£‡∏≤": [13.6904, 101.0779], "‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ": [13.3611, 100.9847],
            "‡∏ä‡∏±‡∏¢‡∏ô‡∏≤‡∏ó": [15.1852, 100.1251], "‡∏ï‡∏£‡∏≤‡∏î": [12.2703, 102.3217], "‡∏ô‡∏Ñ‡∏£‡∏ô‡∏≤‡∏¢‡∏Å": [14.2069, 101.2130],
            "‡∏ô‡∏Ñ‡∏£‡∏õ‡∏ê‡∏°": [13.8188, 100.0373], "‡∏ô‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ": [13.8591, 100.5217], "‡∏õ‡∏ó‡∏∏‡∏°‡∏ò‡∏≤‡∏ô‡∏µ": [14.0208, 100.5250],
            "‡∏õ‡∏£‡∏∞‡∏à‡∏ß‡∏ö‡∏Ñ‡∏µ‡∏£‡∏µ‡∏Ç‡∏±‡∏ô‡∏ò‡πå": [11.7916, 99.8037], "‡∏õ‡∏£‡∏≤‡∏à‡∏µ‡∏ô‡∏ö‡∏∏‡∏£‡∏µ": [14.0620, 101.3783], "‡∏û‡∏£‡∏∞‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤": [14.3532, 100.5684],
            "‡πÄ‡∏û‡∏ä‡∏£‡∏ö‡∏∏‡∏£‡∏µ": [13.1163, 99.9392], "‡∏£‡∏∞‡∏¢‡∏≠‡∏á": [12.6800, 101.0050], "‡∏£‡∏≤‡∏ä‡∏ö‡∏∏‡∏£‡∏µ": [13.5282, 99.8144],
            "‡∏•‡∏û‡∏ö‡∏∏‡∏£‡∏µ": [14.7995, 100.6533], "‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏õ‡∏£‡∏≤‡∏Å‡∏≤‡∏£": [13.6900, 100.7501], "‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏á‡∏Ñ‡∏£‡∏≤‡∏°": [13.4098, 100.0023],
            "‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏≤‡∏Ñ‡∏£": [13.5475, 100.2736], "‡∏™‡∏£‡∏∞‡πÅ‡∏Å‡πâ‡∏ß": [13.8240, 102.0649], "‡∏™‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏µ": [14.5289, 100.9101],
            "‡∏™‡∏¥‡∏á‡∏´‡πå‡∏ö‡∏∏‡∏£‡∏µ": [14.8910, 100.3958], "‡∏™‡∏∏‡∏û‡∏£‡∏£‡∏ì‡∏ö‡∏∏‡∏£‡∏µ": [14.4745, 100.1177], "‡∏≠‡πà‡∏≤‡∏á‡∏ó‡∏≠‡∏á": [14.5896, 100.4550],
            "‡∏Å‡∏£‡∏∞‡∏ö‡∏µ‡πà": [8.0991, 98.9850], "‡∏ä‡∏∏‡∏°‡∏û‡∏£": [10.7119, 99.3636], "‡∏ï‡∏£‡∏±‡∏á": [7.5097, 99.6158],
            "‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏ò‡∏£‡∏£‡∏°‡∏£‡∏≤‡∏ä": [8.5408, 99.9442], "‡∏ô‡∏£‡∏≤‡∏ò‡∏¥‡∏ß‡∏≤‡∏™": [6.5239, 101.7431], "‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ": [6.7867, 101.1578],
            "‡∏û‡∏±‡∏á‡∏á‡∏≤": [8.4501, 98.5255], "‡∏û‡∏±‡∏ó‡∏•‡∏∏‡∏á": [7.6172, 100.0708], "‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï": [8.1132, 98.3169],
            "‡∏¢‡∏∞‡∏•‡∏≤": [6.5412, 101.2804], "‡∏£‡∏∞‡∏ô‡∏≠‡∏á": [9.7777, 98.5853], "‡∏™‡∏á‡∏Ç‡∏•‡∏≤": [6.9333, 100.3933],
            "‡∏™‡∏ï‡∏π‡∏•": [6.6238, 100.0674], "‡∏™‡∏∏‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå‡∏ò‡∏≤‡∏ô‡∏µ": [9.1328, 99.1356]
        };

        const PROVINCE_DATA = {};
        const regions = {
            "‡πÄ‡∏´‡∏ô‡∏∑‡∏≠": ["‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏£‡∏≤‡∏¢", "‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà", "‡∏ô‡πà‡∏≤‡∏ô", "‡∏û‡∏∞‡πÄ‡∏¢‡∏≤", "‡πÅ‡∏û‡∏£‡πà", "‡πÅ‡∏°‡πà‡∏Æ‡πà‡∏≠‡∏á‡∏™‡∏≠‡∏ô", "‡∏•‡∏≥‡∏õ‡∏≤‡∏á", "‡∏•‡∏≥‡∏û‡∏π‡∏ô", "‡∏≠‡∏∏‡∏ï‡∏£‡∏î‡∏¥‡∏ï‡∏ñ‡πå", "‡∏™‡∏∏‡πÇ‡∏Ç‡∏ó‡∏±‡∏¢", "‡∏û‡∏¥‡∏©‡∏ì‡∏∏‡πÇ‡∏•‡∏Å", "‡∏û‡∏¥‡∏à‡∏¥‡∏ï‡∏£", "‡πÄ‡∏û‡∏ä‡∏£‡∏ö‡∏π‡∏£‡∏ì‡πå", "‡∏Å‡∏≥‡πÅ‡∏û‡∏á‡πÄ‡∏û‡∏ä‡∏£", "‡∏ô‡∏Ñ‡∏£‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡πå", "‡∏≠‡∏∏‡∏ó‡∏±‡∏¢‡∏ò‡∏≤‡∏ô‡∏µ"],
            "‡∏≠‡∏µ‡∏™‡∏≤‡∏ô": ["‡∏Å‡∏≤‡∏¨‡∏™‡∏¥‡∏ô‡∏ò‡∏∏‡πå", "‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô", "‡∏ä‡∏±‡∏¢‡∏†‡∏π‡∏°‡∏¥", "‡∏ô‡∏Ñ‡∏£‡∏û‡∏ô‡∏°", "‡∏ô‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡∏™‡∏µ‡∏°‡∏≤", "‡∏ö‡∏∂‡∏á‡∏Å‡∏≤‡∏¨", "‡∏ö‡∏∏‡∏£‡∏µ‡∏£‡∏±‡∏°‡∏¢‡πå", "‡∏°‡∏´‡∏≤‡∏™‡∏≤‡∏£‡∏Ñ‡∏≤‡∏°", "‡∏°‡∏∏‡∏Å‡∏î‡∏≤‡∏´‡∏≤‡∏£", "‡∏¢‡πÇ‡∏™‡∏ò‡∏£", "‡∏£‡πâ‡∏≠‡∏¢‡πÄ‡∏≠‡πá‡∏î", "‡πÄ‡∏•‡∏¢", "‡∏™‡∏Å‡∏•‡∏ô‡∏Ñ‡∏£", "‡∏™‡∏∏‡∏£‡∏¥‡∏ô‡∏ó‡∏£‡πå", "‡∏®‡∏£‡∏µ‡∏™‡∏∞‡πÄ‡∏Å‡∏©", "‡∏´‡∏ô‡∏≠‡∏á‡∏Ñ‡∏≤‡∏¢", "‡∏´‡∏ô‡∏≠‡∏á‡∏ö‡∏±‡∏ß‡∏•‡∏≥‡∏†‡∏π", "‡∏≠‡∏∏‡∏î‡∏£‡∏ò‡∏≤‡∏ô‡∏µ", "‡∏≠‡∏∏‡∏ö‡∏•‡∏£‡∏≤‡∏ä‡∏ò‡∏≤‡∏ô‡∏µ", "‡∏≠‡∏≥‡∏ô‡∏≤‡∏à‡πÄ‡∏à‡∏£‡∏¥‡∏ç"],
            "‡∏Å‡∏•‡∏≤‡∏á": ["‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£", "‡∏ä‡∏±‡∏¢‡∏ô‡∏≤‡∏ó", "‡∏ô‡∏Ñ‡∏£‡∏ô‡∏≤‡∏¢‡∏Å", "‡∏ô‡∏Ñ‡∏£‡∏õ‡∏ê‡∏°", "‡∏ô‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ", "‡∏õ‡∏ó‡∏∏‡∏°‡∏ò‡∏≤‡∏ô‡∏µ", "‡∏û‡∏£‡∏∞‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤", "‡∏•‡∏û‡∏ö‡∏∏‡∏£‡∏µ", "‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏õ‡∏£‡∏≤‡∏Å‡∏≤‡∏£", "‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏á‡∏Ñ‡∏£‡∏≤‡∏°", "‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏≤‡∏Ñ‡∏£", "‡∏™‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏µ", "‡∏™‡∏¥‡∏á‡∏´‡πå‡∏ö‡∏∏‡∏£‡∏µ", "‡∏™‡∏∏‡∏û‡∏£‡∏£‡∏ì‡∏ö‡∏∏‡∏£‡∏µ", "‡∏≠‡πà‡∏≤‡∏á‡∏ó‡∏≠‡∏á"],
            "‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å": ["‡∏à‡∏±‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ", "‡∏â‡∏∞‡πÄ‡∏ä‡∏¥‡∏á‡πÄ‡∏ó‡∏£‡∏≤", "‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ", "‡∏ï‡∏£‡∏≤‡∏î", "‡∏õ‡∏£‡∏≤‡∏à‡∏µ‡∏ô‡∏ö‡∏∏‡∏£‡∏µ", "‡∏£‡∏∞‡∏¢‡∏≠‡∏á", "‡∏™‡∏£‡∏∞‡πÅ‡∏Å‡πâ‡∏ß"],
            "‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏ï‡∏Å": ["‡∏ï‡∏≤‡∏Å", "‡∏Å‡∏≤‡∏ç‡∏à‡∏ô‡∏ö‡∏∏‡∏£‡∏µ", "‡∏õ‡∏£‡∏∞‡∏à‡∏ß‡∏ö‡∏Ñ‡∏µ‡∏£‡∏µ‡∏Ç‡∏±‡∏ô‡∏ò‡πå", "‡πÄ‡∏û‡∏ä‡∏£‡∏ö‡∏∏‡∏£‡∏µ", "‡∏£‡∏≤‡∏ä‡∏ö‡∏∏‡∏£‡∏µ"],
            "‡πÉ‡∏ï‡πâ": ["‡∏Å‡∏£‡∏∞‡∏ö‡∏µ‡πà", "‡∏ä‡∏∏‡∏°‡∏û‡∏£", "‡∏ï‡∏£‡∏±‡∏á", "‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏ò‡∏£‡∏£‡∏°‡∏£‡∏≤‡∏ä", "‡∏ô‡∏£‡∏≤‡∏ò‡∏¥‡∏ß‡∏≤‡∏™", "‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ", "‡∏û‡∏±‡∏á‡∏á‡∏≤", "‡∏û‡∏±‡∏ó‡∏•‡∏∏‡∏á", "‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï", "‡∏¢‡∏∞‡∏•‡∏≤", "‡∏£‡∏∞‡∏ô‡∏≠‡∏á", "‡∏™‡∏á‡∏Ç‡∏•‡∏≤", "‡∏™‡∏ï‡∏π‡∏•", "‡∏™‡∏∏‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå‡∏ò‡∏≤‡∏ô‡∏µ"]
        };

        Object.keys(regions).forEach(region => {
            regions[region].forEach(prov => {
                let ph = 6.5, moisture = 60, soil = "‡∏î‡∏¥‡∏ô‡∏£‡πà‡∏ß‡∏ô";
                if (region === "‡∏≠‡∏µ‡∏™‡∏≤‡∏ô") { ph = 5.5; moisture = 40; soil = "‡∏î‡∏¥‡∏ô‡∏ó‡∏£‡∏≤‡∏¢ (‡∏ä‡∏∏‡∏î‡∏î‡∏¥‡∏ô‡∏£‡πâ‡∏≠‡∏¢‡πÄ‡∏≠‡πá‡∏î)"; }
                if (region === "‡πÄ‡∏´‡∏ô‡∏∑‡∏≠") { ph = 6.0; moisture = 55; soil = "‡∏î‡∏¥‡∏ô‡∏£‡πà‡∏ß‡∏ô‡∏õ‡∏ô‡∏ó‡∏£‡∏≤‡∏¢ (‡∏ä‡∏∏‡∏î‡∏î‡∏¥‡∏ô‡πÅ‡∏°‡πà‡∏£‡∏¥‡∏°)"; }
                if (region === "‡∏Å‡∏•‡∏≤‡∏á") { ph = 7.0; moisture = 70; soil = "‡∏î‡∏¥‡∏ô‡πÄ‡∏´‡∏ô‡∏µ‡∏¢‡∏ß (‡∏ä‡∏∏‡∏î‡∏î‡∏¥‡∏ô‡∏£‡∏≤‡∏ä‡∏ö‡∏∏‡∏£‡∏µ)"; }
                if (region === "‡πÉ‡∏ï‡πâ") { ph = 5.0; moisture = 80; soil = "‡∏î‡∏¥‡∏ô‡∏£‡πà‡∏ß‡∏ô‡∏õ‡∏ô‡∏î‡∏¥‡∏ô‡πÄ‡∏´‡∏ô‡∏µ‡∏¢‡∏ß (‡∏ä‡∏∏‡∏î‡∏î‡∏¥‡∏ô‡∏Ñ‡∏≠‡∏´‡∏á‡∏™‡πå)"; }
                if (region === "‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å") { ph = 5.5; moisture = 75; soil = "‡∏î‡∏¥‡∏ô‡∏£‡πà‡∏ß‡∏ô‡∏õ‡∏ô‡∏ó‡∏£‡∏≤‡∏¢ (‡∏ú‡∏•‡πÑ‡∏°‡πâ)"; }
                if (region === "‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏ï‡∏Å") { ph = 6.5; moisture = 50; soil = "‡∏î‡∏¥‡∏ô‡∏£‡πà‡∏ß‡∏ô‡∏õ‡∏ô‡∏ó‡∏£‡∏≤‡∏¢"; }

                let lat, lng;
                if (PROVINCE_COORDS[prov]) {
                    [lat, lng] = PROVINCE_COORDS[prov];
                } else {
                    lat = 13.7563; lng = 100.5018; // Fallback
                }
                PROVINCE_DATA[prov] = { ph, moisture, soil, region, lat, lng };
            });
        });

        const COST_STRUCTURE = {
            '‡∏Ç‡πâ‡∏≤‡∏ß‡∏´‡∏≠‡∏°‡∏°‡∏∞‡∏•‡∏¥': { fertilizer: 25, labor: 35, seeds: 15, water: 15, misc: 10 },
            '‡∏Ç‡πâ‡∏≤‡∏ß‡∏´‡∏≠‡∏°‡∏°‡∏∞‡∏•‡∏¥ 105': { fertilizer: 25, labor: 35, seeds: 15, water: 15, misc: 10 },
            '‡∏ó‡∏∏‡πÄ‡∏£‡∏µ‡∏¢‡∏ô': { fertilizer: 35, labor: 30, seeds: 10, water: 15, misc: 10 },
            '‡∏ó‡∏∏‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏´‡∏°‡∏≠‡∏ô‡∏ó‡∏≠‡∏á': { fertilizer: 35, labor: 30, seeds: 10, water: 15, misc: 10 },
            '‡∏ú‡∏±‡∏Å‡∏™‡∏•‡∏±‡∏î‡πÑ‡∏Æ‡πÇ‡∏î‡∏£': { fertilizer: 40, labor: 20, seeds: 20, water: 10, misc: 10 },
            '‡∏ú‡∏±‡∏Å‡∏™‡∏•‡∏±‡∏î‡πÑ‡∏Æ‡πÇ‡∏î‡∏£‡∏Ø': { fertilizer: 40, labor: 20, seeds: 20, water: 10, misc: 10 },
            '‡∏°‡∏±‡∏ô‡∏™‡∏≥‡∏õ‡∏∞‡∏´‡∏•‡∏±‡∏á': { fertilizer: 20, labor: 40, seeds: 20, water: 10, misc: 10 },
            '‡∏¢‡∏≤‡∏á‡∏û‡∏≤‡∏£‡∏≤': { fertilizer: 25, labor: 50, seeds: 10, water: 5, misc: 10 },
            '‡∏õ‡∏≤‡∏•‡πå‡∏°‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô': { fertilizer: 30, labor: 40, seeds: 10, water: 10, misc: 10 },
            '‡∏≠‡πâ‡∏≠‡∏¢‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô': { fertilizer: 30, labor: 40, seeds: 10, water: 15, misc: 5 },
            '‡∏Ç‡πâ‡∏≤‡∏ß‡πÇ‡∏û‡∏î‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡∏™‡∏±‡∏ï‡∏ß‡πå': { fertilizer: 35, labor: 30, seeds: 15, water: 15, misc: 5 },
            '‡∏°‡∏∞‡∏û‡∏£‡πâ‡∏≤‡∏ß‡∏ô‡πâ‡∏≥‡∏´‡∏≠‡∏°': { fertilizer: 20, labor: 40, seeds: 10, water: 20, misc: 10 },
            'default': { fertilizer: 30, labor: 30, seeds: 20, water: 10, misc: 10 }
        };

        const FARMING_STEPS = {
            '‡∏Ç‡πâ‡∏≤‡∏ß': [
                { title: '‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏î‡∏¥‡∏ô', desc: '‡πÑ‡∏ñ‡∏î‡∏∞‡∏ï‡∏≤‡∏Å‡∏î‡∏¥‡∏ô 7-14 ‡∏ß‡∏±‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏ñ‡πÅ‡∏õ‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≥‡∏à‡∏±‡∏î‡∏ß‡∏±‡∏ä‡∏û‡∏∑‡∏ä' },
                { title: '‡πÄ‡∏û‡∏≤‡∏∞‡∏õ‡∏•‡∏π‡∏Å', desc: '‡∏´‡∏ß‡πà‡∏≤‡∏ô‡πÄ‡∏°‡∏•‡πá‡∏î‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå (15-20 ‡∏Å‡∏Å./‡πÑ‡∏£‡πà) ‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏±‡∏Å‡∏î‡∏≥' },
                { title: '‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏±‡∏Å‡∏©‡∏≤', desc: '‡πÉ‡∏™‡πà‡∏õ‡∏∏‡πã‡∏¢‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡∏´‡∏•‡∏±‡∏á‡∏õ‡∏•‡∏π‡∏Å 20 ‡∏ß‡∏±‡∏ô ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 2 ‡∏£‡∏∞‡∏¢‡∏∞‡∏Å‡∏≥‡πÄ‡∏ô‡∏¥‡∏î‡∏ä‡πà‡∏≠‡∏î‡∏≠‡∏Å' },
                { title: '‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß', desc: '‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏£‡∏ß‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á 80-90% (‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì 100-120 ‡∏ß‡∏±‡∏ô)' }
            ],
            '‡∏ó‡∏∏‡πÄ‡∏£‡∏µ‡∏¢‡∏ô': [
                { title: '‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà', desc: '‡∏¢‡∏Å‡πÇ‡∏Ñ‡∏Å‡∏™‡∏π‡∏á 50-80 ‡∏ã‡∏°. ‡∏Å‡∏ß‡πâ‡∏≤‡∏á 4-6 ‡πÄ‡∏°‡∏ï‡∏£ ‡∏ß‡∏≤‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡πâ‡∏≥‡πÄ‡∏´‡∏ß‡∏µ‡πà‡∏¢‡∏á' },
                { title: '‡∏•‡∏á‡∏õ‡∏•‡∏π‡∏Å', desc: '‡∏Ç‡∏∏‡∏î‡∏´‡∏•‡∏∏‡∏°‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏ó‡πà‡∏≤‡∏ñ‡∏∏‡∏á‡∏ä‡∏≥ ‡∏£‡∏≠‡∏á‡∏Å‡πâ‡∏ô‡∏´‡∏•‡∏∏‡∏°‡∏î‡πâ‡∏ß‡∏¢‡∏õ‡∏∏‡πã‡∏¢‡∏Ñ‡∏≠‡∏Å ‡∏õ‡∏•‡∏π‡∏Å‡πÄ‡∏™‡∏°‡∏≠‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏î‡∏¥‡∏ô‡πÄ‡∏î‡∏¥‡∏°' },
                { title: '‡∏ï‡∏±‡∏î‡πÅ‡∏ï‡πà‡∏á‡∏Å‡∏¥‡πà‡∏á', desc: '‡∏ï‡∏±‡∏î‡∏Å‡∏¥‡πà‡∏á‡πÅ‡∏Ç‡∏ô‡∏á‡πÉ‡∏ô‡∏ó‡∏£‡∏á‡∏û‡∏∏‡πà‡∏°‡∏≠‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏á‡∏™‡πà‡∏≠‡∏á‡∏ñ‡∏∂‡∏á' },
                { title: '‡∏ó‡∏≥‡∏î‡∏≠‡∏Å/‡∏ú‡∏•', desc: '‡∏á‡∏î‡∏ô‡πâ‡∏≥‡∏Å‡∏£‡∏∞‡∏ï‡∏∏‡πâ‡∏ô‡∏î‡∏≠‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÉ‡∏ö‡πÅ‡∏Å‡πà‡∏à‡∏±‡∏î ‡∏ú‡∏™‡∏°‡πÄ‡∏Å‡∏™‡∏£‡∏ä‡πà‡∏ß‡∏á‡∏Ñ‡πà‡∏≥' }
            ],
            '‡∏°‡∏±‡∏ô‡∏™‡∏≥‡∏õ‡∏∞‡∏´‡∏•‡∏±‡∏á': [
                { title: '‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ó‡πà‡∏≠‡∏ô‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå', desc: '‡∏ï‡∏±‡∏î‡∏ó‡πà‡∏≠‡∏ô‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå‡∏¢‡∏≤‡∏ß 20 ‡∏ã‡∏°. ‡πÅ‡∏ä‡πà‡∏ô‡πâ‡∏≥‡∏¢‡∏≤‡πÄ‡∏£‡πà‡∏á‡∏£‡∏≤‡∏Å 10 ‡∏ô‡∏≤‡∏ó‡∏µ' },
                { title: '‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏î‡∏¥‡∏ô', desc: '‡∏¢‡∏Å‡∏£‡πà‡∏≠‡∏á‡∏™‡∏π‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏´‡∏±‡∏ß‡∏Ç‡∏¢‡∏≤‡∏¢‡∏ï‡∏±‡∏ß‡πÑ‡∏î‡πâ‡∏î‡∏µ' },
                { title: '‡∏Å‡∏≤‡∏£‡∏õ‡∏•‡∏π‡∏Å', desc: '‡∏õ‡∏±‡∏Å‡∏ó‡πà‡∏≠‡∏ô‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå‡∏•‡∏∂‡∏Å 2 ‡πÉ‡∏ô 3 ‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≠‡∏ô ‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á 80x80 ‡∏ã‡∏°.' },
                { title: '‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß', desc: '‡∏Ç‡∏∏‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏ 8-12 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡πÅ‡∏õ‡πâ‡∏á)' }
            ],
            '‡∏¢‡∏≤‡∏á‡∏û‡∏≤‡∏£‡∏≤': [
                { title: '‡∏ß‡∏≤‡∏á‡πÅ‡∏ô‡∏ß‡∏õ‡∏•‡∏π‡∏Å', desc: '‡∏£‡∏∞‡∏¢‡∏∞ 3x7 ‡πÄ‡∏°‡∏ï‡∏£ (76 ‡∏ï‡πâ‡∏ô/‡πÑ‡∏£‡πà) ‡∏Ç‡∏∏‡∏î‡∏´‡∏•‡∏∏‡∏° 50x50x50 ‡∏ã‡∏°.' },
                { title: '‡∏õ‡∏•‡∏π‡∏Å‡∏ã‡πà‡∏≠‡∏°', desc: '‡∏Ñ‡∏ß‡∏£‡∏õ‡∏•‡∏π‡∏Å‡∏ã‡πà‡∏≠‡∏°‡πÉ‡∏´‡πâ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏õ‡∏µ‡πÅ‡∏£‡∏Å' },
                { title: '‡πÉ‡∏™‡πà‡∏õ‡∏∏‡πã‡∏¢', desc: '‡πÉ‡∏™‡πà‡∏ï‡∏≤‡∏°‡∏™‡∏π‡∏ï‡∏£‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏ï‡πâ‡∏ô ‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏£‡∏µ‡∏î (‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì 7 ‡∏õ‡∏µ)' },
                { title: '‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏£‡∏µ‡∏î', desc: '‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ï‡πâ‡∏ô‡∏°‡∏µ‡πÄ‡∏™‡πâ‡∏ô‡∏£‡∏≠‡∏ö‡∏ß‡∏á 50 ‡∏ã‡∏°. ‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á 150 ‡∏ã‡∏°.' }
            ],
            'default': [
                { title: '‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà', desc: '‡πÑ‡∏ñ‡∏û‡∏£‡∏ß‡∏ô‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏†‡∏≤‡∏û‡∏î‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏≥‡∏à‡∏±‡∏î‡∏ß‡∏±‡∏ä‡∏û‡∏∑‡∏ä' },
                { title: '‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏î‡∏¥‡∏ô', desc: '‡∏ï‡∏£‡∏ß‡∏à pH ‡πÅ‡∏•‡∏∞‡πÉ‡∏™‡πà‡∏õ‡∏π‡∏ô‡∏Ç‡∏≤‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏∏‡πã‡∏¢‡∏Ñ‡∏≠‡∏Å‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô' },
                { title: '‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏±‡∏Å‡∏©‡∏≤', desc: '‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥‡∏™‡∏°‡πà‡∏≥‡πÄ‡∏™‡∏°‡∏≠‡πÅ‡∏•‡∏∞‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÅ‡∏°‡∏•‡∏á‡∏®‡∏±‡∏ï‡∏£‡∏π‡∏û‡∏∑‡∏ä' },
                { title: '‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß', desc: '‡πÄ‡∏Å‡πá‡∏ö‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î' }
            ]
        };

        const CROP_LIFECYCLE = {
            '‡∏ó‡∏∏‡πÄ‡∏£‡∏µ‡∏¢‡∏ô': { type: 'tree', wait_years: 5, peak_start: 10, decline_start: 20, lifespan: 25, advice: '‚ö†Ô∏è ‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏Å‡πà...' },
            '‡∏ó‡∏∏‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏´‡∏°‡∏≠‡∏ô‡∏ó‡∏≠‡∏á': { type: 'tree', wait_years: 5, peak_start: 10, decline_start: 20, lifespan: 25, advice: '‚ö†Ô∏è ‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏Å‡πà...' },
            '‡∏¢‡∏≤‡∏á‡∏û‡∏≤‡∏£‡∏≤': { type: 'tree', wait_years: 7, peak_start: 12, decline_start: 20, lifespan: 25, advice: '‚ö†Ô∏è ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏≤‡∏¢ ‡∏ô‡πâ‡∏≥‡∏¢‡∏≤‡∏á‡∏•‡∏î‡∏•‡∏á...' },
            '‡∏õ‡∏≤‡∏•‡πå‡∏°‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô': { type: 'tree', wait_years: 3, peak_start: 7, decline_start: 18, lifespan: 22, advice: '‚ö†Ô∏è ‡∏ï‡πâ‡∏ô‡∏™‡∏π‡∏á‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏¢‡∏≤‡∏Å...' },
            '‡∏°‡∏∞‡∏û‡∏£‡πâ‡∏≤‡∏ß‡∏ô‡πâ‡∏≥‡∏´‡∏≠‡∏°': { type: 'tree', wait_years: 3, peak_start: 5, decline_start: 30, lifespan: 40, advice: '‚ö†Ô∏è ‡∏ï‡πâ‡∏ô‡∏™‡∏π‡∏á‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏¢‡∏≤‡∏Å...' },
            '‡∏°‡∏±‡∏á‡∏Ñ‡∏∏‡∏î': { type: 'tree', wait_years: 5, peak_start: 10, decline_start: 30, lifespan: 50, advice: '‚ö†Ô∏è ‡πÇ‡∏ï‡∏ä‡πâ‡∏≤‡πÅ‡∏ï‡πà‡∏≠‡∏≤‡∏¢‡∏∏‡∏¢‡∏∑‡∏ô...' },
            '‡∏•‡∏≥‡πÑ‡∏¢': { type: 'tree', wait_years: 3, peak_start: 5, decline_start: 20, lifespan: 30, advice: '‚ö†Ô∏è ‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏≤‡∏î‡∏™‡∏≤‡∏£...' },
            'default': { type: 'annual', lifespan: 1, advice: '‚ÑπÔ∏è ‡∏Ñ‡∏ß‡∏£‡∏õ‡∏•‡∏π‡∏Å‡∏û‡∏∑‡∏ä‡∏ï‡∏£‡∏∞‡∏Å‡∏π‡∏•‡∏ñ‡∏±‡πà‡∏ß‡∏™‡∏•‡∏±‡∏ö...' }
        };

        const GOV_SOURCES = {
            OAE: { id: 'oae', name: '‡∏™‡∏®‡∏Å. (‡πÄ‡∏®‡∏£‡∏©‡∏ê‡∏Å‡∏¥‡∏à‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏©‡∏ï‡∏£)', icon: 'fa-chart-line', color: 'text-blue-400', borderColor: 'border-blue-500/30', bg: 'bg-blue-500/10' },
            LDD: { id: 'ldd', name: '‡∏Å‡∏£‡∏°‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô (Agri-Map)', icon: 'fa-layer-group', color: 'text-amber-400', borderColor: 'border-amber-500/30', bg: 'bg-amber-500/10' },
            TMD: { id: 'tmd', name: '‡∏Å‡∏£‡∏°‡∏≠‡∏∏‡∏ï‡∏∏‡∏ô‡∏¥‡∏¢‡∏°‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤', icon: 'fa-cloud-bolt', color: 'text-cyan-400', borderColor: 'border-cyan-500/30', bg: 'bg-cyan-500/10' },
            GISTDA: { id: 'gistda', name: 'GISTDA (‡∏î‡∏≤‡∏ß‡πÄ‡∏ó‡∏µ‡∏¢‡∏°)', icon: 'fa-satellite', color: 'text-purple-400', borderColor: 'border-purple-500/30', bg: 'bg-purple-500/10' },
            MARKET: { id: 'market', name: '‡∏ï‡∏•‡∏≤‡∏î‡πÑ‡∏ó/‡∏™‡∏µ‡πà‡∏°‡∏∏‡∏°‡πÄ‡∏°‡∏∑‡∏≠‡∏á', icon: 'fa-shop', color: 'text-green-400', borderColor: 'border-green-500/30', bg: 'bg-green-500/10' },
            DOA: { id: 'doa', name: '‡∏Å‡∏£‡∏°‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏©‡∏ï‡∏£', icon: 'fa-seedling', color: 'text-pink-400', borderColor: 'border-pink-500/30', bg: 'bg-pink-500/10' },
            RICE: { id: 'rice', name: '‡∏Å‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≤‡∏ß', icon: 'fa-bowl-rice', color: 'text-yellow-200', borderColor: 'border-yellow-200/30', bg: 'bg-yellow-200/10' }
        };

        // --- HELPER FUNCTIONS ---
        const long2tile = (lon, zoom) => (Math.floor((lon + 180) / 360 * Math.pow(2, zoom)));
        const lat2tile = (lat, zoom) => (Math.floor((1 - Math.log(Math.tan(lat * Math.PI / 180) + 1 / Math.cos(lat * Math.PI / 180)) / Math.PI) / 2 * Math.pow(2, zoom)));

        const checkAndPreloadTiles = (lat, lng, zoom = 9) => {
            const promises = [];
            const x = long2tile(lng, zoom);
            const y = lat2tile(lat, zoom);
            for (let i = -1; i <= 1; i++) {
                for (let j = -1; j <= 1; j++) {
                    const tx = x + i;
                    const ty = y + j;
                    const urls = [
                        `https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/${zoom}/${ty}/${tx}`,
                        `https://mt1.google.com/vt/lyrs=h&x=${tx}&y=${ty}&z=${zoom}`
                    ];
                    urls.forEach(url => {
                        const p = new Promise((resolve) => {
                            const img = new Image();
                            img.onload = () => resolve(true);
                            img.onerror = () => resolve(false);
                            img.src = url;
                        });
                        promises.push(p);
                    });
                }
            }
            return Promise.all(promises);
        };

        // --- SUB COMPONENTS ---
        const CloudOverlay = ({ isActive, message }) => {
            return (
                <div className={`cloud-container ${isActive ? 'active' : ''}`}>
                    <div className="cloud-layer"></div>
                    <div className="cloud-layer"></div>
                    <div className="cloud-layer"></div>
                    {isActive && (
                        <div className="travel-message">
                            <div className="text-4xl md:text-6xl text-emerald-600 mb-4 animate-bounce">
                                <i className="fa-solid fa-plane-up"></i>
                            </div>
                            <h2 className="text-2xl md:text-4xl font-bold bg-white/80 backdrop-blur-md px-6 py-3 rounded-full shadow-lg border-2 border-emerald-400 text-emerald-800">
                                {message}
                            </h2>
                            <p className="mt-2 text-slate-800 font-bold bg-white/50 inline-block px-3 py-1 rounded-full shadow-sm">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà...</p>
                        </div>
                    )}
                </div>
            );
        };

        // --- SimulationModal (‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï + ‡∏õ‡∏∏‡πà‡∏°‡∏õ‡∏¥‡∏î‡∏Ç‡∏ß‡∏≤‡∏ö‡∏ô) ---
        const SimulationModal = ({ item, onClose, initialArea, floodData, soilInfo }) => {
            const [localArea, setLocalArea] = useState(initialArea);
            const [yearCount, setYearCount] = useState(10);
            const [isFullscreen, setIsFullscreen] = useState(false);
            const [activeTab, setActiveTab] = useState('analysis');

            const [customCosts, setCustomCosts] = useState(null);

            const isTree = CROP_LIFECYCLE[item.name]?.type === 'tree';
            const lifeInfo = CROP_LIFECYCLE[item.name] || CROP_LIFECYCLE['default'];

            const cropKey = Object.keys(FARMING_STEPS).find(k => item.name.includes(k)) || 'default';
            const plantingSteps = FARMING_STEPS[cropKey];

            const donutCanvasRef = useRef(null);
            const donutChartRef = useRef(null);
            const lineCanvasRef = useRef(null);
            const lineChartRef = useRef(null);

            const calculateTotalPlants = () => {
                if (!item.density) return "-";
                const densityNum = parseInt(item.density.replace(/,/g, ''));
                if (isNaN(densityNum)) return item.density;
                return Math.floor(densityNum * localArea).toLocaleString() + " ‡∏ï‡πâ‡∏ô (‡πÇ‡∏î‡∏¢‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì)";
            };

            useEffect(() => {
                const costStructure = COST_STRUCTURE[item.name] || COST_STRUCTURE['default'];
                const defaultTotalCost = (item.costTotal / initialArea) * localArea;

                setCustomCosts({
                    fertilizer: defaultTotalCost * (costStructure.fertilizer / 100),
                    labor: defaultTotalCost * (costStructure.labor / 100),
                    seeds: defaultTotalCost * (costStructure.seeds / 100),
                    water: defaultTotalCost * (costStructure.water / 100),
                    misc: defaultTotalCost * (costStructure.misc / 100)
                });
            }, [item, localArea]);

            const handleCostChange = (key, value) => {
                const numVal = parseFloat(value) || 0;
                setCustomCosts(prev => ({ ...prev, [key]: numVal }));
            };

            const simulationData = [];
            let totalProfit = 0;
            const currentTotalCostPerYear = customCosts ? Object.values(customCosts).reduce((a, b) => a + b, 0) : 0;
            let grandTotalCost = 0;

            const currentYearBE = new Date().getFullYear() + 543;
            const startYearBE = currentYearBE;

            if (customCosts) {
                const unitRev = (item.profitTotal + item.costTotal) / initialArea;
                const baseYearlyRev = unitRev * localArea;

                for (let i = 0; i < yearCount; i++) {
                    const yearBE = startYearBE + i;
                    const age = i + 1;
                    let yearlyCost = currentTotalCostPerYear;
                    let yearlyRev = baseYearlyRev;

                    if (isTree) {
                        if (age <= lifeInfo.wait_years) {
                            yearlyRev = 0;
                            yearlyCost = yearlyCost * 0.5;
                        } else if (age < lifeInfo.peak_start) {
                            yearlyRev = yearlyRev * 0.6;
                        }
                    }

                    let eventNote = "-";
                    let statusColor = "text-slate-400";
                    const floodMatch = floodData.history.find(h => h.includes(yearBE.toString()));
                    if (floodMatch) {
                        eventNote = `üåä ‡∏ô‡πâ‡∏≥‡∏ó‡πà‡∏ß‡∏° (${floodMatch})`;
                        statusColor = "text-red-400 font-bold";
                        yearlyCost *= 1.5;
                        yearlyRev *= 0.2;
                    }

                    const yearlyProfit = yearlyRev - yearlyCost;
                    totalProfit += yearlyProfit;
                    grandTotalCost += yearlyCost;

                    simulationData.push({
                        year: yearBE, age: age, cost: yearlyCost, revenue: yearlyRev,
                        profit: yearlyProfit, accumulatedProfit: totalProfit,
                        note: eventNote, statusColor: statusColor
                    });
                }
            }

            useEffect(() => {
                if (!customCosts) return;

                if (donutCanvasRef.current) {
                    if (donutChartRef.current) donutChartRef.current.destroy();
                    const ctx = donutCanvasRef.current.getContext('2d');
                    const labels = ['‡∏õ‡∏∏‡πã‡∏¢/‡∏¢‡∏≤', '‡πÅ‡∏£‡∏á‡∏á‡∏≤‡∏ô', '‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå', '‡∏ô‡πâ‡∏≥/‡πÑ‡∏ü', '‡πÄ‡∏ö‡πá‡∏î‡πÄ‡∏ï‡∏•‡πá‡∏î'];
                    const data = [customCosts.fertilizer, customCosts.labor, customCosts.seeds, customCosts.water, customCosts.misc];
                    const colors = ['#34d399', '#facc15', '#f87171', '#60a5fa', '#94a3b8'];
                    donutChartRef.current = new Chart(ctx, {
                        type: 'doughnut',
                        data: { labels: labels, datasets: [{ data: data, backgroundColor: colors, borderWidth: 0 }] },
                        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { color: '#cbd5e1', font: { size: 10 } } }, title: { display: false } } }
                    });
                }
                if (lineCanvasRef.current) {
                    if (lineChartRef.current) lineChartRef.current.destroy();
                    const ctx = lineCanvasRef.current.getContext('2d');
                    lineChartRef.current = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: simulationData.map(d => d.year),
                            datasets: [
                                { label: '‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∞‡∏™‡∏°', data: simulationData.map(d => d.accumulatedProfit), borderColor: '#34d399', backgroundColor: 'rgba(52, 211, 153, 0.2)', fill: true, tension: 0.4 },
                                { label: '‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏õ‡∏µ', data: simulationData.map(d => d.revenue), borderColor: '#60a5fa', borderDash: [2, 2], tension: 0.4, fill: false }
                            ]
                        },
                        options: { responsive: true, maintainAspectRatio: false, scales: { x: { ticks: { color: '#94a3b8' }, grid: { color: '#334155' } }, y: { ticks: { color: '#94a3b8' }, grid: { color: '#334155' } } }, plugins: { legend: { labels: { color: '#cbd5e1' } } } }
                    });
                }
                return () => {
                    if (donutChartRef.current) donutChartRef.current.destroy();
                    if (lineChartRef.current) lineChartRef.current.destroy();
                };
            }, [customCosts, yearCount, simulationData]);

            const toggleModalFullscreen = () => setIsFullscreen(!isFullscreen);
            const modalClass = isFullscreen
                ? "fixed inset-0 z-[3000] bg-slate-900 w-screen h-screen flex flex-col p-4 pt-16 md:p-6 animate-fade-in-up overflow-hidden pointer-events-auto"
                : "bg-slate-800 border-2 border-emerald-500 rounded-2xl w-full max-w-6xl p-6 pt-12 relative shadow-[0_0_50px_rgba(16,185,129,0.3)] flex flex-col max-h-[95vh] h-[90vh] z-[2000] pointer-events-auto";

            if (!customCosts) return <div className="fixed inset-0 z-[3000] flex items-center justify-center text-white">Loading...</div>;

            return (
                <div className={isFullscreen ? "" : "fixed inset-0 z-[2000] bg-black/90 backdrop-blur-sm flex items-center justify-center p-4 animate-fade-in-up pointer-events-auto"} onClick={(e) => e.stopPropagation()}>
                    <div className={modalClass} onClick={(e) => e.stopPropagation()}>

                        <div className="absolute top-3 right-3 md:top-4 md:right-4 flex items-center gap-3 z-[3050]">
                            <button onClick={(e) => { e.stopPropagation(); toggleModalFullscreen(); }} className="w-10 h-10 rounded-full bg-slate-700 text-white flex items-center justify-center border border-white/20 hover:bg-slate-600 transition shadow-lg"><i className={`fa-solid ${isFullscreen ? 'fa-compress' : 'fa-expand'}`}></i></button>
                            <button onClick={(e) => { e.stopPropagation(); onClose(); }} className="w-10 h-10 rounded-full bg-red-500 hover:bg-red-600 text-white border-2 border-red-300 flex items-center justify-center transition shadow-lg hover:scale-110 active:scale-95"><i className="fa-solid fa-times text-lg"></i></button>
                        </div>

                        {/* Header with Credit */}
                        <div className="flex flex-wrap items-center justify-between mb-4 border-b border-slate-700 pb-2 shrink-0 relative mt-2 pr-24">
                            <div className="flex items-center gap-3 mb-2 md:mb-0">
                                <div className="bg-yellow-500 p-2 md:p-3 rounded-full text-slate-900 text-lg md:text-xl shadow-lg"><i className="fa-solid fa-calculator"></i></div>
                                <div>
                                    <h3 className="text-lg md:text-2xl font-bold text-white flex items-center gap-2">
                                        {item.name}
                                        <span className={`text-xs px-2 py-0.5 rounded-full border ${item.risk === 'High' ? 'border-red-500 text-red-400 bg-red-500/10' : 'border-green-500 text-green-400 bg-green-500/10'}`}>Risk: {item.risk}</span>
                                    </h3>

                                    {/* ‚òÖ‚òÖ‚òÖ ‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≥‡∏•‡∏≠‡∏á ‚òÖ‚òÖ‚òÖ */}
                                    <div className="mt-1 p-1 bg-white/5 rounded border border-white/10 w-fit">
                                        <div className="text-[10px] text-slate-300 font-bold">‡∏ú‡∏•‡∏¥‡∏ï‡πÇ‡∏î‡∏¢: Mr.Winai Phanarkat ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡πÑ‡∏ó‡∏¢</div>
                                        <div className="text-[9px] text-slate-400">‡πÑ‡∏•‡∏ô‡πå/‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£: 0926533228 | ‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πå: winayo@gmail.com</div>
                                    </div>
                                </div>
                            </div>

                            <div className="flex items-center gap-2 flex-wrap mt-2 md:mt-0">
                                <div className="flex bg-slate-700 rounded-lg p-1">
                                    <button onClick={() => setActiveTab('analysis')} className={`px-2 md:px-3 py-1 rounded-md text-xs transition ${activeTab === 'analysis' ? 'bg-emerald-500 text-white shadow' : 'text-slate-400 hover:text-white'}`}><i className="fa-solid fa-chart-line mr-1"></i> ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</button>
                                    <button onClick={() => setActiveTab('steps')} className={`px-2 md:px-3 py-1 rounded-md text-xs transition ${activeTab === 'steps' ? 'bg-emerald-500 text-white shadow' : 'text-slate-400 hover:text-white'}`}><i className="fa-solid fa-list-check mr-1"></i> ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏õ‡∏•‡∏π‡∏Å</button>
                                </div>
                                <div className="flex items-center gap-1 bg-slate-700/50 rounded-lg px-2 py-1 border border-slate-600">
                                    <span className="text-xs text-slate-400">‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà:</span>
                                    <input type="number" step="0.1" min="0" value={localArea} onChange={(e) => { const val = parseFloat(e.target.value); setLocalArea(isNaN(val) ? 0 : Math.max(0, val)); }} className="w-12 bg-transparent text-center font-bold text-emerald-400 focus:outline-none" />
                                    <span className="text-xs text-slate-400">‡πÑ‡∏£‡πà</span>
                                </div>
                                <div className="flex items-center gap-1 bg-slate-700/50 rounded-lg px-2 py-1 border border-slate-600">
                                    <span className="text-xs text-slate-400">‡πÄ‡∏ß‡∏•‡∏≤:</span>
                                    <input type="number" value={yearCount} onChange={(e) => setYearCount(Math.max(1, Math.min(50, parseInt(e.target.value) || 1)))} className="w-8 bg-transparent text-center font-bold text-yellow-400 focus:outline-none" />
                                    <span className="text-xs text-slate-400">‡∏õ‡∏µ</span>
                                </div>
                            </div>
                        </div>

                        <div className="flex-1 overflow-y-auto overflow-x-hidden scrollbar-prominent pb-4">
                            {activeTab === 'analysis' && (
                                <div className="grid grid-cols-1 lg:grid-cols-12 gap-4">
                                    <div className="lg:col-span-4 flex flex-col gap-4">
                                        <div className="bg-emerald-900/30 p-4 rounded-xl border border-emerald-500/30">
                                            <h4 className="text-sm font-bold text-emerald-400 mb-2 border-b border-emerald-500/20 pb-1 flex items-center gap-2">
                                                <i className="fa-solid fa-seedling"></i> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏≤‡∏∞‡∏õ‡∏•‡∏π‡∏Å
                                            </h4>
                                            <div className="grid grid-cols-1 gap-2 text-xs text-slate-300">
                                                <div className="flex justify-between items-center">
                                                    <span>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ô‡∏≤‡πÅ‡∏ô‡πà‡∏ô/‡πÑ‡∏£‡πà:</span>
                                                    <span className="text-white font-bold">{item.density || '-'}</span>
                                                </div>
                                                <div className="flex justify-between items-center bg-white/5 p-1 rounded">
                                                    <span>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡πâ‡∏ô‡∏£‡∏ß‡∏° ({localArea} ‡πÑ‡∏£‡πà):</span>
                                                    <span className="text-yellow-400 font-bold text-sm">{calculateTotalPlants()}</span>
                                                </div>
                                                <div className="mt-1 pt-1 border-t border-white/10">
                                                    <div className="text-slate-400 mb-1">‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï‡∏Ñ‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡∏ì‡πå/‡∏´‡∏ô‡πà‡∏ß‡∏¢:</div>
                                                    <div className="text-white pl-2 border-l-2 border-emerald-500">{item.yieldUnit || '-'}</div>
                                                </div>
                                            </div>
                                        </div>

                                        <div className="bg-slate-900/50 p-4 rounded-xl border border-slate-700 shadow-inner">
                                            <div className="grid grid-cols-2 gap-4">
                                                <div>
                                                    <span className="text-xs text-slate-400 block">‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ ({yearCount} ‡∏õ‡∏µ)</span>
                                                    <span className={`text-xl md:text-2xl font-bold ${totalProfit > 0 ? 'text-emerald-400' : 'text-red-400'}`}>{totalProfit.toLocaleString(undefined, { maximumFractionDigits: 0 })} ‡∏ø</span>
                                                </div>
                                                <div className="text-right">
                                                    <span className="text-xs text-slate-400 block">ROI (‡∏ú‡∏•‡∏ï‡∏≠‡∏ö‡πÅ‡∏ó‡∏ô)</span>
                                                    <span className="text-xl md:text-2xl font-bold text-blue-400">{grandTotalCost > 0 ? ((totalProfit / grandTotalCost) * 100).toFixed(1) : 0}%</span>
                                                </div>
                                            </div>
                                        </div>

                                        <div className="bg-slate-900/50 p-4 rounded-xl border border-slate-700 flex-1 flex flex-col">
                                            <h4 className="text-sm font-bold text-yellow-400 mb-2 flex justify-between items-center"><span><i className="fa-solid fa-pen-to-square"></i> ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô (‡∏ï‡πà‡∏≠‡∏õ‡∏µ)</span><span className="text-[10px] text-slate-400 font-normal">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</span></h4>
                                            <div className="overflow-y-auto flex-1">
                                                <table className="w-full text-xs text-left text-slate-300">
                                                    <tbody>
                                                        {[{ key: 'fertilizer', label: '‡∏õ‡∏∏‡πã‡∏¢/‡∏¢‡∏≤', color: '#34d399' }, { key: 'labor', label: '‡πÅ‡∏£‡∏á‡∏á‡∏≤‡∏ô', color: '#facc15' }, { key: 'seeds', label: '‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå', color: '#f87171' }, { key: 'water', label: '‡∏ô‡πâ‡∏≥/‡πÑ‡∏ü', color: '#60a5fa' }, { key: 'misc', label: '‡∏≠‡∏∑‡πà‡∏ô‡πÜ', color: '#94a3b8' }].map((c) => (
                                                            <tr key={c.key} className="border-b border-slate-800 hover:bg-slate-800/30">
                                                                <td className="py-2 pl-2 flex items-center gap-2"><div className="w-2 h-2 rounded-full" style={{ backgroundColor: c.color }}></div>{c.label}</td>
                                                                <td className="py-2 pr-2 text-right"><input type="number" value={Math.round(customCosts[c.key])} onChange={(e) => handleCostChange(c.key, e.target.value)} className="bg-slate-800 border border-slate-600 rounded px-1 w-20 text-right text-emerald-300 focus:border-emerald-500 focus:outline-none" /> ‡∏ø</td>
                                                            </tr>
                                                        ))}
                                                        <tr className="bg-slate-800/50 font-bold text-white"><td className="py-2 pl-2">‡∏£‡∏ß‡∏°‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô/‡∏õ‡∏µ</td><td className="py-2 pr-2 text-right text-red-300">{currentTotalCostPerYear.toLocaleString()} ‡∏ø</td></tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                            <div className="h-[120px] mt-2 relative"><canvas ref={donutCanvasRef}></canvas></div>
                                        </div>
                                    </div>

                                    <div className="lg:col-span-8 flex flex-col gap-4">
                                        <div className="bg-slate-900/50 p-4 rounded-xl border border-slate-700 h-[300px] flex flex-col">
                                            <h4 className="text-sm font-bold text-slate-300 mb-2">‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∞‡∏™‡∏° {yearCount} ‡∏õ‡∏µ (Real-time Simulation)</h4>
                                            <div className="flex-1 relative"><canvas ref={lineCanvasRef}></canvas></div>
                                        </div>
                                        <div className="bg-slate-900/50 p-4 rounded-xl border border-slate-700 h-[200px] overflow-hidden flex flex-col">
                                            <h4 className="text-sm font-bold text-slate-300 mb-2">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏£‡∏∞‡πÅ‡∏™‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î‡∏£‡∏≤‡∏¢‡∏õ‡∏µ</h4>
                                            <div className="overflow-y-auto scrollbar-prominent flex-1">
                                                <table className="w-full text-xs text-left text-slate-300">
                                                    <thead className="bg-slate-800/50 sticky top-0"><tr><th className="px-2 py-1">‡∏õ‡∏µ (‡∏≠‡∏≤‡∏¢‡∏∏)</th><th className="px-2 py-1 text-right">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</th><th className="px-2 py-1 text-right">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</th><th className="px-2 py-1 text-right">‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</th></tr></thead>
                                                    <tbody>{simulationData.map(d => (<tr key={d.year} className="border-b border-slate-800 hover:bg-white/5"><td className="px-2 py-1"><span className="text-yellow-500">{d.year}</span> <span className="text-slate-500 ml-1">({d.age} ‡∏õ‡∏µ)</span>{d.note !== '-' && <div className="text-[9px] text-red-400">{d.note}</div>}</td><td className="px-2 py-1 text-right text-green-400">{d.revenue.toLocaleString()}</td><td className="px-2 py-1 text-right text-red-400">{d.cost.toLocaleString()}</td><td className={`px-2 py-1 text-right font-bold ${d.profit > 0 ? 'text-emerald-400' : 'text-red-500'}`}>{d.profit.toLocaleString()}</td></tr>))}</tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {activeTab === 'steps' && (
                                <div className="animate-fade-in-up">
                                    <div className="bg-gradient-to-r from-emerald-900/40 to-slate-900/40 p-6 rounded-xl border border-emerald-500/30 mb-4">
                                        <h2 className="text-2xl font-bold text-emerald-300 mb-2"><i className="fa-solid fa-seedling mr-2"></i>‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏•‡∏π‡∏Å: {item.name}</h2>
                                        <p className="text-slate-400 text-sm">‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏≤‡∏∞‡∏õ‡∏•‡∏π‡∏Å‡πÉ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà {localArea} ‡πÑ‡∏£‡πà</p>
                                    </div>
                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                        {plantingSteps.map((step, idx) => (
                                            <div key={idx} className="bg-slate-800/50 p-4 rounded-xl border border-slate-700 hover:border-emerald-500/50 transition relative overflow-hidden group">
                                                <div className="absolute -right-4 -top-4 text-6xl font-bold text-white/5 group-hover:text-emerald-500/10 transition">{idx + 1}</div>
                                                <div className="w-10 h-10 rounded-full bg-emerald-500/20 text-emerald-400 flex items-center justify-center font-bold mb-3 border border-emerald-500/30 relative z-10">{idx + 1}</div>
                                                <h3 className="text-lg font-bold text-white mb-2 relative z-10">{step.title}</h3>
                                                <p className="text-sm text-slate-300 leading-relaxed relative z-10">{step.desc}</p>
                                            </div>
                                        ))}
                                    </div>
                                    <div className="mt-6 p-4 bg-yellow-500/10 border border-yellow-500/30 rounded-xl flex items-start gap-3"><i className="fa-solid fa-circle-exclamation text-yellow-500 mt-1"></i><div><h4 className="font-bold text-yellow-500">‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</h4><p className="text-sm text-yellow-200/80">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡πâ‡∏≤‡∏á‡∏ï‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô ‡∏Ñ‡∏ß‡∏£‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ï‡∏≤‡∏°‡∏™‡∏†‡∏≤‡∏û‡∏î‡∏¥‡∏ô ({soilInfo.soil}) ‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏ô‡πâ‡∏≥‡∏ù‡∏ô‡πÉ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà ({soilInfo.region}) ‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≤‡∏ô</p></div></div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const KasetCloudApp = ({ mapInstance, onTravelStart, onTravelEnd }) => {
            const [selectedRegion, setSelectedRegion] = useState(null);
            const [selectedProvince, setSelectedProvince] = useState(null);
            const [province, setProvince] = useState("‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£");
            const [area, setArea] = useState(1);
            const [analyzing, setAnalyzing] = useState(false);
            const [results, setResults] = useState(null);
            const [soilInfo, setSoilInfo] = useState(PROVINCE_DATA["‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£"]);
            const [isFullSheet, setIsFullSheet] = useState(false);
            const [isResultsUpdated, setIsResultsUpdated] = useState(false);
            const [hasArrived, setHasArrived] = useState(false);

            const [itemsPerPage, setItemsPerPage] = useState(5);
            const [currentPage, setCurrentPage] = useState(1);
            const listContainerRef = useRef(null);

            const [weatherData, setWeatherData] = useState(null);
            const [address, setAddress] = useState({
                village: '-', subDistrict: '-', district: '-', province: '‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£', postcode: '-'
            });
            const [floodData, setFloodData] = useState({ risk: 'Low', history: [], desc: '‡∏õ‡∏Å‡∏ï‡∏¥' });

            const [userHasInteracted, setUserHasInteracted] = useState(false);
            const [simulatingItem, setSimulatingItem] = useState(null);
            const [isFullscreen, setIsFullscreen] = useState(false);

            const kasetMarkerRef = useRef(null);
            const debounceRef = useRef(null);

            const toggleFullScreen = () => {
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen().then(() => setIsFullscreen(true));
                } else {
                    if (document.exitFullscreen) {
                        document.exitFullscreen().then(() => setIsFullscreen(false));
                    }
                }
            };

            const analyzeData = () => {
                let baseData = [
                    {
                        name: "‡∏Ç‡πâ‡∏≤‡∏ß‡∏´‡∏≠‡∏°‡∏°‡∏∞‡∏•‡∏¥ 105", category: "‡∏û‡∏∑‡∏ä‡πÑ‡∏£‡πà", price: 16500, yield: 780, cost: 5200, risk: "Low", primarySource: "RICE", market: "‡πÇ‡∏£‡∏á‡∏™‡∏µ‡∏Ç‡πâ‡∏≤‡∏ß‡∏ó‡πâ‡∏≠‡∏á‡∏ñ‡∏¥‡πà‡∏ô / ‡∏™‡∏Å‡∏ï.", marketLocation: "‡∏ó‡∏±‡πà‡∏ß‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®",
                        density: "‡πÉ‡∏ä‡πÄ‡∏°‡∏•‡πá‡∏î‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå 15-20 ‡∏Å‡∏Å.", yieldUnit: "‡∏Ç‡πâ‡∏≤‡∏ß‡πÄ‡∏õ‡∏•‡∏∑‡∏≠‡∏Å (‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô 15%)"
                    },
                    {
                        name: "‡∏°‡∏±‡∏ô‡∏™‡∏≥‡∏õ‡∏∞‡∏´‡∏•‡∏±‡∏á", category: "‡∏û‡∏∑‡∏ä‡πÑ‡∏£‡πà", price: 3200, yield: 3600, cost: 3800, risk: "High", primarySource: "OAE", market: "‡∏•‡∏≤‡∏ô‡∏°‡∏±‡∏ô‡πÄ‡∏≠‡∏Å‡∏ä‡∏ô / ‡πÇ‡∏£‡∏á‡πÅ‡∏õ‡πâ‡∏á", marketLocation: "‡∏ô‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡∏™‡∏µ‡∏°‡∏≤, ‡∏Å‡∏≥‡πÅ‡∏û‡∏á‡πÄ‡∏û‡∏ä‡∏£",
                        density: "1,600-2,500 ‡∏ï‡πâ‡∏ô", yieldUnit: "‡∏´‡∏±‡∏ß‡∏°‡∏±‡∏ô‡∏™‡∏î (‡∏Ñ‡∏•‡∏∞‡πÄ‡∏Å‡∏£‡∏î)"
                    },
                    {
                        name: "‡∏ó‡∏∏‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏´‡∏°‡∏≠‡∏ô‡∏ó‡∏≠‡∏á", category: "‡∏ú‡∏•‡πÑ‡∏°‡πâ", price: 140000, yield: 2200, cost: 32000, risk: "High", primarySource: "MARKET", market: "‡∏ï‡∏•‡∏≤‡∏î‡πÑ‡∏ó / ‡∏ï‡∏•‡∏≤‡∏î‡∏≠‡∏±‡∏¢‡∏¢‡∏£‡∏≤", marketLocation: "‡∏õ‡∏ó‡∏∏‡∏°‡∏ò‡∏≤‡∏ô‡∏µ (14.07, 100.62)",
                        density: "20-25 ‡∏ï‡πâ‡∏ô", yieldUnit: "‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì 600-700 ‡∏•‡∏π‡∏Å (3-4 ‡∏Å‡∏Å./‡∏•‡∏π‡∏Å)"
                    },
                    {
                        name: "‡∏¢‡∏≤‡∏á‡∏û‡∏≤‡∏£‡∏≤ (‡πÅ‡∏ú‡πà‡∏ô‡∏î‡∏¥‡∏ö)", category: "‡πÑ‡∏°‡πâ‡∏¢‡∏∑‡∏ô‡∏ï‡πâ‡∏ô", price: 62000, yield: 240, cost: 4500, risk: "Medium", primarySource: "OAE", market: "‡∏ï‡∏•‡∏≤‡∏î‡∏Å‡∏•‡∏≤‡∏á‡∏¢‡∏≤‡∏á‡∏û‡∏≤‡∏£‡∏≤", marketLocation: "‡∏™‡∏á‡∏Ç‡∏•‡∏≤, ‡∏™‡∏∏‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå‡∏ò‡∏≤‡∏ô‡∏µ",
                        density: "76-80 ‡∏ï‡πâ‡∏ô", yieldUnit: "‡πÅ‡∏ú‡πà‡∏ô‡∏¢‡∏≤‡∏á‡∏î‡∏¥‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û 3"
                    },
                    {
                        name: "‡∏õ‡∏≤‡∏•‡πå‡∏°‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô", category: "‡∏û‡∏∑‡∏ä‡πÑ‡∏£‡πà", price: 5800, yield: 3200, cost: 4200, risk: "Low", primarySource: "OAE", market: "‡∏•‡∏≤‡∏ô‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠‡∏õ‡∏≤‡∏•‡πå‡∏°", marketLocation: "‡∏Å‡∏£‡∏∞‡∏ö‡∏µ‡πà, ‡∏™‡∏∏‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå‡∏ò‡∏≤‡∏ô‡∏µ",
                        density: "22 ‡∏ï‡πâ‡∏ô", yieldUnit: "‡∏ó‡∏∞‡∏•‡∏≤‡∏¢‡∏™‡∏î"
                    },
                    {
                        name: "‡∏Ç‡πâ‡∏≤‡∏ß‡πÇ‡∏û‡∏î‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡∏™‡∏±‡∏ï‡∏ß‡πå", category: "‡∏û‡∏∑‡∏ä‡πÑ‡∏£‡πà", price: 10500, yield: 1250, cost: 6500, risk: "Medium", primarySource: "OAE", market: "‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏™‡∏±‡∏ï‡∏ß‡πå", marketLocation: "‡∏™‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏µ, ‡∏•‡∏û‡∏ö‡∏∏‡∏£‡∏µ",
                        density: "10,000-12,000 ‡∏ï‡πâ‡∏ô", yieldUnit: "‡πÄ‡∏°‡∏•‡πá‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô 14.5%"
                    },
                    {
                        name: "‡∏≠‡πâ‡∏≠‡∏¢‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô", category: "‡∏û‡∏∑‡∏ä‡πÑ‡∏£‡πà", price: 1250, yield: 12500, cost: 6500, risk: "Low", primarySource: "OAE", market: "‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•", marketLocation: "‡∏Å‡∏≤‡∏ç‡∏à‡∏ô‡∏ö‡∏∏‡∏£‡∏µ, ‡∏≠‡∏∏‡∏î‡∏£‡∏ò‡∏≤‡∏ô‡∏µ",
                        density: "10,000-16,000 ‡∏•‡∏≥", yieldUnit: "‡∏ï‡∏±‡∏ô‡∏≠‡πâ‡∏≠‡∏¢ (10-12 C.C.S)"
                    },
                    {
                        name: "‡∏û‡∏£‡∏¥‡∏Å‡∏à‡∏¥‡∏ô‡∏î‡∏≤‡πÅ‡∏î‡∏á", category: "‡∏ú‡∏±‡∏Å", price: 80000, yield: 2000, cost: 35000, risk: "High", primarySource: "MARKET", market: "‡∏ï‡∏•‡∏≤‡∏î‡∏™‡∏µ‡πà‡∏°‡∏∏‡∏°‡πÄ‡∏°‡∏∑‡∏≠‡∏á", marketLocation: "‡∏õ‡∏ó‡∏∏‡∏°‡∏ò‡∏≤‡∏ô‡∏µ (13.96, 100.62)",
                        density: "3,000-4,000 ‡∏ï‡πâ‡∏ô", yieldUnit: "‡∏ú‡∏•‡∏™‡∏î (‡∏Ñ‡∏±‡∏î‡πÄ‡∏Å‡∏£‡∏î)"
                    },
                    {
                        name: "‡∏°‡∏∞‡∏ô‡∏≤‡∏ß (‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏ç‡πà)", category: "‡∏ú‡∏±‡∏Å", price: 75000, yield: 1500, cost: 20000, risk: "Medium", primarySource: "MARKET", market: "‡∏ï‡∏•‡∏≤‡∏î‡πÑ‡∏ó", marketLocation: "‡∏õ‡∏ó‡∏∏‡∏°‡∏ò‡∏≤‡∏ô‡∏µ",
                        density: "50-80 ‡∏ï‡πâ‡∏ô", yieldUnit: "‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì 30,000-40,000 ‡∏•‡∏π‡∏Å"
                    },
                    {
                        name: "‡∏Ñ‡∏∞‡∏ô‡πâ‡∏≤ (‡∏Ñ‡∏±‡∏î‡∏û‡∏¥‡πÄ‡∏®‡∏©)", category: "‡∏ú‡∏±‡∏Å", price: 45000, yield: 2500, cost: 18000, risk: "Medium", primarySource: "MARKET", market: "‡∏ï‡∏•‡∏≤‡∏î‡∏™‡∏µ‡πà‡∏°‡∏∏‡∏°‡πÄ‡∏°‡∏∑‡∏≠‡∏á", marketLocation: "‡∏õ‡∏ó‡∏∏‡∏°‡∏ò‡∏≤‡∏ô‡∏µ",
                        density: "‡∏´‡∏ß‡πà‡∏≤‡∏ô‡πÄ‡∏°‡∏•‡πá‡∏î", yieldUnit: "‡∏ï‡πâ‡∏ô‡∏™‡∏î (‡∏ï‡∏±‡∏î‡πÅ‡∏ï‡πà‡∏á)"
                    },
                    {
                        name: "‡∏ú‡∏±‡∏Å‡∏™‡∏•‡∏±‡∏î‡πÑ‡∏Æ‡πÇ‡∏î‡∏£‡∏Ø", category: "‡∏ú‡∏±‡∏Å", price: 90000, yield: 2200, cost: 35000, risk: "Low", primarySource: "MARKET", market: "Talaad Thai Select", marketLocation: "‡∏õ‡∏ó‡∏∏‡∏°‡∏ò‡∏≤‡∏ô‡∏µ",
                        density: "4,000-6,000 ‡∏ï‡πâ‡∏ô (‡∏ï‡∏≤‡∏°‡∏£‡∏≤‡∏á)", yieldUnit: "‡∏ï‡πâ‡∏ô‡∏™‡∏î (‡∏Å‡∏£‡∏µ‡∏ô‡πÇ‡∏≠‡πä‡∏Ñ/‡πÄ‡∏£‡∏î‡πÇ‡∏≠‡πä‡∏Ñ)"
                    },
                    {
                        name: "‡∏°‡∏±‡∏á‡∏Ñ‡∏∏‡∏î", category: "‡∏ú‡∏•‡πÑ‡∏°‡πâ", price: 45000, yield: 1600, cost: 15000, risk: "Medium", primarySource: "DOA", market: "‡∏ï‡∏•‡∏≤‡∏î‡∏ú‡∏•‡πÑ‡∏°‡πâ‡πÄ‡∏ô‡∏¥‡∏ô‡∏™‡∏π‡∏á", marketLocation: "‡∏à‡∏±‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ",
                        density: "20-25 ‡∏ï‡πâ‡∏ô", yieldUnit: "‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì 16,000-20,000 ‡∏•‡∏π‡∏Å"
                    },
                    {
                        name: "‡∏°‡∏∞‡∏û‡∏£‡πâ‡∏≤‡∏ß‡∏ô‡πâ‡∏≥‡∏´‡∏≠‡∏°", category: "‡∏ú‡∏•‡πÑ‡∏°‡πâ", price: 160000, yield: 2200, cost: 32000, risk: "Low", primarySource: "MARKET", market: "‡∏ï‡∏•‡∏≤‡∏î‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏™‡∏∞‡∏î‡∏ß‡∏Å", marketLocation: "‡∏£‡∏≤‡∏ä‡∏ö‡∏∏‡∏£‡∏µ",
                        density: "40-45 ‡∏ï‡πâ‡∏ô", yieldUnit: "‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì 2,500-3,000 ‡∏•‡∏π‡∏Å"
                    }
                ];
                const calculated = baseData.map(item => {
                    let y = item.yield, c = item.cost;
                    if (item.name.includes("‡∏ó‡∏∏‡πÄ‡∏£‡∏µ‡∏¢‡∏ô")) {
                        const priceFactor = 0.85;
                        item.price = item.price * priceFactor;
                        item.risk = "High";
                    }
                    if (item.name.includes("‡∏°‡∏±‡∏ô‡∏™‡∏≥‡∏õ‡∏∞‡∏´‡∏•‡∏±‡∏á")) {
                        y *= 0.85;
                        item.price *= 1.1;
                    }

                    if (floodData.risk === 'High') {
                        c *= 1.3;
                        if (!item.name.includes("‡∏Ç‡πâ‡∏≤‡∏ß")) y *= 0.5;
                    }
                    if (soilInfo.soil.includes("‡∏ó‡∏£‡∏≤‡∏¢") && item.name.includes("‡∏Ç‡πâ‡∏≤‡∏ß")) {
                        y *= 0.8;
                    }
                    if (weatherData && weatherData.dailyRain < 2 && item.name.includes("‡∏Ç‡πâ‡∏≤‡∏ß")) {
                        y *= 0.9;
                    }
                    const rev = item.price * (y / 1000) * area;
                    const cost = c * area;
                    const usedSources = [];
                    if (GOV_SOURCES[item.primarySource]) usedSources.push(GOV_SOURCES[item.primarySource]);
                    if (floodData.risk !== 'Low') usedSources.push(GOV_SOURCES.GISTDA);
                    if (soilInfo.soil !== '‡∏î‡∏¥‡∏ô‡∏£‡πà‡∏ß‡∏ô') usedSources.push(GOV_SOURCES.LDD);

                    return {
                        ...item,
                        profitTotal: rev - cost,
                        costTotal: cost,
                        risk_level: item.risk,
                        history: [],
                        refSources: usedSources
                    };
                });

                setResults(calculated.sort((a, b) => b.profitTotal - a.profitTotal));
                setAnalyzing(false);
                setIsResultsUpdated(true);
                setCurrentPage(1);
                setTimeout(() => setIsResultsUpdated(false), 5000);
            };

            useEffect(() => {
                const handleResize = () => {
                    if (listContainerRef.current) {
                        const containerHeight = listContainerRef.current.clientHeight;
                        const itemElement = listContainerRef.current.querySelector('.group');
                        const itemHeight = itemElement ? itemElement.offsetHeight : 100;
                        const calculatedItems = Math.floor(containerHeight / itemHeight);
                        setItemsPerPage(Math.max(3, calculatedItems));
                    }
                };
                handleResize();
                const timer = setTimeout(handleResize, 600);
                window.addEventListener('resize', handleResize);
                return () => {
                    window.removeEventListener('resize', handleResize);
                    clearTimeout(timer);
                };
            }, [isFullSheet, results, province]);

            useEffect(() => {
                if (mapInstance) {
                    const targetInfo = PROVINCE_DATA[province];
                    mapInstance.dragging.enable();
                    mapInstance.touchZoom.enable();
                    mapInstance.doubleClickZoom.enable();
                    mapInstance.scrollWheelZoom.enable();
                    mapInstance.boxZoom.enable();
                    mapInstance.keyboard.enable();
                    if (mapInstance.tap) mapInstance.tap.enable();
                    mapInstance.getContainer().style.cursor = 'grab';

                    if (!kasetMarkerRef.current) {
                        const marker = L.marker([targetInfo.lat, targetInfo.lng], { draggable: true }).addTo(mapInstance);
                        marker.bindPopup(`<b>${province}</b><br>‡∏•‡∏≤‡∏Å‡∏´‡∏°‡∏∏‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÅ‡∏õ‡∏•‡∏á`).openPopup();
                        marker.on('dragend', async function (event) {
                            const m = event.target;
                            const position = m.getLatLng();
                            setSoilInfo(prev => ({ ...prev, lat: position.lat, lng: position.lng }));
                            await fetchDetailedAddress(position.lat, position.lng);
                            setFloodData(calculateFloodRisk(position.lat, position.lng));
                            fetchDetailedWeather(position.lat, position.lng);
                            setUserHasInteracted(true);
                            m.setPopupContent(`<b>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà...</b>`).openPopup();
                        });
                        marker.on('mouseover', () => { mapInstance.getContainer().style.cursor = 'pointer'; });
                        marker.on('mouseout', () => { mapInstance.getContainer().style.cursor = 'grab'; });
                        kasetMarkerRef.current = marker;
                    } else {
                        if (!userHasInteracted || selectedRegion) {
                            kasetMarkerRef.current.setLatLng([targetInfo.lat, targetInfo.lng]);
                        }
                    }
                }
                return () => {
                    if (kasetMarkerRef.current) {
                        kasetMarkerRef.current.remove();
                        kasetMarkerRef.current = null;
                    }
                };
            }, [mapInstance, province]);

            const fetchDetailedAddress = async (lat, lng) => {
                try {
                    const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`, { headers: { 'User-Agent': 'WinaiPortal/1.0' } });
                    const data = await res.json();
                    if (data && data.address) {
                        setAddress({
                            village: data.address.village || data.address.hamlet || '-',
                            subDistrict: data.address.suburb || data.address.quarter || data.address.neighbourhood || '-',
                            district: data.address.city_district || data.address.district || data.address.county || '-',
                            province: data.address.province || data.address.state || province,
                            postcode: data.address.postcode || '-'
                        });
                        if (kasetMarkerRef.current) {
                            kasetMarkerRef.current.setPopupContent(
                                `<b>üìç ‡∏û‡∏¥‡∏Å‡∏±‡∏î:</b> ${data.address.suburb || '-'}<br>‡∏≠.${data.address.district || '-'}`
                            ).openPopup();
                        }
                    }
                } catch (e) { console.error("Address fetch failed", e); }
            };

            const calculateFloodRisk = (lat, lng) => {
                const hash = Math.abs(Math.sin(lat * 1000 + lng) * 10000);
                const riskLevel = hash % 100;
                if (riskLevel > 80) return { risk: 'High', desc: '‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏™‡∏π‡∏á‡∏°‡∏≤‡∏Å', history: ['2554', '2564', '2565'] };
                if (riskLevel > 50) return { risk: 'Medium', desc: '‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á', history: ['2565'] };
                return { risk: 'Low', desc: '‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ï‡πà‡∏≥', history: [] };
            };

            const fetchDetailedWeather = async (lat, lng) => {
                try {
                    const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&current=temperature_2m,rain,surface_pressure&daily=temperature_2m_max,temperature_2m_min,precipitation_sum&timezone=Asia%2FBangkok&forecast_days=1`);
                    const data = await res.json();
                    if (data && data.current && data.daily) {
                        setWeatherData({
                            temp: data.current.temperature_2m,
                            rain: data.current.rain,
                            tempMax: data.daily.temperature_2m_max[0],
                            tempMin: data.daily.temperature_2m_min[0],
                            dailyRain: data.daily.precipitation_sum[0],
                            seasonalAvgTemp: data.daily.temperature_2m_max[0] - 2,
                            seasonalAvgRain: 1200
                        });
                    }
                } catch (e) { setWeatherData(null); }
            };

            useEffect(() => {
                if (soilInfo.lat) {
                    fetchDetailedWeather(soilInfo.lat, soilInfo.lng);
                    fetchDetailedAddress(soilInfo.lat, soilInfo.lng);
                    setFloodData(calculateFloodRisk(soilInfo.lat, soilInfo.lng));
                }
            }, [soilInfo.lat, soilInfo.lng]);

            useEffect(() => {
                if (debounceRef.current) clearTimeout(debounceRef.current);
                setAnalyzing(true);
                debounceRef.current = setTimeout(analyzeData, 800);
                return () => clearTimeout(debounceRef.current);
            }, [province, area, weatherData, floodData]);

            const handleRegionSelect = (regionName) => {
                setSelectedRegion(regionName);
            };

            const handleProvinceSelect = async (provName) => {
                setSelectedProvince(provName);
                setProvince(provName);
                setHasArrived(false);

                const info = PROVINCE_DATA[provName];
                setSoilInfo(info);
                setUserHasInteracted(true);
                if (mapInstance) {
                    onTravelStart(`‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Å‡∏≤‡∏£‡∏ö‡∏¥‡∏ô...`);
                    const startLat = DON_MUEANG_COORDS[0];
                    const startLng = DON_MUEANG_COORDS[1];
                    const endLat = info.lat;
                    const endLng = info.lng;
                    const midLat = (startLat + endLat) / 2;
                    const midLng = (startLng + endLng) / 2;
                    const slowNetTimer = setTimeout(() => {
                        onTravelStart(`‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏≠‡∏¥‡∏ô‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï‡πÄ‡∏¢‡∏≠‡∏∞‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...`);
                    }, 2000);
                    const cacheTasks = [
                        checkAndPreloadTiles(startLat, startLng, 9),
                        checkAndPreloadTiles(midLat, midLng, 9),
                        checkAndPreloadTiles(endLat, endLng, 9)
                    ];
                    await Promise.all(cacheTasks);
                    clearTimeout(slowNetTimer);
                    onTravelStart(`‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏≠‡∏≠‡∏Å‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡πÑ‡∏õ ${provName}!`);
                    setTimeout(() => {
                        const offsetLat = info.lat - 0.15;
                        mapInstance.flyTo([offsetLat, info.lng], 9, { duration: 8, easeLinearity: 0.25 });
                        setTimeout(() => {
                            onTravelEnd();
                            setHasArrived(true);
                            if (kasetMarkerRef.current) {
                                kasetMarkerRef.current.setLatLng([info.lat, info.lng]);
                            }
                        }, 8000);
                    }, 500);
                }
            };

            const resetRegion = () => {
                setSelectedRegion(null);
                setSelectedProvince(null);
                if (mapInstance) mapInstance.flyTo(DON_MUEANG_COORDS, 10, { duration: 4 });
            };

            const handleProvinceChange = (e) => {
                const p = e.target.value;
                setProvince(p);
                setHasArrived(true);

                const info = PROVINCE_DATA[p];
                setSoilInfo(info);
                setUserHasInteracted(true);
                if (mapInstance && kasetMarkerRef.current) {
                    const offsetLat = info.lat - 0.15;
                    mapInstance.flyTo([offsetLat, info.lng], 10, { duration: 3 });
                    kasetMarkerRef.current.setLatLng([info.lat, info.lng]);
                }
            };

            const inputContainerClass = !userHasInteracted
                ? "bg-slate-900/40 backdrop-blur-xl p-2 rounded-full border-2 border-yellow-400 shadow-[0_0_20px_rgba(250,204,21,0.5)] animate-attention transition-all duration-300 transform scale-105"
                : "bg-slate-900/10 backdrop-blur-xl px-4 py-1.5 rounded-full border border-white/20 shadow-lg transition-all duration-300";

            const resultHeaderClass = "w-full min-h-14 flex flex-col justify-center px-4 py-2 bg-black/80 text-white cursor-pointer pointer-events-auto rounded-t-xl border-t border-white/10 backdrop-blur-md";

            const totalPages = results ? Math.ceil(results.length / itemsPerPage) : 0;
            const paginatedResults = results ? results.slice((currentPage - 1) * itemsPerPage, currentPage * itemsPerPage) : [];
            const bottomSheetClass = `absolute bottom-0 left-0 right-0 mx-auto w-full md:max-w-4xl lg:max-w-5xl bg-transparent z-[1000] bottom-sheet flex flex-col pointer-events-none transition-all duration-500 ${isFullSheet || !selectedProvince ? 'h-[90%] max-h-[95dvh]' : 'h-[65%] max-h-[70dvh] landscape:h-[80%]'}`;

            return (
                <div className="relative w-full h-[100dvh] overflow-hidden ui-layer pointer-events-none">
                    <button onClick={toggleFullScreen} className="absolute top-6 right-6 z-[1050] bg-slate-900/10 backdrop-blur-xl border border-white/20 text-white w-10 h-10 rounded-full flex items-center justify-center hover:bg-slate-800/40 hover:scale-110 transition-all shadow-lg pointer-events-auto">
                        <i className={`fa-solid ${isFullscreen ? 'fa-compress' : 'fa-expand'} text-sm`}></i>
                    </button>

                    {selectedProvince && (
                        <div className="absolute top-4 left-1/2 -translate-x-1/2 z-[990] w-full pointer-events-auto">
                            <div className={inputContainerClass + " flex flex-row items-center gap-2 justify-center w-fit mx-auto"}>
                                <button onClick={resetRegion} className="w-8 h-8 rounded-full bg-slate-700 hover:bg-slate-600 text-white flex items-center justify-center border border-white/20 transition mr-1" title="‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏†‡∏π‡∏°‡∏¥‡∏†‡∏≤‡∏Ñ">
                                    <i className="fa-solid fa-arrow-left"></i>
                                </button>
                                <div className="relative group">
                                    <i className={`fa-solid fa-location-dot absolute left-2 top-2 text-xs z-10 ${!userHasInteracted ? 'text-yellow-400 animate-bounce' : 'text-emerald-300'}`}></i>
                                    <select className={`w-[140px] py-1.5 pl-7 pr-4 text-xs rounded-full text-white focus:outline-none appearance-none cursor-pointer font-bold ${!userHasInteracted ? 'bg-yellow-500/20 border-yellow-500' : 'bg-transparent border border-white/30'}`}
                                        value={province} onChange={handleProvinceChange}>
                                        {regions[selectedRegion].sort().map(p => (
                                            <option key={p} value={p} className="text-white bg-slate-800">{p}</option>
                                        ))}
                                    </select>
                                </div>
                                <div className="flex items-center gap-2">
                                    <input
                                        type="number"
                                        step="0.1" // üëà ‡πÄ‡∏û‡∏¥‡πà‡∏°
                                        min="0"    // üëà ‡πÄ‡∏û‡∏¥‡πà‡∏°
                                        value={area}
                                        onChange={(e) => {
                                            // üëà ‡πÅ‡∏Å‡πâ: ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏° ‡πÅ‡∏•‡∏∞‡∏´‡πâ‡∏≤‡∏°‡∏ï‡∏¥‡∏î‡∏•‡∏ö
                                            const val = parseFloat(e.target.value);
                                            setArea(isNaN(val) ? 0 : Math.max(0, val));
                                            setUserHasInteracted(true);
                                        }}
                                        className={`w-[50px] py-1.5 text-xs text-center rounded-full text-white focus:outline-none font-bold ${!userHasInteracted ? 'bg-yellow-500/20 border border-yellow-500 placeholder-yellow-200' : 'bg-transparent border border-white/30'}`}
                                        placeholder="‡πÑ‡∏£‡πà"
                                    />
                                    <span className={`text-[10px] font-bold ${!userHasInteracted ? 'text-yellow-300' : 'text-white/80'}`}>‡πÑ‡∏£‡πà</span>
                                </div>
                            </div>
                        </div>
                    )}

                    {selectedProvince && (
                        <>
                            <div className="absolute top-[80px] left-4 z-[950] pointer-events-none flex flex-col gap-2 text-[10px] md:text-xs text-white drop-shadow-[0_1px_2px_rgba(0,0,0,0.8)] max-w-[45%]">
                                <div>
                                    <div className="font-bold text-emerald-300"><i className="fa-solid fa-map-pin"></i> ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</div>
                                    <div>{address.village}</div>
                                    <div>{address.subDistrict} {'>'} {address.district}</div>
                                    <div className="text-yellow-400">{address.province}</div>
                                </div>
                                <div className="mt-1">
                                    <div className="font-bold text-amber-300"><i className="fa-solid fa-layer-group"></i> ‡∏î‡∏¥‡∏ô & ‡∏ô‡πâ‡∏≥</div>
                                    <div>‡∏ä‡∏ô‡∏¥‡∏î: {soilInfo.soil}</div>
                                    <div>pH: {soilInfo.ph} | ‡∏ä‡∏∑‡πâ‡∏ô: {soilInfo.moisture}%</div>
                                    {(floodData.risk === 'High' || floodData.risk === 'Medium') && (
                                        <div className="mt-1 bg-red-500/20 border border-red-500/50 p-1 rounded text-[9px] text-red-100 animate-pulse w-fit">
                                            <div className="font-bold flex items-center gap-1">
                                                <i className="fa-solid fa-clock-rotate-left"></i> ‡πÄ‡∏Ñ‡∏¢‡∏ó‡πà‡∏ß‡∏°: {floodData.history.join(', ')}
                                            </div>
                                        </div>
                                    )}
                                    <div className={`${floodData.risk === 'High' ? 'text-red-400 font-bold' : (floodData.risk === 'Medium' ? 'text-orange-400 font-bold' : 'text-green-300')}`}>
                                        {floodData.desc}
                                    </div>
                                </div>
                            </div>

                            <div className="absolute top-[80px] right-4 z-[950] pointer-events-none flex flex-col gap-2 text-[10px] md:text-xs text-white drop-shadow-[0_1px_2px_rgba(0,0,0,0.8)] text-right items-end max-w-[45%]">
                                <div>
                                    <div className="font-bold text-blue-300"><i className="fa-solid fa-temperature-half"></i> ‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥ (Live)</div>
                                    <div className="text-xl font-bold">{weatherData ? weatherData.temp : '-'}¬∞C</div>
                                    <div>‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î: {weatherData ? weatherData.tempMin : '-'} | ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î: {weatherData ? weatherData.tempMax : '-'}</div>
                                </div>
                                <div className="mt-1">
                                    <div className="font-bold text-cyan-300"><i className="fa-solid fa-cloud-rain"></i> ‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏ù‡∏ô</div>
                                    <div>‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ: {weatherData ? weatherData.rain : 0}mm</div>
                                    <div>‡∏™‡∏∞‡∏™‡∏° 24‡∏ä‡∏°: {weatherData ? weatherData.dailyRain : 0}mm</div>
                                    <div>‡∏ó‡∏±‡πâ‡∏á‡∏õ‡∏µ: ~{weatherData ? weatherData.seasonalAvgRain : '-'}mm</div>
                                </div>
                            </div>
                        </>
                    )}

                    <div className={bottomSheetClass}>
                        {!selectedRegion ? (
                            <div className="flex-1 flex items-center justify-center p-6 pointer-events-auto">
                                <div className="w-full max-w-2xl grid grid-cols-2 gap-4 animate-fade-in-up">
                                    {Object.keys(regions).map((region) => (
                                        <button
                                            key={region}
                                            onClick={() => handleRegionSelect(region)}
                                            className="bg-slate-800/80 hover:bg-emerald-600/90 backdrop-blur-md border border-white/20 rounded-xl p-6 flex flex-col items-center justify-center gap-2 transition-all hover:scale-105 shadow-lg group h-32"
                                        >
                                            <span className="text-3xl group-hover:animate-bounce">
                                                {region === '‡πÄ‡∏´‡∏ô‡∏∑‡∏≠' && 'üå≤'}
                                                {region === '‡∏≠‡∏µ‡∏™‡∏≤‡∏ô' && 'üçÇ'}
                                                {region === '‡∏Å‡∏•‡∏≤‡∏á' && 'üèôÔ∏è'}
                                                {region === '‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å' && 'üè≠'}
                                                {region === '‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏ï‡∏Å' && '‚õ∞Ô∏è'}
                                                {region === '‡πÉ‡∏ï‡πâ' && 'üåä'}
                                            </span>
                                            <span className="text-xl font-bold text-white">‡∏†‡∏≤‡∏Ñ{region}</span>
                                        </button>
                                    ))}
                                </div>
                            </div>
                        ) : !selectedProvince ? (
                            <div className="flex-1 flex flex-col items-center p-4 pointer-events-auto bg-black/60 rounded-t-3xl backdrop-blur-sm max-w-2xl mx-auto w-full">
                                <div className="flex items-center gap-4 mb-4 w-full px-4">
                                    <button onClick={() => setSelectedRegion(null)} className="text-white/70 hover:text-white"><i className="fa-solid fa-arrow-left"></i></button>
                                    <h2 className="text-xl font-bold text-white">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡πÉ‡∏ô‡∏†‡∏≤‡∏Ñ{selectedRegion}</h2>
                                </div>
                                <div className="w-full grid grid-cols-3 gap-2 overflow-y-auto pb-10 scrollbar-prominent px-2">
                                    {regions[selectedRegion].sort().map(p => (
                                        <button
                                            key={p}
                                            onClick={() => handleProvinceSelect(p)}
                                            className="bg-slate-700/80 hover:bg-yellow-500 hover:text-slate-900 border border-white/10 rounded-lg p-3 text-xs md:text-sm font-bold text-white transition-all shadow-md"
                                        >
                                            {p}
                                        </button>
                                    ))}
                                </div>
                            </div>
                        ) : (
                            hasArrived && (
                                <>
                                    {isFullSheet && <button onClick={() => setIsFullSheet(false)} className="absolute top-4 right-4 z-[1010] text-white pointer-events-auto"><i className="fa-solid fa-times text-xl"></i></button>}

                                    {/* ‡∏™‡πà‡∏ß‡∏ô Header ‡∏à‡∏±‡∏î‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏û‡∏∑‡∏ä‡πÄ‡∏®‡∏£‡∏©‡∏ê‡∏Å‡∏¥‡∏à (‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï) */}
                                    <div className={resultHeaderClass} onClick={() => setIsFullSheet(!isFullSheet)}>
                                        <div className="flex flex-wrap justify-between items-center w-full gap-2">
                                            <div className="flex flex-col items-start gap-1">
                                                <div className={`font-bold text-base md:text-lg flex items-center gap-2 ${userHasInteracted ? 'text-emerald-200' : 'text-emerald-400'}`}>
                                                    <i className="fa-solid fa-ranking-star"></i>
                                                    <span className="truncate max-w-[200px] sm:max-w-none">‡∏à‡∏±‡∏î‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏û‡∏∑‡∏ä‡πÄ‡∏®‡∏£‡∏©‡∏ê‡∏Å‡∏¥‡∏à ({selectedProvince})</span>
                                                </div>

                                                {/* ‚òÖ‚òÖ‚òÖ ‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏±‡∏î‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö ‚òÖ‚òÖ‚òÖ */}
                                                <div className="text-[10px] text-slate-400 font-light leading-tight">
                                                    ‡∏ú‡∏•‡∏¥‡∏ï‡πÇ‡∏î‡∏¢: Mr.Winai Phanarkat ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡πÑ‡∏ó‡∏¢ | ‡πÑ‡∏•‡∏ô‡πå/‡πÇ‡∏ó‡∏£: 0926533228
                                                </div>
                                            </div>

                                            <div className="flex items-center gap-3" onClick={(e) => e.stopPropagation()}>
                                                {results && results.length > itemsPerPage && (
                                                    <div className="flex items-center gap-2 text-xs bg-white/10 rounded-full px-2 py-1">
                                                        <button onClick={() => setCurrentPage(p => Math.max(1, p - 1))} disabled={currentPage === 1} className={`w-6 h-6 flex items-center justify-center rounded-full transition ${currentPage === 1 ? 'text-slate-500' : 'text-white hover:bg-white/20'}`}><i className="fa-solid fa-chevron-left"></i></button>
                                                        <span className="font-mono text-yellow-400">{currentPage}/{totalPages}</span>
                                                        <button onClick={() => setCurrentPage(p => Math.min(totalPages, p + 1))} disabled={currentPage === totalPages} className={`w-6 h-6 flex items-center justify-center rounded-full transition ${currentPage === totalPages ? 'text-slate-500' : 'text-white hover:bg-white/20'}`}><i className="fa-solid fa-chevron-right"></i></button>
                                                    </div>
                                                )}
                                                <div className="text-slate-400 text-sm ml-2" onClick={() => setIsFullSheet(!isFullSheet)}>
                                                    <i className={`fa-solid fa-chevron-up transition-transform ${isFullSheet ? 'rotate-180' : ''}`}></i>
                                                </div>
                                            </div>
                                        </div>
                                        {/* ‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏•‡πà‡∏≤‡∏á (‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏ï‡πá‡∏°‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ç‡∏¢‡∏≤‡∏¢‡∏à‡∏≠) */}
                                        {isFullSheet && (
                                            <div className="w-full text-[9px] text-slate-500 text-center mt-2 pt-2 border-t border-white/5">
                                                ‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πå: winayo@gmail.com
                                            </div>
                                        )}
                                    </div>

                                    <div className="flex-1 flex flex-col pointer-events-auto bg-black/60 border-x border-white/10 backdrop-filter-none">
                                        <div
                                            ref={listContainerRef}
                                            className="flex-1 overflow-y-scroll scrollbar-prominent pb-10 pointer-events-auto overscroll-contain"
                                            style={{ WebkitOverflowScrolling: 'touch', touchAction: 'pan-y', isolation: 'isolate' }}
                                            onWheel={(e) => { e.stopPropagation(); }}
                                            onMouseDown={(e) => { e.stopPropagation(); }}
                                            onTouchStart={(e) => { e.stopPropagation(); }}
                                        >
                                            {results ? paginatedResults.map((item, i) => {
                                                const realIndex = (currentPage - 1) * itemsPerPage + i;
                                                return (
                                                    <div key={realIndex} onClick={() => setSimulatingItem(item)}
                                                        className="group flex flex-col sm:flex-row items-start sm:items-center justify-between border-b border-white/10 p-4 cursor-pointer transition hover:bg-white/10 px-4 md:px-6 w-full gap-3">
                                                        <div className="flex items-start gap-3 w-full sm:w-auto">
                                                            <div className="w-8 h-8 rounded-full bg-slate-700/50 flex items-center justify-center text-sm font-bold text-emerald-400 border border-emerald-500/30 shrink-0 shadow-lg mt-1 sm:mt-0">
                                                                {realIndex + 1}
                                                            </div>
                                                            <div className="flex flex-col gap-1 w-full">
                                                                <span className="text-base md:text-lg font-bold text-slate-100 leading-snug group-hover:text-yellow-400 transition break-words">{item.name}</span>
                                                                <div className="flex flex-wrap items-center gap-2 opacity-80">
                                                                    {item.refSources && item.refSources.map((src, idx) => (
                                                                        <span key={idx} className={`text-[10px] px-2 py-0.5 rounded border ${src.color} ${src.borderColor} ${src.bg} flex items-center gap-1 whitespace-nowrap`}>
                                                                            <i className={`fa-solid ${src.icon} text-[9px]`}></i>
                                                                            {src.name}
                                                                        </span>
                                                                    ))}
                                                                </div>
                                                                <div className="flex flex-col text-[10px] text-slate-300 mt-1">
                                                                    <span>‡∏£‡∏≤‡∏Ñ‡∏≤: {item.price.toLocaleString()} ‡∏ö‡∏≤‡∏ó/‡∏ï‡∏±‡∏ô</span>
                                                                    <span>Demand/Supply: {item.risk === 'High' ? 'Supply ‡∏™‡∏π‡∏á/‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ú‡∏±‡∏ô‡∏ú‡∏ß‡∏ô' : (item.risk === 'Medium' ? '‡∏™‡∏°‡∏î‡∏∏‡∏•' : 'Demand ‡∏™‡∏π‡∏á/‡∏£‡∏≤‡∏Ñ‡∏≤‡∏°‡∏±‡πà‡∏ô‡∏Ñ‡∏á')}</span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div className="flex items-center justify-between sm:justify-end w-full sm:w-auto gap-4 pl-11 sm:pl-0 mt-2 sm:mt-0">
                                                            <div className="flex flex-col text-left sm:text-right">
                                                                <span className="text-[10px] text-slate-400 leading-tight">‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</span>
                                                                <span className={`text-base md:text-xl font-bold ${item.profitTotal > 0 ? 'text-emerald-400' : 'text-red-400'}`}>
                                                                    {item.profitTotal > 0 ? '+' : ''}{item.profitTotal.toLocaleString()}
                                                                </span>
                                                            </div>
                                                            <div className="flex flex-col text-left sm:text-right w-[60px] sm:w-[80px]">
                                                                <span className="text-[10px] text-slate-400 leading-tight">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á</span>
                                                                <span className={`text-xs font-bold ${item.risk_level === 'High' ? 'text-red-400' : (item.risk_level === 'Medium' ? 'text-orange-400' : 'text-green-400')}`}>
                                                                    {item.risk_level}
                                                                </span>
                                                            </div>
                                                            <button
                                                                onClick={(e) => { e.stopPropagation(); setSimulatingItem(item); }}
                                                                className="w-8 h-8 rounded-full bg-yellow-500 hover:bg-yellow-400 text-slate-900 flex items-center justify-center shadow-[0_0_10px_rgba(234,179,8,0.6)] animate-pulse group-hover:scale-110 transition shrink-0"
                                                            >
                                                                <i className="fa-solid fa-chevron-right text-xs"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                );
                                            }) : <div className="text-center p-10 text-slate-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå...</div>}
                                        </div>
                                    </div>
                                </>
                            )
                        )}
                    </div>

                    {simulatingItem && (
                        <SimulationModal
                            item={simulatingItem}
                            initialArea={area}
                            floodData={floodData}
                            soilInfo={soilInfo}
                            onClose={() => setSimulatingItem(null)}
                        />
                    )}
                </div>
            );
        };

        const HomePage = ({ setPage, onStartTransition }) => {
            const [isFullscreen, setIsFullscreen] = useState(false);
            const toggleFullScreen = () => {
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen().then(() => setIsFullscreen(true));
                } else {
                    if (document.exitFullscreen) {
                        document.exitFullscreen().then(() => setIsFullscreen(false));
                    }
                }
            };

            useEffect(() => {
                checkAndPreloadTiles(13.9133, 100.6042, 10);
            }, []);

            return (
                <div className="min-h-screen relative flex flex-col items-center justify-center text-white p-6 overflow-hidden ui-layer">
                    <div className="absolute inset-0 w-full h-full pointer-events-none z-0 overflow-hidden">
                        <div className="cloud-layer opacity-30 mix-blend-screen"></div>
                        <div className="cloud-layer opacity-20 mix-blend-screen" style={{ animationDirection: 'reverse', animationDuration: '60s' }}></div>
                    </div>

                    <button onClick={toggleFullScreen} className="absolute top-6 right-6 z-50 bg-slate-800/40 backdrop-blur-md border border-white/10 text-white w-10 h-10 rounded-full flex items-center justify-center hover:bg-slate-700/60 hover:scale-110 transition-all shadow-[0_0_15px_rgba(255,255,255,0.1)] group">
                        <i className={`fa-solid ${isFullscreen ? 'fa-compress' : 'fa-expand'} text-sm group-hover:text-emerald-400`}></i>
                    </button>

                    <div className="z-20 text-center animate-fade-in-up relative flex flex-col items-center">
                        <div className="relative mb-4 pr-2">
                            <div className="absolute top-0 right-[-3px] w-2 h-2 bg-yellow-400 rounded-full shadow-[0_0_5px_rgba(250,204,21,0.8)] z-20"></div>
                            <div className="absolute top-0 right-[-1px] w-1 h-20 bg-slate-400 rounded-b-full shadow-sm z-0"></div>
                            <img src="https://upload.wikimedia.org/wikipedia/commons/a/a9/Flag_of_Thailand.svg" alt="Thai Flag" className="w-24 h-auto animate-flag-wave relative z-10" style={{ transformOrigin: 'center right' }} />
                        </div>

                        <h1 className="text-5xl md:text-7xl font-bold mb-2 text-transparent bg-clip-text bg-gradient-to-r from-yellow-300 via-emerald-400 to-cyan-400 drop-shadow-[0_2px_10px_rgba(0,0,0,0.8)]">
                            Winai Innovation
                        </h1>
                        <p className="text-slate-200 text-lg md:text-xl mb-2 drop-shadow-md font-light bg-black/30 px-4 py-1 rounded-full inline-block backdrop-blur-sm border border-white/10">
                            Super App ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£‡πÑ‡∏ó‡∏¢
                        </p>

                        <div className="flex flex-col gap-6 w-full max-w-sm mx-auto">
                            <button onClick={onStartTransition} className="btn-super-pulse bg-gradient-to-r from-fuchsia-600 via-pink-600 to-orange-500 p-5 rounded-2xl font-bold text-xl text-white hover:scale-105 transition transform shadow-[0_0_20px_rgba(236,72,153,0.5)] border-2 border-white/20 relative overflow-hidden group">
                                <div className="absolute inset-0 bg-white/20 group-hover:bg-white/30 transition"></div>
                                <div className="relative flex items-center justify-center gap-3">
                                    <i className="fa-solid fa-globe text-2xl animate-spin-slow"></i>
                                    <span>Kaset Cloud</span>
                                </div>
                                <span className="text-xs font-normal opacity-90 block mt-1">(‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏ß‡∏¢‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥ 99%)</span>
                            </button>

                            <div className="bg-black/40 px-6 py-4 rounded-xl backdrop-blur-sm border border-white/5 flex flex-col items-center w-full">
                                <div className="flex flex-wrap justify-center gap-3 mb-3">
                                    <a href="https://line.me/ti/p/-M5tBwhz9j" target="_blank" className="inline-flex items-center justify-center gap-2 bg-[#06C755] hover:bg-[#05a546] text-white py-1 px-3 rounded-full text-xs font-bold shadow-sm transition hover:scale-105">
                                        <i className="fa-brands fa-line text-lg"></i>
                                        Admin ‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£‡πÑ‡∏ó‡∏¢‡∏°‡∏±‡πà‡∏á‡∏Ñ‡∏±‡πà‡∏á
                                    </a>
                                    <a href="https://www.facebook.com/winayo1" target="_blank" className="inline-flex items-center justify-center gap-2 bg-[#1877F2] hover:bg-[#166fe5] text-white py-1 px-3 rounded-full text-xs font-bold shadow-sm transition hover:scale-105">
                                        <i className="fa-brands fa-facebook text-lg"></i>
                                        Facebook
                                    </a>
                                </div>
                                <div className="text-[10px] md:text-xs text-slate-400">
                                    <p className="mb-1 font-bold text-slate-300">‡∏ú‡∏•‡∏¥‡∏ï‡πÇ‡∏î‡∏¢: Mr.Winai Phanarkat ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡πÑ‡∏ó‡∏¢</p>
                                    <p>‡πÑ‡∏•‡∏ô‡πå/‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£: 0926533228 | ‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πå: winayo@gmail.com</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const VinaiInnovationPortal = () => {
            const [page, setPage] = useState('home');
            const [isTransitioning, setIsTransitioning] = useState(false);
            const [travelState, setTravelState] = useState({ active: false, message: '' });
            const mapRef = useRef(null);
            const rotationInterval = useRef(null);

            const jetSoundRef = useRef(new Audio('https://www.soundjay.com/transportation/sounds/airplane-fly-by-01.mp3'));

            const playJetSound = () => {
                try {
                    jetSoundRef.current.currentTime = 0;
                    jetSoundRef.current.volume = 0.5;
                    jetSoundRef.current.play().catch(e => console.log("Audio play failed"));
                } catch (e) { }
            };

            useEffect(() => {
                if (!document.getElementById('global-map')) return;
                const map = L.map('global-map', { zoomControl: false, attributionControl: false, zoomSnap: 0.1, minZoom: 2 }).setView([13.7563, 100.5018], 2.5);
                L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Tiles &copy; Esri' }).addTo(map);
                L.tileLayer('https://mt1.google.com/vt/lyrs=h&x={x}&y={y}&z={z}', { opacity: 0.5 }).addTo(map);
                L.control.zoom({ position: 'bottomright' }).addTo(map);
                mapRef.current = map;
                startRotation(map);
                return () => { if (map) map.remove(); stopRotation(); };
            }, []);

            const startRotation = (map) => {
                if (rotationInterval.current) clearInterval(rotationInterval.current);
                map.dragging.disable(); map.scrollWheelZoom.disable(); map.touchZoom.disable(); map.doubleClickZoom.disable();
                rotationInterval.current = setInterval(() => { if (map) map.panBy([1, 0], { animate: false }); }, 50);
            };

            const stopRotation = () => {
                if (rotationInterval.current) { clearInterval(rotationInterval.current); rotationInterval.current = null; }
            };

            const startTravel = (msg) => {
                playJetSound();
                setTravelState({ active: true, message: msg });
            };

            const endTravel = () => setTravelState({ active: false, message: '' });

            const handleStartKaset = () => {
                if (!mapRef.current) return;
                playJetSound();
                setIsTransitioning(true);
                setTravelState({ active: true, message: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡πÑ‡∏õ‡∏ó‡∏µ‡πà ‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£ (‡∏î‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡∏≠‡∏á)...' });
                stopRotation();
                mapRef.current.flyTo(DON_MUEANG_COORDS, 10, { duration: 8, easeLinearity: 0.25 });
                setTimeout(() => { setPage('kaset'); setIsTransitioning(false); setTravelState({ active: false, message: '' }); }, 8000);
            };

            const handleGoHome = () => {
                playJetSound();
                setPage('home');
                if (mapRef.current) {
                    mapRef.current.flyTo([13.7563, 100.5018], 2.5, { duration: 3 });
                    setTimeout(() => startRotation(mapRef.current), 3000);
                }
            };

            return (
                <div className="font-sans text-slate-200 h-[100dvh] w-screen overflow-hidden">
                    <div id="global-map"></div>
                    <CloudOverlay isActive={travelState.active} message={travelState.message} />

                    <button onClick={handleGoHome} className="absolute top-6 left-6 z-[1050] bg-slate-900/10 hover:bg-slate-900/30 text-white w-10 h-10 rounded-full flex items-center justify-center backdrop-blur-md border border-white/20 shadow-lg transition-all group pointer-events-auto" title="‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å">
                        <i className="fa-solid fa-house text-sm group-hover:text-emerald-400"></i>
                    </button>

                    {page === 'home' && <div className={`absolute inset-0 z-20 transition-opacity duration-1000 ${isTransitioning ? 'opacity-0 pointer-events-none' : 'opacity-100'}`}><HomePage setPage={setPage} onStartTransition={handleStartKaset} /></div>}
                    {page === 'kaset' && !isTransitioning && <KasetCloudApp mapInstance={mapRef.current} onTravelStart={startTravel} onTravelEnd={endTravel} />}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<VinaiInnovationPortal />);
    </script>
</body>

</html>
