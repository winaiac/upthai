<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Winai Innovation Portal - Super App ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡πÑ‡∏ó‡∏¢</title>

    <!-- FAVICON (Thai Flag) -->
    <link rel="icon" type="image/svg+xml"
        href="https://upload.wikimedia.org/wikipedia/commons/a/a9/Flag_of_Thailand.svg">

    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Leaflet Map CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;700&display=swap');

        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #0f172a;
            color: #f1f5f9;
            overflow: hidden;
            /* Prevent body scroll, handle in app */
        }

        /* Leaflet Cursor Fixes */
        .leaflet-container {
            cursor: grab !important;
        }

        .leaflet-container:active {
            cursor: grabbing !important;
        }

        .leaflet-interactive {
            cursor: pointer !important;
        }

        .animate-fade-in-up {
            animation: fadeInUp 0.5s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse-glow {

            0%,
            100% {
                box-shadow: 0 0 15px rgba(236, 72, 153, 0.6);
                transform: scale(1);
            }

            50% {
                box-shadow: 0 0 30px rgba(236, 72, 153, 1);
                transform: scale(1.05);
            }
        }

        /* Intense Button Pulse */
        @keyframes intense-pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(234, 179, 8, 0.7);
                transform: scale(1);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(234, 179, 8, 0);
                transform: scale(1.05);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(234, 179, 8, 0);
                transform: scale(1);
            }
        }

        .animate-intense {
            animation: intense-pulse 1.5s infinite;
        }

        /* Attention Seeking Pulse for Inputs */
        @keyframes attention-pulse {

            0%,
            100% {
                box-shadow: 0 0 0 0 rgba(250, 204, 21, 0.7);
                transform: scale(1);
                border-color: rgba(250, 204, 21, 0.8);
            }

            50% {
                box-shadow: 0 0 20px 5px rgba(250, 204, 21, 0.5);
                transform: scale(1.02);
                border-color: rgba(250, 204, 21, 1);
            }
        }

        /* Result Invitation Pulse */
        @keyframes invite-pulse {

            0%,
            100% {
                box-shadow: 0 -5px 15px rgba(16, 185, 129, 0.3);
                background-color: rgba(6, 78, 59, 0.9);
            }

            50% {
                box-shadow: 0 -5px 25px rgba(16, 185, 129, 0.6);
                background-color: rgba(6, 78, 59, 1);
            }
        }

        .animate-attention {
            animation: attention-pulse 2s infinite;
        }

        .animate-invite {
            animation: invite-pulse 2s infinite;
        }

        .btn-super-pulse {
            animation: pulse-glow 2s infinite;
        }

        /* Prominent Scrollbar */
        .scrollbar-prominent::-webkit-scrollbar {
            width: 10px;
        }

        .scrollbar-prominent::-webkit-scrollbar-track {
            background: #1e293b;
            border-radius: 0 0 10px 0;
            border-left: 1px solid #334155;
        }

        .scrollbar-prominent::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #fbbf24, #f59e0b, #d97706);
            border-radius: 6px;
            border: 2px solid #0f172a;
            box-shadow: inset 0 0 5px rgba(255, 255, 255, 0.5);
        }

        .scrollbar-prominent::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, #fcd34d, #fbbf24, #f59e0b);
        }

        .bottom-sheet {
            transition: height 0.5s cubic-bezier(0.32, 0.72, 0, 1);
        }

        /* Map Container Z-Index management */
        #global-map {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
        }

        .ui-layer {
            position: relative;
            z-index: 10;
        }

        /* CLOUD ANIMATION CSS */
        .cloud-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 50;
            opacity: 0;
            transition: opacity 0.8s ease-in-out;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .cloud-container.active {
            opacity: 1;
            pointer-events: auto;
            /* Block clicks while traveling */
        }

        .cloud-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 200%;
            height: 100%;
            background:
                radial-gradient(circle at 10% 20%, rgba(255, 255, 255, 0.5) 0%, transparent 20%),
                radial-gradient(circle at 30% 80%, rgba(255, 255, 255, 0.4) 0%, transparent 25%),
                radial-gradient(circle at 50% 30%, rgba(255, 255, 255, 0.5) 0%, transparent 15%),
                radial-gradient(circle at 70% 60%, rgba(255, 255, 255, 0.4) 0%, transparent 20%),
                radial-gradient(circle at 90% 10%, rgba(255, 255, 255, 0.5) 0%, transparent 25%);

            background-size: 100% 100%;
            filter: blur(40px);
            opacity: 0.6;
            animation: cloudFly 3s linear infinite;
        }

        .cloud-layer:nth-child(2) {
            top: 10%;
            width: 250%;
            background:
                radial-gradient(circle at 15% 50%, rgba(255, 255, 255, 0.3) 0%, transparent 25%),
                radial-gradient(circle at 45% 10%, rgba(255, 255, 255, 0.4) 0%, transparent 20%),
                radial-gradient(circle at 75% 80%, rgba(255, 255, 255, 0.3) 0%, transparent 25%);
            animation: cloudFly 5s linear infinite reverse;
            opacity: 0.4;
            filter: blur(50px);
        }

        .cloud-layer:nth-child(3) {
            top: -10%;
            width: 300%;
            background:
                radial-gradient(circle at 50% 50%, rgba(255, 255, 255, 0.2) 0%, transparent 40%);
            animation: cloudFly 8s linear infinite;
            opacity: 0.3;
            filter: blur(60px);
        }

        @keyframes cloudFly {
            from {
                transform: translateX(-20%);
            }

            to {
                transform: translateX(-60%);
            }
        }

        .travel-message {
            position: relative;
            z-index: 60;
            text-align: center;
            color: #0f172a;
            text-shadow: 0 2px 10px rgba(255, 255, 255, 0.9), 0 0 20px rgba(255, 255, 255, 0.5);
            transform: scale(0.9);
            transition: transform 0.5s;
        }

        .cloud-container.active .travel-message {
            transform: scale(1);
        }
    </style>
</head>

<body class="bg-slate-900 text-slate-100">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- CHART JS DEFAULTS ---
        Chart.defaults.color = '#cbd5e1';
        Chart.defaults.borderColor = '#334155';
        Chart.defaults.font.family = 'Sarabun';

        // --- DATA ---
        const PROVINCE_COORDS = {
            "‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£": [13.7563, 100.5018], "‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà": [18.7883, 98.9853], "‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô": [16.4322, 102.8236],
            "‡∏™‡∏á‡∏Ç‡∏•‡∏≤": [7.1756, 100.6143], "‡∏ô‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡∏™‡∏µ‡∏°‡∏≤": [14.9799, 102.0978], "‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ": [13.3611, 100.9847],
            "‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï": [7.8804, 98.3923], "‡∏™‡∏∏‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå‡∏ò‡∏≤‡∏ô‡∏µ": [9.1386, 99.3218], "‡∏≠‡∏∏‡∏ö‡∏•‡∏£‡∏≤‡∏ä‡∏ò‡∏≤‡∏ô‡∏µ": [15.2448, 104.8473],
            "‡∏≠‡∏∏‡∏î‡∏£‡∏ò‡∏≤‡∏ô‡∏µ": [17.4157, 102.7872], "‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏£‡∏≤‡∏¢": [19.9105, 99.8406], "‡∏à‡∏±‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ": [12.6114, 102.1039],
            "‡∏£‡πâ‡∏≠‡∏¢‡πÄ‡∏≠‡πá‡∏î": [16.0538, 103.6520], "‡∏ô‡πà‡∏≤‡∏ô": [18.7756, 100.7730], "‡∏Å‡∏≤‡∏ç‡∏à‡∏ô‡∏ö‡∏∏‡∏£‡∏µ": [14.0205, 99.5304]
        };

        const PROVINCE_DATA = {};
        const regions = {
            "‡πÄ‡∏´‡∏ô‡∏∑‡∏≠": ["‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏£‡∏≤‡∏¢", "‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà", "‡∏ô‡πà‡∏≤‡∏ô", "‡∏û‡∏∞‡πÄ‡∏¢‡∏≤", "‡πÅ‡∏û‡∏£‡πà", "‡πÅ‡∏°‡πà‡∏Æ‡πà‡∏≠‡∏á‡∏™‡∏≠‡∏ô", "‡∏•‡∏≥‡∏õ‡∏≤‡∏á", "‡∏•‡∏≥‡∏û‡∏π‡∏ô", "‡∏≠‡∏∏‡∏ï‡∏£‡∏î‡∏¥‡∏ï‡∏ñ‡πå", "‡∏™‡∏∏‡πÇ‡∏Ç‡∏ó‡∏±‡∏¢", "‡∏û‡∏¥‡∏©‡∏ì‡∏∏‡πÇ‡∏•‡∏Å", "‡∏û‡∏¥‡∏à‡∏¥‡∏ï‡∏£", "‡πÄ‡∏û‡∏ä‡∏£‡∏ö‡∏π‡∏£‡∏ì‡πå", "‡∏Å‡∏≥‡πÅ‡∏û‡∏á‡πÄ‡∏û‡∏ä‡∏£", "‡∏ï‡∏≤‡∏Å", "‡∏ô‡∏Ñ‡∏£‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡πå", "‡∏≠‡∏∏‡∏ó‡∏±‡∏¢‡∏ò‡∏≤‡∏ô‡∏µ"],
            "‡∏≠‡∏µ‡∏™‡∏≤‡∏ô": ["‡∏Å‡∏≤‡∏¨‡∏™‡∏¥‡∏ô‡∏ò‡∏∏‡πå", "‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô", "‡∏ä‡∏±‡∏¢‡∏†‡∏π‡∏°‡∏¥", "‡∏ô‡∏Ñ‡∏£‡∏û‡∏ô‡∏°", "‡∏ô‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡∏™‡∏µ‡∏°‡∏≤", "‡∏ö‡∏∂‡∏á‡∏Å‡∏≤‡∏¨", "‡∏ö‡∏∏‡∏£‡∏µ‡∏£‡∏±‡∏°‡∏¢‡πå", "‡∏°‡∏´‡∏≤‡∏™‡∏≤‡∏£‡∏Ñ‡∏≤‡∏°", "‡∏°‡∏∏‡∏Å‡∏î‡∏≤‡∏´‡∏≤‡∏£", "‡∏¢‡πÇ‡∏™‡∏ò‡∏£", "‡∏£‡πâ‡∏≠‡∏¢‡πÄ‡∏≠‡πá‡∏î", "‡πÄ‡∏•‡∏¢", "‡∏™‡∏Å‡∏•‡∏ô‡∏Ñ‡∏£", "‡∏™‡∏∏‡∏£‡∏¥‡∏ô‡∏ó‡∏£‡πå", "‡∏®‡∏£‡∏µ‡∏™‡∏∞‡πÄ‡∏Å‡∏©", "‡∏´‡∏ô‡∏≠‡∏á‡∏Ñ‡∏≤‡∏¢", "‡∏´‡∏ô‡∏≠‡∏á‡∏ö‡∏±‡∏ß‡∏•‡∏≥‡∏†‡∏π", "‡∏≠‡∏∏‡∏î‡∏£‡∏ò‡∏≤‡∏ô‡∏µ", "‡∏≠‡∏∏‡∏ö‡∏•‡∏£‡∏≤‡∏ä‡∏ò‡∏≤‡∏ô‡∏µ", "‡∏≠‡∏≥‡∏ô‡∏≤‡∏à‡πÄ‡∏à‡∏£‡∏¥‡∏ç"],
            "‡∏Å‡∏•‡∏≤‡∏á": ["‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£", "‡∏Å‡∏≤‡∏ç‡∏à‡∏ô‡∏ö‡∏∏‡∏£‡∏µ", "‡∏à‡∏±‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ", "‡∏â‡∏∞‡πÄ‡∏ä‡∏¥‡∏á‡πÄ‡∏ó‡∏£‡∏≤", "‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ", "‡∏ä‡∏±‡∏¢‡∏ô‡∏≤‡∏ó", "‡∏ï‡∏£‡∏≤‡∏î", "‡∏ô‡∏Ñ‡∏£‡∏ô‡∏≤‡∏¢‡∏Å", "‡∏ô‡∏Ñ‡∏£‡∏õ‡∏ê‡∏°", "‡∏ô‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ", "‡∏õ‡∏ó‡∏∏‡∏°‡∏ò‡∏≤‡∏ô‡∏µ", "‡∏õ‡∏£‡∏∞‡∏à‡∏ß‡∏ö‡∏Ñ‡∏µ‡∏£‡∏µ‡∏Ç‡∏±‡∏ô‡∏ò‡πå", "‡∏õ‡∏£‡∏≤‡∏à‡∏µ‡∏ô‡∏ö‡∏∏‡∏£‡∏µ", "‡∏û‡∏£‡∏∞‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤", "‡πÄ‡∏û‡∏ä‡∏£‡∏ö‡∏∏‡∏£‡∏µ", "‡∏£‡∏∞‡∏¢‡∏≠‡∏á", "‡∏£‡∏≤‡∏ä‡∏ö‡∏∏‡∏£‡∏µ", "‡∏•‡∏û‡∏ö‡∏∏‡∏£‡∏µ", "‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏õ‡∏£‡∏≤‡∏Å‡∏≤‡∏£", "‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏á‡∏Ñ‡∏£‡∏≤‡∏°", "‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏≤‡∏Ñ‡∏£", "‡∏™‡∏£‡∏∞‡πÅ‡∏Å‡πâ‡∏ß", "‡∏™‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏µ", "‡∏™‡∏¥‡∏á‡∏´‡πå‡∏ö‡∏∏‡∏£‡∏µ", "‡∏™‡∏∏‡∏û‡∏£‡∏£‡∏ì‡∏ö‡∏∏‡∏£‡∏µ", "‡∏≠‡πà‡∏≤‡∏á‡∏ó‡∏≠‡∏á"],
            "‡πÉ‡∏ï‡πâ": ["‡∏Å‡∏£‡∏∞‡∏ö‡∏µ‡πà", "‡∏ä‡∏∏‡∏°‡∏û‡∏£", "‡∏ï‡∏£‡∏±‡∏á", "‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏ò‡∏£‡∏£‡∏°‡∏£‡∏≤‡∏ä", "‡∏ô‡∏£‡∏≤‡∏ò‡∏¥‡∏ß‡∏≤‡∏™", "‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ", "‡∏û‡∏±‡∏á‡∏á‡∏≤", "‡∏û‡∏±‡∏ó‡∏•‡∏∏‡∏á", "‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï", "‡∏¢‡∏∞‡∏•‡∏≤", "‡∏£‡∏∞‡∏ô‡∏≠‡∏á", "‡∏™‡∏á‡∏Ç‡∏•‡∏≤", "‡∏™‡∏ï‡∏π‡∏•", "‡∏™‡∏∏‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå‡∏ò‡∏≤‡∏ô‡∏µ"]
        };

        Object.keys(regions).forEach(region => {
            regions[region].forEach(prov => {
                let ph = 6.5, moisture = 60, soil = "‡∏î‡∏¥‡∏ô‡∏£‡πà‡∏ß‡∏ô";
                if (region === "‡∏≠‡∏µ‡∏™‡∏≤‡∏ô") { ph = 5.5; moisture = 40; soil = "‡∏î‡∏¥‡∏ô‡∏ó‡∏£‡∏≤‡∏¢ (‡∏ä‡∏∏‡∏î‡∏î‡∏¥‡∏ô‡∏£‡πâ‡∏≠‡∏¢‡πÄ‡∏≠‡πá‡∏î)"; }
                if (region === "‡πÄ‡∏´‡∏ô‡∏∑‡∏≠") { ph = 6.0; moisture = 55; soil = "‡∏î‡∏¥‡∏ô‡∏£‡πà‡∏ß‡∏ô‡∏õ‡∏ô‡∏ó‡∏£‡∏≤‡∏¢ (‡∏ä‡∏∏‡∏î‡∏î‡∏¥‡∏ô‡πÅ‡∏°‡πà‡∏£‡∏¥‡∏°)"; }
                if (region === "‡∏Å‡∏•‡∏≤‡∏á") { ph = 7.0; moisture = 70; soil = "‡∏î‡∏¥‡∏ô‡πÄ‡∏´‡∏ô‡∏µ‡∏¢‡∏ß (‡∏ä‡∏∏‡∏î‡∏î‡∏¥‡∏ô‡∏£‡∏≤‡∏ä‡∏ö‡∏∏‡∏£‡∏µ)"; }
                if (region === "‡πÉ‡∏ï‡πâ") { ph = 5.0; moisture = 80; soil = "‡∏î‡∏¥‡∏ô‡∏£‡πà‡∏ß‡∏ô‡∏õ‡∏ô‡∏î‡∏¥‡∏ô‡πÄ‡∏´‡∏ô‡∏µ‡∏¢‡∏ß (‡∏ä‡∏∏‡∏î‡∏î‡∏¥‡∏ô‡∏Ñ‡∏≠‡∏´‡∏á‡∏™‡πå)"; }

                let lat, lng;
                if (PROVINCE_COORDS[prov]) {
                    [lat, lng] = PROVINCE_COORDS[prov];
                } else {
                    let hash = 0;
                    for (let i = 0; i < prov.length; i++) hash = prov.charCodeAt(i) + ((hash << 5) - hash);
                    const offsetLat = ((hash % 1000) / 500) - 1.0;
                    const offsetLng = (((hash >> 2) % 1000) / 500) - 1.0;
                    const centers = { "‡πÄ‡∏´‡∏ô‡∏∑‡∏≠": [18.5, 99.5], "‡∏≠‡∏µ‡∏™‡∏≤‡∏ô": [16.0, 103.5], "‡∏Å‡∏•‡∏≤‡∏á": [14.5, 100.5], "‡πÉ‡∏ï‡πâ": [8.5, 99.5] };
                    const center = centers[region] || [13.7, 100.5];
                    lat = center[0] + offsetLat;
                    lng = center[1] + offsetLng;
                }
                PROVINCE_DATA[prov] = { ph, moisture, soil, region, lat, lng };
            });
        });

        const MARKET_STATS_DB = { '‡∏Ç‡πâ‡∏≤‡∏ß‡∏´‡∏≠‡∏°‡∏°‡∏∞‡∏•‡∏¥': { domestic: 60000, export: 50000, current: 85000 }, '‡∏ó‡∏∏‡πÄ‡∏£‡∏µ‡∏¢‡∏ô': { domestic: 20000, export: 40000, current: 50000 }, '‡∏¢‡∏≤‡∏á‡∏û‡∏≤‡∏£‡∏≤': { domestic: 50000, export: 150000, current: 195000 }, '‡∏°‡∏±‡∏ô‡∏™‡∏≥‡∏õ‡∏∞‡∏´‡∏•‡∏±‡∏á': { domestic: 100000, export: 200000, current: 250000 }, '‡∏Ç‡πâ‡∏≤‡∏ß‡πÇ‡∏û‡∏î‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡∏™‡∏±‡∏ï‡∏ß‡πå': { domestic: 150000, export: 10000, current: 160000 }, '‡∏ú‡∏±‡∏Å‡∏™‡∏•‡∏±‡∏î‡πÑ‡∏Æ‡πÇ‡∏î‡∏£': { domestic: 5000, export: 500, current: 4000 }, '‡∏≠‡πâ‡∏≠‡∏¢‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô': { domestic: 500000, export: 200000, current: 600000 }, '‡∏õ‡∏≤‡∏•‡πå‡∏°‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô': { domestic: 100000, export: 50000, current: 120000 } };
        const CROP_LIFECYCLE = { '‡∏ó‡∏∏‡πÄ‡∏£‡∏µ‡∏¢‡∏ô': { type: 'tree', wait_years: 5, peak_start: 10, decline_start: 20, lifespan: 25, advice: '‚ö†Ô∏è ‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏Å‡πà...' }, '‡∏¢‡∏≤‡∏á‡∏û‡∏≤‡∏£‡∏≤': { type: 'tree', wait_years: 7, peak_start: 12, decline_start: 20, lifespan: 25, advice: '‚ö†Ô∏è ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏≤‡∏¢ ‡∏ô‡πâ‡∏≥‡∏¢‡∏≤‡∏á‡∏•‡∏î‡∏•‡∏á...' }, '‡∏õ‡∏≤‡∏•‡πå‡∏°‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô': { type: 'tree', wait_years: 3, peak_start: 7, decline_start: 18, lifespan: 22, advice: '‚ö†Ô∏è ‡∏ï‡πâ‡∏ô‡∏™‡∏π‡∏á‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏¢‡∏≤‡∏Å...' }, 'default': { type: 'annual', lifespan: 1, advice: '‚ÑπÔ∏è ‡∏Ñ‡∏ß‡∏£‡∏õ‡∏•‡∏π‡∏Å‡∏û‡∏∑‡∏ä‡∏ï‡∏£‡∏∞‡∏Å‡∏π‡∏•‡∏ñ‡∏±‡πà‡∏ß‡∏™‡∏•‡∏±‡∏ö...' } };

        const AppFooter = () => (
            <div className="mt-16 bg-slate-900/80 backdrop-blur-md border-t border-slate-700 py-10 px-4 w-full text-slate-300 relative z-20">
                <div className="max-w-3xl mx-auto text-center">
                    <div className="mb-8 p-6 bg-slate-800/50 rounded-2xl border border-emerald-900/50 shadow-lg">
                        <h3 className="text-emerald-400 font-bold text-lg mb-2">ü§ù ‡∏£‡πà‡∏ß‡∏°‡∏™‡∏ô‡∏±‡∏ö‡∏™‡∏ô‡∏∏‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏µ‡πÜ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡πÑ‡∏ó‡∏¢</h3>
                        <p className="text-slate-400 text-sm mb-4">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡πÑ‡∏ó‡∏¢ ‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÇ‡∏î‡∏¢‡∏Ñ‡∏ô‡πÑ‡∏ó‡∏¢ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏®‡∏£‡∏©‡∏ê‡∏Å‡∏¥‡∏à‡πÑ‡∏ó‡∏¢‡∏¢‡∏±‡πà‡∏á‡∏¢‡∏∑‡∏ô</p>
                    </div>
                    <p className="text-base font-bold text-slate-200">‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÇ‡∏î‡∏¢: ‡∏ß‡∏¥‡∏ô‡∏±‡∏¢ ‡∏ú‡∏±‡∏ô‡∏≠‡∏≤‡∏Å‡∏≤‡∏®</p>
                </div>
            </div>
        );

        const CloudOverlay = ({ isActive, message }) => {
            return (
                <div className={`cloud-container ${isActive ? 'active' : ''}`}>
                    <div className="cloud-layer"></div>
                    <div className="cloud-layer"></div>
                    <div className="cloud-layer"></div>
                    {isActive && (
                        <div className="travel-message">
                            <div className="text-4xl md:text-6xl text-emerald-600 mb-4 animate-bounce">
                                <i className="fa-solid fa-plane-up"></i>
                            </div>
                            <h2 className="text-2xl md:text-4xl font-bold bg-white/80 backdrop-blur-md px-6 py-3 rounded-full shadow-lg border-2 border-emerald-400 text-emerald-800">
                                {message}
                            </h2>
                            <p className="mt-2 text-slate-800 font-bold bg-white/50 inline-block px-3 py-1 rounded-full shadow-sm">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà...</p>
                        </div>
                    )}
                </div>
            );
        };

        // --- SIMULATION MODAL (Historical Data) ---
        const SimulationModal = ({ item, onClose, area, floodData }) => {
            const [yearCount, setYearCount] = useState(10); // Default to 10 years
            const isTree = CROP_LIFECYCLE[item.name]?.type === 'tree';
            const lifeInfo = CROP_LIFECYCLE[item.name] || CROP_LIFECYCLE['default'];

            // Generate Detailed Yearly Data
            const simulationData = [];
            let totalProfit = 0;
            let totalCost = 0;

            const currentYearBE = new Date().getFullYear() + 543;
            const startYearBE = currentYearBE - yearCount;

            for (let i = 0; i < yearCount; i++) {
                const yearBE = startYearBE + i;
                const age = i + 1;

                // Base Cost/Revenue
                let yearlyCost = item.costTotal;
                let yearlyRev = item.profitTotal + item.costTotal; // Derive Revenue from profit+cost

                // Adjust for Tree Lifecycle
                if (isTree) {
                    if (age <= lifeInfo.wait_years) {
                        yearlyRev = 0; // No yield
                        yearlyCost = yearlyCost * 0.5; // Maintenance cost only
                    } else if (age < lifeInfo.peak_start) {
                        yearlyRev = yearlyRev * 0.6; // Growing yield
                    }
                }

                // Adjust for Flood Events (Sync with real floodData history if available)
                let eventNote = "-";
                let statusColor = "text-slate-400";

                // Check if this year matches any flood history
                const floodMatch = floodData.history.find(h => h.includes(yearBE.toString()));
                if (floodMatch) {
                    eventNote = `üåä ‡∏ô‡πâ‡∏≥‡∏ó‡πà‡∏ß‡∏° (${floodMatch})`;
                    statusColor = "text-red-400 font-bold";
                    yearlyCost *= 1.5; // Repair cost
                    yearlyRev *= 0.2; // Crop damaged
                }

                const yearlyProfit = yearlyRev - yearlyCost;
                totalProfit += yearlyProfit;
                totalCost += yearlyCost;

                simulationData.push({
                    year: yearBE,
                    age: age,
                    cost: yearlyCost,
                    revenue: yearlyRev,
                    profit: yearlyProfit,
                    note: eventNote,
                    statusColor: statusColor
                });
            }

            return (
                <div className="fixed inset-0 z-[2000] bg-black/90 backdrop-blur-sm flex items-center justify-center p-4 animate-fade-in-up pointer-events-auto">
                    <div className="bg-slate-800 border-2 border-emerald-500 rounded-2xl w-full max-w-2xl p-6 relative shadow-[0_0_50px_rgba(16,185,129,0.3)] flex flex-col max-h-[90vh]">
                        <button onClick={onClose} className="absolute top-4 right-4 text-slate-400 hover:text-white bg-slate-700 w-8 h-8 rounded-full flex items-center justify-center transition"><i className="fa-solid fa-times"></i></button>

                        <div className="flex items-center gap-3 mb-4 border-b border-slate-700 pb-4">
                            <div className="bg-yellow-500 p-3 rounded-full text-slate-900 text-xl shadow-lg animate-pulse">
                                <i className="fa-solid fa-clock-rotate-left"></i>
                            </div>
                            <div>
                                <h3 className="text-xl font-bold text-white">‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏ú‡∏•‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏Å‡∏≤‡∏£: {item.name}</h3>
                                <p className="text-sm text-slate-400">‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà {area} ‡πÑ‡∏£‡πà ‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡πâ‡∏≥‡∏ó‡πà‡∏ß‡∏°‡∏à‡∏£‡∏¥‡∏á</p>
                            </div>
                        </div>

                        <div className="flex items-center gap-4 mb-4 bg-slate-900/50 p-3 rounded-lg border border-slate-700">
                            <span className="text-slate-300 text-sm whitespace-nowrap">‚è≥ ‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á:</span>
                            <div className="flex items-center gap-2">
                                <input
                                    type="number"
                                    value={yearCount}
                                    onChange={(e) => setYearCount(Math.max(1, parseInt(e.target.value) || 0))}
                                    className="bg-slate-700 border border-emerald-500 rounded w-20 text-center text-white font-bold py-1 focus:outline-none focus:ring-2 focus:ring-emerald-400"
                                />
                                <span className="text-slate-300 text-sm">‡∏õ‡∏µ</span>
                            </div>
                            <div className="text-xs text-slate-500 ml-auto">* ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÑ‡∏î‡πâ</div>
                        </div>

                        {/* Summary Box */}
                        <div className="grid grid-cols-2 gap-4 mb-4">
                            <div className="bg-slate-700/30 p-4 rounded-xl border border-slate-600 text-center">
                                <p className="text-xs text-slate-400 uppercase">‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏™‡∏∞‡∏™‡∏°</p>
                                <p className="text-xl font-bold text-red-400">‡∏ø{totalCost.toLocaleString()}</p>
                            </div>
                            <div className="bg-emerald-900/30 p-4 rounded-xl border border-emerald-500/50 text-center">
                                <p className="text-xs text-emerald-300 uppercase">‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡∏™‡∏∞‡∏™‡∏°</p>
                                <p className="text-2xl font-bold text-emerald-400 animate-pulse">‡∏ø{totalProfit.toLocaleString()}</p>
                            </div>
                        </div>

                        {/* Detailed Table */}
                        <div className="flex-1 overflow-y-auto scrollbar-prominent border border-slate-700 rounded-lg bg-slate-900/50">
                            <table className="w-full text-sm text-left text-slate-300">
                                <thead className="text-xs text-slate-400 uppercase bg-slate-800 sticky top-0 z-10">
                                    <tr>
                                        <th className="px-4 py-3 text-center">‡∏õ‡∏µ (‡∏û.‡∏®.)</th>
                                        <th className="px-4 py-3 text-right">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</th>
                                        <th className="px-4 py-3 text-right">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</th>
                                        <th className="px-4 py-3 text-right">‡∏Å‡∏≥‡πÑ‡∏£</th>
                                        <th className="px-4 py-3">‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {simulationData.map((row) => (
                                        <tr key={row.year} className="border-b border-slate-800 hover:bg-slate-800/50 transition">
                                            <td className="px-4 py-2 text-center font-mono text-yellow-500">{row.year}</td>
                                            <td className="px-4 py-2 text-right text-green-400">{row.revenue > 0 ? row.revenue.toLocaleString() : '-'}</td>
                                            <td className="px-4 py-2 text-right text-red-400">{row.cost.toLocaleString()}</td>
                                            <td className={`px-4 py-2 text-right font-bold ${row.profit > 0 ? 'text-emerald-400' : 'text-red-500'}`}>
                                                {row.profit.toLocaleString()}
                                            </td>
                                            <td className={`px-4 py-2 ${row.statusColor} text-xs`}>{row.note}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        };

        // --- KASET CLOUD APP (GLOBAL MAP INTEGRATED) ---
        const KasetCloudApp = ({ mapInstance, onTravelStart, onTravelEnd }) => {
            const [province, setProvince] = useState("‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£");
            const [area, setArea] = useState(1);
            const [analyzing, setAnalyzing] = useState(false);
            const [results, setResults] = useState(null);
            const [soilInfo, setSoilInfo] = useState(PROVINCE_DATA["‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£"]);
            const [isFullSheet, setIsFullSheet] = useState(false);
            const [isResultsUpdated, setIsResultsUpdated] = useState(false);
            const [weatherData, setWeatherData] = useState(null);
            const [address, setAddress] = useState({ subDistrict: '-', district: '-', province: '‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£' });
            const [floodData, setFloodData] = useState({ risk: 'Low', history: [], desc: '‡∏õ‡∏Å‡∏ï‡∏¥' });
            const [userHasInteracted, setUserHasInteracted] = useState(false);
            const [simulatingItem, setSimulatingItem] = useState(null);

            const kasetMarkerRef = useRef(null);
            const debounceRef = useRef(null);

            // 1. Map Interaction Logic
            useEffect(() => {
                if (!mapInstance) return;

                const targetInfo = PROVINCE_DATA[province];

                // Enable Interactions & Set Cursor
                mapInstance.dragging.enable();
                mapInstance.touchZoom.enable();
                mapInstance.doubleClickZoom.enable();
                mapInstance.scrollWheelZoom.enable();
                mapInstance.boxZoom.enable();
                mapInstance.keyboard.enable();
                if (mapInstance.tap) mapInstance.tap.enable();

                // Force cursor style on container
                mapInstance.getContainer().style.cursor = 'grab';

                // Add or Update Marker
                if (!kasetMarkerRef.current) {
                    const marker = L.marker([targetInfo.lat, targetInfo.lng], { draggable: true }).addTo(mapInstance);
                    marker.bindPopup(`<b>${province}</b><br>‡∏•‡∏≤‡∏Å‡∏´‡∏°‡∏∏‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÅ‡∏õ‡∏•‡∏á`).openPopup();

                    // --- DRAG END EVENT: Update Data ---
                    marker.on('dragend', async function (event) {
                        const m = event.target;
                        const position = m.getLatLng();

                        // Update Soil Info based on new position (Simulation)
                        setSoilInfo(prev => ({ ...prev, lat: position.lat, lng: position.lng }));

                        // Fetch Real Address
                        const addr = await fetchAddress(position.lat, position.lng);
                        if (addr) {
                            setAddress(addr);
                            m.setPopupContent(`<b>${addr.subDistrict}</b><br>${addr.district}`).openPopup();
                        }

                        // Recalculate Risks
                        const fRisk = calculateFloodRisk(position.lat, position.lng);
                        setFloodData(fRisk);

                        // Fetch Weather
                        fetchWeatherData(position.lat, position.lng);

                        setUserHasInteracted(true);
                    });

                    // Add hover cursor for marker
                    marker.on('mouseover', () => { mapInstance.getContainer().style.cursor = 'pointer'; });
                    marker.on('mouseout', () => { mapInstance.getContainer().style.cursor = 'grab'; });

                    kasetMarkerRef.current = marker;
                } else {
                    // Update position if province changed via dropdown
                    if (!userHasInteracted) {
                        kasetMarkerRef.current.setLatLng([targetInfo.lat, targetInfo.lng]);
                    }
                }

                return () => {
                    if (kasetMarkerRef.current) {
                        kasetMarkerRef.current.remove();
                        kasetMarkerRef.current = null;
                    }
                };
            }, [mapInstance, province]);

            // 2. Fetch Data Functions
            const fetchAddress = async (lat, lng) => {
                try {
                    const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=14&addressdetails=1`, { headers: { 'User-Agent': 'WinaiPortal/1.0' } });
                    const data = await res.json();
                    if (data && data.address) return { subDistrict: data.address.suburb || data.address.village || '-', district: data.address.city_district || data.address.district || '-', province: data.address.province || '-' };
                } catch (e) { console.error(e); }
                return null;
            };

            const calculateFloodRisk = (lat, lng) => {
                const hash = Math.abs(Math.sin(lat * 1000 + lng) * 10000);
                const riskLevel = hash % 100;
                if (riskLevel > 80) return { risk: 'High', desc: '‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏™‡∏π‡∏á', history: ['2554', '2564', '2565'] };
                if (riskLevel > 50) return { risk: 'Medium', desc: '‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á', history: ['2565'] };
                return { risk: 'Low', desc: '‡∏ï‡πà‡∏≥', history: [] };
            };

            const fetchWeatherData = async (lat, lng) => {
                try {
                    const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&current=temperature_2m,rain&daily=precipitation_sum&timezone=Asia%2FBangkok&forecast_days=1`);
                    const data = await res.json();
                    setWeatherData({ temp: data.current.temperature_2m, rain: data.current.rain, dailyRain: data.daily.precipitation_sum[0] });
                } catch (e) { setWeatherData(null); }
            };

            // Initial Data Load
            useEffect(() => {
                if (soilInfo.lat) {
                    fetchWeatherData(soilInfo.lat, soilInfo.lng);
                    fetchAddress(soilInfo.lat, soilInfo.lng).then(a => a && setAddress(a));
                    setFloodData(calculateFloodRisk(soilInfo.lat, soilInfo.lng));
                }
            }, [soilInfo.lat, soilInfo.lng]);

            // Calculation Logic
            useEffect(() => {
                if (debounceRef.current) clearTimeout(debounceRef.current);
                setAnalyzing(true);
                debounceRef.current = setTimeout(analyzeData, 800);
                return () => clearTimeout(debounceRef.current);
            }, [province, area, weatherData, floodData]);

            const analyzeData = () => {
                let baseData = [
                    { name: "‡∏Ç‡πâ‡∏≤‡∏ß‡∏´‡∏≠‡∏°‡∏°‡∏∞‡∏•‡∏¥", category: "‡∏û‡∏∑‡∏ä‡πÑ‡∏£‡πà", price: 15000, yield: 800, cost: 4500, risk: "Medium" },
                    { name: "‡∏ú‡∏±‡∏Å‡∏™‡∏•‡∏±‡∏î‡πÑ‡∏Æ‡πÇ‡∏î‡∏£", category: "‡∏ú‡∏±‡∏Å", price: 80000, yield: 2000, cost: 35000, risk: "Low" },
                    { name: "‡∏ó‡∏∏‡πÄ‡∏£‡∏µ‡∏¢‡∏ô", category: "‡∏ú‡∏•‡πÑ‡∏°‡πâ", price: 120000, yield: 2000, cost: 25000, risk: "High" },
                    { name: "‡∏°‡∏±‡∏ô‡∏™‡∏≥‡∏õ‡∏∞‡∏´‡∏•‡∏±‡∏á", category: "‡∏û‡∏∑‡∏ä‡πÑ‡∏£‡πà", price: 3000, yield: 3500, cost: 3500, risk: "Low" },
                    { name: "‡∏õ‡∏≤‡∏•‡πå‡∏°‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô", category: "‡∏û‡∏∑‡∏ä‡πÑ‡∏£‡πà", price: 5000, yield: 3000, cost: 4000, risk: "Low" }
                ];

                const calculated = baseData.map(item => {
                    let y = item.yield, c = item.cost;

                    // Advanced Calculation Logic with Flood Data Sync
                    if (floodData.risk === 'High') { c *= 1.2; if (!item.name.includes("‡∏Ç‡πâ‡∏≤‡∏ß")) y *= 0.6; } // High risk reduces yield more
                    if (weatherData && weatherData.dailyRain < 2 && item.name.includes("‡∏Ç‡πâ‡∏≤‡∏ß")) y *= 0.9;
                    if (soilInfo.soil.includes("‡∏ó‡∏£‡∏≤‡∏¢") && item.name.includes("‡∏Ç‡πâ‡∏≤‡∏ß")) y *= 0.85;

                    const rev = item.price * (y / 1000) * area;
                    const cost = c * area;
                    return { ...item, profitTotal: rev - cost, costTotal: cost, risk_level: item.risk, history: [] };
                });
                setResults(calculated.sort((a, b) => b.profitTotal - a.profitTotal));
                setAnalyzing(false);
                setIsResultsUpdated(true);
                setTimeout(() => setIsResultsUpdated(false), 5000);
            };

            const handleProvinceChange = (e) => {
                const p = e.target.value;
                setProvince(p);
                const info = PROVINCE_DATA[p];
                setSoilInfo(info);
                setUserHasInteracted(true);

                if (mapInstance && kasetMarkerRef.current) {
                    onTravelStart(`‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡πÑ‡∏õ‡∏ó‡∏µ‡πà ${p}...`);

                    // OFFSET CALCULATION: Shift Landing Target slightly South to move Visible Area North
                    // At Zoom 10, approx 0.08 degrees shift is good to counter-balance the bottom sheet
                    const offsetLat = info.lat - 0.15;

                    mapInstance.flyTo([offsetLat, info.lng], 10, { duration: 5, easeLinearity: 0.25 });

                    setTimeout(() => {
                        onTravelEnd();
                        if (kasetMarkerRef.current) {
                            kasetMarkerRef.current.setLatLng([info.lat, info.lng]);
                            kasetMarkerRef.current.setPopupContent(`<b>${p}</b><br>‡∏•‡∏≤‡∏Å‡∏´‡∏°‡∏∏‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÅ‡∏õ‡∏•‡∏á`);
                        }
                    }, 5000);
                }
            };

            const inputContainerClass = !userHasInteracted
                ? "bg-slate-900/60 backdrop-blur-md p-2 rounded-lg border-2 border-yellow-400 shadow-[0_0_20px_rgba(250,204,21,0.5)] animate-attention transition-all duration-300 transform scale-105"
                : "bg-slate-900/40 backdrop-blur-md p-2 rounded-lg border border-emerald-500/50 shadow-sm transition-all duration-300";

            const resultHeaderClass = userHasInteracted || isResultsUpdated
                ? "w-full h-auto min-h-12 flex flex-col justify-center px-4 py-2 cursor-pointer border-b border-white/10 animate-invite text-white"
                : "w-full h-auto min-h-12 flex flex-col justify-center px-4 py-2 cursor-pointer border-b border-white/10 bg-slate-900/80";

            return (
                <div className="relative w-full h-[calc(100vh-60px)] overflow-hidden ui-layer pointer-events-none">
                    {/* Top Controls */}
                    <div className="absolute top-4 left-1/2 -translate-x-1/2 md:left-[60px] md:translate-x-0 z-[990] transition-transform duration-300 w-[90%] md:w-auto pointer-events-auto">
                        <div className={inputContainerClass + " flex flex-col sm:flex-row items-center gap-2 justify-center"}>
                            <div className="relative group">
                                <i className={`fa-solid fa-location-dot absolute left-2 top-2 text-xs z-10 ${!userHasInteracted ? 'text-yellow-400 animate-bounce' : 'text-emerald-300'}`}></i>
                                <select className={`w-full md:w-[150px] py-2 pl-7 pr-4 text-xs rounded text-white focus:outline-none appearance-none cursor-pointer font-bold ${!userHasInteracted ? 'bg-yellow-500/20 border-yellow-500' : 'bg-emerald-900/40 border-emerald-400/50 border'}`}
                                    value={province} onChange={handleProvinceChange}>
                                    <option value="" disabled>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î --</option>
                                    {Object.keys(PROVINCE_DATA).sort().map(p => <option key={p} value={p} className="bg-slate-800">{p}</option>)}
                                </select>
                            </div>
                            <div className="flex items-center gap-2">
                                <input type="number" value={area} onChange={(e) => { setArea(e.target.value); setUserHasInteracted(true); }}
                                    className={`w-[60px] py-2 text-xs text-center rounded text-white focus:outline-none font-bold ${!userHasInteracted ? 'bg-yellow-500/20 border border-yellow-500 placeholder-yellow-200' : 'bg-black/20 border border-white/20'}`}
                                    placeholder="‡πÑ‡∏£‡πà" min="1" />
                                <span className={`text-[10px] font-bold ${!userHasInteracted ? 'text-yellow-300' : 'text-white'}`}>‡πÑ‡∏£‡πà</span>
                            </div>
                            {!userHasInteracted && (
                                <div className="absolute top-full mt-2 left-0 w-full text-center animate-bounce">
                                    <span className="bg-yellow-500 text-slate-900 text-[10px] font-bold px-2 py-1 rounded-full shadow-lg">‚òùÔ∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</span>
                                </div>
                            )}
                        </div>
                    </div>

                    {/* Result Bottom Sheet */}
                    <div className={`absolute bottom-0 left-0 w-full bg-slate-900/95 backdrop-blur-md rounded-t-3xl border-t border-emerald-500/50 shadow-2xl z-[1000] bottom-sheet flex flex-col pointer-events-auto ${isFullSheet ? 'h-[90%]' : 'h-[50%]'}`}>
                        {isFullSheet && <button onClick={() => setIsFullSheet(false)} className="absolute top-4 right-4 z-[1010] text-white"><i className="fa-solid fa-times text-xl"></i></button>}

                        <div className={resultHeaderClass} onClick={() => setIsFullSheet(!isFullSheet)}>
                            <div className="flex justify-between items-center w-full mb-1">
                                <div className={`font-bold flex items-center gap-2 ${userHasInteracted ? 'text-emerald-200' : 'text-emerald-400'}`}>
                                    <i className="fa-solid fa-ranking-star"></i>
                                    <span>10 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏ô‡πà‡∏≤‡∏•‡∏á‡∏ó‡∏∏‡∏ô ({area} ‡πÑ‡∏£‡πà)</span>
                                </div>
                                <div className="text-slate-400 text-xs"><i className={`fa-solid fa-chevron-up transition-transform ${isFullSheet ? 'rotate-180' : ''}`}></i></div>
                            </div>

                            {/* DETAILED DATA DASHBOARD */}
                            <div className="grid grid-cols-2 md:grid-cols-4 gap-2 text-[10px] bg-black/20 p-2 rounded-lg border border-white/5 w-full">
                                <div className="col-span-2 md:col-span-1 text-emerald-300 truncate"><i className="fa-solid fa-map-pin"></i> {address.province} {address.district !== '-' ? `> ${address.district}` : ''} {address.subDistrict !== '-' ? `> ${address.subDistrict}` : ''}</div>
                                <div className="text-amber-300"><i className="fa-solid fa-layer-group"></i> ‡∏î‡∏¥‡∏ô: {soilInfo.soil} ({soilInfo.ph})</div>
                                <div className="text-blue-300"><i className="fa-solid fa-cloud-rain"></i> ‡∏ù‡∏ô: {weatherData ? weatherData.dailyRain : 0}mm | ‡∏ä‡∏∑‡πâ‡∏ô {soilInfo.moisture}%</div>
                                <div className={`${floodData.risk === 'High' ? 'text-red-400' : 'text-green-300'}`}><i className="fa-solid fa-water"></i> ‡∏ô‡πâ‡∏≥‡∏ó‡πà‡∏ß‡∏°: {floodData.desc}</div>
                            </div>
                        </div>

                        <div className="flex-1 overflow-y-auto scrollbar-prominent p-4 pb-24">
                            {results ? results.map((item, i) => (
                                <div key={i} onClick={() => setSimulatingItem(item)} className="bg-slate-800/90 p-4 rounded-xl mb-3 border border-slate-700 relative overflow-hidden transform transition hover:scale-[1.01] cursor-pointer group">
                                    <div className="flex justify-between">
                                        <h3 className="text-lg font-bold text-white flex items-center gap-2">
                                            <span className="text-xs bg-slate-700 w-5 h-5 flex items-center justify-center rounded-full text-slate-300">{i + 1}</span>
                                            {item.name}
                                        </h3>
                                        <span className={`text-xs px-2 py-1 rounded font-bold ${item.profitTotal > 0 ? 'bg-green-600 text-white' : 'bg-red-600 text-white'}`}>
                                            {item.profitTotal > 0 ? '+' : ''}{item.profitTotal.toLocaleString()}
                                        </span>
                                    </div>
                                    <div className="text-xs text-slate-400 mt-2 flex justify-between">
                                        <span>‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô: {item.costTotal.toLocaleString()}</span>
                                        <span className={`${item.risk_level === 'High' ? 'text-red-400' : (item.risk_level === 'Medium' ? 'text-yellow-400' : 'text-green-400')}`}>
                                            ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á: {item.risk_level}
                                        </span>
                                    </div>

                                    {/* SIMULATION BUTTON - REDESIGNED */}
                                    <button
                                        onClick={(e) => { e.stopPropagation(); setSimulatingItem(item); }}
                                        className="w-full mt-3 bg-gradient-to-r from-amber-500 to-orange-600 hover:from-amber-400 hover:to-orange-500 text-white text-xs font-bold py-2 rounded-lg shadow-lg border border-yellow-300/30 flex items-center justify-center gap-2 animate-intense transition-all"
                                    >
                                        <i className="fa-solid fa-calculator"></i> ‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏•‡∏π‡∏Å (Simulation)
                                    </button>
                                </div>
                            )) : <div className="text-center p-10 text-slate-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå...</div>}
                        </div>
                    </div>

                    {/* Simulation Modal - Connected to Flood Data */}
                    {simulatingItem && <SimulationModal item={simulatingItem} area={area} floodData={floodData} onClose={() => setSimulatingItem(null)} />}
                </div>
            );
        };

        const HomePage = ({ setPage, onStartTransition }) => {
            return (
                <div className="min-h-screen relative flex flex-col items-center justify-center text-white p-6 overflow-hidden ui-layer">
                    <div className="z-20 text-center animate-fade-in-up">
                        <h1 className="text-5xl md:text-7xl font-bold mb-2 text-transparent bg-clip-text bg-gradient-to-r from-yellow-300 via-emerald-400 to-cyan-400 drop-shadow-[0_2px_10px_rgba(0,0,0,0.8)]">
                            Winai Innovation
                        </h1>
                        <p className="text-slate-200 text-lg md:text-xl mb-12 drop-shadow-md font-light bg-black/30 px-4 py-1 rounded-full inline-block backdrop-blur-sm">
                            Super App ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£‡πÑ‡∏ó‡∏¢
                        </p>

                        <div className="flex flex-col gap-6 w-full max-w-sm mx-auto">
                            <button
                                onClick={onStartTransition}
                                className="btn-super-pulse bg-gradient-to-r from-fuchsia-600 via-pink-600 to-orange-500 p-5 rounded-2xl font-bold text-xl text-white hover:scale-105 transition transform shadow-[0_0_20px_rgba(236,72,153,0.5)] border-2 border-white/20 relative overflow-hidden group"
                            >
                                <div className="absolute inset-0 bg-white/20 group-hover:bg-white/30 transition"></div>
                                <div className="relative flex items-center justify-center gap-3">
                                    <i className="fa-solid fa-globe text-2xl animate-spin-slow"></i>
                                    <span>Kaset Cloud</span>
                                </div>
                                <span className="text-xs font-normal opacity-90 block mt-1">(‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏ß‡∏¢‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥ 99%)</span>
                            </button>

                            <button onClick={() => setPage('market')} className="bg-slate-800/80 backdrop-blur-sm p-4 rounded-xl font-bold text-slate-300 hover:bg-slate-700 hover:text-white transition flex items-center justify-center gap-2 border border-slate-600">
                                <i className="fa-solid fa-shop"></i> ‡∏ï‡∏•‡∏≤‡∏î & ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô
                            </button>
                        </div>
                    </div>

                    <div className="absolute bottom-4 z-20 text-xs text-slate-400 bg-black/40 px-3 py-1 rounded-full">
                        <i className="fa-solid fa-rotate"></i> ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•: ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÇ‡∏•‡∏Å‡πÄ‡∏™‡∏°‡∏∑‡∏≠‡∏ô‡∏à‡∏£‡∏¥‡∏á (Real-time Satellite)
                    </div>
                </div>
            );
        };

        const MarketPage = ({ setPage }) => (
            <div className="min-h-screen bg-slate-900 p-4 pb-24 ui-layer relative z-20">
                <div className="max-w-md mx-auto bg-slate-800 rounded-xl p-6 shadow-xl border border-slate-700">
                    <h2 className="text-xl font-bold text-orange-400 mb-4">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï</h2>
                    <p className="text-slate-400 mb-4">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà Demand-Supply</p>
                    <button onClick={() => setPage('home')} className="w-full bg-slate-700 py-2 rounded text-white">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
                </div>
            </div>
        );

        const VinaiInnovationPortal = () => {
            const [page, setPage] = useState('home');
            const [isTransitioning, setIsTransitioning] = useState(false);
            const [travelState, setTravelState] = useState({ active: false, message: '' });
            const mapRef = useRef(null);
            const rotationInterval = useRef(null);

            const jetSoundRef = useRef(new Audio('https://www.soundjay.com/transportation/sounds/airplane-fly-by-01.mp3'));

            const playJetSound = () => {
                try {
                    jetSoundRef.current.currentTime = 0;
                    jetSoundRef.current.volume = 0.5;
                    jetSoundRef.current.play().catch(e => console.log("Audio play failed (user gesture required):", e));
                } catch (e) {
                    console.error("Audio Error:", e);
                }
            };

            // GLOBAL MAP INIT
            useEffect(() => {
                if (!document.getElementById('global-map')) return;
                const map = L.map('global-map', { zoomControl: false, attributionControl: false, zoomSnap: 0.1, minZoom: 2 }).setView([13.7563, 100.5018], 2.5);
                L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Tiles &copy; Esri' }).addTo(map);
                L.tileLayer('https://mt1.google.com/vt/lyrs=h&x={x}&y={y}&z={z}', { opacity: 0.5 }).addTo(map);
                L.control.zoom({ position: 'bottomright' }).addTo(map);
                mapRef.current = map;
                startRotation(map);
                return () => { if (map) map.remove(); stopRotation(); };
            }, []);

            const startRotation = (map) => {
                if (rotationInterval.current) clearInterval(rotationInterval.current);
                map.dragging.disable(); map.scrollWheelZoom.disable(); map.touchZoom.disable(); map.doubleClickZoom.disable();
                rotationInterval.current = setInterval(() => { if (map) map.panBy([1, 0], { animate: false }); }, 50);
            };

            const stopRotation = () => {
                if (rotationInterval.current) { clearInterval(rotationInterval.current); rotationInterval.current = null; }
            };

            const startTravel = (msg) => {
                playJetSound();
                setTravelState({ active: true, message: msg });
            };

            const endTravel = () => setTravelState({ active: false, message: '' });

            const handleStartKaset = () => {
                if (!mapRef.current) return;
                playJetSound();
                setIsTransitioning(true);
                setTravelState({ active: true, message: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡πÑ‡∏õ‡∏ó‡∏µ‡πà ‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£...' });
                stopRotation();
                mapRef.current.flyTo([13.7563, 100.5018], 10, { duration: 5, easeLinearity: 0.25 });
                setTimeout(() => { setPage('kaset'); setIsTransitioning(false); setTravelState({ active: false, message: '' }); }, 5000);
            };

            const handleGoHome = () => {
                playJetSound();
                setPage('home');
                if (mapRef.current) {
                    mapRef.current.flyTo([13.7563, 100.5018], 2.5, { duration: 3 });
                    setTimeout(() => startRotation(mapRef.current), 3000);
                }
            };

            return (
                <div className="font-sans text-slate-200 h-screen w-screen overflow-hidden">
                    <div id="global-map"></div>
                    <CloudOverlay isActive={travelState.active} message={travelState.message} />

                    <nav className={`fixed bottom-0 w-full bg-slate-800/90 backdrop-blur border-t border-slate-700 flex justify-around p-3 z-[100] text-xs font-bold text-slate-400 shadow-2xl transition-transform duration-500 ${isTransitioning ? 'translate-y-full' : 'translate-y-0'}`}>
                        <button onClick={handleGoHome} className={page === 'home' ? 'text-emerald-400' : 'hover:text-slate-200'}>
                            <i className="fa-solid fa-house text-xl mb-1 block"></i>
                            ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å üáπüá≠
                        </button>
                        <button onClick={handleStartKaset} className={page === 'kaset' ? 'text-emerald-400' : 'hover:text-slate-200'}>
                            <i className="fa-solid fa-seedling text-xl mb-1 block"></i>
                            ‡πÄ‡∏Å‡∏©‡∏ï‡∏£
                        </button>
                        <button onClick={() => setPage('market')} className={page === 'market' ? 'text-orange-400' : 'hover:text-slate-200'}>
                            <i className="fa-solid fa-shop text-xl mb-1 block"></i>
                            ‡∏ï‡∏•‡∏≤‡∏î
                        </button>
                    </nav>

                    {page === 'home' && <div className={`absolute inset-0 z-20 transition-opacity duration-1000 ${isTransitioning ? 'opacity-0 pointer-events-none' : 'opacity-100'}`}><HomePage setPage={setPage} onStartTransition={handleStartKaset} /></div>}
                    {page === 'kaset' && !isTransitioning && <KasetCloudApp mapInstance={mapRef.current} onTravelStart={startTravel} onTravelEnd={endTravel} />}
                    {page === 'market' && <MarketPage setPage={setPage} />}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<VinaiInnovationPortal />);
    </script>
</body>

</html>
