<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Winai Innovation Portal - Super App ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡πÑ‡∏ó‡∏¢</title>

    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Leaflet Map CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;700&display=swap');

        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #0f172a; /* Slate 900 */
            color: #f1f5f9; /* Slate 100 */
        }

        .animate-fade-in-up {
            animation: fadeInUp 0.5s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Prominent Scrollbar for Results */
        .scrollbar-prominent::-webkit-scrollbar {
            width: 10px;
        }
        .scrollbar-prominent::-webkit-scrollbar-track {
            background: #1e293b; /* Slate 800 */
            border-radius: 0 0 10px 0;
            border-left: 1px solid #334155;
        }
        .scrollbar-prominent::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #fbbf24, #f59e0b, #d97706); /* ‡πÑ‡∏•‡πà‡∏™‡∏µ‡∏ó‡∏≠‡∏á/‡∏™‡πâ‡∏° */
            border-radius: 6px;
            border: 2px solid #0f172a;
            box-shadow: inset 0 0 5px rgba(255, 255, 255, 0.5); /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏°‡∏¥‡∏ï‡∏¥ */
        }
        .scrollbar-prominent::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, #fcd34d, #fbbf24, #f59e0b); /* ‡∏™‡∏ß‡πà‡∏≤‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠ Hover */
        }
        
        /* Bottom Sheet Transition */
        .bottom-sheet {
            transition: height 0.5s cubic-bezier(0.32, 0.72, 0, 1);
        }

        /* Result Header Glow Animation */
        @keyframes result-pulse {
            0% { box-shadow: 0 0 0 0 rgba(52, 211, 153, 0.7); border-color: rgba(52, 211, 153, 0.5); }
            70% { box-shadow: 0 0 0 10px rgba(52, 211, 153, 0); border-color: rgba(52, 211, 153, 1); }
            100% { box-shadow: 0 0 0 0 rgba(52, 211, 153, 0); border-color: rgba(52, 211, 153, 0.5); }
        }
        .animate-result-pulse {
            animation: result-pulse 2s infinite;
        }
    </style>
</head>

<body class="bg-slate-900 text-slate-100">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- CHART JS DARK MODE DEFAULTS ---
        Chart.defaults.color = '#cbd5e1'; // Text Color
        Chart.defaults.borderColor = '#334155'; // Grid Lines

        // --- SUPABASE CONFIG ---
        const SUPABASE_URL = "https://ldsysxczitmkxmukmwri.supabase.co";
        const SUPABASE_ANON_KEY = "sb_publishable_I2HEPgG2BbzK2gBtG3i0NQ_YFlzJfVo";

        let supabaseClient = null;

        if (typeof supabase !== 'undefined') {
            try {
                supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            } catch (e) {
                console.warn("Supabase Init Failed");
            }
        }

        // --- MOCK DATA: PROVINCES & COORDINATES ---
        const PROVINCE_COORDS = {
            "‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£": [13.7563, 100.5018],
            "‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà": [18.7883, 98.9853],
            "‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô": [16.4322, 102.8236],
            "‡∏™‡∏á‡∏Ç‡∏•‡∏≤": [7.1756, 100.6143],
            "‡∏ô‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡∏™‡∏µ‡∏°‡∏≤": [14.9799, 102.0978],
            "‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ": [13.3611, 100.9847],
            "‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï": [7.8804, 98.3923],
            "‡∏™‡∏∏‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå‡∏ò‡∏≤‡∏ô‡∏µ": [9.1386, 99.3218],
            "‡∏≠‡∏∏‡∏ö‡∏•‡∏£‡∏≤‡∏ä‡∏ò‡∏≤‡∏ô‡∏µ": [15.2448, 104.8473],
            "‡∏≠‡∏∏‡∏î‡∏£‡∏ò‡∏≤‡∏ô‡∏µ": [17.4157, 102.7872],
            "‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏£‡∏≤‡∏¢": [19.9105, 99.8406],
            "‡∏à‡∏±‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ": [12.6114, 102.1039],
            "‡∏£‡πâ‡∏≠‡∏¢‡πÄ‡∏≠‡πá‡∏î": [16.0538, 103.6520],
            "‡∏ô‡πà‡∏≤‡∏ô": [18.7756, 100.7730],
            "‡∏Å‡∏≤‡∏ç‡∏à‡∏ô‡∏ö‡∏∏‡∏£‡∏µ": [14.0205, 99.5304]
        };

        const PROVINCE_DATA = {};
        const regions = {
            "‡πÄ‡∏´‡∏ô‡∏∑‡∏≠": ["‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏£‡∏≤‡∏¢", "‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà", "‡∏ô‡πà‡∏≤‡∏ô", "‡∏û‡∏∞‡πÄ‡∏¢‡∏≤", "‡πÅ‡∏û‡∏£‡πà", "‡πÅ‡∏°‡πà‡∏Æ‡πà‡∏≠‡∏á‡∏™‡∏≠‡∏ô", "‡∏•‡∏≥‡∏õ‡∏≤‡∏á", "‡∏•‡∏≥‡∏û‡∏π‡∏ô", "‡∏≠‡∏∏‡∏ï‡∏£‡∏î‡∏¥‡∏ï‡∏ñ‡πå", "‡∏™‡∏∏‡πÇ‡∏Ç‡∏ó‡∏±‡∏¢", "‡∏û‡∏¥‡∏©‡∏ì‡∏∏‡πÇ‡∏•‡∏Å", "‡∏û‡∏¥‡∏à‡∏¥‡∏ï‡∏£", "‡πÄ‡∏û‡∏ä‡∏£‡∏ö‡∏π‡∏£‡∏ì‡πå", "‡∏Å‡∏≥‡πÅ‡∏û‡∏á‡πÄ‡∏û‡∏ä‡∏£", "‡∏ï‡∏≤‡∏Å", "‡∏ô‡∏Ñ‡∏£‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡πå", "‡∏≠‡∏∏‡∏ó‡∏±‡∏¢‡∏ò‡∏≤‡∏ô‡∏µ"],
            "‡∏≠‡∏µ‡∏™‡∏≤‡∏ô": ["‡∏Å‡∏≤‡∏¨‡∏™‡∏¥‡∏ô‡∏ò‡∏∏‡πå", "‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô", "‡∏ä‡∏±‡∏¢‡∏†‡∏π‡∏°‡∏¥", "‡∏ô‡∏Ñ‡∏£‡∏û‡∏ô‡∏°", "‡∏ô‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡∏™‡∏µ‡∏°‡∏≤", "‡∏ö‡∏∂‡∏á‡∏Å‡∏≤‡∏¨", "‡∏ö‡∏∏‡∏£‡∏µ‡∏£‡∏±‡∏°‡∏¢‡πå", "‡∏°‡∏´‡∏≤‡∏™‡∏≤‡∏£‡∏Ñ‡∏≤‡∏°", "‡∏°‡∏∏‡∏Å‡∏î‡∏≤‡∏´‡∏≤‡∏£", "‡∏¢‡πÇ‡∏™‡∏ò‡∏£", "‡∏£‡πâ‡∏≠‡∏¢‡πÄ‡∏≠‡πá‡∏î", "‡πÄ‡∏•‡∏¢", "‡∏™‡∏Å‡∏•‡∏ô‡∏Ñ‡∏£", "‡∏™‡∏∏‡∏£‡∏¥‡∏ô‡∏ó‡∏£‡πå", "‡∏®‡∏£‡∏µ‡∏™‡∏∞‡πÄ‡∏Å‡∏©", "‡∏´‡∏ô‡∏≠‡∏á‡∏Ñ‡∏≤‡∏¢", "‡∏´‡∏ô‡∏≠‡∏á‡∏ö‡∏±‡∏ß‡∏•‡∏≥‡∏†‡∏π", "‡∏≠‡∏∏‡∏î‡∏£‡∏ò‡∏≤‡∏ô‡∏µ", "‡∏≠‡∏∏‡∏ö‡∏•‡∏£‡∏≤‡∏ä‡∏ò‡∏≤‡∏ô‡∏µ", "‡∏≠‡∏≥‡∏ô‡∏≤‡∏à‡πÄ‡∏à‡∏£‡∏¥‡∏ç"],
            "‡∏Å‡∏•‡∏≤‡∏á": ["‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£", "‡∏Å‡∏≤‡∏ç‡∏à‡∏ô‡∏ö‡∏∏‡∏£‡∏µ", "‡∏à‡∏±‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ", "‡∏â‡∏∞‡πÄ‡∏ä‡∏¥‡∏á‡πÄ‡∏ó‡∏£‡∏≤", "‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ", "‡∏ä‡∏±‡∏¢‡∏ô‡∏≤‡∏ó", "‡∏ï‡∏£‡∏≤‡∏î", "‡∏ô‡∏Ñ‡∏£‡∏ô‡∏≤‡∏¢‡∏Å", "‡∏ô‡∏Ñ‡∏£‡∏õ‡∏ê‡∏°", "‡∏ô‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ", "‡∏õ‡∏ó‡∏∏‡∏°‡∏ò‡∏≤‡∏ô‡∏µ", "‡∏õ‡∏£‡∏∞‡∏à‡∏ß‡∏ö‡∏Ñ‡∏µ‡∏£‡∏µ‡∏Ç‡∏±‡∏ô‡∏ò‡πå", "‡∏õ‡∏£‡∏≤‡∏à‡∏µ‡∏ô‡∏ö‡∏∏‡∏£‡∏µ", "‡∏û‡∏£‡∏∞‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤", "‡πÄ‡∏û‡∏ä‡∏£‡∏ö‡∏∏‡∏£‡∏µ", "‡∏£‡∏∞‡∏¢‡∏≠‡∏á", "‡∏£‡∏≤‡∏ä‡∏ö‡∏∏‡∏£‡∏µ", "‡∏•‡∏û‡∏ö‡∏∏‡∏£‡∏µ", "‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏õ‡∏£‡∏≤‡∏Å‡∏≤‡∏£", "‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏á‡∏Ñ‡∏£‡∏≤‡∏°", "‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏≤‡∏Ñ‡∏£", "‡∏™‡∏£‡∏∞‡πÅ‡∏Å‡πâ‡∏ß", "‡∏™‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏µ", "‡∏™‡∏¥‡∏á‡∏´‡πå‡∏ö‡∏∏‡∏£‡∏µ", "‡∏™‡∏∏‡∏û‡∏£‡∏£‡∏ì‡∏ö‡∏∏‡∏£‡∏µ", "‡∏≠‡πà‡∏≤‡∏á‡∏ó‡∏≠‡∏á"],
            "‡πÉ‡∏ï‡πâ": ["‡∏Å‡∏£‡∏∞‡∏ö‡∏µ‡πà", "‡∏ä‡∏∏‡∏°‡∏û‡∏£", "‡∏ï‡∏£‡∏±‡∏á", "‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏ò‡∏£‡∏£‡∏°‡∏£‡∏≤‡∏ä", "‡∏ô‡∏£‡∏≤‡∏ò‡∏¥‡∏ß‡∏≤‡∏™", "‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ", "‡∏û‡∏±‡∏á‡∏á‡∏≤", "‡∏û‡∏±‡∏ó‡∏•‡∏∏‡∏á", "‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï", "‡∏¢‡∏∞‡∏•‡∏≤", "‡∏£‡∏∞‡∏ô‡∏≠‡∏á", "‡∏™‡∏á‡∏Ç‡∏•‡∏≤", "‡∏™‡∏ï‡∏π‡∏•", "‡∏™‡∏∏‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå‡∏ò‡∏≤‡∏ô‡∏µ"]
        };

        Object.keys(regions).forEach(region => {
            regions[region].forEach(prov => {
                let ph = 6.5, moisture = 60, soil = "‡∏î‡∏¥‡∏ô‡∏£‡πà‡∏ß‡∏ô";
                if (region === "‡∏≠‡∏µ‡∏™‡∏≤‡∏ô") { ph = 5.5; moisture = 40; soil = "‡∏î‡∏¥‡∏ô‡∏ó‡∏£‡∏≤‡∏¢ (‡∏ä‡∏∏‡∏î‡∏î‡∏¥‡∏ô‡∏£‡πâ‡∏≠‡∏¢‡πÄ‡∏≠‡πá‡∏î)"; }
                if (region === "‡πÄ‡∏´‡∏ô‡∏∑‡∏≠") { ph = 6.0; moisture = 55; soil = "‡∏î‡∏¥‡∏ô‡∏£‡πà‡∏ß‡∏ô‡∏õ‡∏ô‡∏ó‡∏£‡∏≤‡∏¢ (‡∏ä‡∏∏‡∏î‡∏î‡∏¥‡∏ô‡πÅ‡∏°‡πà‡∏£‡∏¥‡∏°)"; }
                if (region === "‡∏Å‡∏•‡∏≤‡∏á") { ph = 7.0; moisture = 70; soil = "‡∏î‡∏¥‡∏ô‡πÄ‡∏´‡∏ô‡∏µ‡∏¢‡∏ß (‡∏ä‡∏∏‡∏î‡∏î‡∏¥‡∏ô‡∏£‡∏≤‡∏ä‡∏ö‡∏∏‡∏£‡∏µ)"; }
                if (region === "‡πÉ‡∏ï‡πâ") { ph = 5.0; moisture = 80; soil = "‡∏î‡∏¥‡∏ô‡∏£‡πà‡∏ß‡∏ô‡∏õ‡∏ô‡∏î‡∏¥‡∏ô‡πÄ‡∏´‡∏ô‡∏µ‡∏¢‡∏ß (‡∏ä‡∏∏‡∏î‡∏î‡∏¥‡∏ô‡∏Ñ‡∏≠‡∏´‡∏á‡∏™‡πå)"; }
                
                let lat, lng;
                if (PROVINCE_COORDS[prov]) {
                    [lat, lng] = PROVINCE_COORDS[prov];
                } else {
                    let hash = 0;
                    for(let i=0; i<prov.length; i++) hash = prov.charCodeAt(i) + ((hash << 5) - hash);
                    const offsetLat = ((hash % 1000) / 500) - 1.0; 
                    const offsetLng = (((hash >> 2) % 1000) / 500) - 1.0;
                    
                    const centers = {
                        "‡πÄ‡∏´‡∏ô‡∏∑‡∏≠": [18.5, 99.5],
                        "‡∏≠‡∏µ‡∏™‡∏≤‡∏ô": [16.0, 103.5],
                        "‡∏Å‡∏•‡∏≤‡∏á": [14.5, 100.5],
                        "‡πÉ‡∏ï‡πâ": [8.5, 99.5]
                    };
                    const center = centers[region] || [13.7, 100.5];
                    lat = center[0] + offsetLat;
                    lng = center[1] + offsetLng;
                }
                
                PROVINCE_DATA[prov] = { ph, moisture, soil, region, lat, lng };
            });
        });

        // --- COMPONENTS ---

        const AppFooter = () => (
            <div className="mt-16 bg-slate-800 border-t border-slate-700 py-10 px-4 w-full text-slate-300">
                <div className="max-w-3xl mx-auto text-center">
                    <div className="mb-8 p-6 bg-slate-800/50 rounded-2xl border border-emerald-900/50 shadow-lg">
                        <h3 className="text-emerald-400 font-bold text-lg mb-2">ü§ù ‡∏£‡πà‡∏ß‡∏°‡∏™‡∏ô‡∏±‡∏ö‡∏™‡∏ô‡∏∏‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏µ‡πÜ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡πÑ‡∏ó‡∏¢</h3>
                        <p className="text-slate-400 text-sm mb-4">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡πÑ‡∏ó‡∏¢ ‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÇ‡∏î‡∏¢‡∏Ñ‡∏ô‡πÑ‡∏ó‡∏¢ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏®‡∏£‡∏©‡∏ê‡∏Å‡∏¥‡∏à‡πÑ‡∏ó‡∏¢‡∏¢‡∏±‡πà‡∏á‡∏¢‡∏∑‡∏ô</p>
                        <div className="flex justify-center gap-4 text-sm font-medium">
                            <button className="bg-slate-700 border border-slate-600 text-emerald-400 px-4 py-2 rounded-full hover:bg-emerald-600 hover:text-white transition flex items-center gap-2 shadow-sm"><i className="fa-solid fa-share-nodes"></i> ‡πÅ‡∏ä‡∏£‡πå</button>
                            <button className="bg-slate-700 border border-slate-600 text-blue-400 px-4 py-2 rounded-full hover:bg-blue-600 hover:text-white transition flex items-center gap-2 shadow-sm"><i className="fa-solid fa-comment-dots"></i> ‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå</button>
                            <button className="bg-slate-700 border border-slate-600 text-red-400 px-4 py-2 rounded-full hover:bg-red-500 hover:text-white transition flex items-center gap-2 shadow-sm"><i className="fa-solid fa-heart"></i> ‡πÉ‡∏´‡πâ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏à</button>
                        </div>
                    </div>
                    <div className="w-full h-px bg-slate-700 mb-8 mx-auto w-1/2"></div>
                    <div className="flex flex-col items-center gap-3">
                        <div className="w-16 h-16 bg-slate-700 rounded-full flex items-center justify-center mb-2 overflow-hidden shadow-md border-2 border-slate-600">
                            <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Winai" alt="Winai" className="w-full h-full" />
                        </div>
                        <p className="text-base font-bold text-slate-200">‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÇ‡∏î‡∏¢: ‡∏ß‡∏¥‡∏ô‡∏±‡∏¢ ‡∏ú‡∏±‡∏ô‡∏≠‡∏≤‡∏Å‡∏≤‡∏®</p>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm text-slate-400 mt-2 bg-slate-800 px-6 py-4 rounded-xl shadow-sm border border-slate-700">
                            <a href="https://facebook.com/winayo1" target="_blank" className="hover:text-blue-400 flex items-center gap-2 justify-center"><i className="fa-brands fa-facebook text-xl text-blue-500"></i> <div className="text-left"><span className="block text-xs text-slate-500">Facebook</span>Winai Phanarkat</div></a>
                            <div className="flex items-center gap-2 justify-center border-l border-r border-slate-700 px-4"><div className="text-center"><span className="block text-xs text-slate-500 mb-1"><i className="fa-brands fa-line text-green-500"></i> / <i className="fa-solid fa-phone text-slate-400"></i> ‡πÇ‡∏ó‡∏£</span><span className="font-bold text-slate-200">092-653-3228</span></div></div>
                            <a href="mailto:winayo@gmail.com" className="hover:text-red-400 flex items-center gap-2 justify-center"><i className="fa-solid fa-envelope text-xl text-red-500"></i><div className="text-left"><span className="block text-xs text-slate-500">Email</span>winayo@gmail.com</div></a>
                        </div>
                    </div>
                </div>
            </div>
        );

        // --- MARKET DATA CONSTANT & SHARED LOGIC ---
        const MARKET_STATS_DB = {
            '‡∏Ç‡πâ‡∏≤‡∏ß‡∏´‡∏≠‡∏°‡∏°‡∏∞‡∏•‡∏¥': { domestic: 60000, export: 50000, current: 85000 },
            '‡∏ó‡∏∏‡πÄ‡∏£‡∏µ‡∏¢‡∏ô': { domestic: 20000, export: 40000, current: 50000 },
            '‡∏¢‡∏≤‡∏á‡∏û‡∏≤‡∏£‡∏≤': { domestic: 50000, export: 150000, current: 195000 },
            '‡∏°‡∏±‡∏ô‡∏™‡∏≥‡∏õ‡∏∞‡∏´‡∏•‡∏±‡∏á': { domestic: 100000, export: 200000, current: 250000 },
            '‡∏Ç‡πâ‡∏≤‡∏ß‡πÇ‡∏û‡∏î‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡∏™‡∏±‡∏ï‡∏ß‡πå': { domestic: 150000, export: 10000, current: 160000 },
            '‡∏ú‡∏±‡∏Å‡∏™‡∏•‡∏±‡∏î‡πÑ‡∏Æ‡πÇ‡∏î‡∏£': { domestic: 5000, export: 500, current: 4000 },
            '‡∏≠‡πâ‡∏≠‡∏¢‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô': { domestic: 500000, export: 200000, current: 600000 },
            '‡∏õ‡∏≤‡∏•‡πå‡∏°‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô': { domestic: 100000, export: 50000, current: 120000 }
        };

        const getOtherRegisteredSupply = (cropName) => {
            if (!cropName) return 2000;
            let nameKey = cropName;
            if (cropName.includes('‡∏ó‡∏∏‡πÄ‡∏£‡∏µ‡∏¢‡∏ô')) nameKey = '‡∏ó‡∏∏‡πÄ‡∏£‡∏µ‡∏¢‡∏ô';

            let hash = 0;
            for (let i = 0; i < nameKey.length; i++) {
                hash = nameKey.charCodeAt(i) + ((hash << 5) - hash);
            }
            const range = 3000;
            const min = 2000;
            return (Math.abs(hash) % range) + min;
        };

        // --- NEW: CROP LIFECYCLE DATABASE (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏á‡∏à‡∏£‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏û‡∏∑‡∏ä) ---
        // ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡∏ï‡∏≤‡∏°‡∏≠‡∏≤‡∏¢‡∏∏‡∏ï‡πâ‡∏ô‡πÑ‡∏°‡πâ
        const CROP_LIFECYCLE = {
            '‡∏ó‡∏∏‡πÄ‡∏£‡∏µ‡∏¢‡∏ô': { 
                type: 'tree', 
                wait_years: 5,     // ‡∏õ‡∏•‡∏π‡∏Å 5 ‡∏õ‡∏µ‡πÅ‡∏£‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏•
                peak_start: 10,    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡πâ‡∏ú‡∏•‡∏î‡∏Å‡∏õ‡∏µ‡∏ó‡∏µ‡πà 10
                decline_start: 20, // ‡∏õ‡∏µ‡∏ó‡∏µ‡πà 20 ‡∏ú‡∏•‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏•‡∏î/‡∏ï‡πâ‡∏ô‡πÇ‡∏ó‡∏£‡∏°
                lifespan: 25,      // ‡∏≠‡∏≤‡∏¢‡∏∏‡πÄ‡∏®‡∏£‡∏©‡∏ê‡∏Å‡∏¥‡∏à‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì 25-30 ‡∏õ‡∏µ
                advice: '‚ö†Ô∏è ‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏Å‡πà ‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï‡∏à‡∏∞‡∏•‡∏î‡∏•‡∏á‡πÅ‡∏•‡∏∞‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡πÇ‡∏£‡∏Ñ ‡∏£‡∏≤‡∏Å‡πÄ‡∏ô‡πà‡∏≤‡πÇ‡∏Ñ‡∏ô‡πÄ‡∏ô‡πà‡∏≤ ‡∏Ñ‡∏ß‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏õ‡∏•‡∏π‡∏Å‡∏ï‡πâ‡∏ô‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏ã‡∏°‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡πÅ‡∏ñ‡∏ß ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏õ‡∏•‡∏á‡πÉ‡∏´‡∏°‡πà‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤ 3-4 ‡∏õ‡∏µ' 
            },
            '‡∏¢‡∏≤‡∏á‡∏û‡∏≤‡∏£‡∏≤': { 
                type: 'tree', 
                wait_years: 7, 
                peak_start: 12, 
                decline_start: 20, 
                lifespan: 25, 
                advice: '‚ö†Ô∏è ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏≤‡∏¢ ‡∏ô‡πâ‡∏≥‡∏¢‡∏≤‡∏á‡∏•‡∏î‡∏•‡∏á ‡∏Ñ‡∏ß‡∏£‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡πÇ‡∏Ñ‡πà‡∏ô‡∏¢‡∏≤‡∏á‡πÄ‡∏Å‡πà‡∏≤‡πÅ‡∏•‡∏∞‡∏¢‡∏∑‡πà‡∏ô‡∏Ç‡∏≠‡∏ó‡∏∏‡∏ô‡∏™‡∏á‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏™‡∏ß‡∏ô‡∏¢‡∏≤‡∏á (‡∏Å‡∏¢‡∏ó.) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏•‡∏π‡∏Å‡πÉ‡∏´‡∏°‡πà' 
            },
            '‡∏õ‡∏≤‡∏•‡πå‡∏°‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô': { 
                type: 'tree', 
                wait_years: 3, 
                peak_start: 7, 
                decline_start: 18, 
                lifespan: 22, 
                advice: '‚ö†Ô∏è ‡∏ï‡πâ‡∏ô‡∏™‡∏π‡∏á‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏¢‡∏≤‡∏Å ‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï‡∏•‡∏î‡∏•‡∏á ‡∏Ñ‡∏ß‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏•‡πâ‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏Å‡πà‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏•‡∏π‡∏Å‡∏ó‡∏î‡πÅ‡∏ó‡∏ô‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏ú‡∏•‡∏î‡∏Å‡∏Å‡∏ß‡πà‡∏≤' 
            },
            // ‡∏û‡∏∑‡∏ä‡∏•‡πâ‡∏°‡∏•‡∏∏‡∏Å (Annual)
            'default': { 
                type: 'annual', 
                lifespan: 1, 
                advice: '‚ÑπÔ∏è ‡∏Ñ‡∏ß‡∏£‡∏õ‡∏•‡∏π‡∏Å‡∏û‡∏∑‡∏ä‡∏ï‡∏£‡∏∞‡∏Å‡∏π‡∏•‡∏ñ‡∏±‡πà‡∏ß‡∏™‡∏•‡∏±‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏î‡∏¥‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏Ñ‡πà‡∏≤ pH ‡∏î‡∏¥‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏§‡∏î‡∏π‡πÉ‡∏´‡∏°‡πà' 
            }
        };

        // --- SUB-COMPONENT: Historical Simulation Modal ---
        const HistoricalSimulation = ({ crop, province, area, address, onClose }) => { 
            const [simulationYears, setSimulationYears] = useState(10); // ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô 10 ‡∏õ‡∏µ
            const [simulationData, setSimulationData] = useState([]);
            const [summary, setSummary] = useState({ totalCost: 0, totalRevenue: 0, totalProfit: 0, roi: 0 });
            const [lifecycleInfo, setLifecycleInfo] = useState(null); // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏á‡∏à‡∏£‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏û‡∏∑‡∏ä‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
            const chartRef = useRef(null);
            const canvasRef = useRef(null);

            // Handler for year input change
            const handleYearChange = (e) => {
                const val = parseInt(e.target.value);
                // Validation: Must be > 0 and not NaN
                if (!isNaN(val) && val > 0) {
                    setSimulationYears(val);
                } else if (e.target.value === '') {
                    setSimulationYears(''); 
                }
            };

            // Helper to match crop name to DB
            const getCropLifecycle = (name) => {
                const key = Object.keys(CROP_LIFECYCLE).find(k => name.includes(k));
                return CROP_LIFECYCLE[key] || CROP_LIFECYCLE['default'];
            };

            useEffect(() => {
                // Skip simulation if years is invalid
                if (!simulationYears || simulationYears <= 0) return;

                const cropInfo = getCropLifecycle(crop);
                setLifecycleInfo(cropInfo);

                // Generate data
                const currentYear = new Date().getFullYear() + 543;
                // ‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏ß‡πà‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 1 ‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏≥‡∏•‡∏≠‡∏á ‡∏Ñ‡∏∑‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏õ‡∏•‡∏π‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠ (‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô - simulationYears)
                // ‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï? ‡∏õ‡∏Å‡∏ï‡∏¥ Historical ‡∏Ñ‡∏∑‡∏≠‡∏î‡∏π‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á ‡πÅ‡∏ï‡πà‡∏ñ‡πâ‡∏≤ Simulate ‡∏õ‡∏•‡∏π‡∏Å ‡∏°‡∏±‡∏Å‡∏à‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å‡∏õ‡∏µ‡∏ó‡∏µ‡πà 1
                // ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏á‡πà‡∏≤‡∏¢: ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏ß‡πà‡∏≤ "‡∏ñ‡πâ‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏õ‡∏•‡∏π‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠ X ‡∏õ‡∏µ‡∏Å‡πà‡∏≠‡∏ô ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏£‡∏ß‡∏¢‡πÑ‡∏´‡∏°"
                const startYear = currentYear - simulationYears;
                
                const data = [];
                let cumProfit = 0;
                let totCost = 0;
                let totRev = 0;
                
                for (let i = 0; i < simulationYears; i++) {
                    const year = startYear + i;
                    const treeAge = i + 1; // ‡∏≠‡∏≤‡∏¢‡∏∏‡∏ï‡πâ‡∏ô‡πÑ‡∏°‡πâ

                    let stage = '';
                    let event = '‡∏õ‡∏Å‡∏ï‡∏¥';
                    let eventColor = 'text-green-400';
                    let cost = 0;
                    let revenue = 0;
                    
                    // --- Simulation Logic based on Lifecycle ---
                    if (cropInfo.type === 'tree') {
                        if (treeAge <= cropInfo.wait_years) {
                            stage = `‡∏õ‡∏µ‡∏ó‡∏µ‡πà ${treeAge}: ‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ú‡∏•)`;
                            cost = (i === 0 ? 15000 : 5000) * area; // ‡∏õ‡∏µ‡πÅ‡∏£‡∏Å‡πÅ‡∏û‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏•‡πâ‡∏≤
                            revenue = 0;
                        } else {
                            // Yield Calculation Curve
                            let yieldFactor = 1.0;
                            if (treeAge < cropInfo.peak_start) {
                                // ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡πâ‡∏ú‡∏• (‡πÑ‡∏ï‡πà‡∏£‡∏∞‡∏î‡∏±‡∏ö)
                                stage = `‡∏õ‡∏µ‡∏ó‡∏µ‡πà ${treeAge}: ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡πâ‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï`;
                                yieldFactor = 0.5 + ((treeAge - cropInfo.wait_years) * 0.1); 
                            } else if (treeAge >= cropInfo.peak_start && treeAge < cropInfo.decline_start) {
                                // ‡∏ä‡πà‡∏ß‡∏á‡∏û‡∏µ‡∏Ñ
                                stage = `‡∏õ‡∏µ‡∏ó‡∏µ‡πà ${treeAge}: ‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î (Golden Period)`;
                                yieldFactor = 1.2;
                            } else if (treeAge >= cropInfo.decline_start) {
                                // ‡∏ä‡πà‡∏ß‡∏á‡∏Ç‡∏≤‡∏•‡∏á
                                stage = `‡∏õ‡∏µ‡∏ó‡∏µ‡πà ${treeAge}: ‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏•‡∏î‡∏•‡∏á (Aging)`;
                                yieldFactor = Math.max(0.4, 1.0 - ((treeAge - cropInfo.decline_start) * 0.05));
                                
                                // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏õ‡∏•‡∏π‡∏Å‡πÉ‡∏´‡∏°‡πà
                                if (treeAge === cropInfo.decline_start || treeAge === cropInfo.lifespan) {
                                    event = '‚ö†Ô∏è ‡∏Ñ‡∏ß‡∏£‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏õ‡∏•‡∏π‡∏Å‡∏ó‡∏î‡πÅ‡∏ó‡∏ô (Replanting)';
                                    eventColor = 'text-orange-400';
                                }
                            }

                            cost = 8000 * area; // ‡∏Ñ‡πà‡∏≤‡∏õ‡∏∏‡πã‡∏¢‡∏¢‡∏≤‡∏Ñ‡∏á‡∏ó‡∏µ‡πà
                            let baseYieldPerRai = 2000; // ‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏ê‡∏≤‡∏ô
                            let price = 100 + (Math.random() * 40 - 20); // Fluctuating price

                            revenue = baseYieldPerRai * yieldFactor * area * price;
                        }
                    } else {
                        // Annual Crops (‡∏û‡∏∑‡∏ä‡∏•‡πâ‡∏°‡∏•‡∏∏‡∏Å)
                        stage = '‡∏£‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï‡∏£‡∏≤‡∏¢‡∏õ‡∏µ';
                        cost = 4000 * area;
                        let yieldPerRai = 800 + (Math.random() * 100);
                        let price = 15 + (Math.random() * 5);
                        revenue = yieldPerRai * area * price;
                    }

                    // --- Mock Events (History Impact) ---
                    // Example: 2554 (2011) Flood
                    if (year === 2554 || year === 2564) {
                        event = '‡∏ô‡πâ‡∏≥‡∏ó‡πà‡∏ß‡∏°‡πÉ‡∏´‡∏ç‡πà (‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢‡∏´‡∏ô‡∏±‡∏Å)';
                        eventColor = 'text-red-500';
                        revenue *= 0.1; 
                        cost *= 1.5; // ‡∏ã‡πà‡∏≠‡∏°‡πÅ‡∏ã‡∏°
                    } else if (year === 2558) {
                        event = '‡∏†‡∏±‡∏¢‡πÅ‡∏•‡πâ‡∏á‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á';
                        eventColor = 'text-orange-500';
                        revenue *= 0.5;
                    }

                    const profit = revenue - cost;
                    cumProfit += profit;
                    totCost += cost;
                    totRev += revenue;

                    data.push({ year, treeAge, stage, event, eventColor, cost, revenue, profit, cumProfit });
                }

                setSimulationData(data);
                const roi = totCost > 0 ? ((totRev - totCost) / totCost) * 100 : 0;
                setSummary({ totalCost: totCost, totalRevenue: totRev, totalProfit: totRev - totCost, roi });

            }, [crop, area, simulationYears]);

            // Draw Chart
            useEffect(() => {
                if (canvasRef.current && simulationData.length > 0) {
                    if (chartRef.current) chartRef.current.destroy();
                    const ctx = canvasRef.current.getContext('2d');
                    
                    chartRef.current = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: simulationData.map(d => d.year),
                            datasets: [
                                {
                                    label: '‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∞‡∏™‡∏° (‡∏ö‡∏≤‡∏ó)',
                                    data: simulationData.map(d => d.cumProfit),
                                    borderColor: '#34d399',
                                    backgroundColor: 'rgba(52, 211, 153, 0.1)',
                                    fill: true,
                                    tension: 0.4
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false },
                                title: { display: true, text: `‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∞‡∏™‡∏° ${simulationYears || 0} ‡∏õ‡∏µ`, color: '#94a3b8' }
                            },
                            scales: {
                                y: { grid: { color: '#334155' }, ticks: { color: '#cbd5e1' } },
                                x: { grid: { display: false }, ticks: { color: '#cbd5e1' } }
                            }
                        }
                    });
                }
                return () => { if (chartRef.current) chartRef.current.destroy(); };
            }, [simulationData]);

            // Helper to format address text
            const fullAddress = [
                address?.subDistrict, 
                address?.district, 
                province
            ].filter(Boolean).join(' ');

            return (
                <div className="fixed inset-0 z-[1100] bg-slate-900/90 backdrop-blur-sm flex items-center justify-center p-4 animate-fade-in-up">
                    <div className="bg-slate-800 rounded-2xl shadow-2xl border border-slate-600 w-full max-w-4xl h-[90vh] flex flex-col overflow-hidden relative">
                        {/* Header */}
                        <div className="p-6 border-b border-slate-700 flex justify-between items-start bg-slate-800 z-10">
                            <div>
                                <h2 className="text-xl md:text-2xl font-bold text-white flex items-center gap-2 flex-wrap">
                                    <i className="fa-solid fa-clock-rotate-left text-yellow-400"></i> 
                                    ‡∏à‡∏≥‡∏•‡∏≠‡∏á‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÄ‡∏®‡∏£‡∏©‡∏ê‡∏µ: {crop} ({area} ‡πÑ‡∏£‡πà)
                                </h2>
                                <p className="text-slate-400 text-sm mt-1 flex items-center gap-2">
                                    <i className="fa-solid fa-map-location-dot text-emerald-400"></i>
                                    <span className="flex items-center gap-1">
                                        Simulate: ‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á
                                        <input 
                                            type="number" 
                                            value={simulationYears} 
                                            onChange={handleYearChange}
                                            className="w-14 bg-slate-700 text-white text-center rounded border border-slate-500 focus:border-emerald-400 focus:outline-none px-1 py-0.5 mx-1"
                                            min="1"
                                        />
                                        ‡∏õ‡∏µ ‡∏ì <span className="text-emerald-300 font-bold">{fullAddress || province}</span>
                                    </span>
                                </p>
                            </div>
                            <button onClick={onClose} className="text-slate-400 hover:text-white transition bg-slate-700/50 w-8 h-8 rounded-full flex items-center justify-center">
                                <i className="fa-solid fa-times"></i>
                            </button>
                        </div>

                        {/* Body */}
                        <div className="flex-1 overflow-y-auto p-6 scrollbar-prominent">
                            
                            {/* Alert Box for Aging Crops */}
                            {lifecycleInfo && lifecycleInfo.type === 'tree' && simulationYears >= lifecycleInfo.decline_start && (
                                <div className="mb-6 p-4 bg-orange-900/30 border border-orange-500/50 rounded-xl flex items-start gap-3 animate-pulse">
                                    <i className="fa-solid fa-triangle-exclamation text-orange-400 text-xl mt-1"></i>
                                    <div>
                                        <h4 className="font-bold text-orange-300">‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡∏û‡∏∑‡∏ä‡∏≠‡∏≤‡∏¢‡∏∏‡∏°‡∏≤‡∏Å (Aging Crop Alert)</h4>
                                        <p className="text-sm text-slate-300">{lifecycleInfo.advice}</p>
                                    </div>
                                </div>
                            )}

                            {/* Summary Cards */}
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                                <div className="bg-slate-700/50 p-4 rounded-xl border border-slate-600 text-center">
                                    <p className="text-xs text-slate-400">‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏£‡∏ß‡∏° {simulationYears} ‡∏õ‡∏µ</p>
                                    <p className="text-xl font-bold text-red-400">{summary.totalCost.toLocaleString()}</p>
                                </div>
                                <div className="bg-slate-700/50 p-4 rounded-xl border border-slate-600 text-center">
                                    <p className="text-xs text-slate-400">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏£‡∏ß‡∏° {simulationYears} ‡∏õ‡∏µ</p>
                                    <p className="text-xl font-bold text-blue-400">{summary.totalRevenue.toLocaleString()}</p>
                                </div>
                                <div className="bg-emerald-900/30 p-4 rounded-xl border border-emerald-500/50 text-center relative overflow-hidden">
                                    <div className="absolute inset-0 bg-emerald-500/10 animate-pulse"></div>
                                    <p className="text-xs text-emerald-300 relative z-10">‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ (Net Profit)</p>
                                    <p className="text-2xl font-bold text-emerald-400 relative z-10">{summary.totalProfit.toLocaleString()} ‡∏ø</p>
                                    <p className="text-[10px] text-emerald-200/70 mt-1 relative z-10">ROI: {summary.roi.toFixed(1)}%</p>
                                </div>
                            </div>

                            {/* Chart */}
                            <div className="bg-slate-900/50 p-4 rounded-xl border border-slate-700 mb-6 h-64">
                                <canvas ref={canvasRef}></canvas>
                            </div>

                            {/* Timeline */}
                            <h3 className="text-lg font-bold text-white mb-4 border-l-4 border-yellow-500 pl-3">‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏£‡∏≤‡∏¢‡∏õ‡∏µ (Timeline)</h3>
                            <div className="space-y-3 relative before:absolute before:left-4 before:top-2 before:bottom-2 before:w-0.5 before:bg-slate-600">
                                {simulationData.map((d, i) => (
                                    <div key={d.year} className="relative pl-10">
                                        {/* Dot */}
                                        <div className={`absolute left-2.5 top-3 w-3 h-3 rounded-full border-2 border-slate-900 ${d.profit > 0 ? 'bg-emerald-500' : 'bg-red-500'} z-10`}></div>
                                        
                                        <div className={`p-3 rounded-lg border transition ${d.event.includes('‡∏õ‡∏•‡∏π‡∏Å‡∏ó‡∏î‡πÅ‡∏ó‡∏ô') ? 'bg-orange-900/20 border-orange-500/50' : 'bg-slate-700/30 border-slate-600 hover:bg-slate-700/50'}`}>
                                            <div className="flex flex-col md:flex-row justify-between md:items-center gap-2">
                                                <div>
                                                    <span className="font-bold text-yellow-400 text-lg mr-2">{d.year}</span>
                                                    <span className="text-sm text-slate-300 bg-slate-800 px-2 py-0.5 rounded border border-slate-600 mr-2">{d.stage}</span>
                                                    {lifecycleInfo?.type === 'tree' && <span className="text-[10px] text-slate-500">(‡∏≠‡∏≤‡∏¢‡∏∏ {d.treeAge} ‡∏õ‡∏µ)</span>}
                                                </div>
                                                <div className="flex items-center gap-2 text-sm">
                                                    <span className={`${d.eventColor} font-bold`}><i className="fa-solid fa-circle-exclamation"></i> {d.event}</span>
                                                </div>
                                            </div>
                                            
                                            <div className="grid grid-cols-3 gap-2 mt-2 text-xs border-t border-slate-600/50 pt-2">
                                                <div className="text-red-400">‡∏ó‡∏∏‡∏ô: {d.cost.toLocaleString()}</div>
                                                <div className="text-blue-400">‡∏£‡∏±‡∏ö: {d.revenue.toLocaleString()}</div>
                                                <div className={`font-bold ${d.profit >= 0 ? 'text-emerald-400' : 'text-red-500'}`}>
                                                    {d.profit >= 0 ? '+' : ''}{d.profit.toLocaleString()}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>

                        </div>
                    </div>
                </div>
            );
        };

        // --- SUB-COMPONENT: Result Item with Chart (KASET CLOUD) ---
        const ResultItemWithChart = ({ item, index, onSimulate }) => { // ‡∏£‡∏±‡∏ö prop onSimulate ‡πÄ‡∏û‡∏¥‡πà‡∏°
            const chartRef = useRef(null);
            const canvasRef = useRef(null);
            const historyChartRef = useRef(null);
            const historyCanvasRef = useRef(null);
            const [showHistory, setShowHistory] = useState(false);

            useEffect(() => {
                if (!showHistory && canvasRef.current) {
                    if (chartRef.current) chartRef.current.destroy();

                    setTimeout(() => {
                        if (!canvasRef.current) return;
                        
                        const ctx = canvasRef.current.getContext('2d');
                        const totalDemand = item.marketDemand || 10000;
                        const totalSupply = item.marketSupply || 8000;

                        chartRef.current = new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: ['Demand (‡∏ï‡∏•‡∏≤‡∏î)', 'Supply (‡∏£‡∏ß‡∏°)'],
                                datasets: [{
                                    label: '‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì (‡∏ï‡∏±‡∏ô)',
                                    data: [totalDemand, totalSupply],
                                    backgroundColor: [
                                        'rgba(54, 162, 235, 0.7)',
                                        totalSupply > totalDemand ? 'rgba(239, 68, 68, 0.7)' : 'rgba(16, 185, 129, 0.7)'
                                    ],
                                    borderColor: [
                                        'rgba(54, 162, 235, 1)',
                                        totalSupply > totalDemand ? 'rgba(239, 68, 68, 1)' : 'rgba(16, 185, 129, 1)'
                                    ],
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                indexAxis: 'y',
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: { legend: { display: false } },
                                scales: { x: { beginAtZero: true } }
                            }
                        });
                    }, 50);
                }
                return () => { if (chartRef.current) chartRef.current.destroy(); };
            }, [item, showHistory]);

            useEffect(() => {
                if (showHistory) {
                    setTimeout(() => {
                        if (historyCanvasRef.current && item.history && item.history.length > 0) {
                            if (historyChartRef.current) historyChartRef.current.destroy();

                            const ctx = historyCanvasRef.current.getContext('2d');
                            historyChartRef.current = new Chart(ctx, {
                                type: 'line',
                                data: {
                                    labels: item.history.map(h => h.year),
                                    datasets: [
                                        {
                                            label: '‡∏Å‡∏≥‡πÑ‡∏£ (‡∏ö‡∏≤‡∏ó)',
                                            data: item.history.map(h => h.profit),
                                            borderColor: 'rgba(16, 185, 129, 1)',
                                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                            yAxisID: 'y',
                                            tension: 0.3
                                        },
                                        {
                                            label: '‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô (‡∏ö‡∏≤‡∏ó)',
                                            data: item.history.map(h => h.cost),
                                            borderColor: 'rgba(239, 68, 68, 1)',
                                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                                            yAxisID: 'y',
                                            tension: 0.3
                                        }
                                    ]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    interaction: { mode: 'index', intersect: false },
                                    plugins: {
                                        title: { display: true, text: `‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á 5 ‡∏õ‡∏µ (${item.name})` },
                                        tooltip: {
                                            callbacks: {
                                                footer: (tooltipItems) => '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á'
                                            }
                                        }
                                    },
                                    scales: {
                                        y: { type: 'linear', display: true, position: 'left', title: { display: true, text: '‡∏ö‡∏≤‡∏ó' } }
                                    }
                                }
                            });
                        }
                    }, 100);
                }
                return () => { if (historyChartRef.current) historyChartRef.current.destroy(); };
            }, [showHistory, item]);

            return (
                <div className="bg-slate-800/90 p-5 rounded-2xl shadow-lg border border-slate-700 relative overflow-hidden transition hover:shadow-xl hover:border-slate-600 mb-4">
                    <div className="absolute top-0 left-0 bg-gradient-to-r from-emerald-600 to-green-700 text-white text-xs px-3 py-1 rounded-br-lg font-bold shadow-sm">‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà #{index + 1}</div>

                    <div className="mt-4 flex flex-col md:flex-row justify-between items-start">
                        <div>
                            <h3 className="text-xl font-bold text-white">{item.name} <span className="text-sm font-normal text-slate-400">({item.category})</span></h3>
                            <div className="flex gap-2 mt-1">
                                <span className={`text-[10px] px-2 py-0.5 rounded text-white ${item.risk_level === 'Low' ? 'bg-green-600' : item.risk_level === 'Medium' ? 'bg-yellow-600' : 'bg-red-600'}`}>‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á: {item.risk_level}</span>
                                {item.marketSupply > item.marketDemand ?
                                    <span className="text-[10px] bg-red-900/30 text-red-400 border border-red-900 px-2 py-0.5 rounded font-bold">‚ö†Ô∏è ‡∏•‡πâ‡∏ô‡∏ï‡∏•‡∏≤‡∏î</span> :
                                    <span className="text-[10px] bg-green-900/30 text-green-400 border border-green-900 px-2 py-0.5 rounded font-bold">‚úÖ ‡∏Ç‡∏≤‡∏î‡∏ï‡∏•‡∏≤‡∏î</span>
                                }
                            </div>
                        </div>
                        
                        {/* Simulation Button */}
                        <button 
                            onClick={() => onSimulate(item)}
                            className="mt-2 md:mt-0 bg-gradient-to-r from-fuchsia-600 via-pink-600 to-purple-600 hover:from-fuchsia-500 hover:to-pink-500 text-white text-xs px-4 py-2 rounded-xl shadow-[0_0_15px_rgba(236,72,153,0.6)] flex items-center gap-1.5 transition-all active:scale-95 border border-white/30 animate-pulse font-bold tracking-wide transform hover:scale-105"
                        >
                            <i className="fa-solid fa-clock-rotate-left text-yellow-300"></i> üïí ‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏•‡∏π‡∏Å
                        </button>
                    </div>

                    <div className="flex gap-4 my-4">
                        <div className="flex-1 bg-red-900/10 p-2 rounded text-center border border-red-900/30">
                            <p className="text-[10px] text-red-400 font-bold uppercase">‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏£‡∏ß‡∏°</p>
                            <p className="text-lg font-bold text-red-500">{item.costTotal.toLocaleString()}</p>
                        </div>
                        <div className="flex-1 bg-green-900/10 p-2 rounded text-center border border-green-900/30">
                            <p className="text-[10px] text-green-400 font-bold uppercase">‡∏Å‡∏≥‡πÑ‡∏£/‡∏õ‡∏µ (‡πÇ‡∏î‡∏¢‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì)</p>
                            <p className="text-lg font-bold text-green-500">{item.profitTotal.toLocaleString()}</p>
                        </div>
                    </div>

                    <div className="grid md:grid-cols-2 gap-4 text-xs text-slate-300 bg-slate-700/50 p-3 rounded-lg border border-slate-700">
                        <div>
                            <p className="font-bold mb-2 text-blue-400"><i className="fa-solid fa-list-check"></i> ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î:</p>
                            <p>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢: {item.price.toLocaleString()} ‡∏ö‡∏≤‡∏ó/‡∏ï‡∏±‡∏ô</p>
                            <p>‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï‡∏ï‡πà‡∏≠‡πÑ‡∏£‡πà: {item.yield.toLocaleString()} ‡∏Å‡∏Å./‡πÑ‡∏£‡πà</p>
                        </div>
                        <div>
                            <p className="font-bold mb-2 text-orange-400"><i className="fa-solid fa-triangle-exclamation"></i> ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á:</p>
                            <p className="mb-3 text-slate-400">{item.risk_reason}</p>
                        </div>
                    </div>

                    {/* CHART SECTION */}
                    <div className="mt-4 border-t border-slate-700 pt-4">
                        <div className="flex justify-between items-center mb-2">
                            <p className="text-xs font-bold text-slate-400"><i className="fa-solid fa-chart-simple"></i> ‡∏™‡∏†‡∏≤‡∏ß‡∏∞‡∏ï‡∏•‡∏≤‡∏î‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (Demand vs Supply)</p>
                            <button onClick={() => setShowHistory(!showHistory)} className="text-xs text-blue-400 hover:text-blue-300 bg-slate-700 px-2 py-1 rounded transition">
                                {showHistory ? <><i className="fa-solid fa-eye-slash"></i> ‡∏ã‡πà‡∏≠‡∏ô‡∏Å‡∏£‡∏≤‡∏ü</> : <><i className="fa-solid fa-chart-line"></i> ‡∏î‡∏π‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á</>}
                            </button>
                        </div>

                        {!showHistory ? (
                            <div className="h-32 w-full relative">
                                <canvas ref={canvasRef}></canvas>
                            </div>
                        ) : (
                            <div className="w-full animate-fade-in-up bg-slate-700/30 p-2 rounded border border-slate-700 mt-2">
                                {item.history && item.history.length > 0 ? (
                                    <div style={{ height: '250px', position: 'relative' }}>
                                        <canvas ref={historyCanvasRef}></canvas>
                                    </div>
                                ) : (
                                    <div className="text-center py-8 text-slate-500">
                                        <i className="fa-solid fa-circle-exclamation text-2xl mb-2"></i>
                                        <p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏û‡∏∑‡∏ä‡∏ä‡∏ô‡∏¥‡∏î‡∏ô‡∏µ‡πâ</p>
                                    </div>
                                )}
                                <p className="text-[10px] text-slate-500 text-center mt-2">* ‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Å‡∏≥‡πÑ‡∏£‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á (Simulation)</p>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // --- PAGE: KASET CLOUD ---
        const KasetCloudApp = () => {
            const [province, setProvince] = useState("‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£");
            const [area, setArea] = useState(1); // ‡πÅ‡∏Å‡πâ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô 1 ‡πÑ‡∏£‡πà
            const [analyzing, setAnalyzing] = useState(false);
            const [results, setResults] = useState(null);
            const [soilInfo, setSoilInfo] = useState(PROVINCE_DATA["‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£"]);
            const [isFullSheet, setIsFullSheet] = useState(false); // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å isSheetOpen ‡πÄ‡∏õ‡πá‡∏ô isFullSheet (‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà)
            const [isResultsUpdated, setIsResultsUpdated] = useState(false); // New state for pulse animation
            
            // ‡πÄ‡∏û‡∏¥‡πà‡∏° State ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏®
            const [weatherData, setWeatherData] = useState(null);
            
            // ‡πÄ‡∏û‡∏¥‡πà‡∏° State ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Historical Simulation Modal
            const [simulatingCrop, setSimulatingCrop] = useState(null);
            
            // ‡πÄ‡∏û‡∏¥‡πà‡∏° State ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÅ‡∏•‡∏∞‡∏ô‡πâ‡∏≥‡∏ó‡πà‡∏ß‡∏°
            const [address, setAddress] = useState({ subDistrict: '', district: '', province: '' });
            const [floodData, setFloodData] = useState({ risk: 'Low', history: [], desc: '' });

            const kasetMapRef = useRef(null);
            const kasetMarkerRef = useRef(null);
            const debounceRef = useRef(null); // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì

            const handleProvinceChange = (e) => {
                const p = e.target.value;
                setProvince(p);
                const info = PROVINCE_DATA[p];
                setSoilInfo(info);
                // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ã‡πá‡∏ï results=null ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á
            };
            
            // --- FUNCTION: Open Simulation Modal ---
            const handleSimulate = (cropItem) => {
                setSimulatingCrop(cropItem);
            };

            const closeSimulation = () => {
                setSimulatingCrop(null);
            };
            
            // --- FUNCTION: REVERSE GEOCODING (Nominatim) ---
            const fetchAddress = async (lat, lng) => {
                try {
                    // ‡πÉ‡∏ä‡πâ OSM Nominatim API (Free, Limit usage)
                    const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=14&addressdetails=1`, {
                        headers: { 'User-Agent': 'WinaiPortal/1.0' }
                    });
                    const data = await res.json();
                    if (data && data.address) {
                        return {
                            subDistrict: data.address.suburb || data.address.quarter || data.address.neighbourhood || data.address.village || '-',
                            district: data.address.city_district || data.address.district || data.address.county || '-',
                            province: data.address.province || data.address.state || '-'
                        };
                    }
                } catch (e) { console.error("Geocoding error:", e); }
                return null;
            };

            // --- FUNCTION: FLOOD RISK SIMULATION ---
            // ‡πÉ‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏à‡∏£‡∏¥‡∏á ‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API ‡∏Ç‡∏≠‡∏á GISTDA ‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏±‡∏ö Database
            // ‡∏≠‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ï‡∏≤‡∏° Lat/Lng Hash ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏î‡πâ‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°
            const calculateFloodRisk = (lat, lng, districtName) => {
                const hash = Math.abs(Math.sin(lat * 1000 + lng) * 10000);
                const riskLevel = hash % 100;
                
                let risk = 'Low';
                let desc = '‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏î‡∏≠‡∏ô ‡∏ô‡πâ‡∏≥‡πÑ‡∏°‡πà‡∏ó‡πà‡∏ß‡∏°‡∏Ç‡∏±‡∏á';
                let history = [];
                
                if (riskLevel > 80) {
                    risk = 'High';
                    desc = '‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏∏‡πà‡∏°‡∏ï‡πà‡∏≥ ‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ô‡πâ‡∏≥‡∏ó‡πà‡∏ß‡∏°‡∏ã‡πâ‡∏≥‡∏ã‡∏≤‡∏Å';
                    history = ['2554 (‡∏´‡∏ô‡∏±‡∏Å)', '2564', '2565'];
                } else if (riskLevel > 50) {
                    risk = 'Medium';
                    desc = '‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á ‡∏ó‡πà‡∏ß‡∏°‡∏ö‡∏≤‡∏á‡∏õ‡∏µ';
                    history = ['2554', '2565'];
                }
                
                return { risk, desc, history };
            };

            // --- FUNCTION: FETCH LIVE WEATHER ---
            const fetchWeatherData = async (lat, lng) => {
                try {
                    // Open-Meteo API: Forecast for current weather (temperature, rain)
                    // Docs: https://open-meteo.com/en/docs
                    const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&current=temperature_2m,rain&daily=precipitation_sum&timezone=Asia%2FBangkok&forecast_days=1`;
                    
                    const response = await fetch(url);
                    if (!response.ok) throw new Error('Weather API Error');
                    const data = await response.json();
                    
                    setWeatherData({
                        temp: data.current.temperature_2m, // Current Temp
                        rain: data.current.rain, // Current Rain
                        dailyRain: data.daily.precipitation_sum[0] // Forecast rain today
                    });
                } catch (error) {
                    console.error("Failed to fetch weather:", error);
                    setWeatherData(null); // Reset on error
                }
            };

            // Trigger Fetch Weather when Soil Info (Location) changes
            useEffect(() => {
                if (soilInfo && soilInfo.lat && soilInfo.lng) {
                    fetchWeatherData(soilInfo.lat, soilInfo.lng);
                    // Initial load address/flood
                    fetchAddress(soilInfo.lat, soilInfo.lng).then(addr => {
                       if(addr) setAddress(addr);
                       setFloodData(calculateFloodRisk(soilInfo.lat, soilInfo.lng));
                    });
                }
            }, [soilInfo]);


            // Auto Analyze Effect (‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠ province ‡∏´‡∏£‡∏∑‡∏≠ area ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô)
            useEffect(() => {
                // ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å timer ‡πÄ‡∏Å‡πà‡∏≤‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡πá‡∏ß‡πÜ (Debounce)
                if (debounceRef.current) clearTimeout(debounceRef.current);

                // ‡∏ï‡∏±‡πâ‡∏á‡∏´‡∏ô‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ (500ms) ‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏∞‡∏ï‡∏∏‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç
                setAnalyzing(true);
                debounceRef.current = setTimeout(() => {
                    analyzeData();
                }, 500);

                return () => {
                    if (debounceRef.current) clearTimeout(debounceRef.current);
                };
            }, [province, area, weatherData, floodData]); // ‡πÄ‡∏û‡∏¥‡πà‡∏° weatherData, floodData ‡πÄ‡∏Ç‡πâ‡∏≤ dependency
            
            useEffect(() => {
                if (document.getElementById('kaset-map')) {
                    const targetInfo = PROVINCE_DATA[province];

                    if (!kasetMapRef.current) {
                        const map = L.map('kaset-map').setView([targetInfo.lat, targetInfo.lng], 10);
                        
                        const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                            attribution: '&copy; OpenStreetMap contributors'
                        });

                        const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                            attribution: 'Tiles &copy; Esri'
                        });

                        const googleHybridLayer = L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', {
                            attribution: '&copy; Google Maps'
                        });

                        googleHybridLayer.addTo(map);

                        const baseMaps = {
                            "‡∏î‡∏≤‡∏ß‡πÄ‡∏ó‡∏µ‡∏¢‡∏° + ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà": googleHybridLayer,
                            "‡∏î‡∏≤‡∏ß‡πÄ‡∏ó‡∏µ‡∏¢‡∏° (‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠)": satelliteLayer,
                            "‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ": osmLayer
                        };
                        L.control.layers(baseMaps).addTo(map);
                        
                        const marker = L.marker([targetInfo.lat, targetInfo.lng], { draggable: true }).addTo(map);
                        marker.bindPopup(`<b>${province}</b><br>‡∏•‡∏≤‡∏Å‡∏´‡∏°‡∏∏‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÅ‡∏õ‡∏•‡∏á`).openPopup();
                        
                        // --- DRAG END EVENT HANDLER ---
                        marker.on('dragend', async function(event) {
                            const marker = event.target;
                            const position = marker.getLatLng();
                            marker.setLatLng(new L.LatLng(position.lat, position.lng), { draggable: 'true' });
                            // map.panTo(new L.LatLng(position.lat, position.lng)); // Optional: Don't pan if annoying
                            
                            // 1. Update Coords State
                            setSoilInfo(prev => ({...prev, lat: position.lat, lng: position.lng}));
                            
                            // 2. Fetch Address (Tambon/Amphoe)
                            const addr = await fetchAddress(position.lat, position.lng);
                            if(addr) {
                                setAddress(addr);
                                marker.setPopupContent(`<b>${addr.subDistrict}</b><br>${addr.district}`);
                                marker.openPopup();
                            }

                            // 3. Calc Flood Risk
                            const fRisk = calculateFloodRisk(position.lat, position.lng);
                            setFloodData(fRisk);
                        });

                        kasetMapRef.current = map;
                        kasetMarkerRef.current = marker;

                        setTimeout(() => { map.invalidateSize(); }, 200);

                    } else {
                        const map = kasetMapRef.current;
                        const marker = kasetMarkerRef.current;
                        if (targetInfo) {
                            map.flyTo([targetInfo.lat, targetInfo.lng], 10);
                            marker.setLatLng([targetInfo.lat, targetInfo.lng]);
                            marker.setPopupContent(`<b>${province}</b><br>‡∏•‡∏≤‡∏Å‡∏´‡∏°‡∏∏‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÅ‡∏õ‡∏•‡∏á`);
                            setTimeout(() => { map.invalidateSize(); }, 200);
                        }
                    }
                }
                
                // Cleanup map on unmount
                return () => {
                    // We don't remove map here to prevent re-initialization issues with React Strict Mode in some envs
                    // But in single file logic, it persists. 
                };
            }, [province]);

            // ‡πÅ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏≠‡∏Å‡∏°‡∏≤ (‡πÄ‡∏≠‡∏≤ setTimeout ‡∏≠‡∏≠‡∏Å‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÉ‡∏ä‡πâ‡πÉ‡∏ô useEffect ‡πÅ‡∏•‡πâ‡∏ß)
            const analyzeData = () => {
                let baseData = [
                    { id: 1, name: "‡∏Ç‡πâ‡∏≤‡∏ß‡∏´‡∏≠‡∏°‡∏°‡∏∞‡∏•‡∏¥", category: "‡∏û‡∏∑‡∏ä‡πÑ‡∏£‡πà", price: 15000, yield: 800, cost: 4500, risk_level: "Medium", demand_desc: "‡∏™‡∏π‡∏á", risk_reason: "‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ú‡∏±‡∏ô‡∏ú‡∏ß‡∏ô‡∏ï‡∏≤‡∏°‡∏ï‡∏•‡∏≤‡∏î‡πÇ‡∏•‡∏Å" },
                    { id: 2, name: "‡∏ú‡∏±‡∏Å‡∏™‡∏•‡∏±‡∏î‡πÑ‡∏Æ‡πÇ‡∏î‡∏£", category: "‡∏ú‡∏±‡∏Å", price: 80000, yield: 2000, cost: 35000, risk_level: "Low", demand_desc: "‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á", risk_reason: "‡∏ï‡πâ‡∏≠‡∏á‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡πâ‡∏≥‡∏î‡∏µ‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°" },
                    { id: 3, name: "‡∏ó‡∏∏‡πÄ‡∏£‡∏µ‡∏¢‡∏ô", category: "‡∏ú‡∏•‡πÑ‡∏°‡πâ", price: 120000, yield: 2000, cost: 25000, risk_level: "High", demand_desc: "‡∏™‡∏π‡∏á‡∏°‡∏≤‡∏Å", risk_reason: "‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏≤‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏Ñ‡∏∑‡∏ô‡∏ó‡∏∏‡∏ô (5 ‡∏õ‡∏µ+)" },
                    { id: 4, name: "‡∏¢‡∏≤‡∏á‡∏û‡∏≤‡∏£‡∏≤", category: "‡∏û‡∏∑‡∏ä‡πÑ‡∏£‡πà", price: 50000, yield: 250, cost: 1500, risk_level: "Low", demand_desc: "‡∏Ñ‡∏á‡∏ó‡∏µ‡πà", risk_reason: "‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏±‡∏ö‡∏ï‡∏•‡∏≤‡∏î‡πÇ‡∏•‡∏Å‡πÅ‡∏•‡∏∞‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô" },
                    { id: 5, name: "‡∏°‡∏±‡∏ô‡∏™‡∏≥‡∏õ‡∏∞‡∏´‡∏•‡∏±‡∏á", category: "‡∏û‡∏∑‡∏ä‡πÑ‡∏£‡πà", price: 3000, yield: 3500, cost: 3500, risk_level: "Low", demand_desc: "‡∏™‡∏π‡∏á", risk_reason: "‡∏£‡∏∞‡∏ß‡∏±‡∏á‡πÇ‡∏£‡∏Ñ‡πÉ‡∏ö‡∏î‡πà‡∏≤‡∏á" },
                    { id: 6, name: "‡∏Ç‡πâ‡∏≤‡∏ß‡πÇ‡∏û‡∏î‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡∏™‡∏±‡∏ï‡∏ß‡πå", category: "‡∏û‡∏∑‡∏ä‡πÑ‡∏£‡πà", price: 8500, yield: 1000, cost: 4000, risk_level: "Medium", demand_desc: "‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á", risk_reason: "‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Å‡∏±‡∏ö‡∏û‡∏∑‡∏ä‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤" },
                    { id: 7, name: "‡∏≠‡πâ‡∏≠‡∏¢‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô", category: "‡∏û‡∏∑‡∏ä‡πÑ‡∏£‡πà", price: 1100, yield: 12000, cost: 6000, risk_level: "Medium", demand_desc: "‡∏™‡∏π‡∏á", risk_reason: "‡∏ï‡πâ‡∏≠‡∏á‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡∏ï‡∏≤‡∏°‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤" },
                    { id: 8, name: "‡∏õ‡∏≤‡∏•‡πå‡∏°‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô", category: "‡∏û‡∏∑‡∏ä‡πÑ‡∏£‡πà", price: 6000, yield: 3000, cost: 2000, risk_level: "Low", demand_desc: "‡∏™‡∏π‡∏á‡∏°‡∏≤‡∏Å", risk_reason: "‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ú‡∏±‡∏ô‡∏ú‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô" }
                ];

                // ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤ area ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì
                const currentArea = parseFloat(area) || 0;

                // --- INTEGRATE FLOOD & WEATHER INTO CALCULATION ---
                baseData = baseData.map(item => {
                    let adjustedYield = item.yield;
                    let adjustedCost = item.cost;
                    let adjustedRisk = item.risk_level;
                    let reason = item.risk_reason;

                    // 1. Flood Risk Impact
                    if (floodData.risk === 'High') {
                        // High flood risk area
                        adjustedCost *= 1.2; // Add 20% cost for prevention
                        if (!item.name.includes("‡∏Ç‡πâ‡∏≤‡∏ß")) { // Rice might survive better than others
                            adjustedYield *= 0.7; // Lose 30% yield potential
                            adjustedRisk = "High";
                            reason = `‚ö†Ô∏è ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ô‡πâ‡∏≥‡∏ó‡πà‡∏ß‡∏°! (${address.subDistrict}) ‡∏Ñ‡∏ß‡∏£‡∏ó‡∏≥‡∏Ñ‡∏±‡∏ô‡∏î‡∏¥‡∏ô‡∏™‡∏π‡∏á`;
                        }
                    } else if (floodData.risk === 'Medium') {
                         adjustedCost *= 1.1;
                         reason = `‚ö†Ô∏è ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ô‡πâ‡∏≥‡∏ó‡πà‡∏ß‡∏°‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á ‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏ä‡πà‡∏ß‡∏á‡∏§‡∏î‡∏π‡∏ù‡∏ô`;
                    }

                    // 2. Weather Impact (Forecast)
                    if (weatherData) {
                        if (weatherData.dailyRain < 2 && (item.name.includes("‡∏Ç‡πâ‡∏≤‡∏ß") || item.name.includes("‡∏Ç‡πâ‡∏≤‡∏ß‡πÇ‡∏û‡∏î"))) {
                            adjustedYield *= 0.85;
                            reason += " | ‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡πÅ‡∏•‡πâ‡∏á (‡∏ù‡∏ô‡∏ô‡πâ‡∏≠‡∏¢)";
                        }
                    }

                    return { ...item, yield: adjustedYield, cost: adjustedCost, risk_level: adjustedRisk, risk_reason: reason };
                });

                const calculated = baseData.map(item => {
                    const marketStats = MARKET_STATS_DB[item.name] || { domestic: 10000, export: 5000, current: 8000 };
                    const totalDemand = marketStats.domestic + marketStats.export;
                    const myOutputTons = (item.yield * currentArea) / 1000;
                    const otherRegisteredSupply = getOtherRegisteredSupply(item.name);
                    const totalSupply = marketStats.current + myOutputTons + otherRegisteredSupply;
                    const revenue = item.price * (item.yield / 1000) * currentArea;
                    const totalCost = item.cost * currentArea;
                    const profit = revenue - totalCost;

                    const history = Array.from({ length: 5 }, (_, i) => {
                        const year = 2567 - (4 - i);
                        const factor = 1 + (Math.random() * 0.2 - 0.1);
                        return {
                            year,
                            profit: Math.max(0, profit * factor),
                            cost: totalCost * factor,
                            demand: totalDemand * factor,
                            supply: totalSupply * (1 + (Math.random() * 0.3 - 0.15))
                        };
                    });

                    return {
                        ...item,
                        profitTotal: profit,
                        costTotal: totalCost,
                        marketDemand: totalDemand,
                        marketSupply: totalSupply,
                        history: history
                    };
                });

                calculated.sort((a, b) => b.profitTotal - a.profitTotal);
                setResults(calculated);
                setAnalyzing(false);
                
                // Trigger Pulse Animation
                setIsResultsUpdated(true);
                setTimeout(() => setIsResultsUpdated(false), 10000); // Stop pulsing after 10 seconds (Edited)
            };

            const analyze = () => {
                setAnalyzing(true);
                setTimeout(() => {
                    analyzeData();
                }, 500);
            };

            const getPhColor = (ph) => {
                if(ph < 5.5) return "text-red-400";
                if(ph > 7.5) return "text-purple-400";
                return "text-emerald-400";
            }

            const getPhText = (ph) => {
                if(ph < 5.5) return "‡∏î‡∏¥‡∏ô‡∏Å‡∏£‡∏î (Acid)";
                if(ph > 7.5) return "‡∏î‡∏¥‡∏ô‡∏î‡πà‡∏≤‡∏á (Alkaline)";
                return "‡∏Å‡∏•‡∏≤‡∏á (Neutral)";
            }

            return (
                <div className="relative w-full h-[calc(100vh-60px)] bg-slate-900 overflow-hidden">
                    {/* Header (Optional overlay or just embedded) */}
                    <div className="absolute top-4 left-1/2 transform -translate-x-1/2 z-[1000] bg-slate-900/80 backdrop-blur-md px-4 py-1.5 rounded-full border border-emerald-500/50 shadow-lg pointer-events-none">
                        <h2 className="text-sm font-bold text-slate-100 flex items-center gap-2"><i className="fa-solid fa-calculator text-emerald-500"></i> Kaset Cloud AI</h2>
                    </div>

                    {/* Map Container (Full Screen relative) */}
                    <div id="kaset-map" className="absolute inset-0 z-0 h-full w-full"></div>
                                
                    {/* Overlay: Select Province & Area - Adjusted position to be higher and next to zoom controls */}
                    {/* ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å top-12 left-2 ‡πÄ‡∏õ‡πá‡∏ô top-2 left-[50px] ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏™‡∏π‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏ã‡∏π‡∏° (‡∏ã‡∏∂‡πà‡∏á‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì 40px) */}
                    <div className="absolute top-3 left-[50px] md:left-[60px] z-[990] transition-transform duration-300">
                        {/* ‡∏õ‡∏£‡∏±‡∏ö flex-col ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏î‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏•‡∏á‡∏°‡∏≤ */}
                        <div className="bg-slate-900/40 backdrop-blur-md p-2 rounded-lg border-2 border-emerald-500 shadow-[0_0_15px_rgba(16,185,129,0.4)] hover:bg-slate-900/60 transition-all duration-300 flex flex-col sm:flex-row items-start sm:items-center gap-2">
                            {/* ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 1: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î (Compact & Prominent) */}
                            <div className="relative group/select">
                                <div className="absolute left-1.5 top-1/2 transform -translate-y-1/2 text-emerald-300 pointer-events-none text-[12px] drop-shadow-md z-10">
                                    <i className="fa-solid fa-location-dot animate-bounce"></i>
                                </div>
                                <select 
                                    className="w-[130px] py-1.5 pl-6 pr-4 text-[11px] border border-emerald-400/50 rounded bg-emerald-900/40 text-white focus:ring-2 focus:ring-emerald-400 focus:border-emerald-400 focus:outline-none appearance-none cursor-pointer hover:bg-emerald-800/50 transition shadow-inner font-bold tracking-wide" 
                                    value={province} 
                                    onChange={handleProvinceChange}
                                >
                                    {Object.keys(PROVINCE_DATA).sort().map(p => <option key={p} value={p} className="bg-slate-800 text-white">{p}</option>)}
                                </select>
                                <div className="absolute right-1 top-1/2 transform -translate-y-1/2 pointer-events-none text-emerald-300">
                                    <i className="fa-solid fa-caret-down text-[10px]"></i>
                                </div>
                                
                                {/* Hint Label */}
                                <div className="absolute -top-3 left-0 w-full text-center">
                                    <span className="text-[9px] text-emerald-300 font-bold bg-slate-900/80 px-1 rounded-full border border-emerald-500/50 animate-pulse shadow-sm">
                                        ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î
                                    </span>
                                </div>
                            </div>

                            {/* ‡πÄ‡∏™‡πâ‡∏ô‡∏Ñ‡∏±‡πà‡∏ô - ‡∏ã‡πà‡∏≠‡∏ô‡πÉ‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ (hidden sm:block) */}
                            <div className="hidden sm:block w-[1px] h-6 bg-emerald-500/30"></div>

                            {/* Container ‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà 2 ‡πÉ‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */}
                            <div className="flex items-center gap-2">
                                {/* ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 2: ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà (‡πÑ‡∏£‡πà) */}
                                <div className="relative flex items-center group/input">
                                    <input 
                                        type="number" 
                                        value={area} 
                                        onChange={(e) => {
                                            const val = e.target.value;
                                            if (val === '' || parseFloat(val) > 0) {
                                                setArea(val);
                                            }
                                        }}
                                        className="w-[50px] py-1.5 pl-1 pr-1 text-[11px] text-center border border-white/20 rounded bg-black/20 text-white focus:ring-1 focus:ring-emerald-400 focus:border-emerald-400 focus:outline-none hover:bg-black/40 transition shadow-inner font-mono font-bold" 
                                        placeholder="0" 
                                        min="1"
                                    />
                                    <span className="text-[10px] text-white/80 ml-1 font-bold">‡πÑ‡∏£‡πà</span>
                                </div>

                                {/* Auto Status Icon */}
                                <div className="ml-1" title="‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥">
                                    <i className={`fa-solid fa-bolt text-[10px] ${analyzing ? 'text-yellow-400 animate-spin' : 'text-emerald-400'}`}></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Overlay: Live Data Info (Moved to Top Right on Mobile to avoid bottom sheet collision) */}
                    {/* ‡∏õ‡∏£‡∏±‡∏ö top-20 right-2 ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏ô‡∏µ Header ‡πÅ‡∏•‡∏∞ Layer Control */}
                    <div className="absolute top-24 right-2 md:top-[10px] md:right-[60px] z-[990] w-[140px] md:w-[180px]">
                        <div className="bg-slate-900/70 backdrop-blur-md p-2 md:p-3 rounded-xl border border-blue-500/30 shadow-lg hover:bg-slate-900/90 transition-all duration-300">
                             <div className="flex justify-between items-center mb-1 md:mb-2 pb-1 border-b border-white/10">
                                <span className="text-[9px] md:text-[10px] font-bold text-blue-300"><i className="fa-solid fa-satellite-dish"></i> Live Data</span>
                                <span className="text-[8px] md:text-[9px] text-slate-400 truncate max-w-[60px]">{province}</span>
                             </div>
                             <div className="space-y-1 md:space-y-2 text-[9px] md:text-[10px] text-slate-300">
                                <div className="flex justify-between items-center">
                                    <span><i className="fa-solid fa-layer-group text-amber-500"></i> ‡∏î‡∏¥‡∏ô:</span>
                                    <span className="font-bold text-slate-100 truncate max-w-[70px] md:max-w-[80px]" title={soilInfo.soil}>{soilInfo.soil}</span>
                                </div>
                                <div className="flex justify-between items-center">
                                    <span><i className="fa-solid fa-flask text-purple-400"></i> pH:</span>
                                    <span className={`font-bold ${getPhColor(soilInfo.ph)}`}>{soilInfo.ph}</span>
                                </div>
                                <div className="flex justify-between items-center">
                                    <span><i className="fa-solid fa-cloud-rain text-blue-400"></i> ‡∏ä‡∏∑‡πâ‡∏ô:</span>
                                    <span className="font-bold text-slate-100">{soilInfo.moisture}%</span>
                                </div>
                                {weatherData && (
                                    <>
                                        <div className="w-full h-px bg-white/10 my-1"></div>
                                        <div className="flex justify-between items-center">
                                            <span><i className="fa-solid fa-temperature-half text-orange-400"></i> ‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥:</span>
                                            <span className="font-bold text-orange-200">{weatherData.temp}¬∞C</span>
                                        </div>
                                        <div className="flex justify-between items-center">
                                            <span><i className="fa-solid fa-cloud-showers-heavy text-cyan-400"></i> ‡∏ù‡∏ô (‡∏ß‡∏±‡∏ô):</span>
                                            <span className="font-bold text-cyan-200">{weatherData.dailyRain}mm</span>
                                        </div>
                                    </>
                                )}
                                <div className="pt-1 border-t border-white/10">
                                    <div className="flex justify-between items-center">
                                        <span><i className="fa-solid fa-water text-cyan-400"></i> ‡∏ô‡πâ‡∏≥‡∏ó‡πà‡∏ß‡∏°:</span>
                                        <span className={`font-bold ${floodData.risk === 'High' ? 'text-red-500' : (floodData.risk === 'Medium' ? 'text-yellow-500' : 'text-green-500')}`}>{floodData.risk === 'High' ? '‡∏™‡∏π‡∏á' : (floodData.risk === 'Medium' ? '‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á' : '‡∏ï‡πà‡∏≥')}</span>
                                    </div>
                                    {floodData.history.length > 0 && <div className="text-[8px] text-red-300 text-right">‡πÄ‡∏Ñ‡∏¢‡∏ó‡πà‡∏ß‡∏°: {floodData.history.join(', ')}</div>}
                                </div>
                             </div>
                        </div>
                    </div>
                    
                    {/* Bottom Sheet Results - Transparent Background, No Blur, Always Visible (Starts half-open) */}
                    <div className={`absolute bottom-0 left-0 w-full bg-slate-900/60 backdrop-blur-none rounded-t-3xl border-t border-emerald-500/50 shadow-[0_-5px_30px_rgba(0,0,0,0.5)] z-[1000] bottom-sheet flex flex-col ${isFullSheet ? 'h-[100%] pt-10' : 'h-[45%]'}`}>
                        
                        {/* Close Button (Visible only when full screen) */}
                        {isFullSheet && (
                            <button 
                                onClick={() => setIsFullSheet(false)}
                                className="absolute top-4 right-4 z-[1010] bg-slate-800/50 text-white w-8 h-8 rounded-full flex items-center justify-center hover:bg-red-500/50 transition-colors"
                            >
                                <i className="fa-solid fa-times"></i>
                            </button>
                        )}

                        {/* Header / Handle */}
                        <div 
                            className={`w-full h-12 min-h-[3rem] flex items-center justify-between px-6 cursor-pointer border-b border-white/10 hover:bg-white/5 transition-all duration-300 ${isResultsUpdated ? 'animate-result-pulse bg-emerald-900/20' : ''}`}
                            onClick={() => setIsFullSheet(!isFullSheet)}
                        >
                            <div className="font-bold text-emerald-400 flex items-center gap-2 overflow-hidden">
                                <div className="bg-emerald-500/20 p-1.5 rounded-full flex-shrink-0"><i className="fa-solid fa-ranking-star"></i></div>
                                <div className="flex flex-col overflow-hidden">
                                    <span className="text-sm md:text-base leading-tight truncate">
                                        10 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏ô‡πà‡∏≤‡∏•‡∏á‡∏ó‡∏∏‡∏ô ({area} ‡πÑ‡∏£‡πà) @ {address.subDistrict && address.subDistrict !== '-' ? `${address.subDistrict} ` : ''}{address.district && address.district !== '-' ? `${address.district} ` : ''}{province}
                                    </span>
                                    {analyzing ? (
                                        <span className="text-[10px] text-slate-400 font-normal animate-pulse">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì...</span>
                                    ) : (
                                        <span className="text-[10px] text-slate-500 font-normal truncate">
                                            ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏´‡∏°‡∏∏‡∏î: {soilInfo.lat.toFixed(4)}, {soilInfo.lng.toFixed(4)}
                                        </span>
                                    )}
                                </div>
                            </div>
                            
                            {/* Handle Pill */}
                            <div className="absolute left-1/2 top-2 transform -translate-x-1/2 w-12 h-1 bg-slate-500/50 rounded-full"></div>
                            
                            <div className={`text-slate-400 text-xs flex items-center gap-2 flex-shrink-0 ${isResultsUpdated ? 'text-emerald-300 font-bold animate-bounce' : ''}`}>
                                <span className="hidden sm:inline">
                                    {isFullSheet ? '‡∏¢‡πà‡∏≠‡∏•‡∏á' : (isResultsUpdated ? '‚ú® ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏î‡∏π‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå!' : '‡∏Ç‡∏¢‡∏≤‡∏¢‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠')}
                                </span>
                                <span className="sm:hidden">
                                    {isFullSheet ? '‡∏¢‡πà‡∏≠' : '‡∏Ç‡∏¢‡∏≤‡∏¢'}
                                </span>
                                <i className={`fa-solid fa-chevron-up transition-transform duration-500 ${isFullSheet ? 'rotate-180' : ''}`}></i>
                            </div>
                        </div>

                        {/* Content Area (Scrollable) */}
                        <div className="flex-1 overflow-y-auto scrollbar-prominent p-4 pb-24">
                            {results && results.map((item, idx) => (
                                <ResultItemWithChart 
                                    key={idx} 
                                    item={item} 
                                    index={idx} 
                                    onSimulate={handleSimulate} 
                                />
                            ))}
                            {!results && (
                                <div className="flex flex-col items-center justify-center h-full text-slate-500">
                                    <i className="fa-solid fa-chart-pie text-4xl mb-4 opacity-50"></i>
                                    <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏≠‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå...</p>
                                </div>
                            )}
                        </div>
                    </div>

                    {/* Coordinates Display (Bottom Right inside Map - Adjusted position) */}
                    <div className={`absolute right-2 z-[900] text-[9px] text-slate-300 font-mono bg-black/60 backdrop-blur-[2px] px-2 py-1 rounded border-[0.5px] border-white/10 pointer-events-none transition-all duration-300 ${isFullSheet ? 'bottom-4' : 'bottom-[46%]'}`}>
                        <span className="text-emerald-400">{soilInfo.lat.toFixed(4)}, {soilInfo.lng.toFixed(4)}</span>
                    </div>

                    {/* Historical Simulation Modal */}
                    {simulatingCrop && (
                        <HistoricalSimulation 
                            crop={simulatingCrop.name} 
                            province={province} 
                            area={area} 
                            address={address} // Pass address state here
                            onClose={closeSimulation} 
                        />
                    )}

                </div>
            );
        };

        // --- COMPONENTS FROM PREVIOUS CONTEXT (MarketPage, AdminPage, HomePage) ---

        const MarketPage = ({ setPage, user }) => {
            const [activeTab, setActiveTab] = useState('register');
            const [formData, setFormData] = useState({
                crop: '‡∏Ç‡πâ‡∏≤‡∏ß‡∏´‡∏≠‡∏°‡∏°‡∏∞‡∏•‡∏¥', area: '', province: '‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£', date: new Date().toISOString().split('T')[0], lat: 13.7563, lng: 100.5018
            });
            const [hasLocation, setHasLocation] = useState(false);
            const [analysisResult, setAnalysisResult] = useState(null);
            const [isSubmitting, setIsSubmitting] = useState(false);
            const [myRegistrations, setMyRegistrations] = useState([]);

            const calculateDemandSupply = () => {
                setIsSubmitting(true);
                setTimeout(() => {
                    const marketStats = MARKET_STATS_DB[formData.crop] || { domestic: 10000, export: 5000, current: 8000 };
                    setAnalysisResult({
                        ...marketStats,
                        estimatedOutput: parseFloat(formData.area) * 0.8,
                        totalProjectedSupply: marketStats.current + (parseFloat(formData.area) * 0.8),
                        totalDemand: marketStats.domestic + marketStats.export,
                        statusText: "‡∏™‡∏°‡∏î‡∏∏‡∏• (Balanced)", statusColor: "green", advice: "‡∏£‡∏≤‡∏Ñ‡∏≤‡∏î‡∏µ ‡∏•‡∏∏‡∏¢‡πÄ‡∏•‡∏¢!"
                    });
                    setIsSubmitting(false);
                }, 1000);
            };

            return (
                <div className="min-h-screen bg-slate-900 p-4 pb-24">
                     <div className="bg-slate-800 rounded-xl shadow-md p-6 border border-slate-700 mb-6">
                        <h3 className="font-bold text-slate-100 mb-4 border-l-4 border-orange-500 pl-3">üìù ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô Supply</h3>
                        <div className="grid md:grid-cols-2 gap-4">
                            <select name="crop" value={formData.crop} onChange={e => setFormData({...formData, crop: e.target.value})} className="w-full p-3 border border-slate-600 rounded bg-slate-700 text-white focus:outline-none focus:ring-2 focus:ring-orange-500">{Object.keys(MARKET_STATS_DB).map(k => <option key={k} value={k}>{k}</option>)}</select>
                            <input type="number" placeholder="‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà (‡πÑ‡∏£‡πà)" value={formData.area} onChange={e => setFormData({...formData, area: e.target.value})} className="w-full p-3 border border-slate-600 rounded bg-slate-700 text-white focus:outline-none focus:ring-2 focus:ring-orange-500"/>
                        </div>
                        <button onClick={calculateDemandSupply} className="w-full mt-4 bg-orange-600 hover:bg-orange-700 text-white p-3 rounded font-bold transition shadow-lg">{isSubmitting ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...' : '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'}</button>
                     </div>
                     {analysisResult && <div className="bg-slate-800 p-4 rounded shadow mt-4 text-center border-2 border-emerald-600"><h3 className="font-bold text-emerald-400">{analysisResult.statusText}</h3><p className="text-slate-300">{analysisResult.advice}</p></div>}
                     <button onClick={() => setPage('home')} className="mt-6 text-slate-500 hover:text-white w-full text-center transition">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
                </div>
            );
        };

        const HomePage = ({ user, onLogin, onAdminLogin, setPage, onLogout }) => (
            <div className="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 text-white p-6 flex flex-col items-center justify-center">
                 <h1 className="text-4xl font-bold mb-2 text-transparent bg-clip-text bg-gradient-to-r from-yellow-300 to-emerald-400 drop-shadow-sm">Winai Innovation</h1>
                 <p className="text-slate-400 mb-8">Super App ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£‡πÑ‡∏ó‡∏¢</p>
                 <div className="grid gap-4 w-full max-w-md">
                    <button onClick={() => setPage('kaset')} className="bg-emerald-700 p-4 rounded-xl font-bold hover:bg-emerald-600 transition flex items-center justify-center gap-2 shadow-lg border border-emerald-600/30"><i className="fa-solid fa-seedling"></i> Kaset Cloud (‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏ß‡∏¢)</button>
                    <button onClick={() => setPage('market')} className="bg-orange-700 p-4 rounded-xl font-bold hover:bg-orange-600 transition flex items-center justify-center gap-2 shadow-lg border border-orange-600/30"><i className="fa-solid fa-shop"></i> ‡∏ï‡∏•‡∏≤‡∏î & ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button>
                 </div>

                 {/* YouTube Video Section */}
                 <div className="w-full max-w-2xl mt-12 mb-8">
                    <div className="relative pt-[56.25%] rounded-xl overflow-hidden shadow-2xl border border-slate-700 bg-black">
                        <iframe 
                            className="absolute top-0 left-0 w-full h-full"
                            src="https://www.youtube.com/embed/PpMXYpy3_h0?si=nhlTPentJdXoYrdX" 
                            title="YouTube video player" 
                            frameBorder="0" 
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" 
                            referrerPolicy="strict-origin-when-cross-origin" 
                            allowFullScreen>
                        </iframe>
                    </div>
                    <p className="text-center text-slate-500 text-sm mt-3"><i className="fa-brands fa-youtube text-red-500"></i> ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô Winai Innovation</p>
                 </div>

                 <AppFooter />
            </div>
        );

        // --- MAIN APP ---
        const VinaiInnovationPortal = () => {
            const [page, setPage] = useState('home');
            const [user, setUser] = useState(null);

            return (
                <div className="font-sans text-slate-200">
                    <nav className="fixed bottom-0 w-full bg-slate-800 border-t border-slate-700 flex justify-around p-3 z-50 text-xs font-bold text-slate-400 shadow-2xl">
                        <button onClick={() => setPage('home')} className={page === 'home' ? 'text-emerald-400' : 'hover:text-slate-200'}><i className="fa-solid fa-house text-xl mb-1 block"></i>‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</button>
                        <button onClick={() => setPage('kaset')} className={page === 'kaset' ? 'text-emerald-400' : 'hover:text-slate-200'}><i className="fa-solid fa-seedling text-xl mb-1 block"></i>‡πÄ‡∏Å‡∏©‡∏ï‡∏£</button>
                        <button onClick={() => setPage('market')} className={page === 'market' ? 'text-orange-400' : 'hover:text-slate-200'}><i className="fa-solid fa-shop text-xl mb-1 block"></i>‡∏ï‡∏•‡∏≤‡∏î</button>
                    </nav>

                    {page === 'home' && <HomePage user={user} setPage={setPage} />}
                    {page === 'kaset' && <KasetCloudApp />}
                    {page === 'market' && <MarketPage setPage={setPage} user={user} />}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<VinaiInnovationPortal />);
    </script>
</body>

</html>
