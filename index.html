<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Winai Innovation Portal - Live Agriculture Data</title>

    <link rel="icon" type="image/svg+xml"
        href="https://upload.wikimedia.org/wikipedia/commons/a/a9/Flag_of_Thailand.svg">

    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- FIX: ใช้ unpkg เพื่อความเสถียร -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;700&display=swap');

        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #0f172a;
            color: #f1f5f9;
            overflow: hidden;
            height: 100dvh;
        }

        .leaflet-container {
            cursor: grab !important;
            background: #0f172a;
        }

        .leaflet-container:active {
            cursor: grabbing !important;
        }

        .leaflet-interactive {
            cursor: pointer !important;
        }

        /* Ensure pin is always interactive and visible on top */
        .custom-pin {
            pointer-events: auto !important;
            z-index: 1000 !important;
        }

        /* --- Custom Map Layer Filters --- */
        /* ย้อมสีเส้นแผนที่ให้เป็นสีฟ้า/น้ำเงิน */
        .blue-hybrid-labels {
            filter: invert(1) sepia(1) saturate(30) hue-rotate(200deg) brightness(1.2);
            opacity: 0.8; /* ปรับความเข้มจาง */
        }

        /* Animations */
        .animate-fade-in-up {
            animation: fadeInUp 0.5s ease-out forwards;
        }

        .animate-slide-in-right {
            animation: slideInRight 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }
        
        .animate-slide-down {
            animation: slideDown 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 15px rgba(236, 72, 153, 0.6); transform: scale(1); }
            50% { box-shadow: 0 0 30px rgba(236, 72, 153, 1); transform: scale(1.05); }
        }

        .btn-super-pulse {
            animation: pulse-glow 2s infinite;
        }

        @keyframes flag-wave-left {
            0% { transform: perspective(400px) rotateY(-5deg) skewY(0deg) translateY(0); }
            25% { transform: perspective(400px) rotateY(-15deg) skewY(2deg) translateY(-2px); }
            50% { transform: perspective(400px) rotateY(-5deg) skewY(0deg) translateY(0); }
            75% { transform: perspective(400px) rotateY(5deg) skewY(-2deg) translateY(2px); }
            100% { transform: perspective(400px) rotateY(-5deg) skewY(0deg) translateY(0); }
        }

        .animate-flag-wave {
            animation: flag-wave-left 3s infinite cubic-bezier(0.45, 0.05, 0.55, 0.95);
            transform-origin: bottom right;
            filter: drop-shadow(0 10px 10px rgba(0, 0, 0, 0.5));
        }

        .scrollbar-prominent {
            scrollbar-width: thin;
            scrollbar-color: rgba(251, 191, 36, 0.5) transparent;
        }

        .scrollbar-prominent::-webkit-scrollbar {
            width: 6px;
            height: 6px;
            display: block;
            -webkit-appearance: none;
        }

        .scrollbar-prominent::-webkit-scrollbar-track {
            background: transparent;
        }

        .scrollbar-prominent::-webkit-scrollbar-thumb {
            background: rgba(251, 191, 36, 0.5);
            border-radius: 10px;
        }

        .scrollbar-prominent::-webkit-scrollbar-thumb:hover {
            background: rgba(251, 191, 36, 0.8);
        }

        #global-map {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
        }

        .ui-unified-layer {
            position: relative;
            z-index: 10;
            height: 100%;
            display: flex;
            flex-direction: column;
            pointer-events: none; /* Let clicks pass through to map where not blocked */
        }
        
        .ui-unified-layer > * {
            pointer-events: auto; /* Re-enable clicks for UI elements */
        }

        /* --- GLASS STYLES --- */
        .glass-panel {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(52, 211, 153, 0.5);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }

        .glass-panel-clear {
            background: rgba(15, 23, 42, 0.85); /* Darker for better text readability */
            border: 1px solid rgba(52, 211, 153, 0.5);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(4px);
        }


        .cloud-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 50;
            opacity: 0;
            transition: opacity 1.5s ease-in-out;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .cloud-container.active {
            opacity: 1;
            pointer-events: auto;
        }

        .cloud-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 200%;
            height: 100%;
            background: radial-gradient(circle at 10% 20%, rgba(255, 255, 255, 0.5) 0%, transparent 20%),
                radial-gradient(circle at 30% 80%, rgba(255, 255, 255, 0.4) 0%, transparent 25%),
                radial-gradient(circle at 50% 30%, rgba(255, 255, 255, 0.5) 0%, transparent 15%),
                radial-gradient(circle at 70% 60%, rgba(255, 255, 255, 0.4) 0%, transparent 20%),
                radial-gradient(circle at 90% 10%, rgba(255, 255, 255, 0.5) 0%, transparent 25%);
            background-size: 100% 100%;
            filter: blur(40px);
            opacity: 0.6;
            animation: cloudFly 20s linear infinite;
        }

        .cloud-layer:nth-child(2) {
            top: 10%;
            width: 250%;
            background: radial-gradient(circle at 15% 50%, rgba(255, 255, 255, 0.3) 0%, transparent 25%),
                radial-gradient(circle at 45% 10%, rgba(255, 255, 255, 0.4) 0%, transparent 20%),
                radial-gradient(circle at 75% 80%, rgba(255, 255, 255, 0.3) 0%, transparent 25%);
            animation: cloudFly 25s linear infinite reverse;
            opacity: 0.4;
            filter: blur(50px);
        }

        @keyframes cloudFly {
            from { transform: translateX(-20%); }
            to { transform: translateX(-60%); }
        }

        .travel-message {
            position: relative;
            z-index: 60;
            text-align: center;
            color: #0f172a;
            text-shadow: 0 2px 10px rgba(255, 255, 255, 0.9), 0 0 20px rgba(255, 255, 255, 0.5);
            transform: scale(0.9);
            transition: transform 0.5s;
        }

        .cloud-container.active .travel-message {
            transform: scale(1);
        }
    </style>
</head>

<body>

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo, useCallback } = React;

        // --- SUPABASE CONFIG ---
        const SUPABASE_URL = 'https://ldsysxczitmkxmukmwri.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imxkc3lzeGN6aXRta3htdWttd3JpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYxNzI4NDAsImV4cCI6MjA4MTc0ODg0MH0.1rHQug1PlhgNE6lsy3RllAQC36k0BoY6KqjeeQvAVhc';

        // --- GLOBAL CONSTANTS ---
        Chart.defaults.color = '#cbd5e1';
        Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.1)';
        Chart.defaults.font.family = 'Sarabun';
        const DON_MUEANG_COORDS = [13.9133, 100.6042];

        // --- MOCK DATA FALLBACKS ---
        const MOCK_REGIONS = { "กลาง": ["กรุงเทพมหานคร"] };
        const MOCK_PROVINCE_DATA = { 
            "กรุงเทพมหานคร": { 
                lat: 13.9133, lng: 100.6042, 
                ph: 7.0, moisture: 70, soil: "ดินเหนียว (ชุดดินราชบุรี)", 
                region: "กลาง", slogan: "กรุงเทพฯ ดุจเทพสร้าง เมืองศูนย์กลางการปกครอง", 
                population: "5.5 ล้านคน", area: "1,568 ตร.กม." 
            } 
        };
        const MOCK_CROPS = [{ name: "ข้าวหอมมะลิ 105", category: "พืชไร่", price: 16500, yield: 650, cost: 5200, risk: "Low", unit: "ton", yieldUnit: "กิโลกรัม", primarySource: "RICE", market: "โรงสีข้าวท้องถิ่น", marketLocation: "ทั่วประเทศ", density: "ใชเมล็ดพันธุ์ 15-20 กก.", costStructure: { fertilizer: 25, labor: 35, seeds: 15, water: 15, misc: 10 }, farmingSteps: [], lifecycle: { type: 'annual', lifespan: 1, advice: 'ℹ️ ข้อมูลจำลอง' }, lifecycleData: [] }];

        // --- HOOK: USE REALTIME DATA ---
        const useRealtimeData = () => {
            const [data, setData] = useState({
                regions: MOCK_REGIONS,
                provinceData: MOCK_PROVINCE_DATA,
                crops: MOCK_CROPS,
                floodAlerts: [],
                knowledge: [],
                stats: [],
                thaiPop: [], // <-- เพิ่ม State สำหรับตาราง thai_provinces_population
                isLoading: true,
                isOnline: false,
                error: null
            });

            const client = useMemo(() => {
                if (window.supabase && typeof window.supabase.createClient === 'function') {
                    return window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                }
                return null;
            }, []);

            useEffect(() => {
                if (!client) {
                    setData(prev => ({ ...prev, isLoading: false, error: "Supabase library not loaded" }));
                    return;
                }

                // 1. Initial Fetch
                const fetchData = async () => {
                    try {
                        const [provRes, cropRes, floodRes, knowRes, lifeRes, statsRes, popRes] = await Promise.all([
                            client.from('provinces').select('*'),
                            client.from('crops').select('*'),
                            client.from('flood_alerts').select('*'),
                            client.from('crop_knowledge').select('*'),
                            client.from('crop_lifecycle').select('*'),
                            client.from('farmer_stats').select('*'),
                            client.from('thai_provinces_population').select('*') // <-- ดึงข้อมูลจากตารางใหม่
                        ]);

                        if (provRes.error || cropRes.error) throw new Error("Database fetch error");

                        // Process Provinces & Soil Data
                        const newRegions = {};
                        const newProvinceData = {};
                        if (provRes.data) {
                            provRes.data.forEach(p => {
                                if (!newRegions[p.region]) newRegions[p.region] = [];
                                newRegions[p.region].push(p.name);
                                newProvinceData[p.name] = { 
                                    lat: p.lat, 
                                    lng: p.lng, 
                                    ph: p.ph,             // Ensure pH is mapped
                                    moisture: p.moisture, // Ensure Moisture is mapped
                                    soil: p.soil_type,    // Ensure Soil Type is mapped
                                    region: p.region, 
                                    slogan: p.slogan || '', 
                                    population: p.population || '', 
                                    area: p.area || '' 
                                };
                            });
                        }

                        // Process Crops with Lifecycle
                        const newCrops = (cropRes.data || []).map(c => {
                            const cycles = (lifeRes.data || []).filter(l => l.crop_id === c.id);
                            let avgCost = c.cost || 0;
                            let peakYield = c.yield || 0;
                            if (cycles.length > 0) {
                                const totalCost = cycles.reduce((s, x) => s + (x.cost_seed + x.cost_fertilizer + x.cost_water + x.cost_labor), 0);
                                avgCost = totalCost / cycles.length;
                                peakYield = Math.max(...cycles.map(x => x.yield_per_rai));
                            }
                            return {
                                ...c,
                                price: c.price_per_unit || c.price || 0,
                                yield: peakYield || c.yield,
                                cost: avgCost || c.cost,
                                lifecycle: c.lifecycle,
                                lifecycleData: cycles,
                                profitTotal: 0, costTotal: 0
                            };
                        });

                        setData({
                            regions: Object.keys(newRegions).length > 0 ? newRegions : MOCK_REGIONS,
                            provinceData: Object.keys(newProvinceData).length > 0 ? newProvinceData : MOCK_PROVINCE_DATA,
                            crops: newCrops.length > 0 ? newCrops : MOCK_CROPS,
                            floodAlerts: floodRes.data || [],
                            knowledge: knowRes.data || [],
                            stats: statsRes.data || [],
                            thaiPop: popRes.data || [], // <-- เก็บข้อมูลลง State
                            isLoading: false,
                            isOnline: true,
                            error: null
                        });

                    } catch (err) {
                        console.error("Fetch failed:", err);
                        setData(prev => ({ ...prev, isLoading: false, isOnline: false, error: err.message }));
                    }
                };

                fetchData();

                // Setup Realtime Subscription
                const channel = client.channel('public-updates')
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'flood_alerts' }, (payload) => {
                         setData(prev => {
                            let newAlerts = [...prev.floodAlerts];
                            if (payload.eventType === 'INSERT') newAlerts.push(payload.new);
                            else if (payload.eventType === 'DELETE') newAlerts = newAlerts.filter(a => a.id !== payload.old.id);
                            else if (payload.eventType === 'UPDATE') newAlerts = newAlerts.map(a => a.id === payload.new.id ? payload.new : a);
                            return { ...prev, floodAlerts: newAlerts };
                        });
                    })
                    .subscribe();

                return () => { client.removeChannel(channel); };
            }, [client]);

            return data;
        };

        // --- COMPONENTS ---

        const SimulationPanel = ({ item, onClose, initialArea, floodData, soilInfo }) => {
            const [localArea, setLocalArea] = useState(initialArea);
            const [yearCount, setYearCount] = useState(item.lifespan_years || 10);
            const [panelTab, setPanelTab] = useState('financial');
            const [customCosts, setCustomCosts] = useState(null);

            const lifeInfo = item.lifecycle || { type: 'annual', lifespan: 1, advice: '-' };
            const isTree = lifeInfo.type === 'tree';
            const lifecycleData = item.lifecycleData || [];

            const lineCanvasRef = useRef(null);
            const lineChartRef = useRef(null);

            // Cost Logic
            useEffect(() => {
                if (lifecycleData.length > 0) {
                    const y1 = lifecycleData[0];
                    setCustomCosts({
                        fertilizer: (y1.cost_fertilizer || 0) * localArea,
                        labor: (y1.cost_labor || 0) * localArea,
                        seeds: (y1.cost_seed || 0) * localArea,
                        water: (y1.cost_water || 0) * localArea,
                        misc: (y1.cost_other || 0) * localArea
                    });
                } else {
                    const costStructure = item.costStructure || { fertilizer: 30, labor: 30, seeds: 20, water: 10, misc: 10 };
                    const defaultTotalCost = (item.cost * localArea);
                    setCustomCosts({
                        fertilizer: defaultTotalCost * (costStructure.fertilizer / 100),
                        labor: defaultTotalCost * (costStructure.labor / 100),
                        seeds: defaultTotalCost * (costStructure.seeds / 100),
                        water: defaultTotalCost * (costStructure.water / 100),
                        misc: defaultTotalCost * (costStructure.misc / 100)
                    });
                }
            }, [item, localArea, lifecycleData]);

            // Simulation Logic
            const simulationData = useMemo(() => {
                const data = [];
                let cumulative = 0;
                const currentYearBE = new Date().getFullYear() + 543;

                for (let i = 0; i < yearCount; i++) {
                    const age = i + 1;
                    let yearlyCost = 0;
                    let yearlyRev = 0;

                    const isTonPrice = item.unit === 'ton' || item.yieldUnit === 'ตัน' || item.name.includes('ข้าว');

                    if (lifecycleData.length > 0) {
                        const yearData = lifecycleData.find(d => d.age_year === age) || lifecycleData[lifecycleData.length - 1];
                        yearlyCost = (yearData.cost_seed + yearData.cost_fertilizer + yearData.cost_water + yearData.cost_labor + yearData.cost_other) * localArea;
                        let safeYield = yearData.yield_per_rai || 0;
                        if (isTonPrice && safeYield > 100) safeYield = safeYield / 1000;
                        yearlyRev = item.price * safeYield * localArea;
                    } else if (customCosts) {
                        yearlyCost = Object.values(customCosts).reduce((a, b) => a + b, 0);
                        let safeYield = item.yield || 0;
                        if (isTonPrice && safeYield > 100) safeYield = safeYield / 1000;
                        let baseRev = item.price * safeYield * localArea;
                        yearlyRev = baseRev;
                        if (isTree) {
                            if (age <= (lifeInfo.wait_years || 0)) { yearlyRev = 0; yearlyCost *= 0.5; }
                            else if (age < (lifeInfo.peak_start || 5)) yearlyRev *= 0.6;
                        }
                    }

                    if (floodData.risk === 'High' && i % 4 === 0) {
                        yearlyCost *= 1.5;
                        yearlyRev *= 0.2;
                    }

                    const yearlyProfit = yearlyRev - yearlyCost;
                    cumulative += yearlyProfit;
                    data.push({ year: currentYearBE + i, cost: yearlyCost, revenue: yearlyRev, profit: yearlyProfit, accumulatedProfit: cumulative });
                }
                return data;
            }, [item, localArea, yearCount, lifecycleData, floodData, customCosts, isTree, lifeInfo]);

            const totalProfitFinal = simulationData.length > 0 ? simulationData[simulationData.length - 1].accumulatedProfit : 0;

            // Charting
            useEffect(() => {
                if (!customCosts) return;
                if (panelTab === 'financial' && lineCanvasRef.current) {
                    if (lineChartRef.current) lineChartRef.current.destroy();
                    const ctx = lineCanvasRef.current.getContext('2d');
                    lineChartRef.current = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: simulationData.map(d => d.year),
                            datasets: [
                                { label: 'กำไรสะสม', data: simulationData.map(d => d.accumulatedProfit), borderColor: '#34d399', backgroundColor: 'rgba(52, 211, 153, 0.1)', fill: true, tension: 0.4 },
                                { label: 'รายรับ', data: simulationData.map(d => d.revenue), borderColor: '#60a5fa', borderDash: [5, 5], fill: false, tension: 0.1 },
                            ]
                        },
                        options: { responsive: true, maintainAspectRatio: false, scales: { x: { ticks: { color: '#94a3b8' }, grid: { display: false } }, y: { ticks: { color: '#94a3b8' }, grid: { color: 'rgba(255,255,255,0.05)' } } }, plugins: { legend: { labels: { color: '#cbd5e1' } } } }
                    });
                }
                return () => { if (lineChartRef.current) lineChartRef.current.destroy(); };
            }, [simulationData, panelTab, customCosts]);

            if (!customCosts) return <div className="p-10 text-center text-slate-400">Loading...</div>;

            return (
                <div className="flex flex-col h-full w-full animate-slide-down glass-panel-clear rounded-b-3xl overflow-hidden shadow-2xl border-t-0">
                    <div className="flex-1 overflow-y-auto p-4 space-y-4 pb-20 pt-6">
                        <div className="flex items-center justify-between mb-2">
                             <h2 className="text-xl font-bold text-white">{item.name} <span className="text-sm font-normal text-slate-400">({yearCount} ปี)</span></h2>
                             <button onClick={onClose} className="text-slate-400 hover:text-white"><i className="fa-solid fa-times text-xl"></i></button>
                        </div>
                        <div className="grid grid-cols-2 gap-4">
                            <div className="bg-emerald-900/40 p-4 rounded-xl border border-emerald-500/30 text-center backdrop-blur-sm">
                                <div className="text-xs text-emerald-300 mb-1">กำไรสะสมรวม</div>
                                <div className="text-2xl font-bold text-white">{totalProfitFinal.toLocaleString(undefined, { maximumFractionDigits: 0 })} ฿</div>
                            </div>
                            <div className="bg-black/20 p-4 rounded-xl border border-white/10 text-center backdrop-blur-sm">
                                <div className="text-xs text-slate-400 mb-1">ความเสี่ยง (น้ำท่วม)</div>
                                <div className={`text-xl font-bold ${floodData.risk === 'High' ? 'text-red-400' : 'text-green-400'}`}>{floodData.risk === 'High' ? 'สูง' : 'ต่ำ'}</div>
                            </div>
                        </div>

                        {panelTab === 'financial' ? (
                            <div className="bg-black/20 p-3 rounded-xl border border-white/5 h-[200px] flex flex-col backdrop-blur-sm">
                                <div className="flex-1 relative"><canvas ref={lineCanvasRef}></canvas></div>
                            </div>
                        ) : (
                            <div className="bg-black/20 rounded-xl overflow-hidden border border-white/10 backdrop-blur-sm">
                                <table className="w-full text-xs text-left text-slate-200">
                                    <thead className="bg-white/5 text-slate-300">
                                        <tr><th className="p-3">ปี พ.ศ.</th><th className="p-3 text-right">รายรับ</th><th className="p-3 text-right">กำไร</th></tr>
                                    </thead>
                                    <tbody>
                                        {simulationData.map((d, idx) => (
                                            <tr key={idx} className="border-b border-white/5">
                                                <td className="p-3 text-yellow-400">{d.year}</td>
                                                <td className="p-3 text-right text-emerald-300">{d.revenue.toLocaleString()}</td>
                                                <td className={`p-3 text-right font-bold ${d.profit > 0 ? 'text-white' : 'text-red-400'}`}>{d.profit.toLocaleString()}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        )}
                        <div className="flex justify-center gap-2 mt-2">
                            <button onClick={() => setPanelTab(panelTab === 'overview' ? 'financial' : 'overview')} className="text-xs text-emerald-400 underline">
                                {panelTab === 'overview' ? 'ดูกราฟการเงิน' : 'ดูตารางสรุป'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const CloudOverlay = ({ isActive, message }) => {
            return (
                <div className={`cloud-container ${isActive ? 'active' : ''}`}>
                    <div className="cloud-layer"></div>
                    {message && (
                        <div className="travel-message flex flex-col items-center">
                            <div className="text-6xl text-emerald-400 mb-6 drop-shadow-[0_0_15px_rgba(52,211,153,0.8)] animate-bounce">
                                <i className="fa-solid fa-plane-up"></i>
                            </div>
                            <h2 className="text-2xl md:text-3xl font-bold glass-panel-clear px-10 py-6 rounded-full text-white tracking-wide shadow-[0_0_50px_rgba(16,185,129,0.4)]">
                                {message}
                            </h2>
                        </div>
                    )}
                </div>
            );
        };

        const KasetCloudApp = ({ mapInstance, onTravelStart, onTravelEnd, onGoHome, isTraveling }) => {
            const [selectedRegion, setSelectedRegion] = useState(null);
            const [selectedProvince, setSelectedProvince] = useState(null);
            const [area, setArea] = useState(1);
            const [results, setResults] = useState(null);
            const [simulatingItem, setSimulatingItem] = useState(null);
            const [isFullscreen, setIsFullscreen] = useState(false);
            const [isPinning, setIsPinning] = useState(false);
            const [mapType, setMapType] = useState('satellite');

            // USE CUSTOM HOOK for Data
            const appData = useRealtimeData();

            const markerRef = useRef(null);
            const lastProvinceRef = useRef(null);
            const provinceFeaturesRef = useRef(null);
            const tileLayerRef = useRef(null);
            const labelLayerRef = useRef(null); // Added for Hybrid labels

            const [soilInfo, setSoilInfo] = useState(null);
            const [floodData, setFloodData] = useState({ risk: 'Low', desc: 'ปกติ' });

            // -- Logic to Process Farmer Stats & Population --
            const provinceStats = useMemo(() => {
                if (!selectedProvince) return null; // Simple check

                // 1. ลองค้นหาจากตาราง thai_provinces_population ก่อน (Priority 1)
                const exactPop = appData.thaiPop?.find(p => p.province_name === selectedProvince);
                
                // 2. Logic เดิมสำหรับข้อมูลอื่นๆ หรือ Fallback
                const statsList = appData.stats ? appData.stats.filter(s => s.province === selectedProvince) : [];
                // หาปีล่าสุด (ถ้ามีข้อมูล statsList)
                const maxYear = statsList.length > 0 ? Math.max(...statsList.map(s => s.year)) : 0;
                const currentStats = statsList.filter(s => s.year === maxYear);

                const getValue = (keyword) => {
                    const item = currentStats.find(s => s.topic && s.topic.includes(keyword));
                    return item ? { val: Number(item.value).toLocaleString(), unit: item.unit } : null;
                };

                return {
                    year: maxYear < 2000 && maxYear > 0 ? maxYear + 543 : maxYear,
                    
                    // ใช้ข้อมูลจาก thai_provinces_population เป็นหลัก
                    totalPop: exactPop 
                        ? { val: Number(exactPop.population).toLocaleString(), unit: 'คน' } 
                        : (getValue('ประชากรทั้งหมด') || getValue('รวม') || { val: appData.provinceData[selectedProvince]?.population || '-', unit: 'คน' }),
                        
                    male: getValue('ชาย'),
                    female: getValue('หญิง'),
                    farmers: getValue('เกษตรกร') || getValue('เกษตร') || getValue('ขึ้นทะเบียน'),
                    // Age groups if available in topic
                    elder: getValue('สูงอายุ'), 
                    working: getValue('วัยทำงาน'),
                    kids: getValue('วัยเด็ก')
                };
            }, [selectedProvince, appData.stats, appData.provinceData, appData.thaiPop]);

            // -- Map Type Logic with Hybrid Support --
            useEffect(() => {
                if (!mapInstance) return;
                
                // Remove existing
                if (tileLayerRef.current) mapInstance.removeLayer(tileLayerRef.current);
                if (labelLayerRef.current) mapInstance.removeLayer(labelLayerRef.current);

                if (mapType === 'satellite' || mapType === 'hybrid') {
                    // Base Satellite
                    tileLayerRef.current = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}').addTo(mapInstance);
                    
                    // Add labels on top if hybrid
                    if (mapType === 'hybrid') {
                        // FIX: Change to CartoDB Light Only Labels for thinner lines, and add blue filter
                        labelLayerRef.current = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}{r}.png', {
                            className: 'blue-hybrid-labels' // Apply blue tint CSS
                        }).addTo(mapInstance);
                    }
                } else {
                    // Standard
                    tileLayerRef.current = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mapInstance);
                }

                // Cleanup on unmount (e.g. going back to home)
                return () => {
                    if (tileLayerRef.current) mapInstance.removeLayer(tileLayerRef.current);
                    if (labelLayerRef.current) mapInstance.removeLayer(labelLayerRef.current);
                };
            }, [mapType, mapInstance]);

            // -- Marker & Features Logic --
            useEffect(() => {
                if (!mapInstance) return;

                let topPane = mapInstance.getPane('top-pane');
                if (!topPane) {
                    topPane = mapInstance.createPane('top-pane');
                    topPane.style.zIndex = 3000;
                    topPane.style.pointerEvents = 'none';
                }

                if (!provinceFeaturesRef.current) provinceFeaturesRef.current = L.layerGroup().addTo(mapInstance);

                if (!selectedProvince || !appData.provinceData[selectedProvince]) {
                    if (markerRef.current) { markerRef.current.remove(); markerRef.current = null; lastProvinceRef.current = null; }
                    if (provinceFeaturesRef.current) provinceFeaturesRef.current.clearLayers();
                    return;
                }

                const info = appData.provinceData[selectedProvince];

                if (lastProvinceRef.current !== selectedProvince) {
                    if (provinceFeaturesRef.current) provinceFeaturesRef.current.clearLayers();
                    // Add Mock Landmarks
                    const places = [
                        { name: "ศาลากลาง", icon: "fa-landmark", color: "#60a5fa", lat: info.lat + 0.01, lng: info.lng - 0.01 },
                        { name: "ตลาดกลาง", icon: "fa-store", color: "#34d399", lat: info.lat + 0.015, lng: info.lng + 0.01 }
                    ];
                    places.forEach(p => {
                        const icon = L.divIcon({ className: 'custom-place-icon', html: `<div class="landmark-icon" style="background-color: ${p.color}; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.5);"><i class="fa-solid ${p.icon} text-white text-xs"></i></div>`, iconSize: [30, 30] });
                        L.marker([p.lat, p.lng], { icon }).bindPopup(p.name).addTo(provinceFeaturesRef.current);
                    });
                }

                if (!markerRef.current) {
                    const customIcon = L.divIcon({ className: 'custom-pin', html: `<div class="pin-inner transition-all duration-300" style="background-color: #ef4444; width: 24px; height: 24px; border-radius: 50%; border: 3px solid white; box-shadow: 0 4px 6px rgba(0,0,0,0.3);"></div>`, iconSize: [24, 24], iconAnchor: [12, 12] });
                    markerRef.current = L.marker([info.lat, info.lng], { icon: customIcon, draggable: true, pane: 'top-pane' }).addTo(mapInstance);
                    markerRef.current.dragging.disable();
                    lastProvinceRef.current = selectedProvince;
                } else {
                    if (lastProvinceRef.current !== selectedProvince) {
                        markerRef.current.setLatLng([info.lat, info.lng]);
                        lastProvinceRef.current = selectedProvince;
                    }
                    markerRef.current.setOpacity(1);
                }
            }, [selectedProvince, mapInstance, appData.provinceData]);

            // Pin Visuals
            useEffect(() => {
                if (markerRef.current) {
                    const el = markerRef.current.getElement();
                    if (!el) return;
                    const inner = el.querySelector('.pin-inner');
                    if (isPinning) {
                        markerRef.current.dragging.enable();
                        if (inner) inner.classList.add('scale-125', 'ring-4', 'ring-emerald-400/50');
                    } else {
                        markerRef.current.dragging.disable();
                        if (inner) inner.classList.remove('scale-125', 'ring-4', 'ring-emerald-400/50');
                    }
                }
            }, [isPinning, selectedProvince]);

            const handleFullscreen = () => {
                if (!document.fullscreenElement) document.documentElement.requestFullscreen().then(() => setIsFullscreen(true));
                else if (document.exitFullscreen) document.exitFullscreen().then(() => setIsFullscreen(false));
            };

            const togglePin = () => setIsPinning(!isPinning);
            // Toggle logic adjusted to include hybrid
            const toggleMapType = () => setMapType(prev => prev === 'satellite' ? 'standard' : prev === 'standard' ? 'hybrid' : 'satellite');

            const handleRegionSelect = (r) => {
                setSelectedRegion(r); setSelectedProvince(null); setResults(null); setIsPinning(false); lastProvinceRef.current = null;
            };

            const calculateEconomics = (newArea) => {
                if (!appData.crops) return [];
                return appData.crops.map(c => {
                    let rawYield = c.yield;
                    const isPricePerTon = c.unit === 'ton' || c.yieldUnit === 'ตัน' || c.name.includes('ข้าว');
                    let revenue = 0;
                    if (isPricePerTon) {
                        let yieldInTon = rawYield;
                        if (rawYield > 100) yieldInTon = rawYield / 1000;
                        revenue = yieldInTon * c.price * newArea;
                    } else {
                        revenue = rawYield * c.price * newArea;
                    }
                    const costVal = Number(c.cost) || 0;
                    const profit = revenue - (costVal * newArea);
                    return { ...c, cost: costVal, profitTotal: profit };
                }).sort((a, b) => b.profitTotal - a.profitTotal);
            };

            const handleProvinceSelect = (p) => {
                setIsPinning(false);
                setSelectedProvince(p);
                // Switch to hybrid map when province selected
                setMapType('hybrid'); 
                
                const info = appData.provinceData[p];
                if (info) setSoilInfo(info);

                // Calculate Flood Risk from Realtime Data
                const alert = appData.floodAlerts.find(a => a.province === p);
                setFloodData(alert ? { risk: alert.risk_level, desc: alert.description } : { risk: 'Low', desc: 'ปกติ' });

                if (mapInstance && info && mapInstance._container) {
                    onTravelStart(`กำลังเดินทางไป ${p}...`);
                    mapInstance.flyTo([info.lat - 0.1, info.lng], 10, { duration: 3 });
                    setTimeout(() => onTravelEnd(), 3000);
                }
                setResults(calculateEconomics(area));
            };

            const handleBack = () => {
                if (isPinning) { setIsPinning(false); return; }
                if (simulatingItem) { setSimulatingItem(null); return; }
                if (selectedProvince) {
                    setSelectedProvince(null); setResults(null); lastProvinceRef.current = null;
                    setMapType('satellite'); // Reset to satellite when going back from province
                    if (mapInstance && mapInstance._container) mapInstance.flyTo(DON_MUEANG_COORDS, 6, { duration: 2 });
                    return;
                }
                if (selectedRegion) { setSelectedRegion(null); return; }
            };

            const handleAreaChange = (val) => {
                const newArea = parseFloat(val) || 0;
                setArea(newArea);
                if (selectedProvince) setResults(calculateEconomics(newArea));
            };

            // Get Current Soil/Province Info
            const currentProvInfo = appData.provinceData[selectedProvince];

            return (
                <div className="ui-unified-layer">
                    {/* Header Bar */}
                    <div className="w-full max-w-7xl mx-auto flex items-center justify-between pointer-auto px-2 md:px-4 z-[2100] mt-2">
                        <div className="flex items-center gap-2 md:gap-3 shrink-0">
                            <button onClick={onGoHome} className="w-10 h-10 md:w-12 md:h-12 rounded-full glass-panel hover:bg-white/10 text-white flex items-center justify-center transition shadow-lg group" title="หน้าแรก">
                                <i className="fa-solid fa-house text-sm md:text-base group-hover:text-emerald-400"></i>
                            </button>
                            {(selectedRegion || selectedProvince) && (
                                <button onClick={handleBack} className="w-10 h-10 md:w-12 md:h-12 rounded-full glass-panel hover:bg-white/10 text-white flex items-center justify-center transition shadow-lg animate-fade-in-up" title="ย้อนกลับ">
                                    <i className="fa-solid fa-arrow-left text-sm md:text-base"></i>
                                </button>
                            )}
                        </div>

                        <div className="flex-1 flex justify-center px-2 min-w-0">
                            {simulatingItem ? (
                                <div className="glass-panel rounded-full px-4 py-1.5 flex items-center gap-2 shadow-[0_0_20px_rgba(16,185,129,0.3)] animate-fade-in-up max-w-full overflow-hidden">
                                    <i className="fa-solid fa-chart-line text-emerald-400 animate-pulse"></i>
                                    <span className="text-sm md:text-base font-bold text-white truncate">{simulatingItem.name}</span>
                                </div>
                            ) : selectedProvince ? (
                                <div className="glass-panel rounded-full px-1 py-1 flex items-center gap-1 md:gap-2 shadow-[0_0_20px_rgba(0,0,0,0.3)] animate-fade-in-up max-w-full overflow-hidden">
                                    <div className="flex items-center gap-1 pl-3 pr-2 border-r border-white/20 shrink-0">
                                        <i className="fa-solid fa-seedling text-emerald-400"></i>
                                        <span className="text-xs font-bold text-emerald-100 hidden sm:inline">พืชแนะนำ</span>
                                    </div>
                                    <div className="relative group pl-1 min-w-0 flex-1">
                                        <i className="fa-solid fa-location-dot text-emerald-400 text-xs md:text-sm absolute left-1 top-1/2 -translate-y-1/2"></i>
                                        <select value={selectedProvince} onChange={(e) => handleProvinceSelect(e.target.value)} className="bg-transparent text-white text-xs md:text-sm font-bold py-2 pl-6 pr-2 focus:outline-none cursor-pointer appearance-none w-full truncate">
                                            {(appData.regions[selectedRegion] || [selectedProvince]).map(p => <option key={p} value={p} className="bg-slate-800 text-white">{p}</option>)}
                                        </select>
                                    </div>
                                    <div className="w-[1px] h-4 bg-white/20"></div>
                                    <div className="flex items-center gap-1 pr-2 shrink-0">
                                        <input type="number" step="0.1" min="0" value={area} onChange={(e) => handleAreaChange(e.target.value)} className="w-10 md:w-16 bg-transparent text-center text-xs md:text-sm font-bold text-yellow-300 focus:outline-none py-1 transition placeholder-white/30" />
                                        <span className="text-[10px] md:text-xs text-slate-300 font-bold">ไร่</span>
                                    </div>
                                </div>
                            ) : (
                                <div className="glass-panel rounded-full px-4 py-1.5 text-sm font-bold text-white/90">{selectedRegion ? `ภาค${selectedRegion}` : 'เลือกภูมิภาค'}</div>
                            )}
                        </div>

                        <div className="flex items-center gap-2 md:gap-3 shrink-0">
                            {selectedProvince && !simulatingItem && (
                                <button onClick={togglePin} className={`w-10 h-10 md:w-12 md:h-12 rounded-full glass-panel flex items-center justify-center transition shadow-lg animate-fade-in-up ${isPinning ? 'bg-emerald-500 hover:bg-emerald-400 border-emerald-400 text-white' : 'hover:bg-white/10 text-white'}`} title={isPinning ? "ยืนยันตำแหน่ง" : "ขยับหมุด"}>
                                    <i className={`fa-solid ${isPinning ? 'fa-check text-lg font-bold' : 'fa-map-location-dot text-sm md:text-base'}`}></i>
                                </button>
                            )}
                            <button onClick={toggleMapType} className="w-10 h-10 md:w-12 md:h-12 rounded-full glass-panel hover:bg-white/10 text-white flex items-center justify-center transition shadow-lg" title="เปลี่ยนแผนที่">
                                <i className={`fa-solid ${mapType === 'satellite' ? 'fa-layer-group' : mapType === 'hybrid' ? 'fa-map' : 'fa-earth-americas'} text-sm md:text-base`}></i>
                            </button>
                            <button onClick={handleFullscreen} className="w-10 h-10 md:w-12 md:h-12 rounded-full glass-panel hover:bg-white/10 text-white flex items-center justify-center transition shadow-lg" title="เต็มจอ">
                                <i className={`fa-solid ${isFullscreen ? 'fa-compress' : 'fa-expand'} text-sm md:text-base`}></i>
                            </button>
                        </div>
                    </div>

                    {/* --- PROVINCE INFO & STATS (Horizontal Bottom - Always Visible when Province Selected) --- */}
                    {selectedProvince && !isTraveling && (
                        <div className="absolute bottom-6 left-0 w-full z-[3000] flex flex-col md:flex-row items-end justify-between px-6 pb-2 pointer-events-none animate-fade-in-up">
                            {/* Custom style for strong shadow */}
                            <style>{`.text-shadow-heavy { text-shadow: 0 2px 4px rgba(0,0,0,0.9); }`}</style>

                            {/* Left: Province Name & Slogan */}
                            <div className="mb-4 md:mb-0 text-shadow-heavy">
                                <h3 className="font-bold text-white text-4xl md:text-5xl leading-none tracking-wide">
                                    {selectedProvince}
                                </h3>
                                {currentProvInfo?.slogan && (
                                    <p className="text-xs text-emerald-300 italic pl-1 font-medium max-w-md truncate">
                                        "{currentProvInfo.slogan}"
                                    </p>
                                )}
                            </div>

                            {/* Right: Horizontal Stats */}
                            <div className="flex flex-wrap items-end gap-6 md:gap-8 text-shadow-heavy">
                                
                                {/* Population */}
                                <div className="flex flex-col items-center">
                                    <div className="flex items-baseline gap-1">
                                        <i className="fa-solid fa-users text-blue-400 text-lg"></i>
                                        <span className="text-2xl font-bold text-white">{provinceStats?.totalPop?.val || '-'}</span>
                                        <span className="text-xs text-slate-300">{provinceStats?.totalPop?.unit}</span>
                                    </div>
                                    <div className="text-[10px] text-blue-200 font-bold uppercase tracking-wider">ประชากร</div>
                                </div>

                                {/* Farmers */}
                                <div className="flex flex-col items-center">
                                    <div className="flex items-baseline gap-1">
                                        <i className="fa-solid fa-address-card text-emerald-400 text-lg"></i>
                                        <span className="text-2xl font-bold text-white">{provinceStats?.farmers?.val || '-'}</span>
                                        <span className="text-xs text-emerald-200/70">{provinceStats?.farmers?.unit}</span>
                                    </div>
                                    <div className="text-[10px] text-emerald-200 font-bold uppercase tracking-wider">เกษตรกร</div>
                                </div>

                                {/* Divider */}
                                <div className="w-px h-8 bg-white/20 hidden md:block"></div>

                                {/* pH */}
                                <div className="flex flex-col items-center">
                                    <div className="flex items-baseline gap-1">
                                        <i className="fa-solid fa-flask text-purple-400 text-lg"></i>
                                        <span className="text-2xl font-bold text-white">{currentProvInfo?.ph || '-'}</span>
                                    </div>
                                    <div className="text-[10px] text-purple-200 font-bold uppercase tracking-wider">pH ดิน</div>
                                </div>

                                {/* Moisture */}
                                <div className="flex flex-col items-center">
                                    <div className="flex items-baseline gap-1">
                                        <i className="fa-solid fa-droplet text-blue-400 text-lg"></i>
                                        <span className="text-2xl font-bold text-white">{currentProvInfo?.moisture || '-'}</span>
                                        <span className="text-xs text-blue-200">%</span>
                                    </div>
                                    <div className="text-[10px] text-blue-200 font-bold uppercase tracking-wider">ความชื้น</div>
                                </div>

                            </div>
                        </div>
                    )}

                    {/* --- MAIN INTERFACE (Region Select -> Province Select -> Crops) --- */}
                    <div className={`w-full flex-1 flex flex-col items-center transition-all duration-700 ease-in-out transform ${isTraveling || isPinning ? '-translate-y-20 opacity-0' : 'translate-y-0 opacity-100'} ${isTraveling || isPinning ? 'pointer-events-none' : 'pointer-events-auto'}`}>
                        {!selectedRegion && (
                            <div className={`w-full max-w-5xl mx-auto glass-panel-clear rounded-b-3xl p-6 animate-slide-down shadow-[0_10px_40px_rgba(0,0,0,0.5)] border-t-0 mt-4`}>
                                <h2 className="text-xl font-bold text-white mb-4 text-center">เลือกภูมิภาคของคุณ</h2>
                                <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
                                    {Object.keys(appData.regions).map(r => (
                                        <button key={r} onClick={() => handleRegionSelect(r)} className="bg-white/5 hover:bg-emerald-500/20 border border-white/20 rounded-xl p-6 flex flex-col items-center gap-2 transition hover:scale-105 group backdrop-blur-sm">
                                            <span className="text-4xl group-hover:animate-bounce">{r === 'เหนือ' ? '⛰️' : r === 'ใต้' ? '🌊' : '🏙️'}</span>
                                            <span className="font-bold text-slate-200">{r}</span>
                                        </button>
                                    ))}
                                </div>
                            </div>
                        )}

                        {selectedRegion && !selectedProvince && (
                            <div className={`w-full max-w-5xl mx-auto glass-panel-clear rounded-b-3xl p-6 animate-slide-down h-[80vh] flex flex-col border-t-0 mt-2`}>
                                <h2 className="text-xl font-bold text-white mb-4 text-center">เลือกจังหวัดในภาค{selectedRegion}</h2>
                                <div className="flex-1 overflow-y-auto grid grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-2 scrollbar-prominent pb-10">
                                    {(appData.regions[selectedRegion] || []).sort().map(p => (
                                        <button key={p} onClick={() => handleProvinceSelect(p)} className="bg-white/5 hover:bg-emerald-500/20 border border-white/20 rounded-lg p-3 text-sm font-bold text-slate-200 transition backdrop-blur-sm">
                                            {p}
                                        </button>
                                    ))}
                                </div>
                            </div>
                        )}

                        {selectedProvince && !simulatingItem && (
                            <div className={`w-full max-w-5xl mx-auto flex flex-col h-[80vh] animate-slide-down mt-2`}>
                                <div className="flex-1 glass-panel-clear rounded-b-3xl overflow-hidden flex flex-col shadow-xl border-t-0">
                                    <div className="flex-1 overflow-y-auto scrollbar-prominent pb-44 pt-2">
                                        {results ? results.map((item, idx) => (
                                            <div key={idx} onClick={() => setSimulatingItem(item)} className="p-4 border-b border-white/10 hover:bg-white/5 cursor-pointer flex items-center justify-between group transition">
                                                <div className="flex items-center gap-4">
                                                    <div className="w-10 h-10 rounded-full bg-emerald-500/20 flex items-center justify-center text-emerald-400 font-bold border border-emerald-500/30 group-hover:scale-110 transition backdrop-blur-sm">
                                                        {idx + 1}
                                                    </div>
                                                    <div>
                                                        <div className="font-bold text-white group-hover:text-yellow-400 transition">{item.name}</div>
                                                        <div className="text-xs text-slate-300">ลงทุน: {(item.cost || 0).toLocaleString()} ฿/ไร่</div>
                                                    </div>
                                                </div>
                                                <div className="text-right">
                                                    <div className="text-xs text-slate-400">กำไรสุทธิ</div>
                                                    <div className={`font-bold ${item.profitTotal > 0 ? 'text-emerald-400' : 'text-red-400'}`}>
                                                        {(item.profitTotal || 0).toLocaleString()} ฿
                                                    </div>
                                                </div>
                                            </div>
                                        )) : <div className="p-10 text-center text-slate-500">Loading...</div>}
                                    </div>
                                    <div className="w-full h-4 flex items-center justify-center cursor-pointer bg-white/5">
                                        <div className="w-12 h-1 bg-white/20 rounded-full"></div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {simulatingItem && (
                            <div className={`w-full max-w-5xl mx-auto h-[80vh] animate-slide-down z-[2050] mt-2`}>
                                <SimulationPanel item={simulatingItem} onClose={() => setSimulatingItem(null)} initialArea={area} floodData={floodData} soilInfo={currentProvInfo} />
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const HomePage = ({ onStart, isTraveling }) => {
            return (
                <div className="relative z-10 flex flex-col items-center justify-center min-h-screen text-center p-6 animate-fade-in-up">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/a/a9/Flag_of_Thailand.svg" alt="Thai Flag" className="w-24 mb-4 animate-flag-wave shadow-lg" />
                    <h1 className="text-5xl md:text-7xl font-bold mb-2 text-transparent bg-clip-text bg-gradient-to-r from-yellow-300 via-emerald-400 to-cyan-400 drop-shadow-xl">Winai Innovation</h1>
                    <p className="text-slate-300 text-lg mb-8 bg-black/40 px-4 py-1 rounded-full backdrop-blur-sm border border-white/10">Super App เพื่อเกษตรกรไทย</p>
                    <button onClick={onStart} disabled={isTraveling} className={`group relative font-bold py-4 px-10 rounded-2xl shadow-[0_0_30px_rgba(16,185,129,0.6)] transition-all overflow-hidden border border-emerald-400/50 backdrop-blur-md ${isTraveling ? 'bg-emerald-900/40 text-emerald-200 cursor-default scale-105' : 'bg-white/10 hover:bg-emerald-500/30 text-white hover:scale-105 hover:shadow-[0_0_50px_rgba(16,185,129,0.8)]'}`}>
                        <div className={`absolute inset-0 bg-emerald-500/20 transition-transform duration-1000 ${isTraveling ? 'translate-y-0' : 'translate-y-full group-hover:translate-y-0'}`}></div>
                        <span className="relative flex items-center gap-3 text-xl">{isTraveling ? (<><i className="fa-solid fa-plane-up animate-bounce"></i> กำลังเดินทาง เข้าสู่เกษตร คราวน์</>) : (<><i className="fa-solid fa-rocket"></i> เข้าสู่เกษตร คราวน์</>)}</span>
                    </button>
                    <div className="mt-8 text-xs text-slate-400 bg-black/30 p-4 rounded-xl backdrop-blur-sm border border-white/5"><p>พัฒนาโดย: Mr.Winai Phanarkat</p><p>Line: 0926533228 | Email: winayo@gmail.com</p></div>
                </div>
            );
        };

        const App = () => {
            const [page, setPage] = useState('home');
            const [travel, setTravel] = useState({ active: false, msg: '' });
            const mapRef = useRef(null);
            const rotationInterval = useRef(null);

            // Init Map (Run Once)
            useEffect(() => {
                if (mapRef.current) return;

                const map = L.map('global-map', { zoomControl: false, attributionControl: false }).setView([13.7563, 100.5018], 5);
                L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}').addTo(map);
                mapRef.current = map;

                return () => {
                    if (map) map.remove();
                    mapRef.current = null;
                };
            }, []);

            // Handle Rotation Logic (Depends on Page)
            useEffect(() => {
                const map = mapRef.current;
                if (!map) return;

                if (page === 'home') {
                    // Start Rotation
                    if (rotationInterval.current) clearInterval(rotationInterval.current);
                    rotationInterval.current = setInterval(() => {
                        if (map && map._container) map.panBy([1, 0], { animate: false });
                    }, 50);
                } else {
                    // Stop Rotation
                    if (rotationInterval.current) {
                        clearInterval(rotationInterval.current);
                        rotationInterval.current = null;
                    }
                }

                return () => {
                    if (rotationInterval.current) clearInterval(rotationInterval.current);
                };
            }, [page]);

            const handleStart = () => {
                if (mapRef.current) {
                    setTravel({ active: true, msg: '' }); // Clear message to only show clouds
                    mapRef.current.flyTo(DON_MUEANG_COORDS, 6, { duration: 4 });
                    setTimeout(() => {
                        setPage('kaset');
                        setTravel({ active: false, msg: '' });
                    }, 4000);
                }
            };

            const handleGoHome = () => {
                setPage('home');
                if (mapRef.current) mapRef.current.setView([13.7563, 100.5018], 5);
            };

            return (
                <div className="h-screen w-screen overflow-hidden text-slate-200">
                    <div id="global-map"></div>
                    <CloudOverlay isActive={travel.active} message={travel.msg} />

                    {page === 'home' && <HomePage onStart={handleStart} isTraveling={travel.active} />}

                    {page === 'kaset' && (
                        <KasetCloudApp
                            mapInstance={mapRef.current}
                            onTravelStart={(msg) => setTravel({ active: true, msg })}
                            onTravelEnd={() => setTravel({ active: false, msg: '' })}
                            onGoHome={handleGoHome}
                            isTraveling={travel.active}
                        />
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>
