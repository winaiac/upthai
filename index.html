<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Winai Innovation Portal - Super App ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡πÑ‡∏ó‡∏¢</title>

    <link rel="icon" type="image/svg+xml"
        href="https://upload.wikimedia.org/wikipedia/commons/a/a9/Flag_of_Thailand.svg">

    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;700&display=swap');

        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #0f172a;
            color: #f1f5f9;
            overflow: hidden;
            /* Prevent body scroll, handle in app */
        }

        /* Leaflet Cursor Fixes */
        .leaflet-container {
            cursor: grab !important;
        }

        .leaflet-container:active {
            cursor: grabbing !important;
        }

        .leaflet-interactive {
            cursor: pointer !important;
        }

        .animate-fade-in-up {
            animation: fadeInUp 0.8s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse-glow {

            0%,
            100% {
                box-shadow: 0 0 15px rgba(236, 72, 153, 0.6);
                transform: scale(1);
            }

            50% {
                box-shadow: 0 0 30px rgba(236, 72, 153, 1);
                transform: scale(1.05);
            }
        }

        /* Intense Button Pulse */
        @keyframes intense-pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(234, 179, 8, 0.7);
                transform: scale(1);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(234, 179, 8, 0);
                transform: scale(1.05);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(234, 179, 8, 0);
                transform: scale(1);
            }
        }

        .animate-intense {
            animation: intense-pulse 1.5s infinite;
        }

        /* Attention Seeking Pulse for Inputs */
        @keyframes attention-pulse {

            0%,
            100% {
                box-shadow: 0 0 0 0 rgba(250, 204, 21, 0.7);
                transform: scale(1);
                border-color: rgba(250, 204, 21, 0.8);
            }

            50% {
                box-shadow: 0 0 20px 5px rgba(250, 204, 21, 0.5);
                transform: scale(1.02);
                border-color: rgba(250, 204, 21, 1);
            }
        }

        /* Result Invitation Pulse */
        @keyframes invite-pulse {

            0%,
            100% {
                box-shadow: 0 -5px 15px rgba(16, 185, 129, 0.3);
                background-color: rgba(6, 78, 59, 0.9);
            }

            50% {
                box-shadow: 0 -5px 25px rgba(16, 185, 129, 0.6);
                background-color: rgba(6, 78, 59, 1);
            }
        }

        .animate-attention {
            animation: attention-pulse 2s infinite;
        }

        .animate-invite {
            animation: invite-pulse 2s infinite;
        }

        .btn-super-pulse {
            animation: pulse-glow 2s infinite;
        }

        /* Animation ‡∏ò‡∏á‡∏™‡∏ö‡∏±‡∏î (Waving Effect) */
        @keyframes flag-wave-left {
            0% {
                transform: perspective(400px) rotateY(-5deg) skewY(0deg) translateY(0);
            }

            25% {
                transform: perspective(400px) rotateY(-15deg) skewY(2deg) translateY(-2px);
            }

            50% {
                transform: perspective(400px) rotateY(-5deg) skewY(0deg) translateY(0);
            }

            75% {
                transform: perspective(400px) rotateY(5deg) skewY(-2deg) translateY(2px);
            }

            100% {
                transform: perspective(400px) rotateY(-5deg) skewY(0deg) translateY(0);
            }
        }

        .animate-flag-wave {
            animation: flag-wave-left 3s infinite cubic-bezier(0.45, 0.05, 0.55, 0.95);
            transform-origin: bottom right;
            /* ‡∏à‡∏∏‡∏î‡∏¢‡∏∂‡∏î‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà‡∏°‡∏∏‡∏°‡∏Ç‡∏ß‡∏≤‡∏•‡πà‡∏≤‡∏á (‡πÄ‡∏™‡∏≤‡∏≠‡∏¢‡∏π‡πà‡∏Ç‡∏ß‡∏≤ ‡∏õ‡∏•‡∏¥‡∏ß‡πÑ‡∏õ‡∏ã‡πâ‡∏≤‡∏¢) */
            filter: drop-shadow(0 10px 10px rgba(0, 0, 0, 0.5));
            /* ‡πÄ‡∏á‡∏≤‡∏™‡∏°‡∏à‡∏£‡∏¥‡∏á */
        }

        /* Prominent Scrollbar */
        .scrollbar-prominent::-webkit-scrollbar {
            width: 8px;
        }

        .scrollbar-prominent::-webkit-scrollbar-track {
            background: #1e293b;
            border-radius: 0 0 10px 0;
            border-left: 1px solid #334155;
        }

        .scrollbar-prominent::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #fbbf24, #f59e0b, #d97706);
            border-radius: 6px;
            border: 1px solid #0f172a;
        }

        .scrollbar-prominent::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, #fcd34d, #fbbf24, #f59e0b);
        }

        .bottom-sheet {
            transition: height 0.5s cubic-bezier(0.32, 0.72, 0, 1);
        }

        /* Map Container Z-Index management */
        #global-map {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
        }

        .ui-layer {
            position: relative;
            z-index: 10;
        }

        /* CLOUD ANIMATION CSS */
        .cloud-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 50;
            opacity: 0;
            transition: opacity 1.5s ease-in-out;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .cloud-container.active {
            opacity: 1;
            pointer-events: auto;
            /* Block clicks while traveling */
        }

        .cloud-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 200%;
            height: 100%;
            background:
                radial-gradient(circle at 10% 20%, rgba(255, 255, 255, 0.5) 0%, transparent 20%),
                radial-gradient(circle at 30% 80%, rgba(255, 255, 255, 0.4) 0%, transparent 25%),
                radial-gradient(circle at 50% 30%, rgba(255, 255, 255, 0.5) 0%, transparent 15%),
                radial-gradient(circle at 70% 60%, rgba(255, 255, 255, 0.4) 0%, transparent 20%),
                radial-gradient(circle at 90% 10%, rgba(255, 255, 255, 0.5) 0%, transparent 25%);

            background-size: 100% 100%;
            filter: blur(40px);
            opacity: 0.6;
            animation: cloudFly 20s linear infinite;
        }

        .cloud-layer:nth-child(2) {
            top: 10%;
            width: 250%;
            background:
                radial-gradient(circle at 15% 50%, rgba(255, 255, 255, 0.3) 0%, transparent 25%),
                radial-gradient(circle at 45% 10%, rgba(255, 255, 255, 0.4) 0%, transparent 20%),
                radial-gradient(circle at 75% 80%, rgba(255, 255, 255, 0.3) 0%, transparent 25%);
            animation: cloudFly 25s linear infinite reverse;
            opacity: 0.4;
            filter: blur(50px);
        }

        .cloud-layer:nth-child(3) {
            top: -10%;
            width: 300%;
            background:
                radial-gradient(circle at 50% 50%, rgba(255, 255, 255, 0.2) 0%, transparent 40%);
            animation: cloudFly 35s linear infinite;
            opacity: 0.3;
            filter: blur(60px);
        }

        @keyframes cloudFly {
            from {
                transform: translateX(-20%);
            }

            to {
                transform: translateX(-60%);
            }
        }

        .travel-message {
            position: relative;
            z-index: 60;
            text-align: center;
            color: #0f172a;
            text-shadow: 0 2px 10px rgba(255, 255, 255, 0.9), 0 0 20px rgba(255, 255, 255, 0.5);
            transform: scale(0.9);
            transition: transform 0.5s;
        }

        .cloud-container.active .travel-message {
            transform: scale(1);
        }
    </style>
</head>

<body class="bg-slate-900 text-slate-100">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- CHART JS DEFAULTS ---
        Chart.defaults.color = '#cbd5e1';
        Chart.defaults.borderColor = '#334155';
        Chart.defaults.font.family = 'Sarabun';

        // --- DATA (UPDATED: AIRPORT COORDINATES WHERE POSSIBLE) ---
        // Don Mueang Airport
        const DON_MUEANG_COORDS = [13.9133, 100.6042];

        const PROVINCE_COORDS = {
            // --- ‡∏†‡∏≤‡∏Ñ‡πÄ‡∏´‡∏ô‡∏∑‡∏≠ (Airports) ---
            "‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏£‡∏≤‡∏¢": [19.9502, 99.8826], // Mae Fah Luang
            "‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà": [18.7677, 98.9640], // Chiang Mai Intl
            "‡∏ô‡πà‡∏≤‡∏ô": [18.8077, 100.7834], // Nan Nakhon
            "‡∏û‡∏∞‡πÄ‡∏¢‡∏≤": [19.1662, 99.9022], // (No Airport, City)
            "‡πÅ‡∏û‡∏£‡πà": [18.1301, 100.1623], // Phrae
            "‡πÅ‡∏°‡πà‡∏Æ‡πà‡∏≠‡∏á‡∏™‡∏≠‡∏ô": [19.3005, 97.9706], // Mae Hong Son
            "‡∏•‡∏≥‡∏õ‡∏≤‡∏á": [18.2764, 99.5028], // Lampang
            "‡∏•‡∏≥‡∏û‡∏π‡∏ô": [18.5772, 99.0087],
            "‡∏≠‡∏∏‡∏ï‡∏£‡∏î‡∏¥‡∏ï‡∏ñ‡πå": [17.6201, 100.0993],
            "‡∏™‡∏∏‡πÇ‡∏Ç‡∏ó‡∏±‡∏¢": [17.2384, 99.8295], // Sukhothai
            "‡∏û‡∏¥‡∏©‡∏ì‡∏∏‡πÇ‡∏•‡∏Å": [16.7797, 100.2741], // Phitsanulok
            "‡∏û‡∏¥‡∏à‡∏¥‡∏ï‡∏£": [16.4418, 100.3488],
            "‡πÄ‡∏û‡∏ä‡∏£‡∏ö‡∏π‡∏£‡∏ì‡πå": [16.7628, 101.1894], // Phetchabun
            "‡∏Å‡∏≥‡πÅ‡∏û‡∏á‡πÄ‡∏û‡∏ä‡∏£": [16.4834, 99.5215],
            "‡∏ï‡∏≤‡∏Å": [16.8974, 99.2541], // Mae Sot
            "‡∏ô‡∏Ñ‡∏£‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡πå": [15.6667, 100.1333],
            "‡∏≠‡∏∏‡∏ó‡∏±‡∏¢‡∏ò‡∏≤‡∏ô‡∏µ": [15.3835, 100.0246],
            // --- ‡∏†‡∏≤‡∏Ñ‡∏≠‡∏µ‡∏™‡∏≤‡∏ô (Airports) ---
            "‡∏Å‡∏≤‡∏¨‡∏™‡∏¥‡∏ô‡∏ò‡∏∏‡πå": [16.4328, 103.5069],
            "‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô": [16.4643, 102.7872], // Khon Kaen
            "‡∏ä‡∏±‡∏¢‡∏†‡∏π‡∏°‡∏¥": [15.8105, 102.0288],
            "‡∏ô‡∏Ñ‡∏£‡∏û‡∏ô‡∏°": [17.3833, 104.6433], // Nakhon Phanom
            "‡∏ô‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡∏™‡∏µ‡∏°‡∏≤": [14.9392, 102.1119], // Nakhon Ratchasima
            "‡∏ö‡∏∂‡∏á‡∏Å‡∏≤‡∏¨": [18.3612, 103.6461],
            "‡∏ö‡∏∏‡∏£‡∏µ‡∏£‡∏±‡∏°‡∏¢‡πå": [15.2294, 103.2533], // Buriram
            "‡∏°‡∏´‡∏≤‡∏™‡∏≤‡∏£‡∏Ñ‡∏≤‡∏°": [16.1858, 103.3015],
            "‡∏°‡∏∏‡∏Å‡∏î‡∏≤‡∏´‡∏≤‡∏£": [16.5436, 104.7046],
            "‡∏¢‡πÇ‡∏™‡∏ò‡∏£": [15.7924, 104.1451],
            "‡∏£‡πâ‡∏≠‡∏¢‡πÄ‡∏≠‡πá‡∏î": [16.1507, 103.7745], // Roi Et
            "‡πÄ‡∏•‡∏¢": [17.4411, 101.7225], // Loei
            "‡∏™‡∏Å‡∏•‡∏ô‡∏Ñ‡∏£": [17.1897, 104.1186], // Sakon Nakhon
            "‡∏™‡∏∏‡∏£‡∏¥‡∏ô‡∏ó‡∏£‡πå": [14.8829, 103.4937],
            "‡∏®‡∏£‡∏µ‡∏™‡∏∞‡πÄ‡∏Å‡∏©": [15.1186, 104.3227],
            "‡∏´‡∏ô‡∏≠‡∏á‡∏Ñ‡∏≤‡∏¢": [17.8785, 102.7413],
            "‡∏´‡∏ô‡∏≠‡∏á‡∏ö‡∏±‡∏ß‡∏•‡∏≥‡∏†‡∏π": [17.2044, 102.4413],
            "‡∏≠‡∏∏‡∏î‡∏£‡∏ò‡∏≤‡∏ô‡∏µ": [17.3859, 102.7880], // Udon Thani
            "‡∏≠‡∏∏‡∏ö‡∏•‡∏£‡∏≤‡∏ä‡∏ò‡∏≤‡∏ô‡∏µ": [15.2514, 104.8703], // Ubon Ratchathani
            "‡∏≠‡∏≥‡∏ô‡∏≤‡∏à‡πÄ‡∏à‡∏£‡∏¥‡∏ç": [15.8587, 104.6258],
            // --- ‡∏†‡∏≤‡∏Ñ‡∏Å‡∏•‡∏≤‡∏á ---
            "‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£": [13.9133, 100.6042], // Don Mueang
            "‡∏Å‡∏≤‡∏ç‡∏à‡∏ô‡∏ö‡∏∏‡∏£‡∏µ": [14.0205, 99.5304],
            "‡∏à‡∏±‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ": [12.6114, 102.1039],
            "‡∏â‡∏∞‡πÄ‡∏ä‡∏¥‡∏á‡πÄ‡∏ó‡∏£‡∏≤": [13.6904, 101.0779],
            "‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ": [13.3611, 100.9847],
            "‡∏ä‡∏±‡∏¢‡∏ô‡∏≤‡∏ó": [15.1852, 100.1251],
            "‡∏ï‡∏£‡∏≤‡∏î": [12.2703, 102.3217], // Trat
            "‡∏ô‡∏Ñ‡∏£‡∏ô‡∏≤‡∏¢‡∏Å": [14.2069, 101.2130],
            "‡∏ô‡∏Ñ‡∏£‡∏õ‡∏ê‡∏°": [13.8188, 100.0373],
            "‡∏ô‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ": [13.8591, 100.5217],
            "‡∏õ‡∏ó‡∏∏‡∏°‡∏ò‡∏≤‡∏ô‡∏µ": [14.0208, 100.5250],
            "‡∏õ‡∏£‡∏∞‡∏à‡∏ß‡∏ö‡∏Ñ‡∏µ‡∏£‡∏µ‡∏Ç‡∏±‡∏ô‡∏ò‡πå": [11.7916, 99.8037], // Hua Hin is close
            "‡∏õ‡∏£‡∏≤‡∏à‡∏µ‡∏ô‡∏ö‡∏∏‡∏£‡∏µ": [14.0620, 101.3783],
            "‡∏û‡∏£‡∏∞‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤": [14.3532, 100.5684],
            "‡πÄ‡∏û‡∏ä‡∏£‡∏ö‡∏∏‡∏£‡∏µ": [13.1163, 99.9392],
            "‡∏£‡∏∞‡∏¢‡∏≠‡∏á": [12.6800, 101.0050], // U-Tapao
            "‡∏£‡∏≤‡∏ä‡∏ö‡∏∏‡∏£‡∏µ": [13.5282, 99.8144],
            "‡∏•‡∏û‡∏ö‡∏∏‡∏£‡∏µ": [14.7995, 100.6533],
            "‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏õ‡∏£‡∏≤‡∏Å‡∏≤‡∏£": [13.6900, 100.7501], // Suvarnabhumi
            "‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏á‡∏Ñ‡∏£‡∏≤‡∏°": [13.4098, 100.0023],
            "‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏≤‡∏Ñ‡∏£": [13.5475, 100.2736],
            "‡∏™‡∏£‡∏∞‡πÅ‡∏Å‡πâ‡∏ß": [13.8240, 102.0649],
            "‡∏™‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏µ": [14.5289, 100.9101],
            "‡∏™‡∏¥‡∏á‡∏´‡πå‡∏ö‡∏∏‡∏£‡∏µ": [14.8910, 100.3958],
            "‡∏™‡∏∏‡∏û‡∏£‡∏£‡∏ì‡∏ö‡∏∏‡∏£‡∏µ": [14.4745, 100.1177],
            "‡∏≠‡πà‡∏≤‡∏á‡∏ó‡∏≠‡∏á": [14.5896, 100.4550],
            // --- ‡∏†‡∏≤‡∏Ñ‡πÉ‡∏ï‡πâ (Airports) ---
            "‡∏Å‡∏£‡∏∞‡∏ö‡∏µ‡πà": [8.0991, 98.9850], // Krabi
            "‡∏ä‡∏∏‡∏°‡∏û‡∏£": [10.7119, 99.3636], // Chumphon
            "‡∏ï‡∏£‡∏±‡∏á": [7.5097, 99.6158], // Trang
            "‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏ò‡∏£‡∏£‡∏°‡∏£‡∏≤‡∏ä": [8.5408, 99.9442], // Nakhon Si Thammarat
            "‡∏ô‡∏£‡∏≤‡∏ò‡∏¥‡∏ß‡∏≤‡∏™": [6.5239, 101.7431], // Narathiwat
            "‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ": [6.7867, 101.1578], // Pattani
            "‡∏û‡∏±‡∏á‡∏á‡∏≤": [8.4501, 98.5255],
            "‡∏û‡∏±‡∏ó‡∏•‡∏∏‡∏á": [7.6172, 100.0708],
            "‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï": [8.1132, 98.3169], // Phuket
            "‡∏¢‡∏∞‡∏•‡∏≤": [6.5412, 101.2804],
            "‡∏£‡∏∞‡∏ô‡∏≠‡∏á": [9.7777, 98.5853], // Ranong
            "‡∏™‡∏á‡∏Ç‡∏•‡∏≤": [6.9333, 100.3933], // Hat Yai
            "‡∏™‡∏ï‡∏π‡∏•": [6.6238, 100.0674],
            "‡∏™‡∏∏‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå‡∏ò‡∏≤‡∏ô‡∏µ": [9.1328, 99.1356] // Surat Thani
        };

        const PROVINCE_DATA = {};

        // REORGANIZED 6 REGIONS
        const regions = {
            "‡πÄ‡∏´‡∏ô‡∏∑‡∏≠": ["‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏£‡∏≤‡∏¢", "‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà", "‡∏ô‡πà‡∏≤‡∏ô", "‡∏û‡∏∞‡πÄ‡∏¢‡∏≤", "‡πÅ‡∏û‡∏£‡πà", "‡πÅ‡∏°‡πà‡∏Æ‡πà‡∏≠‡∏á‡∏™‡∏≠‡∏ô", "‡∏•‡∏≥‡∏õ‡∏≤‡∏á", "‡∏•‡∏≥‡∏û‡∏π‡∏ô", "‡∏≠‡∏∏‡∏ï‡∏£‡∏î‡∏¥‡∏ï‡∏ñ‡πå", "‡∏™‡∏∏‡πÇ‡∏Ç‡∏ó‡∏±‡∏¢", "‡∏û‡∏¥‡∏©‡∏ì‡∏∏‡πÇ‡∏•‡∏Å", "‡∏û‡∏¥‡∏à‡∏¥‡∏ï‡∏£", "‡πÄ‡∏û‡∏ä‡∏£‡∏ö‡∏π‡∏£‡∏ì‡πå", "‡∏Å‡∏≥‡πÅ‡∏û‡∏á‡πÄ‡∏û‡∏ä‡∏£", "‡∏ô‡∏Ñ‡∏£‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡πå", "‡∏≠‡∏∏‡∏ó‡∏±‡∏¢‡∏ò‡∏≤‡∏ô‡∏µ"],
            "‡∏≠‡∏µ‡∏™‡∏≤‡∏ô": ["‡∏Å‡∏≤‡∏¨‡∏™‡∏¥‡∏ô‡∏ò‡∏∏‡πå", "‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô", "‡∏ä‡∏±‡∏¢‡∏†‡∏π‡∏°‡∏¥", "‡∏ô‡∏Ñ‡∏£‡∏û‡∏ô‡∏°", "‡∏ô‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡∏™‡∏µ‡∏°‡∏≤", "‡∏ö‡∏∂‡∏á‡∏Å‡∏≤‡∏¨", "‡∏ö‡∏∏‡∏£‡∏µ‡∏£‡∏±‡∏°‡∏¢‡πå", "‡∏°‡∏´‡∏≤‡∏™‡∏≤‡∏£‡∏Ñ‡∏≤‡∏°", "‡∏°‡∏∏‡∏Å‡∏î‡∏≤‡∏´‡∏≤‡∏£", "‡∏¢‡πÇ‡∏™‡∏ò‡∏£", "‡∏£‡πâ‡∏≠‡∏¢‡πÄ‡∏≠‡πá‡∏î", "‡πÄ‡∏•‡∏¢", "‡∏™‡∏Å‡∏•‡∏ô‡∏Ñ‡∏£", "‡∏™‡∏∏‡∏£‡∏¥‡∏ô‡∏ó‡∏£‡πå", "‡∏®‡∏£‡∏µ‡∏™‡∏∞‡πÄ‡∏Å‡∏©", "‡∏´‡∏ô‡∏≠‡∏á‡∏Ñ‡∏≤‡∏¢", "‡∏´‡∏ô‡∏≠‡∏á‡∏ö‡∏±‡∏ß‡∏•‡∏≥‡∏†‡∏π", "‡∏≠‡∏∏‡∏î‡∏£‡∏ò‡∏≤‡∏ô‡∏µ", "‡∏≠‡∏∏‡∏ö‡∏•‡∏£‡∏≤‡∏ä‡∏ò‡∏≤‡∏ô‡∏µ", "‡∏≠‡∏≥‡∏ô‡∏≤‡∏à‡πÄ‡∏à‡∏£‡∏¥‡∏ç"],
            "‡∏Å‡∏•‡∏≤‡∏á": ["‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£", "‡∏ä‡∏±‡∏¢‡∏ô‡∏≤‡∏ó", "‡∏ô‡∏Ñ‡∏£‡∏ô‡∏≤‡∏¢‡∏Å", "‡∏ô‡∏Ñ‡∏£‡∏õ‡∏ê‡∏°", "‡∏ô‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ", "‡∏õ‡∏ó‡∏∏‡∏°‡∏ò‡∏≤‡∏ô‡∏µ", "‡∏û‡∏£‡∏∞‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤", "‡∏•‡∏û‡∏ö‡∏∏‡∏£‡∏µ", "‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏õ‡∏£‡∏≤‡∏Å‡∏≤‡∏£", "‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏á‡∏Ñ‡∏£‡∏≤‡∏°", "‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏≤‡∏Ñ‡∏£", "‡∏™‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏µ", "‡∏™‡∏¥‡∏á‡∏´‡πå‡∏ö‡∏∏‡∏£‡∏µ", "‡∏™‡∏∏‡∏û‡∏£‡∏£‡∏ì‡∏ö‡∏∏‡∏£‡∏µ", "‡∏≠‡πà‡∏≤‡∏á‡∏ó‡∏≠‡∏á"],
            "‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å": ["‡∏à‡∏±‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ", "‡∏â‡∏∞‡πÄ‡∏ä‡∏¥‡∏á‡πÄ‡∏ó‡∏£‡∏≤", "‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ", "‡∏ï‡∏£‡∏≤‡∏î", "‡∏õ‡∏£‡∏≤‡∏à‡∏µ‡∏ô‡∏ö‡∏∏‡∏£‡∏µ", "‡∏£‡∏∞‡∏¢‡∏≠‡∏á", "‡∏™‡∏£‡∏∞‡πÅ‡∏Å‡πâ‡∏ß"],
            "‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏ï‡∏Å": ["‡∏ï‡∏≤‡∏Å", "‡∏Å‡∏≤‡∏ç‡∏à‡∏ô‡∏ö‡∏∏‡∏£‡∏µ", "‡∏õ‡∏£‡∏∞‡∏à‡∏ß‡∏ö‡∏Ñ‡∏µ‡∏£‡∏µ‡∏Ç‡∏±‡∏ô‡∏ò‡πå", "‡πÄ‡∏û‡∏ä‡∏£‡∏ö‡∏∏‡∏£‡∏µ", "‡∏£‡∏≤‡∏ä‡∏ö‡∏∏‡∏£‡∏µ"],
            "‡πÉ‡∏ï‡πâ": ["‡∏Å‡∏£‡∏∞‡∏ö‡∏µ‡πà", "‡∏ä‡∏∏‡∏°‡∏û‡∏£", "‡∏ï‡∏£‡∏±‡∏á", "‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏ò‡∏£‡∏£‡∏°‡∏£‡∏≤‡∏ä", "‡∏ô‡∏£‡∏≤‡∏ò‡∏¥‡∏ß‡∏≤‡∏™", "‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ", "‡∏û‡∏±‡∏á‡∏á‡∏≤", "‡∏û‡∏±‡∏ó‡∏•‡∏∏‡∏á", "‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï", "‡∏¢‡∏∞‡∏•‡∏≤", "‡∏£‡∏∞‡∏ô‡∏≠‡∏á", "‡∏™‡∏á‡∏Ç‡∏•‡∏≤", "‡∏™‡∏ï‡∏π‡∏•", "‡∏™‡∏∏‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå‡∏ò‡∏≤‡∏ô‡∏µ"]
        };

        Object.keys(regions).forEach(region => {
            regions[region].forEach(prov => {
                let ph = 6.5, moisture = 60, soil = "‡∏î‡∏¥‡∏ô‡∏£‡πà‡∏ß‡∏ô";
                if (region === "‡∏≠‡∏µ‡∏™‡∏≤‡∏ô") { ph = 5.5; moisture = 40; soil = "‡∏î‡∏¥‡∏ô‡∏ó‡∏£‡∏≤‡∏¢ (‡∏ä‡∏∏‡∏î‡∏î‡∏¥‡∏ô‡∏£‡πâ‡∏≠‡∏¢‡πÄ‡∏≠‡πá‡∏î)"; }
                if (region === "‡πÄ‡∏´‡∏ô‡∏∑‡∏≠") { ph = 6.0; moisture = 55; soil = "‡∏î‡∏¥‡∏ô‡∏£‡πà‡∏ß‡∏ô‡∏õ‡∏ô‡∏ó‡∏£‡∏≤‡∏¢ (‡∏ä‡∏∏‡∏î‡∏î‡∏¥‡∏ô‡πÅ‡∏°‡πà‡∏£‡∏¥‡∏°)"; }
                if (region === "‡∏Å‡∏•‡∏≤‡∏á") { ph = 7.0; moisture = 70; soil = "‡∏î‡∏¥‡∏ô‡πÄ‡∏´‡∏ô‡∏µ‡∏¢‡∏ß (‡∏ä‡∏∏‡∏î‡∏î‡∏¥‡∏ô‡∏£‡∏≤‡∏ä‡∏ö‡∏∏‡∏£‡∏µ)"; }
                if (region === "‡πÉ‡∏ï‡πâ") { ph = 5.0; moisture = 80; soil = "‡∏î‡∏¥‡∏ô‡∏£‡πà‡∏ß‡∏ô‡∏õ‡∏ô‡∏î‡∏¥‡∏ô‡πÄ‡∏´‡∏ô‡∏µ‡∏¢‡∏ß (‡∏ä‡∏∏‡∏î‡∏î‡∏¥‡∏ô‡∏Ñ‡∏≠‡∏´‡∏á‡∏™‡πå)"; }
                if (region === "‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å") { ph = 5.5; moisture = 75; soil = "‡∏î‡∏¥‡∏ô‡∏£‡πà‡∏ß‡∏ô‡∏õ‡∏ô‡∏ó‡∏£‡∏≤‡∏¢ (‡∏ú‡∏•‡πÑ‡∏°‡πâ)"; }
                if (region === "‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏ï‡∏Å") { ph = 6.5; moisture = 50; soil = "‡∏î‡∏¥‡∏ô‡∏£‡πà‡∏ß‡∏ô‡∏õ‡∏ô‡∏ó‡∏£‡∏≤‡∏¢"; }

                let lat, lng;
                if (PROVINCE_COORDS[prov]) {
                    [lat, lng] = PROVINCE_COORDS[prov];
                } else {
                    lat = 13.7563; lng = 100.5018; // Fallback
                }
                PROVINCE_DATA[prov] = { ph, moisture, soil, region, lat, lng };
            });
        });

        // Cost Breakdown Data (Estimates)
        const COST_STRUCTURE = {
            '‡∏Ç‡πâ‡∏≤‡∏ß‡∏´‡∏≠‡∏°‡∏°‡∏∞‡∏•‡∏¥': { fertilizer: 25, labor: 35, seeds: 15, water: 15, misc: 10 },
            '‡∏ó‡∏∏‡πÄ‡∏£‡∏µ‡∏¢‡∏ô': { fertilizer: 35, labor: 30, seeds: 10, water: 15, misc: 10 },
            '‡∏ú‡∏±‡∏Å‡∏™‡∏•‡∏±‡∏î‡πÑ‡∏Æ‡πÇ‡∏î‡∏£': { fertilizer: 40, labor: 20, seeds: 20, water: 10, misc: 10 },
            '‡∏°‡∏±‡∏ô‡∏™‡∏≥‡∏õ‡∏∞‡∏´‡∏•‡∏±‡∏á': { fertilizer: 20, labor: 40, seeds: 20, water: 10, misc: 10 },
            'default': { fertilizer: 30, labor: 30, seeds: 20, water: 10, misc: 10 }
        };

        const CROP_LIFECYCLE = { '‡∏ó‡∏∏‡πÄ‡∏£‡∏µ‡∏¢‡∏ô': { type: 'tree', wait_years: 5, peak_start: 10, decline_start: 20, lifespan: 25, advice: '‚ö†Ô∏è ‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏Å‡πà...' }, '‡∏¢‡∏≤‡∏á‡∏û‡∏≤‡∏£‡∏≤': { type: 'tree', wait_years: 7, peak_start: 12, decline_start: 20, lifespan: 25, advice: '‚ö†Ô∏è ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏≤‡∏¢ ‡∏ô‡πâ‡∏≥‡∏¢‡∏≤‡∏á‡∏•‡∏î‡∏•‡∏á...' }, '‡∏õ‡∏≤‡∏•‡πå‡∏°‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô': { type: 'tree', wait_years: 3, peak_start: 7, decline_start: 18, lifespan: 22, advice: '‚ö†Ô∏è ‡∏ï‡πâ‡∏ô‡∏™‡∏π‡∏á‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏¢‡∏≤‡∏Å...' }, 'default': { type: 'annual', lifespan: 1, advice: '‚ÑπÔ∏è ‡∏Ñ‡∏ß‡∏£‡∏õ‡∏•‡∏π‡∏Å‡∏û‡∏∑‡∏ä‡∏ï‡∏£‡∏∞‡∏Å‡∏π‡∏•‡∏ñ‡∏±‡πà‡∏ß‡∏™‡∏•‡∏±‡∏ö...' } };

        // --- PREFETCHING LOGIC (PROMISE BASED) ---
        const long2tile = (lon, zoom) => (Math.floor((lon + 180) / 360 * Math.pow(2, zoom)));
        const lat2tile = (lat, zoom) => (Math.floor((1 - Math.log(Math.tan(lat * Math.PI / 180) + 1 / Math.cos(lat * Math.PI / 180)) / Math.PI) / 2 * Math.pow(2, zoom)));

        const checkAndPreloadTiles = (lat, lng, zoom = 9) => {
            const promises = [];
            const x = long2tile(lng, zoom);
            const y = lat2tile(lat, zoom);

            // Load 3x3 grid
            for (let i = -1; i <= 1; i++) {
                for (let j = -1; j <= 1; j++) {
                    const tx = x + i;
                    const ty = y + j;

                    const urls = [
                        `https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/${zoom}/${ty}/${tx}`,
                        `https://mt1.google.com/vt/lyrs=h&x=${tx}&y=${ty}&z=${zoom}`
                    ];

                    urls.forEach(url => {
                        const p = new Promise((resolve) => {
                            const img = new Image();
                            img.onload = () => resolve(true);
                            img.onerror = () => resolve(false); // Resolve even on error to keep going
                            img.src = url;
                        });
                        promises.push(p);
                    });
                }
            }
            return Promise.all(promises);
        };

        const CloudOverlay = ({ isActive, message }) => {
            return (
                <div className={`cloud-container ${isActive ? 'active' : ''}`}>
                    <div className="cloud-layer"></div>
                    <div className="cloud-layer"></div>
                    <div className="cloud-layer"></div>
                    {isActive && (
                        <div className="travel-message">
                            <div className="text-4xl md:text-6xl text-emerald-600 mb-4 animate-bounce">
                                <i className="fa-solid fa-plane-up"></i>
                            </div>
                            <h2 className="text-2xl md:text-4xl font-bold bg-white/80 backdrop-blur-md px-6 py-3 rounded-full shadow-lg border-2 border-emerald-400 text-emerald-800">
                                {message}
                            </h2>
                            <p className="mt-2 text-slate-800 font-bold bg-white/50 inline-block px-3 py-1 rounded-full shadow-sm">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà...</p>
                        </div>
                    )}
                </div>
            );
        };

        const SimulationModal = ({ item, onClose, area, floodData }) => {
            const [yearCount, setYearCount] = useState(10);
            const isTree = CROP_LIFECYCLE[item.name]?.type === 'tree';
            const lifeInfo = CROP_LIFECYCLE[item.name] || CROP_LIFECYCLE['default'];
            const costStructure = COST_STRUCTURE[item.name] || COST_STRUCTURE['default'];

            const canvasRef = useRef(null);
            const chartRef = useRef(null);

            const simulationData = [];
            let totalProfit = 0;
            let totalCost = 0;

            const currentYearBE = new Date().getFullYear() + 543;
            const startYearBE = currentYearBE - yearCount;

            for (let i = 0; i < yearCount; i++) {
                const yearBE = startYearBE + i;
                const age = i + 1;

                let yearlyCost = item.costTotal;
                let yearlyRev = item.profitTotal + item.costTotal;

                if (isTree) {
                    if (age <= lifeInfo.wait_years) {
                        yearlyRev = 0;
                        yearlyCost = yearlyCost * 0.5;
                    } else if (age < lifeInfo.peak_start) {
                        yearlyRev = yearlyRev * 0.6;
                    }
                }

                let eventNote = "-";
                let statusColor = "text-slate-400";
                const floodMatch = floodData.history.find(h => h.includes(yearBE.toString()));
                if (floodMatch) {
                    eventNote = `üåä ‡∏ô‡πâ‡∏≥‡∏ó‡πà‡∏ß‡∏° (${floodMatch})`;
                    statusColor = "text-red-400 font-bold";
                    yearlyCost *= 1.5;
                    yearlyRev *= 0.2;
                }

                const yearlyProfit = yearlyRev - yearlyCost;
                totalProfit += yearlyProfit;
                totalCost += yearlyCost;

                simulationData.push({
                    year: yearBE,
                    age: age,
                    cost: yearlyCost,
                    revenue: yearlyRev,
                    profit: yearlyProfit,
                    note: eventNote,
                    statusColor: statusColor
                });
            }

            useEffect(() => {
                if (canvasRef.current) {
                    if (chartRef.current) chartRef.current.destroy();
                    const ctx = canvasRef.current.getContext('2d');
                    chartRef.current = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: ['‡∏Ñ‡πà‡∏≤‡∏õ‡∏∏‡πã‡∏¢/‡∏¢‡∏≤', '‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á‡∏á‡∏≤‡∏ô', '‡∏Ñ‡πà‡∏≤‡πÄ‡∏°‡∏•‡πá‡∏î/‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå', '‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥/‡πÑ‡∏ü', '‡πÄ‡∏ö‡πá‡∏î‡πÄ‡∏ï‡∏•‡πá‡∏î'],
                            datasets: [{
                                data: [costStructure.fertilizer, costStructure.labor, costStructure.seeds, costStructure.water, costStructure.misc],
                                backgroundColor: ['#34d399', '#facc15', '#f87171', '#60a5fa', '#94a3b8'],
                                borderWidth: 0
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: { position: 'right', labels: { color: '#cbd5e1', font: { size: 10 } } },
                                title: { display: true, text: '‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï', color: '#fff' }
                            }
                        }
                    });
                }
                return () => { if (chartRef.current) chartRef.current.destroy(); };
            }, [item]);

            return (
                <div className="fixed inset-0 z-[2000] bg-black/90 backdrop-blur-sm flex items-center justify-center p-4 animate-fade-in-up pointer-events-auto">
                    <div className="bg-slate-800 border-2 border-emerald-500 rounded-2xl w-full max-w-4xl p-6 relative shadow-[0_0_50px_rgba(16,185,129,0.3)] flex flex-col max-h-[95vh]">
                        <button onClick={onClose} className="absolute top-4 right-4 text-slate-400 hover:text-white bg-slate-700 w-8 h-8 rounded-full flex items-center justify-center transition"><i className="fa-solid fa-times"></i></button>

                        <div className="flex items-center gap-3 mb-4 border-b border-slate-700 pb-4">
                            <div className="bg-yellow-500 p-3 rounded-full text-slate-900 text-xl shadow-lg animate-pulse">
                                <i className="fa-solid fa-clock-rotate-left"></i>
                            </div>
                            <div>
                                <h3 className="text-xl font-bold text-white">‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏ú‡∏•‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏Å‡∏≤‡∏£: {item.name}</h3>
                                <p className="text-sm text-slate-400">‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà {area} ‡πÑ‡∏£‡πà ‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡∏à‡∏£‡∏¥‡∏á</p>
                            </div>
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 flex-1 overflow-hidden">
                            <div className="col-span-1 flex flex-col gap-4 overflow-y-auto pr-2">
                                <div className="bg-slate-900/50 p-4 rounded-xl border border-slate-700">
                                    <div className="flex justify-between items-center mb-2">
                                        <span className="text-slate-400 text-xs">‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡∏™‡∏∞‡∏™‡∏° ({yearCount} ‡∏õ‡∏µ)</span>
                                    </div>
                                    <p className="text-2xl font-bold text-emerald-400 animate-pulse">‡∏ø{totalProfit.toLocaleString()}</p>
                                    <div className="text-xs text-red-400 mt-1">‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏™‡∏∞‡∏™‡∏°: ‡∏ø{totalCost.toLocaleString()}</div>
                                </div>

                                <div className="bg-slate-900/50 p-4 rounded-xl border border-slate-700 flex-1 flex flex-col items-center justify-center min-h-[200px]">
                                    <canvas ref={canvasRef}></canvas>
                                </div>

                                <a href="https://line.me/ti/p/-M5tBwhz9j" target="_blank" className="bg-[#06C755] hover:bg-[#05a546] text-white p-3 rounded-xl flex items-center justify-center gap-3 transition-all shadow-lg group">
                                    <i className="fa-brands fa-line text-2xl group-hover:scale-110 transition"></i>
                                    <div className="text-left">
                                        <div className="text-[10px] opacity-80">‡∏™‡∏á‡∏™‡∏±‡∏¢‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏•‡∏π‡∏Å?</div>
                                        <div className="font-bold text-sm">‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ Admin</div>
                                    </div>
                                </a>
                            </div>

                            <div className="col-span-1 md:col-span-2 flex flex-col bg-slate-900/50 rounded-xl border border-slate-700 overflow-hidden">
                                <div className="p-3 bg-slate-800 border-b border-slate-700 flex justify-between items-center">
                                    <span className="font-bold text-slate-300">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏õ‡∏µ</span>
                                    <div className="flex items-center gap-2">
                                        <span className="text-xs text-slate-400">‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤:</span>
                                        <input type="number" value={yearCount} onChange={(e) => setYearCount(Math.max(1, parseInt(e.target.value) || 0))} className="w-12 bg-slate-700 text-center rounded text-xs text-white" />
                                        <span className="text-xs text-slate-400">‡∏õ‡∏µ</span>
                                    </div>
                                </div>
                                <div className="flex-1 overflow-y-auto scrollbar-prominent">
                                    <table className="w-full text-xs text-left text-slate-300">
                                        <thead className="text-xs text-slate-400 uppercase bg-slate-800 sticky top-0">
                                            <tr>
                                                <th className="px-3 py-2 text-center">‡∏û.‡∏®.</th>
                                                <th className="px-3 py-2 text-right">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</th>
                                                <th className="px-3 py-2 text-right">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</th>
                                                <th className="px-3 py-2 text-right">‡∏Å‡∏≥‡πÑ‡∏£</th>
                                                <th className="px-3 py-2">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {simulationData.map((row) => (
                                                <tr key={row.year} className="border-b border-slate-800 hover:bg-slate-800/50 transition">
                                                    <td className="px-3 py-2 text-center font-mono text-yellow-500">{row.year}</td>
                                                    <td className="px-3 py-2 text-right text-green-400">{row.revenue > 0 ? row.revenue.toLocaleString() : '-'}</td>
                                                    <td className="px-3 py-2 text-right text-red-400">{row.cost.toLocaleString()}</td>
                                                    <td className={`px-3 py-2 text-right font-bold ${row.profit > 0 ? 'text-emerald-400' : 'text-red-500'}`}>{row.profit.toLocaleString()}</td>
                                                    <td className={`px-3 py-2 ${row.statusColor}`}>{row.note}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- KASET CLOUD APP ---
        const KasetCloudApp = ({ mapInstance, onTravelStart, onTravelEnd }) => {
            const [selectedRegion, setSelectedRegion] = useState(null);
            const [selectedProvince, setSelectedProvince] = useState(null); // New state for specific province selection
            const [province, setProvince] = useState("‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£");
            const [area, setArea] = useState(1);
            const [analyzing, setAnalyzing] = useState(false);
            const [results, setResults] = useState(null);
            const [soilInfo, setSoilInfo] = useState(PROVINCE_DATA["‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£"]);
            const [isFullSheet, setIsFullSheet] = useState(false);
            const [isResultsUpdated, setIsResultsUpdated] = useState(false);

            const [weatherData, setWeatherData] = useState(null);
            const [address, setAddress] = useState({
                village: '-', subDistrict: '-', district: '-', province: '‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£', postcode: '-'
            });
            const [floodData, setFloodData] = useState({ risk: 'Low', history: [], desc: '‡∏õ‡∏Å‡∏ï‡∏¥' });

            const [userHasInteracted, setUserHasInteracted] = useState(false);
            const [simulatingItem, setSimulatingItem] = useState(null);
            const [isFullscreen, setIsFullscreen] = useState(false);

            const kasetMarkerRef = useRef(null);
            const debounceRef = useRef(null);

            const toggleFullScreen = () => {
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen().then(() => setIsFullscreen(true));
                } else {
                    if (document.exitFullscreen) {
                        document.exitFullscreen().then(() => setIsFullscreen(false));
                    }
                }
            };

            // 1. Map Interaction Logic
            useEffect(() => {
                if (!mapInstance) return;

                const targetInfo = PROVINCE_DATA[province];

                mapInstance.dragging.enable();
                mapInstance.touchZoom.enable();
                mapInstance.doubleClickZoom.enable();
                mapInstance.scrollWheelZoom.enable();
                mapInstance.boxZoom.enable();
                mapInstance.keyboard.enable();
                if (mapInstance.tap) mapInstance.tap.enable();
                mapInstance.getContainer().style.cursor = 'grab';

                if (!kasetMarkerRef.current) {
                    const marker = L.marker([targetInfo.lat, targetInfo.lng], { draggable: true }).addTo(mapInstance);
                    marker.bindPopup(`<b>${province}</b><br>‡∏•‡∏≤‡∏Å‡∏´‡∏°‡∏∏‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÅ‡∏õ‡∏•‡∏á`).openPopup();

                    marker.on('dragend', async function (event) {
                        const m = event.target;
                        const position = m.getLatLng();

                        setSoilInfo(prev => ({ ...prev, lat: position.lat, lng: position.lng }));
                        await fetchDetailedAddress(position.lat, position.lng);
                        setFloodData(calculateFloodRisk(position.lat, position.lng));
                        fetchDetailedWeather(position.lat, position.lng);

                        setUserHasInteracted(true);
                        m.setPopupContent(`<b>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà...</b>`).openPopup();
                    });

                    marker.on('mouseover', () => { mapInstance.getContainer().style.cursor = 'pointer'; });
                    marker.on('mouseout', () => { mapInstance.getContainer().style.cursor = 'grab'; });

                    kasetMarkerRef.current = marker;
                } else {
                    // Update marker position ONLY if interacted or region changed recently
                    if (!userHasInteracted || selectedRegion) {
                        kasetMarkerRef.current.setLatLng([targetInfo.lat, targetInfo.lng]);
                    }
                }

                return () => {
                    if (kasetMarkerRef.current) {
                        kasetMarkerRef.current.remove();
                        kasetMarkerRef.current = null;
                    }
                };
            }, [mapInstance, province]);

            // 2. Fetch Data Functions
            const fetchDetailedAddress = async (lat, lng) => {
                try {
                    const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`, { headers: { 'User-Agent': 'WinaiPortal/1.0' } });
                    const data = await res.json();
                    if (data && data.address) {
                        setAddress({
                            village: data.address.village || data.address.hamlet || '-',
                            subDistrict: data.address.suburb || data.address.quarter || data.address.neighbourhood || '-',
                            district: data.address.city_district || data.address.district || data.address.county || '-',
                            province: data.address.province || data.address.state || province,
                            postcode: data.address.postcode || '-'
                        });
                        if (kasetMarkerRef.current) {
                            kasetMarkerRef.current.setPopupContent(
                                `<b>üìç ‡∏û‡∏¥‡∏Å‡∏±‡∏î:</b> ${data.address.suburb || '-'}<br>‡∏≠.${data.address.district || '-'}`
                            ).openPopup();
                        }
                    }
                } catch (e) { console.error("Address fetch failed", e); }
            };

            const calculateFloodRisk = (lat, lng) => {
                const hash = Math.abs(Math.sin(lat * 1000 + lng) * 10000);
                const riskLevel = hash % 100;
                if (riskLevel > 80) return { risk: 'High', desc: '‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏™‡∏π‡∏á‡∏°‡∏≤‡∏Å', history: ['2554', '2564', '2565'] };
                if (riskLevel > 50) return { risk: 'Medium', desc: '‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á', history: ['2565'] };
                return { risk: 'Low', desc: '‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ï‡πà‡∏≥', history: [] };
            };

            const fetchDetailedWeather = async (lat, lng) => {
                try {
                    const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&current=temperature_2m,rain,surface_pressure&daily=temperature_2m_max,temperature_2m_min,precipitation_sum&timezone=Asia%2FBangkok&forecast_days=1`);
                    const data = await res.json();

                    if (data && data.current && data.daily) {
                        setWeatherData({
                            temp: data.current.temperature_2m,
                            rain: data.current.rain,
                            tempMax: data.daily.temperature_2m_max[0],
                            tempMin: data.daily.temperature_2m_min[0],
                            dailyRain: data.daily.precipitation_sum[0],
                            seasonalAvgTemp: data.daily.temperature_2m_max[0] - 2,
                            seasonalAvgRain: 1200
                        });
                    }
                } catch (e) { setWeatherData(null); }
            };

            useEffect(() => {
                if (soilInfo.lat) {
                    fetchDetailedWeather(soilInfo.lat, soilInfo.lng);
                    fetchDetailedAddress(soilInfo.lat, soilInfo.lng);
                    setFloodData(calculateFloodRisk(soilInfo.lat, soilInfo.lng));
                }
            }, [soilInfo.lat, soilInfo.lng]);

            useEffect(() => {
                if (debounceRef.current) clearTimeout(debounceRef.current);
                setAnalyzing(true);
                debounceRef.current = setTimeout(analyzeData, 800);
                return () => clearTimeout(debounceRef.current);
            }, [province, area, weatherData, floodData]);

            const analyzeData = () => {
                let baseData = [
                    { name: "‡∏Ç‡πâ‡∏≤‡∏ß‡∏´‡∏≠‡∏°‡∏°‡∏∞‡∏•‡∏¥", category: "‡∏û‡∏∑‡∏ä‡πÑ‡∏£‡πà", price: 15000, yield: 800, cost: 4500, risk: "Medium" },
                    { name: "‡∏ú‡∏±‡∏Å‡∏™‡∏•‡∏±‡∏î‡πÑ‡∏Æ‡πÇ‡∏î‡∏£", category: "‡∏ú‡∏±‡∏Å", price: 80000, yield: 2000, cost: 35000, risk: "Low" },
                    { name: "‡∏ó‡∏∏‡πÄ‡∏£‡∏µ‡∏¢‡∏ô", category: "‡∏ú‡∏•‡πÑ‡∏°‡πâ", price: 120000, yield: 2000, cost: 25000, risk: "High" },
                    { name: "‡∏°‡∏±‡∏ô‡∏™‡∏≥‡∏õ‡∏∞‡∏´‡∏•‡∏±‡∏á", category: "‡∏û‡∏∑‡∏ä‡πÑ‡∏£‡πà", price: 3000, yield: 3500, cost: 3500, risk: "Low" },
                    { name: "‡∏õ‡∏≤‡∏•‡πå‡∏°‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô", category: "‡∏û‡∏∑‡∏ä‡πÑ‡∏£‡πà", price: 5000, yield: 3000, cost: 4000, risk: "Low" }
                ];

                const calculated = baseData.map(item => {
                    let y = item.yield, c = item.cost;
                    if (floodData.risk === 'High') { c *= 1.2; if (!item.name.includes("‡∏Ç‡πâ‡∏≤‡∏ß")) y *= 0.6; }
                    if (weatherData && weatherData.dailyRain < 2 && item.name.includes("‡∏Ç‡πâ‡∏≤‡∏ß")) y *= 0.9;
                    if (soilInfo.soil.includes("‡∏ó‡∏£‡∏≤‡∏¢") && item.name.includes("‡∏Ç‡πâ‡∏≤‡∏ß")) y *= 0.85;

                    const rev = item.price * (y / 1000) * area;
                    const cost = c * area;
                    return { ...item, profitTotal: rev - cost, costTotal: cost, risk_level: item.risk, history: [] };
                });
                setResults(calculated.sort((a, b) => b.profitTotal - a.profitTotal));
                setAnalyzing(false);
                setIsResultsUpdated(true);
                setTimeout(() => setIsResultsUpdated(false), 5000);
            };

            // NEW: Step 1 - Select Region
            const handleRegionSelect = (regionName) => {
                setSelectedRegion(regionName);
            };

            // NEW: Step 2 - Select Province & Fly with Cache Check
            const handleProvinceSelect = async (provName) => {
                setSelectedProvince(provName);
                setProvince(provName);

                const info = PROVINCE_DATA[provName];
                setSoilInfo(info);
                setUserHasInteracted(true);

                // --- SMART PRELOAD CHECK ---
                if (mapInstance) {
                    onTravelStart(`‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Å‡∏≤‡∏£‡∏ö‡∏¥‡∏ô...`);

                    // 1. Calculate Midpoint for smooth path caching
                    const startLat = DON_MUEANG_COORDS[0];
                    const startLng = DON_MUEANG_COORDS[1];
                    const endLat = info.lat;
                    const endLng = info.lng;
                    const midLat = (startLat + endLat) / 2;
                    const midLng = (startLng + endLng) / 2;

                    // 2. Set timeout to change message if slow
                    const slowNetTimer = setTimeout(() => {
                        onTravelStart(`‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏≠‡∏¥‡∏ô‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï‡πÄ‡∏¢‡∏≠‡∏∞‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...`);
                    }, 2000);

                    // 3. Cache: Start -> Mid -> End
                    const cacheTasks = [
                        checkAndPreloadTiles(startLat, startLng, 9),
                        checkAndPreloadTiles(midLat, midLng, 9),
                        checkAndPreloadTiles(endLat, endLng, 9)
                    ];

                    await Promise.all(cacheTasks);

                    // 4. Ready!
                    clearTimeout(slowNetTimer);
                    onTravelStart(`‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏≠‡∏≠‡∏Å‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡πÑ‡∏õ ${provName}!`);

                    // 5. Fly
                    setTimeout(() => {
                        const offsetLat = info.lat - 0.15;
                        mapInstance.flyTo([offsetLat, info.lng], 9, { duration: 8, easeLinearity: 0.25 });
                        setTimeout(() => {
                            onTravelEnd();
                            if (kasetMarkerRef.current) {
                                kasetMarkerRef.current.setLatLng([info.lat, info.lng]);
                            }
                        }, 8000);
                    }, 500);
                }
            };

            const resetRegion = () => {
                setSelectedRegion(null);
                setSelectedProvince(null);
                // Fly back to Don Mueang
                if (mapInstance) mapInstance.flyTo(DON_MUEANG_COORDS, 10, { duration: 4 });
            };

            // Keep this for manual dropdown changes AFTER landing
            const handleProvinceChange = (e) => {
                const p = e.target.value;
                setProvince(p);
                const info = PROVINCE_DATA[p];
                setSoilInfo(info);
                setUserHasInteracted(true);

                if (mapInstance && kasetMarkerRef.current) {
                    const offsetLat = info.lat - 0.15;
                    mapInstance.flyTo([offsetLat, info.lng], 10, { duration: 3 });
                    kasetMarkerRef.current.setLatLng([info.lat, info.lng]);
                }
            };

            const inputContainerClass = !userHasInteracted
                ? "bg-slate-900/40 backdrop-blur-xl p-2 rounded-full border-2 border-yellow-400 shadow-[0_0_20px_rgba(250,204,21,0.5)] animate-attention transition-all duration-300 transform scale-105"
                : "bg-slate-900/10 backdrop-blur-xl px-4 py-1.5 rounded-full border border-white/20 shadow-lg transition-all duration-300";

            const resultHeaderClass = "w-full h-10 flex items-center justify-between px-4 py-1 bg-black/40 text-white cursor-pointer pointer-events-auto rounded-t-xl border-t border-white/10";

            return (
                <div className="relative w-full h-[calc(100vh-60px)] overflow-hidden ui-layer pointer-events-none">

                    {/* Fullscreen Button */}
                    <button onClick={toggleFullScreen} className="absolute top-6 right-6 z-[1050] bg-slate-900/10 backdrop-blur-xl border border-white/20 text-white w-10 h-10 rounded-full flex items-center justify-center hover:bg-slate-800/40 hover:scale-110 transition-all shadow-lg pointer-events-auto">
                        <i className={`fa-solid ${isFullscreen ? 'fa-compress' : 'fa-expand'} text-sm`}></i>
                    </button>

                    {/* Top Controls - Show Dropdown ONLY AFTER Province Selected */}
                    {selectedProvince && (
                        <div className="absolute top-4 left-1/2 -translate-x-1/2 z-[990] w-full pointer-events-auto">
                            <div className={inputContainerClass + " flex flex-row items-center gap-2 justify-center w-fit mx-auto"}>
                                {/* Back Button */}
                                <button onClick={resetRegion} className="w-8 h-8 rounded-full bg-slate-700 hover:bg-slate-600 text-white flex items-center justify-center border border-white/20 transition mr-1" title="‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏†‡∏π‡∏°‡∏¥‡∏†‡∏≤‡∏Ñ">
                                    <i className="fa-solid fa-arrow-left"></i>
                                </button>

                                <div className="relative group">
                                    <i className={`fa-solid fa-location-dot absolute left-2 top-2 text-xs z-10 ${!userHasInteracted ? 'text-yellow-400 animate-bounce' : 'text-emerald-300'}`}></i>
                                    <select className={`w-[140px] py-1.5 pl-7 pr-4 text-xs rounded-full text-white focus:outline-none appearance-none cursor-pointer font-bold ${!userHasInteracted ? 'bg-yellow-500/20 border-yellow-500' : 'bg-transparent border border-white/30'}`}
                                        value={province} onChange={handleProvinceChange}>
                                        {regions[selectedRegion].sort().map(p => (
                                            <option key={p} value={p} className="text-white bg-slate-800">{p}</option>
                                        ))}
                                    </select>
                                </div>
                                <div className="flex items-center gap-2">
                                    <input type="number" value={area} onChange={(e) => { setArea(e.target.value); setUserHasInteracted(true); }}
                                        className={`w-[50px] py-1.5 text-xs text-center rounded-full text-white focus:outline-none font-bold ${!userHasInteracted ? 'bg-yellow-500/20 border border-yellow-500 placeholder-yellow-200' : 'bg-transparent border border-white/30'}`}
                                        placeholder="‡πÑ‡∏£‡πà" min="1" />
                                    <span className={`text-[10px] font-bold ${!userHasInteracted ? 'text-yellow-300' : 'text-white/80'}`}>‡πÑ‡∏£‡πà</span>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Overlay - Show ONLY AFTER Province Selected */}
                    {selectedProvince && (
                        <>
                            <div className="absolute top-[80px] left-4 z-[950] pointer-events-none flex flex-col gap-2 text-[10px] md:text-xs text-white drop-shadow-[0_1px_2px_rgba(0,0,0,0.8)] max-w-[45%]">
                                <div>
                                    <div className="font-bold text-emerald-300"><i className="fa-solid fa-map-pin"></i> ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</div>
                                    <div>{address.village}</div>
                                    <div>{address.subDistrict} {'>'} {address.district}</div>
                                    <div className="text-yellow-400">{address.province}</div>
                                </div>
                                <div className="mt-1">
                                    <div className="font-bold text-amber-300"><i className="fa-solid fa-layer-group"></i> ‡∏î‡∏¥‡∏ô & ‡∏ô‡πâ‡∏≥</div>
                                    <div>‡∏ä‡∏ô‡∏¥‡∏î: {soilInfo.soil}</div>
                                    <div>pH: {soilInfo.ph} | ‡∏ä‡∏∑‡πâ‡∏ô: {soilInfo.moisture}%</div>
                                    {(floodData.risk === 'High' || floodData.risk === 'Medium') && (
                                        <div className="mt-1 bg-red-500/20 border border-red-500/50 p-1 rounded text-[9px] text-red-100 animate-pulse w-fit">
                                            <div className="font-bold flex items-center gap-1">
                                                <i className="fa-solid fa-clock-rotate-left"></i> ‡πÄ‡∏Ñ‡∏¢‡∏ó‡πà‡∏ß‡∏°: {floodData.history.join(', ')}
                                            </div>
                                        </div>
                                    )}
                                    <div className={`${floodData.risk === 'High' ? 'text-red-400 font-bold' : (floodData.risk === 'Medium' ? 'text-orange-400 font-bold' : 'text-green-300')}`}>
                                        {floodData.desc}
                                    </div>
                                </div>
                            </div>

                            <div className="absolute top-[80px] right-4 z-[950] pointer-events-none flex flex-col gap-2 text-[10px] md:text-xs text-white drop-shadow-[0_1px_2px_rgba(0,0,0,0.8)] text-right items-end max-w-[45%]">
                                <div>
                                    <div className="font-bold text-blue-300"><i className="fa-solid fa-temperature-half"></i> ‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥ (Live)</div>
                                    <div className="text-xl font-bold">{weatherData ? weatherData.temp : '-'}¬∞C</div>
                                    <div>‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î: {weatherData ? weatherData.tempMin : '-'} | ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î: {weatherData ? weatherData.tempMax : '-'}</div>
                                </div>
                                <div className="mt-1">
                                    <div className="font-bold text-cyan-300"><i className="fa-solid fa-cloud-rain"></i> ‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏ù‡∏ô</div>
                                    <div>‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ: {weatherData ? weatherData.rain : 0}mm</div>
                                    <div>‡∏™‡∏∞‡∏™‡∏° 24‡∏ä‡∏°: {weatherData ? weatherData.dailyRain : 0}mm</div>
                                    <div>‡∏ó‡∏±‡πâ‡∏á‡∏õ‡∏µ: ~{weatherData ? weatherData.seasonalAvgRain : '-'}mm</div>
                                </div>
                            </div>
                        </>
                    )}

                    {/* Logic for Bottom Sheet / Menus */}
                    <div className={`absolute bottom-0 left-0 right-0 mx-auto w-full max-w-xl bg-transparent z-[1000] bottom-sheet flex flex-col pointer-events-none ${isFullSheet || !selectedProvince ? 'h-[80%]' : 'h-[50%] landscape:h-[40%]'}`}>

                        {!selectedRegion ? (
                            // MENU 1: REGION SELECTION
                            <div className="flex-1 flex items-center justify-center p-6 pointer-events-auto">
                                <div className="w-full grid grid-cols-2 gap-4 animate-fade-in-up">
                                    {Object.keys(regions).map((region) => (
                                        <button
                                            key={region}
                                            onClick={() => handleRegionSelect(region)}
                                            className="bg-slate-800/80 hover:bg-emerald-600/90 backdrop-blur-md border border-white/20 rounded-xl p-6 flex flex-col items-center justify-center gap-2 transition-all hover:scale-105 shadow-lg group h-32"
                                        >
                                            <span className="text-3xl group-hover:animate-bounce">
                                                {region === '‡πÄ‡∏´‡∏ô‡∏∑‡∏≠' && 'üå≤'}
                                                {region === '‡∏≠‡∏µ‡∏™‡∏≤‡∏ô' && 'üçÇ'}
                                                {region === '‡∏Å‡∏•‡∏≤‡∏á' && 'üèôÔ∏è'}
                                                {region === '‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å' && 'üè≠'}
                                                {region === '‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏ï‡∏Å' && '‚õ∞Ô∏è'}
                                                {region === '‡πÉ‡∏ï‡πâ' && 'üåä'}
                                            </span>
                                            <span className="text-xl font-bold text-white">‡∏†‡∏≤‡∏Ñ{region}</span>
                                        </button>
                                    ))}
                                </div>
                            </div>
                        ) : !selectedProvince ? (
                            // MENU 2: PROVINCE SELECTION
                            <div className="flex-1 flex flex-col items-center p-4 pointer-events-auto bg-black/60 rounded-t-3xl backdrop-blur-sm">
                                <div className="flex items-center gap-4 mb-4 w-full px-4">
                                    <button onClick={() => setSelectedRegion(null)} className="text-white/70 hover:text-white"><i className="fa-solid fa-arrow-left"></i></button>
                                    <h2 className="text-xl font-bold text-white">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡πÉ‡∏ô‡∏†‡∏≤‡∏Ñ{selectedRegion}</h2>
                                </div>
                                <div className="w-full grid grid-cols-3 gap-2 overflow-y-auto pb-10 scrollbar-prominent px-2">
                                    {regions[selectedRegion].sort().map(p => (
                                        <button
                                            key={p}
                                            onClick={() => handleProvinceSelect(p)}
                                            className="bg-slate-700/80 hover:bg-yellow-500 hover:text-slate-900 border border-white/10 rounded-lg p-3 text-xs md:text-sm font-bold text-white transition-all shadow-md"
                                        >
                                            {p}
                                        </button>
                                    ))}
                                </div>
                            </div>
                        ) : (
                            // RESULT LIST MODE (AFTER LANDING)
                            <>
                                {isFullSheet && <button onClick={() => setIsFullSheet(false)} className="absolute top-4 right-4 z-[1010] text-white pointer-events-auto"><i className="fa-solid fa-times text-xl"></i></button>}

                                <div className={resultHeaderClass} onClick={() => setIsFullSheet(!isFullSheet)}>
                                    <div className="flex justify-between items-center w-full mb-1 drop-shadow-md">
                                        <div className={`font-bold flex items-center gap-2 ${userHasInteracted ? 'text-emerald-200' : 'text-emerald-400'}`}>
                                            <i className="fa-solid fa-ranking-star"></i>
                                            <span>10 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏ô‡πà‡∏≤‡∏•‡∏á‡∏ó‡∏∏‡∏ô ({selectedProvince})</span>
                                        </div>
                                        <div className="text-slate-400 text-xs"><i className={`fa-solid fa-chevron-up transition-transform ${isFullSheet ? 'rotate-180' : ''}`}></i></div>
                                    </div>
                                </div>

                                <div className="flex-1 overflow-y-auto scrollbar-prominent pointer-events-auto bg-black/60 border-x border-white/10 backdrop-filter-none">
                                    {results ? results.map((item, i) => (
                                        <div key={i} onClick={() => setSimulatingItem(item)}
                                            className="flex items-center justify-between border-b border-white/10 p-2 cursor-pointer transition hover:bg-white/10 group px-4">
                                            <div className="flex items-center gap-3">
                                                <div className="w-6 h-6 rounded-full bg-slate-700/50 flex items-center justify-center text-xs font-bold text-emerald-400 border border-emerald-500/30">
                                                    {i + 1}
                                                </div>
                                                <div className="flex flex-col">
                                                    <span className="text-sm font-bold text-slate-100 leading-tight">{item.name}</span>
                                                    <span className="text-[10px] text-slate-400 leading-tight">
                                                        ‡∏ó‡∏∏‡∏ô: {item.costTotal.toLocaleString()} |
                                                        <span className={`ml-1 ${item.risk_level === 'High' ? 'text-red-400' : (item.risk_level === 'Medium' ? 'text-orange-400' : 'text-green-400')}`}>
                                                            ‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á: {item.risk_level}
                                                        </span>
                                                    </span>
                                                </div>
                                            </div>
                                            <div className="flex items-center gap-3">
                                                <span className={`text-sm font-bold ${item.profitTotal > 0 ? 'text-emerald-400' : 'text-red-400'}`}>
                                                    {item.profitTotal > 0 ? '+' : ''}{item.profitTotal.toLocaleString()}
                                                </span>
                                                <button
                                                    onClick={(e) => { e.stopPropagation(); setSimulatingItem(item); }}
                                                    className="w-8 h-8 rounded-full bg-yellow-500 hover:bg-yellow-400 text-slate-900 flex items-center justify-center shadow-[0_0_10px_rgba(234,179,8,0.6)] animate-pulse"
                                                >
                                                    <i className="fa-solid fa-chevron-right text-xs"></i>
                                                </button>
                                            </div>
                                        </div>
                                    )) : <div className="text-center p-10 text-slate-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå...</div>}
                                </div>
                            </>
                        )}
                    </div>

                    {/* Simulation Modal */}
                    {simulatingItem && <SimulationModal item={simulatingItem} area={area} floodData={floodData} onClose={() => setSimulatingItem(null)} />}
                </div>
            );
        };

        const HomePage = ({ setPage, onStartTransition }) => {
            const [isFullscreen, setIsFullscreen] = useState(false);
            const toggleFullScreen = () => {
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen().then(() => setIsFullscreen(true));
                } else {
                    if (document.exitFullscreen) {
                        document.exitFullscreen().then(() => setIsFullscreen(false));
                    }
                }
            };

            // AGGRESSIVE PREFETCHING: HOME SCREEN
            useEffect(() => {
                // Prefetch Kaset Cloud Start View (Don Mueang Zoom 10)
                checkAndPreloadTiles(13.9133, 100.6042, 10);
            }, []);

            return (
                <div className="min-h-screen relative flex flex-col items-center justify-center text-white p-6 overflow-hidden ui-layer">
                    {/* Cloud Layers */}
                    <div className="absolute inset-0 w-full h-full pointer-events-none z-0 overflow-hidden">
                        <div className="cloud-layer opacity-30 mix-blend-screen"></div>
                        <div className="cloud-layer opacity-20 mix-blend-screen" style={{ animationDirection: 'reverse', animationDuration: '60s' }}></div>
                    </div>

                    {/* Fullscreen Button */}
                    <button onClick={toggleFullScreen} className="absolute top-6 right-6 z-50 bg-slate-800/40 backdrop-blur-md border border-white/10 text-white w-10 h-10 rounded-full flex items-center justify-center hover:bg-slate-700/60 hover:scale-110 transition-all shadow-[0_0_15px_rgba(255,255,255,0.1)] group">
                        <i className={`fa-solid ${isFullscreen ? 'fa-compress' : 'fa-expand'} text-sm group-hover:text-emerald-400`}></i>
                    </button>

                    <div className="z-20 text-center animate-fade-in-up relative flex flex-col items-center">
                        {/* Thai Flag */}
                        <div className="relative mb-4 pr-2">
                            <div className="absolute top-0 right-[-3px] w-2 h-2 bg-yellow-400 rounded-full shadow-[0_0_5px_rgba(250,204,21,0.8)] z-20"></div>
                            <div className="absolute top-0 right-[-1px] w-1 h-20 bg-slate-400 rounded-b-full shadow-sm z-0"></div>
                            <img src="https://upload.wikimedia.org/wikipedia/commons/a/a9/Flag_of_Thailand.svg" alt="Thai Flag" className="w-24 h-auto animate-flag-wave relative z-10" style={{ transformOrigin: 'center right' }} />
                        </div>

                        <h1 className="text-5xl md:text-7xl font-bold mb-2 text-transparent bg-clip-text bg-gradient-to-r from-yellow-300 via-emerald-400 to-cyan-400 drop-shadow-[0_2px_10px_rgba(0,0,0,0.8)]">
                            Winai Innovation
                        </h1>
                        <p className="text-slate-200 text-lg md:text-xl mb-2 drop-shadow-md font-light bg-black/30 px-4 py-1 rounded-full inline-block backdrop-blur-sm border border-white/10">
                            Super App ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£‡πÑ‡∏ó‡∏¢
                        </p>

                        <div className="flex flex-col gap-6 w-full max-w-sm mx-auto">
                            <button onClick={onStartTransition} className="btn-super-pulse bg-gradient-to-r from-fuchsia-600 via-pink-600 to-orange-500 p-5 rounded-2xl font-bold text-xl text-white hover:scale-105 transition transform shadow-[0_0_20px_rgba(236,72,153,0.5)] border-2 border-white/20 relative overflow-hidden group">
                                <div className="absolute inset-0 bg-white/20 group-hover:bg-white/30 transition"></div>
                                <div className="relative flex items-center justify-center gap-3">
                                    <i className="fa-solid fa-globe text-2xl animate-spin-slow"></i>
                                    <span>Kaset Cloud</span>
                                </div>
                                <span className="text-xs font-normal opacity-90 block mt-1">(‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏ß‡∏¢‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥ 99%)</span>
                            </button>

                            {/* MOVED: Footer Section is now here (Inside Flex Container) */}
                            <div className="bg-black/40 px-6 py-4 rounded-xl backdrop-blur-sm border border-white/5 flex flex-col items-center w-full">
                                <div className="flex flex-wrap justify-center gap-3 mb-3">
                                    <a href="https://line.me/ti/p/-M5tBwhz9j" target="_blank" className="inline-flex items-center justify-center gap-2 bg-[#06C755] hover:bg-[#05a546] text-white py-1 px-3 rounded-full text-xs font-bold shadow-sm transition hover:scale-105">
                                        <i className="fa-brands fa-line text-lg"></i>
                                        Admin ‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£‡πÑ‡∏ó‡∏¢‡∏°‡∏±‡πà‡∏á‡∏Ñ‡∏±‡πà‡∏á
                                    </a>
                                    <a href="https://www.facebook.com/winayo1" target="_blank" className="inline-flex items-center justify-center gap-2 bg-[#1877F2] hover:bg-[#166fe5] text-white py-1 px-3 rounded-full text-xs font-bold shadow-sm transition hover:scale-105">
                                        <i className="fa-brands fa-facebook text-lg"></i>
                                        Facebook
                                    </a>
                                </div>
                                <div className="text-[10px] md:text-xs text-slate-400">
                                    <p className="mb-1 font-bold text-slate-300">‡∏ú‡∏•‡∏¥‡∏ï‡πÇ‡∏î‡∏¢: Mr.Winai Phanarkat ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡πÑ‡∏ó‡∏¢</p>
                                    <p>‡πÑ‡∏•‡∏ô‡πå/‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£: 0926533228 | ‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πå: winayo@gmail.com</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const VinaiInnovationPortal = () => {
            const [page, setPage] = useState('home');
            const [isTransitioning, setIsTransitioning] = useState(false);
            const [travelState, setTravelState] = useState({ active: false, message: '' });
            const mapRef = useRef(null);
            const rotationInterval = useRef(null);

            const jetSoundRef = useRef(new Audio('https://www.soundjay.com/transportation/sounds/airplane-fly-by-01.mp3'));

            const playJetSound = () => {
                try {
                    jetSoundRef.current.currentTime = 0;
                    jetSoundRef.current.volume = 0.5;
                    jetSoundRef.current.play().catch(e => console.log("Audio play failed"));
                } catch (e) { }
            };

            // GLOBAL MAP INIT
            useEffect(() => {
                if (!document.getElementById('global-map')) return;
                const map = L.map('global-map', { zoomControl: false, attributionControl: false, zoomSnap: 0.1, minZoom: 2 }).setView([13.7563, 100.5018], 2.5);
                L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Tiles &copy; Esri' }).addTo(map);
                L.tileLayer('https://mt1.google.com/vt/lyrs=h&x={x}&y={y}&z={z}', { opacity: 0.5 }).addTo(map);
                L.control.zoom({ position: 'bottomright' }).addTo(map);
                mapRef.current = map;
                startRotation(map);
                return () => { if (map) map.remove(); stopRotation(); };
            }, []);

            const startRotation = (map) => {
                if (rotationInterval.current) clearInterval(rotationInterval.current);
                map.dragging.disable(); map.scrollWheelZoom.disable(); map.touchZoom.disable(); map.doubleClickZoom.disable();
                rotationInterval.current = setInterval(() => { if (map) map.panBy([1, 0], { animate: false }); }, 50);
            };

            const stopRotation = () => {
                if (rotationInterval.current) { clearInterval(rotationInterval.current); rotationInterval.current = null; }
            };

            const startTravel = (msg) => {
                playJetSound();
                setTravelState({ active: true, message: msg });
            };

            const endTravel = () => setTravelState({ active: false, message: '' });

            const handleStartKaset = () => {
                if (!mapRef.current) return;
                playJetSound();
                setIsTransitioning(true);
                setTravelState({ active: true, message: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡πÑ‡∏õ‡∏ó‡∏µ‡πà ‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£ (‡∏î‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡∏≠‡∏á)...' });
                stopRotation();
                // Fly to Don Mueang Airport
                mapRef.current.flyTo(DON_MUEANG_COORDS, 10, { duration: 8, easeLinearity: 0.25 });
                setTimeout(() => { setPage('kaset'); setIsTransitioning(false); setTravelState({ active: false, message: '' }); }, 8000);
            };

            const handleGoHome = () => {
                playJetSound();
                setPage('home');
                if (mapRef.current) {
                    mapRef.current.flyTo([13.7563, 100.5018], 2.5, { duration: 3 });
                    setTimeout(() => startRotation(mapRef.current), 3000);
                }
            };

            return (
                <div className="font-sans text-slate-200 h-screen w-screen overflow-hidden">
                    <div id="global-map"></div>
                    <CloudOverlay isActive={travelState.active} message={travelState.message} />

                    {/* MOVED: Home Button to Top-Left */}
                    <button onClick={handleGoHome} className="absolute top-6 left-6 z-[1050] bg-slate-900/10 hover:bg-slate-900/30 text-white w-10 h-10 rounded-full flex items-center justify-center backdrop-blur-md border border-white/20 shadow-lg transition-all group pointer-events-auto" title="‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å">
                        <i className="fa-solid fa-house text-sm group-hover:text-emerald-400"></i>
                    </button>

                    {page === 'home' && <div className={`absolute inset-0 z-20 transition-opacity duration-1000 ${isTransitioning ? 'opacity-0 pointer-events-none' : 'opacity-100'}`}><HomePage setPage={setPage} onStartTransition={handleStartKaset} /></div>}
                    {page === 'kaset' && !isTransitioning && <KasetCloudApp mapInstance={mapRef.current} onTravelStart={startTravel} onTravelEnd={endTravel} />}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<VinaiInnovationPortal />);
    </script>
</body>

</html>
